// Package main provides a test generator tool that reads YAML spec files
// and generates Go test code for RTX command parsing and building.
package main

import (
	"flag"
	"fmt"
	"os"
	"path/filepath"
	"strings"

	"github.com/sh1/terraform-provider-rtx/tools/specgen/generator"
)

func main() {
	var (
		specFile   string
		outputDir  string
		dryRun     bool
		verbose    bool
		testOnly   bool
		structOnly bool
	)

	flag.StringVar(&specFile, "spec", "", "Path to spec YAML file (required)")
	flag.StringVar(&outputDir, "output", "", "Output directory for generated files (default: auto-detect)")
	flag.BoolVar(&dryRun, "dry-run", false, "Print generated code without writing files")
	flag.BoolVar(&verbose, "verbose", false, "Enable verbose output")
	flag.BoolVar(&testOnly, "test-only", false, "Generate only test files")
	flag.BoolVar(&structOnly, "struct-only", false, "Generate only struct additions")
	flag.Parse()

	if specFile == "" {
		fmt.Fprintln(os.Stderr, "Error: -spec flag is required")
		flag.Usage()
		os.Exit(1)
	}

	// Read spec file
	spec, err := generator.LoadSpec(specFile)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error loading spec: %v\n", err)
		os.Exit(1)
	}

	if verbose {
		fmt.Printf("Loaded spec: %s\n", spec.Command.Name)
		fmt.Printf("  Description: %s\n", spec.Command.Description)
		fmt.Printf("  Syntax tests: %d\n", len(spec.Command.SyntaxTests))
	}

	// Determine output directory
	if outputDir == "" {
		// Default to internal/rtx/parsers for test files
		cwd, _ := os.Getwd()
		outputDir = filepath.Join(cwd, "internal", "rtx", "parsers")
	}

	// Generate code
	gen := generator.New(spec, generator.Options{
		Verbose:    verbose,
		TestOnly:   testOnly,
		StructOnly: structOnly,
	})

	results, err := gen.Generate()
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error generating code: %v\n", err)
		os.Exit(1)
	}

	// Output results
	for _, result := range results {
		if dryRun {
			fmt.Printf("=== %s ===\n", result.Filename)
			fmt.Println(result.Content)
			fmt.Println()
		} else {
			outputPath := filepath.Join(outputDir, result.Filename)

			// Check if file exists and has "generated" marker
			if !result.Overwrite {
				if _, err := os.Stat(outputPath); err == nil {
					content, _ := os.ReadFile(outputPath)
					if !strings.Contains(string(content), "// Code generated by specgen") {
						fmt.Printf("Skipping %s (not a generated file)\n", outputPath)
						continue
					}
				}
			}

			if err := os.WriteFile(outputPath, []byte(result.Content), 0644); err != nil {
				fmt.Fprintf(os.Stderr, "Error writing %s: %v\n", outputPath, err)
				os.Exit(1)
			}
			fmt.Printf("Generated: %s\n", outputPath)
		}
	}

	if verbose {
		fmt.Printf("\nGeneration complete. %d files generated.\n", len(results))
	}
}
