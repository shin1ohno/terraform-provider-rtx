# 第32章: トリガによるメール通知機能

> 元PDFページ: 527-533

---

第 32 章
トリガによるメール通知機能
この機能は、あらかじめ設定したトリガを検出してその内容をメールで通知する機能です。
mail notify  コマンドで設定したトリガを検出すると、 mail template  コマンドで設定したメールテンプレートを基に
メールを作成し、 mail server smtp  コマンドで指定したメールサーバーを使用して検出したトリガの内容を記述した
メールを送信します。
SMTP 認証として、 CRAM-MD5/DIGEST-MD5/PLAIN に対応しており、 POP-before-SMTP にも対応しています。
32.1 メール設定識別名の設定
[書式 ]
mail  server  name  id name
no mail  server  name  id [name ]
[設定値及び初期値 ]
•id
• [設定値 ] : メールサーバー設定  ID (1..10)
• [初期値 ] : -
•name
• [設定値 ] : 識別名
• [初期値 ] : -
[説明 ]
メール設定の識別名を設定する。空白を伴う識別名の場合は、 「 "」で囲む必要がある。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
32.2 SMTP メールサーバーの設定
[書式 ]
mail  server  smtp  id address  [port= port] [smtp-auth username  password  [auth_protocol ]] [pop-before-smtp] [ smtps ]
no mail  server  smtp  id [...]
[設定値及び初期値 ]
•id
• [設定値 ] : メールサーバー設定  ID (1..10)
• [初期値 ] : -
•address
• [設定値 ] : サーバーの  IP アドレスまたはホスト名  (半角  1 文字以上  64 文字以内 )
• [初期値 ] : -
•port
• [設定値 ] : サーバーのポート番号  (省略時は  25、または、 465)
• [初期値 ] : -
•username
• [設定値 ] : 認証用ユーザ名  (半角  1 文字以上  64 文字以内 )
• [初期値 ] : -
•password
• [設定値 ] : 認証用パスワード  (半角  1 文字以上  64 文字以内 )
• [初期値 ] : -
•auth_protocol  : SMTP-AUTH 認証プロトコル
• [設定値 ] :コマンドリファレンス  | トリガによるメール通知機能  | 527

設定値 説明
cram-md5 CRAM-MD5
digest-md5 DIGEST-MD5
plain PLAIN 認証
• [初期値 ] : -
• pop-before-smtp
• [設定値 ] : POP before SMTP の使用
• [初期値 ] : -
• smtps
• [設定値 ] : SMTPS の使用
• [初期値 ] : -
[説明 ]
メール送信に使用するサーバー情報を設定する。
smtp-auth  パラメータでは、メール送信の際の  SMTP 認証のためのデータ  ( ユーザ名、パスワード  ) を指定する。
SMTP サーバーで認証が必要ない場合は smtp-auth  の設定は必要ない。
SMTP 認証でサポートしている認証プロトコルは、 CRAM-MD5 、DIGEST-MD5 および  PLAIN 認証の  3 種類である。
smtp-auth  パラメータでプロトコルを指定した場合にはそれを用い、プロトコルが省略された場合には  SMTP サーバ
ーとの前記の順で認証交渉を行う。
pop-before-smtp  パラメータを設定すると、メール送信時に  POP before SMTP 動作を行う。ここで行う  POP 動作は、
mail server pop  コマンドで同じ  ID で設定したものを利用する。 pop-before-smtp  パラメータが設定されているのに、
対応する mail server pop  コマンドの設定がないと、メールは送信できない。
smtps  パラメーターが設定されている場合、 SMTPS を使用してメールを送信する。 smtps  パラメーターと pop-before-
smtp  パラメーターは同時に設定できない。
port パラメーターを省略した場合、 smtps  パラメーターの設定によって、メールサーバーのポート番号として使用す
る値が変わる。 smtps  パラメーターの設定と、メールサーバーのポート番号の対応は以下のとおり。
smtps パラメーター 使用するポート番号
設定しない  ( 省略  ) 25
設定する 465
[ノート ]
smtps  パラメーターは、 RTX5000 / RTX3500 Rev.14.00.25 以前、 RTX1210 Rev.14.01.25 以前、および  RTX830
Rev.15.02.02 以前では指定不可能。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
32.3 POP メールサーバーの設定
[書式 ]
mail  server  pop id address  [port= port] protocol  username  password
no mail  server  pop id [...]
[設定値及び初期値 ]
•id
• [設定値 ] : メールサーバー設定  ID (1..10)
• [初期値 ] : -
•address
• [設定値 ] : サーバーの  IP アドレスまたはホスト名
• [初期値 ] : -
•port
• [設定値 ] : サーバーのポート番号  ( 省略時は  110)
• [初期値 ] : -
•protocol528 | コマンドリファレンス  | トリガによるメール通知機能

• [設定値 ] :
設定値 説明
pop3 POP3
apop APOP
• [初期値 ] : -
•username
• [設定値 ] : 認証用ユーザ名
• [初期値 ] : -
•password
• [設定値 ] : 認証用パスワード
• [初期値 ] : -
[説明 ]
メール受信に使用するサーバー情報を設定する。
mail server smtp  コマンドで pop-before-smtp  パラメータを設定したときに必要な設定である。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
32.4 メール処理のタイムアウト値の設定
[書式 ]
mail  server  timeout  id timeout
no mail  server  timeout  id [timeout ]
[設定値及び初期値 ]
•id
• [設定値 ] : メールサーバー設定  ID (1..10)
• [初期値 ] : -
•timeout
• [設定値 ] : タイムアウト値  (1..600 秒)
• [初期値 ] : 60
[説明 ]
メールの送受信処理に対するタイムアウト値を設定する。
指定した時間以内にメールの処理が終らない時には、いったん処理を中断して、 mail template  コマンドで設定した
待機時間  ( デフォルトは  30 秒 ) の間を置いた後、メール処理を最初からやり直す。処理のやり直しは、最初のメー
ル処理を除き、最大  3 回行われる。最大回数を超えた場合には、メール処理は失敗となる。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
32.5 メールの送信時に使用するテンプレートの設定
[書式 ]
mail  template  template_id  mailserver_id  From: from_address  To:to_address  [Subject: subject ] [Date: date] [MIME-
Version: mime_version ] [Content-Type: content_type ] [notify-log= switch ] [notify-wait-time= sec]
no mail  template  template_id  [...]
[設定値及び初期値 ]
•template_id
• [設定値 ] : メールテンプレート  ID (1..10)
• [初期値 ] : -
•mailserver_id
• [設定値 ] : このテンプレートで使用するメールサーバー ID (1..10)コマンドリファレンス  | トリガによるメール通知機能  | 529

• [初期値 ] : -
•from_address
• [設定値 ] : 送信元メールアドレス
• [初期値 ] : -
•to_address
• [設定値 ] : 宛先メールアドレス
• [初期値 ] : -
•subject
• [設定値 ] : 送信時の件名
• [初期値 ] : Backup Info/Route Change Info/Filter Info/Status Info/Intrusion Info/TM Info
•date
• [設定値 ] : メールのヘッダに表示する時刻
• [初期値 ] : 送信時の時刻
•mime_version
• [設定値 ] : メールのヘッダに表示する  MIME-Version
• [初期値 ] : 1.0
•content_type
• [設定値 ] : メールのヘッダに表示する  Content-Type
• [初期値 ] : text/plain;charset=iso-2022-jp
•switch
• [設定値 ] :
設定値 説明
on 通知系のメール内容に  syslog の内容を含める
off 通知系のメール内容に  syslog の内容を含めない
• [初期値 ] : off
•sec
• [設定値 ] : 通知系のメール送信時に、実際に送信されるまでの待機時間  (1..86400 秒)
• [初期値 ] : 30
[説明 ]
メール送信時に使用するメールサーバー設定  ID、送信元メールアドレス、宛先メールアドレスおよびヘッダ等を設
定する。
from_address  に送信元メールアドレスを指定する。送信元メールアドレスは一つしか指定できない。
to_address  に宛先メールアドレスを指定する。宛先メールアドレスは複数指定できる。複数指定する場合はカンマ
(,) で区切り、間に空白を入れてはいけない。
メールアドレスは  local-part@domain もしくは  local-part@ipaddress の形式のみ対応している。 "NAME<local-
part@domain>" 等の形式には対応していない。
subject  でメールの件名を指定する。空白を含む場合は、ダブルクォーテーション  (") で Subject: subject  全体を囲む必
要がある。
date には、 RFC822 に示されるフォーマットの時刻を指定する。 RFC822 のフォーマットでは必ず空白が含まれるた
め、ダブルクォーテーション  (") で Date: date 全体を囲む必要がある。
content-type  に指定できる  type/subtype は "text/plain" のみで、パラメータは  "charset=us-ascii" および  "charset=iso-2022-
jp" のみ対応している。
[ノート ]
メールヘッダ情報として必須のものは、 " 送信元メールアドレス  " と " 宛先メールアドレス  " になる。
[表示例 ]
mail template 1 1 From:test@test.com To:test1@test.com,test2@test.com
  "Subject:Test Mail" notify-log=on
mail template 1 2 From:test@test.com To:test1@test.com
  "Subject:RTX1220 test" "Date:Mon, 23 Feb 2022 09:54:20 +0900"
  MIME-Version:1.0 "Content-Type:text/plain; charset=iso-2022-jp"530 | コマンドリファレンス  | トリガによるメール通知機能

[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
32.6 メール通知のトリガの設定
[書式 ]
mail  notify  id template_id  trigger backup if_b [[range_b ] if_b ...]
mail  notify  id template_id  trigger route route  [route  ...]
mail  notify  id template_id  trigger route6 route6  [route6  ...]
mail  notify  id template_id  trigger filter ethernet if_f dir_f  [if_f dir_f  ...]
mail  notify  id template_id  trigger status type [type ...]
mail  notify  id template_id  trigger intrusion if_i [range_i ] dir_i  [if_i [range_i ] dir_i  ...]
mail  notify  id template_id  trigger lan-map
no mail  notify  id [...]
[設定値及び初期値 ]
•id
• [設定値 ] : 設定番号  (1..10)
• [初期値 ] : -
•template_id
• [設定値 ] : テンプレート  ID (1..10)
• [初期値 ] : -
•if_b : メール通知を行うバックアップ対象のインタフェース
• [設定値 ] :
設定値 説明
pp PP バックアップ
lanN LAN バックアップ
tunnel TUNNEL バックアップ
• [初期値 ] : -
•range_b
• [設定値 ] :
•インタフェース番号および範囲指定
• pp,tunnel のみ  (*,xx-yy,zz etc)
• [初期値 ] : -
•route
• [設定値 ] :
•ネットマスク付きの経路
• default
• [初期値 ] : -
•route6
• [設定値 ] :
•プレフィックス長付きの経路
• default
• [初期値 ] : -
•if_f
• [設定値 ] : メール通知を行うイーサネットフィルタの設定された  LAN インタフェース
• [初期値 ] : -
•dir_f  : フィルタ設定の方向
• [設定値 ] :
設定値 説明
in 受信方向コマンドリファレンス  | トリガによるメール通知機能  | 531

設定値 説明
out 送信方向
• [初期値 ] : -
•type : メール通知で通知する情報
• [設定値 ] :
設定値 説明
all 全ての内容
interface インタフェースの情報
routing ルーティングの情報
vpn VPN の情報
nat NAT の情報
firewall ファイアウォールの情報
config-log 設定情報とログ
• [初期値 ] : -
•if_i : 不正アクセス検知設定のインタフェース
• [設定値 ] :
設定値 説明
pp PP インタフェース
lanN(N,M,N/M) LAN インタフェース
wan1 WAN インタフェース
( vRX シリーズ、 RTX5000 、および  RTX3500 では指
定不可能  )
tunnel TUNNEL インタフェース
* 全てのインタフェース
• [初期値 ] : -
•range_i
• [設定値 ] :
•インタフェース番号および範囲指定
• lan(*,x)
• pp,tunnel(*,x,xx-yy,zz etc)
• [初期値 ] : -
•dir_i  : 不正アクセス検知設定の方向
• [設定値 ] :
設定値 説明
in 受信方向
out 送信方向
in/out 受信 /送信方向
• [初期値 ] : -
[説明 ]
メール通知の行うトリガ動作の設定を行う。バックアップ、 経路変更、 イーサネットフィルタのログ表示、 mail notify
status exec  コマンド実行時、および不正アクセス検知時をトリガとして指定できる。
バックアップおよび経路については以下で設定されたものが対象となる。
PP バックアップ pp backup  コマンド
LAN バックアップ lan backup  コマンド532 | コマンドリファレンス  | トリガによるメール通知機能

TUNNEL バックアップ tunnel backup  コマンド
経路に対するバックアップ  (IPv4 ) ip route  コマンド
経路に対するバックアップ  (IPv6 ) ipv6 route  コマンド
イーサネットフィルタについてはログ表示されるものが対象となる。
イーサネットフィルタ ....... pass-log,reject-log パラメータの定義
内部状態を通知する場合は、 mail notify status exec  コマンドを実行する必要がある。
不正アクセス検知については  ip interface  intrusion detection  コマンドの設定により検出されたものが通知対象とな
る。
LAN マップによる異常検知については  switch control use  interface  コマンドが設定された  LAN インターフェースが
対象となる。スナップショット機能による異常を含める場合は  lan-map snapshot use  interface  コマンドを設定する
必要がある。
また、一つのテンプレート  ID に所属するメール通知設定はまとめて処理される。
[ノート ]
trigger route6 は、 vRX Amazon EC2 版、 vRX VMware ESXi 版、 RTX5000 、RTX3500 、RTX1300 Rev.23.00.04 以前、
RTX1220 Rev.15.04.03 以前、 RTX1210 、および  RTX830 Rev.15.02.26 以前では使用不可能。
trigger lan-map は、 LAN マップ機能に対応している機種・リビジョン  ( RTX1210 Rev.14.01.08 以前を除く  ) で使用可
能。
[設定例 ]
mail notify 1 1 trigger backup pp * lan2 lan3 tunnel 1-10,12
mail notify 2 1 trigger route 192.168.1.0/24 172.16.0.0/16
mail notify 3 1 trigger route6 1000::1/64
mail notify 4 1 trigger filter ethernet lan1 in
mail notify 5 1 trigger status all
mail notify 6 1 trigger intrusion lan1 in/out pp * in tunnel 1-3,5 out
mail notify 7 1 trigger lan-map
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830コマンドリファレンス  | トリガによるメール通知機能  | 533

