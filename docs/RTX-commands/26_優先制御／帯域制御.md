# 第26章: 優先制御／帯域制御

> 元PDFページ: 430-443

---

第 26 章
優先制御／帯域制御
優先制御と帯域制御の機能は、インタフェースに入力されたパケットの順序を入れ換えて別のインタフェースに出
力します。これらの機能を使用しない場合には、パケットは入力した順番に処理されます。
優先制御は、クラス分けしたキューに優先順位をつけ、まず高位のキューのパケットを出力し、そのキューが空に
なると次の順位のキューのパケットを出力する、という処理を行います。
帯域制御は、クラス分けしたキューをラウンドロビン方式で監視しますが、監視頻度に差を与えてキューごとに利
用できる帯域に差をつけます。
クラスは、 queue class filter  コマンドにより、パケットのフィルタリングと同様な定義でパケットを分類します。
RTX3510 では、クラスは  1 から  250 まで、 vRX シリーズ、 RTX5000 、RTX3500 では、クラスは  1 から  100 まで、そ
の他のモデルでは  1 から  16 までの番号で識別します。優先制御、帯域制御で使用可能なクラスは以下の通りです。
モデル 優先制御で使用可能なクラス 帯域制御で使用可能なクラス
RTX3510 1～16 1～250
vRX シリーズ、 RTX5000 、RTX3500 1～16 1～100
上記以外の機種 1～4 1～16
クラスは番号が大きいほど優先順位が高くなります。
パケットの処理アルゴリズムは、 queue  interface  type コマンドにより、優先制御、帯域制御、単純  FIFO の中から選
択します。
これはインタフェースごとに選択することができます。
RTX5000 、RTX3510 、RTX3500 ではクラス構造を階層化し、 2 階層目に優先制御クラスを持つことができます。つま
り、 1 階層目は帯域制御、または、優先制御が設定でき、 2 階層目は優先制御が設定できます。
26.1 インタフェース速度の設定
[書式 ]
speed  interface  speed
speed  pp speed
no speed  interface  [speed ]
no speed  pp [speed ]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•speed
• [設定値 ] : インタフェース速度  (bit/s)
• [初期値 ] : 0 ( PP インタフェースの場合  )
[説明 ]
指定したインタフェースに対して、インタフェースの速度を設定する。
queue  interface  type コマンドで優先制御および帯域制御の設定が必要。
帯域制御で CBQを利用する時にはパラメータ計算に用いられるので、物理的な速度と一致しているのが望ましい。
その場合、 MPにより動的に回線速度が変動する場合などは、最低限の速度に設定しておく。430 | コマンドリファレンス  | 優先制御／帯域制御

[ノート ]
speed  パラメータの後ろに  'k'、'M'、または  'G' をつけると、それぞれ  kbit/s、Mbit/s、Gbit/s として扱われる。 ( 'G' は
RTX5000 、RTX3500 、RTX1220 、RTX1210 、RTX840、および  RTX830 では使用不可能  )
第 2、第  4 書式は、 RTX5000 、RTX3500 、および  RTX1210 で使用可能。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.2 クラス分けのためのフィルター設定
[書式 ]
queue  class  filter  num class1 [/class2 ] [cos= cos] ip src_addr  [dest_addr  [protocol  [src_port  [dest_port ]]]]
queue  class  filter  num class1 [/class2 ] [cos= cos] ipv6 src_addr  [dest_addr  [protocol  [src_port  [dest_port ]]]]
queue  class  filter  num precedence  [mapping= prec:class  [,prec:class ...]] [cos= cos] ip src_addr  [dest_addr  [protocol
[src_port  [dest_port ]]]]
queue  class  filter  num precedence  [mapping= prec:class  [,prec:class ...]] [cos= cos] ipv6 src_addr  [dest_addr  [protocol
[src_port  [dest_port ]]]]
queue  class  filter  num dscp  [cos= cos] ip src_addr  [dest_addr  [protocol  [src_port  [dest_port ]]]]
queue  class  filter  num dscp  [cos= cos] ipv6 src_addr  [dest_addr  [protocol  [src_port  [dest_port ]]]]
queue  class  filter  num class1  ip dpi src_addr  [dest_addr  [application ]]
queue  class  filter  num class1  ipv6 dpi src_addr  [dest_addr  [application ]]
queue  class  filter  num precedence  [mapping= prec:class  [,prec:class ...]] [cos= cos] ip dpi src_addr  [dest_addr
[application ]]
queue  class  filter  num precedence  [mapping= prec:class  [,prec:class ...]] [cos= cos] ipv6 dpi src_addr  [dest_addr
[application ]]
queue  class  filter  num class1  ip dpi src_addr  [dest_addr  [group_num ]]
queue  class  filter  num class1  ipv6 dpi src_addr  [dest_addr  [group_num ]]
queue  class  filter  num precedence  [mapping= prec:class  [,prec:class ...]] [cos= cos] ip dpi src_addr  [dest_addr
[group_num ]]
queue  class  filter  num precedence  [mapping= prec:class  [,prec:class ...]] [cos= cos] ipv6 dpi src_addr  [dest_addr
[group_num ]]
no queue  class  filter  num [...]
[設定値及び初期値 ]
•num
• [設定値 ] : クラスフィルターの識別番号
• [初期値 ] : -
•class1
• [設定値 ] :
設定値 説明
1..250 (RTX3510)
クラス 1..100 (vRX シリーズ、 RTX5000 、RTX3500)
1..16 ( 上記以外  )
• [初期値 ] : -
•class2
• [設定値 ] : 第 2 階層クラス  (1..4)
• [初期値 ] : -
•prec
• [設定値 ] : precedence 値 (0..7)
• [初期値 ] : -
•cos
• [設定値 ] :コマンドリファレンス  | 優先制御／帯域制御  | 431

設定値 説明
0-7 CoS 値
precedence 転送するパケットの  TOS の precedence(0-7) を ToS-
CoS 変換として  COS 値に格納する
• [初期値 ] : -
•src_addr  : IPパケットの始点アドレス
• [設定値 ] :
• IPアドレス
• A.B.C.D (A ～D: 0～255もしくは *)
•上記表記で A～Dを*とすると、該当する 8ビット分についてはすべての値に対応する
• IPv6 アドレス
•間に  - を挟んだ  2 つの上項目、 - を前につけた上項目、 - を後ろにつけた上項目、これらは範囲を指定す
る。
• , を区切りとして複数設定することができる。
• FQDN
•任意の文字列  (半角  255 文字以内。 / ： は使用できない。 , は区切り文字として使われるため、使用でき
ない )
• * から始まる  FQDN は * より後ろの文字列を後方一致条件として判断する  例えば  *.example.co.jp は
www.example.co.jp 、mail.example.co.jp などと一致する
• , を区切りとして複数設定することができる。
• * (すべての  IP アドレスまたは  IPv6 アドレスに対応 )
• [初期値 ] : -
•dest_addr  : IPパケットの終点アドレス
• [設定値 ] :
•src_addr  と同じ形式
•省略した場合は一個の  * と同じ
• [初期値 ] : -
•protocol  : フィルタリングするパケットの種類
• [設定値 ] :
•プロトコルを表す十進数
•プロトコルを表すニーモニック
icmp 1
tcp 6
udp 17
•上項目のカンマで区切った並び  (5 個以内  )
• *( すべてのプロトコル  )
• established
•省略時は  * と同じ
• [初期値 ] : -
•src_port  : UDP、TCP のソースポート番号
• [設定値 ] :
•ポート番号を表す十進数
•ポート番号を表すニーモニック  ( 一部  )
ニーモニック ポート番号
ftp 20,21
ftpdata 20
telnet 23
smtp 25432 | コマンドリファレンス  | 優先制御／帯域制御

ニーモニック ポート番号
domain 53
gopher 70
finger 79
www 80
pop3 110
sunrpc 111
ident 113
ntp 123
nntp 119
snmp 161
syslog 514
printer 515
talk 517
route 520
uucp 540
submission 587
•間に  - をはさんだ  2 つの上項目、 - を前につけた上項目、 - を後ろにつけた上項目、これらは範囲を指定す
る。
•上項目のカンマで区切った並び  (10 個以内  )
• *( すべてのポート  )
•省略時は  * と同じ。
• [初期値 ] : -
•dest_port  : UDP、TCP のディスティネーションポート番号
• [設定値 ] : src_portと同じ形式
• [初期値 ] : -
•application  : フィルタリング対象とするアプリケーション、またはカテゴリー
• [設定値 ] :
•アプリケーションを表すニーモニック
• "@" で始まるカテゴリーを表すニーモニック
•上記文字列をカンマで区切った並び  (10 個以内、アプリケーションとカテゴリーの混在が可能 )
•省略時は 1つの  * と同じ
• [初期値 ] : -
•group_num  : グループ  ID
• [設定値 ] : dpi group set  コマンドでグループ化したアプリケーションのグループ  ID
• [初期値 ] : -
[説明 ]
クラス分けのためのフィルターを設定する。
precedence 形式の場合、 転送するパケットの  TOS フィールドの  precedence(0-7) に応じてクラス  (1-8) を分けて優先制
御もしくはシェーピング、 Dynamic Traffic Control や CBQ による帯域制御を行う。  precedence 値からクラスへの変換
は、  mapping オプションにより指定  できる。例えば、以下の例では  precedence 値=1をクラス 8に、  precedence 値=4
をクラス 3に変換する。
queue class filter 1 precedence mapping=1:8,4:3 ip *
mapping オプション全体を省略した場合、あるいは  mapping オプションは指定しているものの、その中で記述しなか
った  precedence 値に  ついては以下の表のような変換が行われる。
precedence 値 0 1 2 3 4 5 6 7
クラス 1 2 3 4 5 6 7 8コマンドリファレンス  | 優先制御／帯域制御  | 433

dscp 形式の場合、 転送するパケットの  DS フィールドの  DSCP 値により定義される  PHB に応じてクラス  (1-9) を分け
て優先制御もしくはシェーピングや  Dynamic Traffic Control による帯域制御を行う。
cos= cos 指定を行うと、フィルターに合致したパケットに付加される  IEEE802.1Q タグの  user_priority フィールドに
は、指定した  CoS 値が格納される。 cos に precedence を指定した場合、そのパケットの  IP ヘッダの  precedence 値に
対応する値が  user_priority フィールドに格納される。
パケットフィルターに該当したパケットは、指定したクラスに分類される。このコマンドで設定したフィルターを
使用するかどうか、 あるいはどのような順番で適用するかは、 各インターフェースにおける queue  interface  class filter
list コマンドで設定する。
application 、または、 group_num  を指定した場合、 DPI のアプリケーション識別結果を利用したクラス分けが行われ
る。アプリケーションの識別が完了したパケットは、直ちに指定のクラスに分類されるようになる。識別処理中の
パケットや  DPI がアクティベーション中で識別されなかったパケットは、 DPI のフィルターにはマッチせず、通常
の設定に従ってクラスに分類される。
class1  とclass2  を「 /」( スラッシュ  ) で連結して指定することができる。 class2  は RTX5000 、RTX3510 、RTX3500 で
指定可能。
[ノート ]
cos パラメーターは、 vRX シリーズ  では指定不可能。
src_addr  および  dest_addr  パラメーターへの  FQDN の指定は、 RTX5000 / RTX3500 Rev.14.00.25 以前、 RTX1210
Rev.14.01.25 以前、 RTX830 Rev.15.02.02 以前では不可能。
application  パラメータ、および  group_num  パラメータは、 RTX5000 、RTX3510 、RTX3500 、RTX1220 、RTX1210 、
RTX830 の Rev.15.02.10 以前では使用不可能。
第 5 書式、および第  6 書式は  RTX5000 、RTX3510 、RTX3500 、RTX1300 、RTX1220 、RTX1210 で指定可能である。
[設定例 ]
# queue class filter 1 4 ip * * udp 5004-5060 *
# queue class filter 2 10/3 ip * 172.16.1.0/24 tcp telnet *
# queue class filter 5 precedence ip 172.16.5.0/24 * tcp * *
# queue class filter 6 precedence/4 ip * 172.16.6.0/24 tcp * *
# queue class filter 10 dscp ip 172.16.10.0/24 *
# queue class filter 11 dscp/4 ip * 172.16.11.0/24
# queue class filter 12 4 ip dpi * * @audio_video
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.3 キューイングアルゴリズムタイプの選択
[書式 ]
queue  interface  type type [shaping-level =level ]
queue  pp type type
no queue  interface  type [type]
no queue  pp type [type]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•type
• [設定値 ] :
設定値 説明
fifo First In,First Out 形式のキューイング
priority 優先制御キューイング
cbq 帯域制御キューイング434 | コマンドリファレンス  | 優先制御／帯域制御

設定値 説明
wfq Weighted Fair Queue 形式のキューイング
shaping 帯域制御
• [初期値 ] : fifo
•level  : 帯域速度の計算を行うレイヤー
• [設定値 ] :
設定値 説明
1 レイヤー 1
2 レイヤー 2
• [初期値 ] : 2
[説明 ]
指定したインタフェースに対して、キューイングアルゴリズムタイプを選択する。
fifo は最も基本的なキューである。 fifo の場合、パケットは必ず先にルーターに到着したものから送信される。パケ
ットの順番が入れ替わることは無い。 fifo キューにたまったパケットの数が queue  interface  length  コマンドで指定
した値を越えた場合、キューの最後尾、つまり最後に到着したパケットが破棄される。
priority は優先制御を行う。 queue class filter  コマンドおよび queue  interface  class filter list  コマンドでパケットをク
ラス分けし、送信待ちのパケットの中から最も優先順位の高いクラスのパケットを送信する。
cbq は BRI と PRI インタフェースに対する帯域制御を行う。 queue  interface  class property  コマンドで各クラスに割
り振る帯域をあらかじめ設定しておき、 queue class filter  コマンドおよび queue  interface  class filter list  コマンドでク
ラス分けされたパケットが指定の帯域になるように送信する。 PP インタフェースにだけ設定できる。
wfq は送信待ちのパケットを始点・終点  IP_アドレスやプロトコル、ポート番号でフローとしてグループ分けして、
それぞれのフローで使用する帯域のバランスが取れるようにするキューイングアルゴリズムである。 wfq を使用す
ると、 TELNET のような、帯域はあまり必要としないが速い応答時間を必要とするプロトコルと、 FTP のような応
答時間よりも広い帯域を必要とするプロトコルを同時に利用した場合に、 TELNET の応答時間の落ち込みを  fifo に
比べて軽減することができる。 wfq のもう一つの特徴は、 設定がいらないということである。設定するところがない
ため、優先制御や帯域制御に比べて細かい調整はできないが、簡単にフロー間での帯域のバランスを図ることがで
きる。 PP インタフェースにだけ設定できる。
shaping は LAN インタフェースに対する帯域制御を行う。 LAN インタフェースにだけ設定できる。
shaping-level オプションは TYPEパラメーターに priorityおよび shapingを指定しているときのみ指定可能。
shaping-level に1を設定した場合、帯域速度の計算をプリアンブル、 SFD(Start Frame Delimiter) 、IFG(Inter Frame Gap)
を含んだフレームサイズでおこなう。
[ノート ]
RTX5000 、RTX3500 、RTX1210type パラメータに  fifo、priority、cbq、wfq、shaping を指
定することができる。
上記以外の機種type パラメータに  fifo、priority、shaping を指定すること
ができる。
shaping-level オプションは、 RTX5000 / RTX3500 Rev.14.00.17 以前、および  RTX1210 Rev.14.01.08 以前では指定不可
能。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.4 MP インタリーブの設定
[書式 ]
ppp mp interleave  [delay ] switch
no ppp mp interleave  [[delay ] switch ]
[設定値及び初期値 ]
•delay
• [設定値 ] : 遅延  ( ミリ秒  )コマンドリファレンス  | 優先制御／帯域制御  | 435

• [初期値 ] : 30
•switch
• [設定値 ] :
設定値 説明
on MP インタリーブを使用する
off MP インタリーブを使用しない
• [初期値 ] : off
[説明 ]
MP インタリーブを使用するかどうかを設定する。 delay  では、優先されるプロトコルで許容できる最大遅延を設定
する。パケットをどのような大きさに分割するかは、 delay  の値と回線速度により決定される。
[ノート ]
delay  で設定した遅延が保証されるわけではない。
データの受信側でも同じ設定をしておかないと、効果が発揮されない。
同時に圧縮は利用できない。圧縮を利用する設定の場合、この機能は無視されるので、以下の設定で圧縮を無効に
しておく必要がある。
ppp ccp type none
[設定例 ]
# queue class filter 1 4 ip VOIP-GATEWAY * * * *
# queue class filter 2 3 ip * * icmp * *
# queue class filter 3 1 ip * * * * *
# pp select 1
pp1# pp bind bri2.1
pp1# queue pp type priority
pp1# queue class filter list 1 2 3
pp1# isdn remote address call 03-123-4567
pp1# ppp mp use on
pp1# ppp mp interleave on
pp1# ppp mp maxlink 1
pp1# ppp ccp type none
pp1# pp enable 1
[適用モデル ]
RTX5000, RTX3500, RTX1210
26.5 クラス分けフィルタの適用
[書式 ]
queue  interface  class  filter  list filter_list
queue  pp class  filter  list filter_list
queue  tunnel  class  filter  list filter_list
no queue  interface  class  filter  list [filter_list ]
no queue  pp class  filter  list [filter_list ]
no queue  tunnel  class  filter  list [filter_list ]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•filter_list
• [設定値 ] : 空白で区切られたクラスフィルタの並び
• [初期値 ] : -436 | コマンドリファレンス  | 優先制御／帯域制御

[説明 ]
指定した  LAN インタフェース、 WAN インタフェースまたは選択されている  PP、トンネルに対して、 queue class
filter  コマンドで設定したフィルタを適用する順番を設定する。フィルタにマッチしなかったパケットは、 queue
interface  default class  コマンドで指定したデフォルトクラスに分類される。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.6 クラス毎のキュー長の設定
[書式 ]
queue  interface  length  len1 [len2...lenN ] [drop-threshold= dthreshold-mid [,dthreshold-high ]]
queue  pp length  len1 [len2...len16 ]
no queue  interface  length  [len1...]
no queue  pp length  [len1...]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•len1..lenN
• [設定値 ] :
•クラス  1 からクラス  16 のキュー長  (1..10000)
• vRX シリーズ、 RTX5000 、RTX3500 の場合はクラス  1 からクラス  100 のキュー長  (1..10000)
• RTX3510 の場合はクラス  1 からクラス  250 のキュー長  (1..10000)
• [初期値 ] :
• 600 (RTX5000 、RTX3510 、RTX3500)
• 200 (上記以外の機種 )
•len1..len16.
• [設定値 ] : クラス  1 からクラス  16 のキュー長  (1..10000)
• [初期値 ] : 20
•dthreshold-mid
• [設定値 ] : AF PHB の廃棄優先度が中の場合のキューサイズの閾値  (1%..100%)
• [初期値 ] : 75%
•dthreshold-high
• [設定値 ] : AF PHB の廃棄優先度が高の場合のキューサイズの閾値  (1%..100%)
• [初期値 ] : 50%
[説明 ]
インタフェースに対して、指定したクラスのキューに入れることができるパケットの個数を指定する。指定を省略
したクラスに関しては、最後に指定されたキュー長が残りのクラスにも適用される。
DiffServ ベース  QoS の場合、 dthreshold-mid 、dthreshold-high  パラメータで指定した値が  AF PHB の廃棄優先度が中と
高に対応するキューに積むことができる閾値となる。閾値は、クラスのキュー長に対する割合  (%) として表す。
dthreshold-high  を省略した場合は、 dthreshold-mid  と同じ値となる。廃棄優先度が低に対応する閾値は常に  100% であ
る。
[ノート ]
dthreshold-mid 、dthreshold-high  パラメータは、 RTX840、RTX830 では指定不可能。
RTX5000 、RTX3510 、RTX3500 でqueue  interface  length secondary  コマンドで第  2 階層クラスのキュー長が指定され
ている場合は、 queue  interface  length secondary  コマンドで設定されたキュー長が優先して適用される。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830コマンドリファレンス  | 優先制御／帯域制御  | 437

26.7 第 2 階層クラスのキュー長の設定
[書式 ]
queue  interface  length  secondary  [primary= primary_class ] len1 [len2 ...len4]
no queue  interface  length  secondary  [primary= primary_class ...]
[設定値及び初期値 ]
•interface
• [設定値 ] : LAN インタフェース名
• [初期値 ] : -
•primary_class
• [設定値 ] :
•第１階層クラス  (RTX5000 、RTX3500 は 1..100; RTX3510 は 1..250)
•省略時、すべての第  1 階層クラスに従属する第  2 階層クラスのキュー長を一律に指定する
• [初期値 ] : -
•len1...len4
• [設定値 ] : クラス  1 からクラス  4 のキュー長  (1..10000)
• [初期値 ] :
• 600 (RTX5000 、RTX3510 、RTX3500)
• 200 (上記以外 )
[説明 ]
インタフェースに対して、指定した第  1 階層クラスに従属する第  2 階層クラスのキューに入ることのできるパケッ
トの個数を指定する。設定を省略したクラスに関しては、最後に指定されたキュー長が残りのクラスにも適用され
る。
[適用モデル ]
RTX5000, RTX3510, RTX3500
26.8 デフォルトクラスの設定
[書式 ]
queue  interface  default  class  class0
queue  pp default  class  class1
queue  tunnel  default  class  class0
no queue  interface  default  class  [class0 ]
no queue  pp default  class  [class1 ]
no queue  tunnel  default  class  [class0 ]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•class0
• [設定値 ] : クラス  (1..16; vRX シリーズ、 RTX5000 、RTX3500 は 1..100; RTX3510 は 1..250)
• [初期値 ] : 2
•class1
• [設定値 ] : クラス  (1..16)
• [初期値 ] : 2
[説明 ]
インタフェースに対して、フィルタにマッチしないパケットをどのクラスに分類するかを指定する。438 | コマンドリファレンス  | 優先制御／帯域制御

[ノート ]
第 3、第  6 書式は、 vRX Amazon EC2 版、 RTX5000 / RTX3500 Rev.14.00.31 以前、 RTX1210 Rev.14.01.39 以前、および
RTX830 Rev.15.02.19 以前では使用不可能。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.9 第 2 階層のデフォルトクラスの設定
[書式 ]
queue  interface  default  class  secondary  [primary= primary_class ] class
queue  tunnel  default  class  secondary  [primary= primary_class ] class
no queue  interface  default  class  secondary  [primary= primary_class ...]
no queue  tunnel  default  class  secondary  [primary= primary_class ...]
[設定値及び初期値 ]
•interface
• [設定値 ] : LAN インタフェース名
• [初期値 ] : -
•primary_class
• [設定値 ] :
•第 1 階層クラス  (RTX5000 、RTX3500 は 1..100; RTX3510 は 1..250)
•省略時、すべての第  1 階層クラスに従属する第  2 階層クラスのデフォルトクラスを一律に指定する
• [初期値 ] : -
•class
• [設定値 ] : クラス  (1..4)
• [初期値 ] : 2
[説明 ]
指定した第  1 階層クラスに従属する第  2 階層クラスにおいて、フィルタにマッチしないパケットをどのクラスに分
類するかを指定する。
[ノート ]
第 2、第  4 書式は  RTX5000 / RTX3500 は Rev.14.00.32 以降のファームウェアで使用可能。
[適用モデル ]
RTX5000, RTX3510, RTX3500
26.10 クラスの属性の設定
[書式 ]
queue  interface  class  property  class  bandwidth= bandwidth
queue  interface  class  property  class  type= type
queue  pp class  property  class  bandwidth= bandwidth  [parent= parent ] [borrow= borrow ] [maxburst= maxburst ]
[minburst= minburst ] [packetsize= packetsize ]
no queue  interface  class  property  class  [...]
no queue  pp class  property  class  [bandwidth= bandwidth ...]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•class
• [設定値 ] : クラス  (1..16; vRX シリーズ、 RTX5000 、RTX3500 は 1..100; RTX3510 は 1..250)コマンドリファレンス  | 優先制御／帯域制御  | 439

• [初期値 ] : -
•bandwidth
• [設定値 ] :
•クラスに割り当てる帯域  (bit/s)
•数値の後ろに  'k'、'M'、または  'G' をつけるとそれぞれ  kbit/s、Mbit/s、Gbit/s として扱われる。また、数値
の後ろに  '%' をつけると、回線全体の帯域に対するパーセンテージとなる。
• 'G' は RTX5000 、RTX3500 、RTX1220 、RTX1210 、および  RTX830 では使用不可能。
• 'ngn' を指定した場合は、データコネクト拠点間接続の接続時に決めた帯域に設定される。
• vRX Amazon EC2 版、および  vRX さくらのクラウド版  では指定不可能。
• [初期値 ] : -
•parent
• [設定値 ] : 親クラスの番号  (0..16)
• [初期値 ] : 0
•borrow  : 帯域が足りなくなった場合に親クラスから帯域を借りるか否かの設定
• [設定値 ] :
設定値 説明
on 借りる
off 借りない
• [初期値 ] : on
•maxburst
• [設定値 ] : 連続送信できる最大バイト数  (1..10000)
• [初期値 ] : 20
•minburst
• [設定値 ] : 安定送信中に連続送信できる最大バイト数  (1..10000)
• [初期値 ] : maxburst/10
•packetsize
• [設定値 ] : クラスで流れるパケットの平均パケット長  (1..10000)
• [初期値 ] : 512
•type
• [設定値 ] :
設定値 説明
priority 優先制御クラスとして使用することを明示する。
• [初期値 ] : -
[説明 ]
指定したクラスの属性を設定する。
[ノート ]
bandwidth  パラメータで各クラスに割り当てる帯域の合計は、回線全体の帯域を越えてはいけない。回線全体の帯域
は、 speed  コマンドで設定される。なお、 cbq による帯域制御を行う場合、各クラスに割り当てる帯域は、親クラス
以下の値でなければいけない。  'ngn'を指定した場合は、データコネクト拠点間接続で接続時に決まる帯域に自動的
に設定される。  複数のデータコネクト拠点間接続を利用する場合は、トンネルインタフェース毎にクラスを分ける
必要がある。  また、 tunnel ngn interface コマンドで使用する LANインタフェースを設定する必要がある。
queue  interface  type コマンドで  shaping が指定されている場合は、 Dynamic Traffic Control による帯域制御を行うこと
が可能である。 Dynamic Traffic Control を行うためには、  bandwidth パラメータに「 ,」( コンマ  ) でつないだ  2 つの速
度を指定することで、保証帯域と上限帯域を設定する。記述順に関係なく、常に値の小さな方が保証帯域となる。
なお、保証帯域の合計が回線全体の帯域を越えてはいけない。
parent/borrow/maxburst/minburst/packetsize  パラメータは queue  interface  type コマンドで  cbq が指定されている場合の
み有効である。
cbq において、クラス番号  0 はルートクラスを表す。ルートクラスは仮想的なクラスで、常に  100% の帯域を持ち、
デフォルトでは他のクラスの親クラスになっている。ルートクラスに直接パケットを割り振ることはできず、その
帯域は他のクラスに貸し出すためにだけ割り当てられている。440 | コマンドリファレンス  | 優先制御／帯域制御

帯域が足りなくなった場合に、親クラスから帯域を借りてくる  (borrow=on) と設定すると、このクラスの最大速度は
親クラスの最大速度まで増えることができる。通常は  100% の帯域を持つルートクラスを親クラスとするので、 クラ
スの帯域は回線速度一杯に広がることができる。この場合、 bandwidth  の設定は、回線が混雑している場合に他のク
ラスとどの程度の割り合いで帯域を分けるかの目安として使われる。
帯域を借りてこない設定  (borrow=off) だと、このクラスの最大速度は bandwidth  の値になり、それ以上の帯域を使わ
なくなる。特定のトラフィックの帯域を制限したい場合に有効である。
type パラメータは queue  interface  type コマンドで  shaping が指定されている場合のみ有効である。インタフェース
において帯域制御による速度配分がされている場合でも、 type パラメータに  priority を指定することで、そのクラス
は優先制御クラスとなり、帯域制御クラスよりも優先してパケットの転送が行われる。 type パラメータに  priority を
指定したクラスが複数ある場合は、クラス番号が大きいほど優先順位が高くなる。 type パラメータは、 vRX シリー
ズ、 RTX5000 、RTX3510 、RTX3500 で指定可能である。
このコマンドが設定されていないクラスには、常に  100% の帯域が割り振られている。そのため、帯域制御の設定を
する場合には最低限でも対象としているクラスと、デフォルトクラスの  2 つに関してこのコマンドを設定しなくて
はいけない。デフォルトクラスの設定を忘れると、デフォルトクラスに  100% の帯域が割り振られるため、対象とす
るクラスは常にデフォルトクラスより狭い帯域を割り当てられることになる。
queue pp class property  コマンドは  RTX5000 、RTX3500 、RTX1210 で指定可能。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.11 動的なクラス変更  (Dynamic Class Control) の設定
[書式 ]
queue  interface  class  control  class  [except  ip_address  ...] [ option =value  ...]
no queue  interface  class  control  class  [except  ip_address ...]
[設定値及び初期値 ]
•interface
• [設定値 ] :
• LAN インタフェース名
• WAN インタフェース名
• vRX シリーズ、 RTX5000 、および  RTX3500 では指定不可能
• [初期値 ] : -
•class
• [設定値 ] : DCC を有効にするクラス  (1..16; vRX シリーズ、 RTX5000 、RTX3500 は 1..100; RTX3510 は 1..250)
• [初期値 ] : -
•ip_address
• [設定値 ] :
設定値 説明
IP アドレス サーバーなどの監視対象から除外するホストの  IP ア
ドレスを設定する  ( 空白で区切って複数指定可能、 ハ
イフン「 -」を使用して範囲指定も可能  )
• [初期値 ] : -
•option = value 列
• [設定値 ] :
option value 説明
forwarding reject,1..16過剰送信と見なしたトラフィック
の転送先のクラス
watchsource送信元  IP アドレス単位で帯域を監
視する
destination宛先  IP アドレス単位で帯域を監視
するコマンドリファレンス  | 優先制御／帯域制御  | 441

option value 説明
threshold 占有率 , 秒数過剰送信と見なす閾値を帯域の占
有率と占有時間をカンマ「 ,」で結
び設定する  ( 占有率  1%..100% 、秒
数 10..86400)
timeinfinity 過剰送信と見なしたトラフィック
を遮断する時間、または、使用す
るクラスを変更する時間  ( 秒 ) 10..604800
modeforced動作モードを強制制御モードにす
る
adaptive動作モードを適応制御モードにす
る
triggerwinnyWinny 検知をトリガとして制御を
開始する
shareShare 検知をトリガとして制御を
開始する
masquerade-sessionIP マスカレード変換セッション数
制限をトリガとして制御を開始す
る
noticeon 制御されていることを通知する
off 制御されていることを通知しない
• [初期値 ] :
• watch=source
• threshold=70%,30
• time=600
• mode=forced
• notice=on
[説明 ]
指定したインタフェースについて、同一のホストが過剰な送信 /受信を行い、帯域を逼迫していないか監視をする。
監視対象のインタフェースに適用されている  QoS 種別が  shaping の場合は、 queue  interface  class property  コマンドで
設定されたクラス帯域に対する占有率  ( クラス帯域に保証値と上限値を指定している場合は保証値に対する占有
率 ) を監視する。 QoS 種別が  priority の場合は、インタフェース帯域に対する占有率を監視する。監視時は  10 秒毎
に占有率を求め、その占有率が指定秒数を超えたときに閾値超過と判定される。
例えば、 threshold=70%,30 と設定した場合、帯域使用率  70% 以上である  10 秒間が連続して  3 回続いたときに閾値超
過と判定される。
同一のホストから  (watch=source) 、あるいは、同一のホスト宛て  (watch=destination) の過剰送信を検知した場合、そ
のトラフィックは forwarding  パラメータに指定されたクラスへ転送され、転送先のクラス設定に従ってパケットの
送出が行われる。なお、 forwarding  パラメータに  reject を指定した場合、当該トラフィックは遮断される。また、
forwarding  パラメータは省略することも可能で、この場合転送制御は行われないが、 threshold を超過しているホスト
をshow status qos  コマンドから確認することができる。
time パラメータは転送制御が行われる時間を示し、 infinity を指定した場合は、無期限に対象のトラフィックの遮断、
または、使用クラスの変更がなされる。
mode パラメータは動作モードを指定する。 forced を指定した場合は、 threshold パラメータで指定した占有時間が経
過したら直ちに当該フローの制御を実行する。また、 time パラメータで指定した制御時間が経過したら直ちに当該
フローの制御を解除する。 adaptive を指定した場合は、 threshold パラメータで指定した占有時間が経過しても当該ク
ラスの使用帯域が保証帯域の  90% 未満である間は制御を保留する。また、 time パラメータで指定した制御時間が経
過しても当該クラスの使用帯域が保証帯域の  90% 以上である間は制御解除を保留する。
制御が保留されているホストは show status qos  コマンドで表示されず、制御が保留されている間に  threshold の占有
率を割ったらその時点で制御は解除される。
trigger パラメータは制御開始のトリガとなるルーター内部のイベントを指定する。カンマ「 ,」で区切って併記する
ことができる。442 | コマンドリファレンス  | 優先制御／帯域制御

notice パラメータは  Dynamic Class Control により制御されていることをホストに通知するかどうかを指定する。 on
を指定した場合は、当該ホストが制御されてから初めていずれかの  http サーバー ( ポート番号： 80) へ Web アクセス
をした時に、 Web 画面上にその旨を表示して通知する。 notice パラメータは  Web GUI 機能を搭載している機種で使
用可能。
[ノート ]
トラフィックの転送は  1 段のみ可能である。転送先のクラスにも当コマンドが設定されている場合、 2 段目の設定は
無効となり、トラフィックの  2 重転送は行われない。
[適用モデル ]
vRX シリーズ , RTX5000, RTX3510, RTX3500, RTX1300, RTX1220, RTX1210, RTX840, RTX830
26.12 クラス毎のキュー長の自動設定
[書式 ]
queue  length  auto-config  go
[説明 ]
優先制御や帯域制御で使用するクラス毎のキュー長の自動設定をする。
設定されているクラス数に応じたキュー長を算出し、 queue  interface  length  コマンドにキュー長を自動で設定する。
階層型  QoS を使用している場合には、 queue  interface  length secondary  コマンドにも自動で設定する。  受信用パケッ
トバッファが不足する場合には、 system packet-buffer  コマンドも自動で設定し、受信用パケットバッファを増やす。
[ノート ]
50 以上のクラスを使用して  QoS を行う場合には、受信用パケットバッファの枯渇を防ぐため、本コマンドにより各
クラスのキュー長と受信用パケットバッファの自動設定を行うことを推奨する。
設定されているクラスの数が  1,000 を超える場合には、本コマンドはエラーになる。 system packet-buffer  コマンド
が設定された場合には、設定を有効にするため再起動が必要となる。
[適用モデル ]
RTX3510コマンドリファレンス  | 優先制御／帯域制御  | 443

