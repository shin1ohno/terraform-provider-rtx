# NAT Masquerade Configuration Command Specification
# Reference: RTX Command Reference
#
# Covers:
# - nat descriptor type masquerade: マスカレード設定
# - nat descriptor address: アドレス設定
# - nat descriptor masquerade static: 静的ポートマッピング

command:
  name: nat_masquerade
  description: "NATマスカレード設定"

  applicable_models:
    - vRX
    - RTX5000
    - RTX3510
    - RTX3500
    - RTX1300
    - RTX1220
    - RTX1210
    - RTX840
    - RTX830

  terraform:
    resource_name: rtx_nat_masquerade
    struct_name: NATMasquerade
    package: parsers

  syntax_tests:
    # =============================================================================
    # NAT Descriptor Type
    # =============================================================================
    - name: nat_type_masquerade
      rtx: "nat descriptor type 1 masquerade"
      terraform:
        descriptor_id: 1

    - name: nat_type_masquerade_100
      rtx: "nat descriptor type 100 masquerade"
      terraform:
        descriptor_id: 100

    # =============================================================================
    # NAT Descriptor Address Outer
    # =============================================================================
    - name: nat_address_outer_ipcp
      rtx: "nat descriptor address outer 1 ipcp"
      terraform:
        descriptor_id: 1
        outer_address: "ipcp"

    - name: nat_address_outer_ip
      rtx: "nat descriptor address outer 1 203.0.113.1"
      terraform:
        descriptor_id: 1
        outer_address: "203.0.113.1"

    - name: nat_address_outer_primary
      rtx: "nat descriptor address outer 1 primary"
      terraform:
        descriptor_id: 1
        outer_address: "primary"

    # =============================================================================
    # NAT Descriptor Address Inner
    # =============================================================================
    - name: nat_address_inner_network
      rtx: "nat descriptor address inner 1 192.168.1.1-192.168.1.254"
      terraform:
        descriptor_id: 1
        inner_network: "192.168.1.1-192.168.1.254"

    - name: nat_address_inner_auto
      rtx: "nat descriptor address inner 1 auto"
      terraform:
        descriptor_id: 1
        inner_network: "auto"

    # =============================================================================
    # NAT Masquerade Static (Port Forwarding)
    # =============================================================================
    - name: masquerade_static_tcp
      rtx: "nat descriptor masquerade static 1 1 192.168.1.100 tcp 80"
      terraform:
        descriptor_id: 1
        static_entries:
          - entry_number: 1
            inside_local: "192.168.1.100"
            protocol: "tcp"
            inside_local_port: 80

    - name: masquerade_static_tcp_https
      rtx: "nat descriptor masquerade static 1 2 192.168.1.100 tcp 443"
      terraform:
        descriptor_id: 1
        static_entries:
          - entry_number: 2
            inside_local: "192.168.1.100"
            protocol: "tcp"
            inside_local_port: 443

    - name: masquerade_static_udp
      rtx: "nat descriptor masquerade static 1 3 192.168.1.200 udp 53"
      terraform:
        descriptor_id: 1
        static_entries:
          - entry_number: 3
            inside_local: "192.168.1.200"
            protocol: "udp"
            inside_local_port: 53

    - name: masquerade_static_port_mapping
      rtx: "nat descriptor masquerade static 1 4 192.168.1.100 tcp 8080=80"
      terraform:
        descriptor_id: 1
        static_entries:
          - entry_number: 4
            inside_local: "192.168.1.100"
            protocol: "tcp"
            outside_global_port: 8080
            inside_local_port: 80

    - name: masquerade_static_outer_inner
      rtx: "nat descriptor masquerade static 1 5 203.0.113.1:22=192.168.1.10:22"
      terraform:
        descriptor_id: 1
        static_entries:
          - entry_number: 5
            outside_global: "203.0.113.1"
            outside_global_port: 22
            inside_local: "192.168.1.10"
            inside_local_port: 22

    - name: masquerade_static_protocol_only
      rtx: "nat descriptor masquerade static 1 6 192.168.1.100 icmp"
      terraform:
        descriptor_id: 1
        static_entries:
          - entry_number: 6
            inside_local: "192.168.1.100"
            protocol: "icmp"

    # =============================================================================
    # Interface NAT Descriptor
    # =============================================================================
    - name: interface_nat_descriptor
      rtx: "ip lan2 nat descriptor 1"
      terraform:
        interface: "lan2"
        descriptor_id: 1

    - name: interface_nat_descriptor_pp
      rtx: "ip pp nat descriptor 1"
      terraform:
        interface: "pp"
        descriptor_id: 1

    # =============================================================================
    # Delete Commands (build_only)
    # =============================================================================
    - name: delete_nat_masquerade
      rtx: "no nat descriptor type 1"
      terraform:
        descriptor_id: 1
      build_only: true

    - name: delete_masquerade_static
      rtx: "no nat descriptor masquerade static 1 1"
      terraform:
        descriptor_id: 1
        entry_number: 1
      build_only: true

    # === Additional test variations ===
    - name: nat_descriptor_min
      rtx: "nat descriptor type 1 masquerade"
      description: "ディスクリプタID最小"
      terraform:
        descriptor_id: 1
        type: "masquerade"

    - name: nat_descriptor_max
      rtx: "nat descriptor type 65535 masquerade"
      description: "ディスクリプタID最大"
      terraform:
        descriptor_id: 65535
        type: "masquerade"

    - name: nat_static_tcp_ssh
      rtx: "nat descriptor masquerade static 1 1 192.168.1.100 tcp 22"
      description: "SSH静的NAT"
      terraform:
        descriptor_id: 1
        static_id: 1
        inner_ip: "192.168.1.100"
        protocol: "tcp"
        port: 22

    - name: nat_static_tcp_https
      rtx: "nat descriptor masquerade static 1 2 192.168.1.100 tcp 443"
      description: "HTTPS静的NAT"
      terraform:
        descriptor_id: 1
        static_id: 2
        inner_ip: "192.168.1.100"
        protocol: "tcp"
        port: 443

    - name: nat_static_udp_dns
      rtx: "nat descriptor masquerade static 1 3 192.168.1.53 udp 53"
      description: "DNS静的NAT"
      terraform:
        descriptor_id: 1
        static_id: 3
        inner_ip: "192.168.1.53"
        protocol: "udp"
        port: 53

    - name: nat_address_outer
      rtx: "nat descriptor address outer 1 ipcp"
      description: "外部アドレスIPCP"
      terraform:
        descriptor_id: 1
        outer_address: "ipcp"

    - name: nat_address_inner
      rtx: "nat descriptor address inner 1 192.168.1.0-192.168.1.255"
      description: "内部アドレス範囲"
      terraform:
        descriptor_id: 1
        inner_address_start: "192.168.1.0"
        inner_address_end: "192.168.1.255"

    - name: nat_timer_min
      rtx: "nat descriptor timer 1 60"
      description: "NATタイマー最小"
      terraform:
        descriptor_id: 1
        timer: 60


  boundary_tests:
    descriptor_id:
      - value: 1
        valid: true
      - value: 100
        valid: true
      - value: 1000
        valid: true
      - value: 0
        valid: false
        error_contains: "must be positive"

    entry_number:
      - value: 1
        valid: true
      - value: 100
        valid: true
      - value: 65535
        valid: true
      - value: 0
        valid: false
        error_contains: "must be positive"

    port:
      - value: 1
        valid: true
      - value: 80
        valid: true
      - value: 443
        valid: true
      - value: 65535
        valid: true
      - value: 0
        valid: false
        error_contains: "must be 1-65535"
      - value: 65536
        valid: false
        error_contains: "must be 1-65535"

    protocol:
      - value: "tcp"
        valid: true
      - value: "udp"
        valid: true
      - value: "icmp"
        valid: true
      - value: "invalid"
        valid: false
        error_contains: "invalid protocol"
