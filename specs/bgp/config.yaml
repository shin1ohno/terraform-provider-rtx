# BGP Configuration Command Specification
# Reference: RTX Command Reference
#
# Covers:
# - bgp use: BGP有効化
# - bgp autonomous-system: AS番号設定
# - bgp router id: ルーターID設定
# - bgp neighbor: ネイバー設定
# - bgp import: 経路広報

command:
  name: bgp_config
  description: "BGP設定"

  applicable_models:
    - vRX
    - RTX5000
    - RTX3510
    - RTX3500
    - RTX1300
    - RTX1220
    - RTX1210
    - RTX840
    - RTX830

  terraform:
    resource_name: rtx_bgp
    struct_name: BGPConfig
    package: parsers

  syntax_tests:
    # =============================================================================
    # BGP Enable/Disable
    # =============================================================================
    - name: bgp_use_on
      rtx: "bgp use on"
      terraform:
        enabled: true

    - name: bgp_use_off
      rtx: "bgp use off"
      terraform:
        enabled: false

    # =============================================================================
    # BGP Autonomous System
    # Reference: AS range is 1-65535 (2-byte AS only)
    # =============================================================================
    - name: bgp_asn_2byte
      rtx: "bgp autonomous-system 65001"
      terraform:
        asn: "65001"

    - name: bgp_asn_min
      rtx: "bgp autonomous-system 100"
      terraform:
        asn: "100"

    # =============================================================================
    # BGP Router ID
    # =============================================================================
    - name: bgp_router_id
      rtx: "bgp router id 192.168.1.1"
      terraform:
        router_id: "192.168.1.1"

    - name: bgp_router_id_loopback
      rtx: "bgp router id 10.0.0.1"
      terraform:
        router_id: "10.0.0.1"

    # =============================================================================
    # BGP Neighbor
    # Reference: bgp neighbor <neighbor_id> <remote_as> <remote_address> [<parameter>...]
    # =============================================================================
    - name: bgp_neighbor
      rtx: "bgp neighbor 1 65002 203.0.113.1"
      terraform:
        neighbors:
          - id: 1
            ip: "203.0.113.1"
            remote_as: "65002"

    - name: bgp_neighbor_second
      rtx: "bgp neighbor 2 65003 203.0.113.2"
      terraform:
        neighbors:
          - id: 2
            ip: "203.0.113.2"
            remote_as: "65003"

    # Note: RTX supports 2-byte AS only (1-65535), removed 4-byte AS test case

    # =============================================================================
    # BGP Neighbor Options
    # Note: These options are specified as inline parameters in the neighbor command
    # Reference: bgp neighbor <n> <as> <ip> [hold-time=<sec>] [local-address=<ip>] [passive=on|off]
    # =============================================================================
    - name: bgp_neighbor_holdtime
      rtx: "bgp neighbor 1 65002 192.168.1.2 hold-time=90"
      terraform:
        neighbors:
          - id: 1
            remote_as: "65002"
            ip: "192.168.1.2"
            hold_time: 90

    - name: bgp_neighbor_local_address
      rtx: "bgp neighbor 1 65002 192.168.1.2 local-address=192.168.1.1"
      terraform:
        neighbors:
          - id: 1
            remote_as: "65002"
            ip: "192.168.1.2"
            local_address: "192.168.1.1"

    - name: bgp_neighbor_passive
      rtx: "bgp neighbor 1 65002 192.168.1.2 passive=on"
      terraform:
        neighbors:
          - id: 1
            remote_as: "65002"
            ip: "192.168.1.2"
            passive: true

    # =============================================================================
    # BGP Neighbor Pre-Shared Key (TCP MD5 Authentication)
    # Reference: bgp neighbor pre-shared-key <neighbor_id> text <text_key>
    # =============================================================================
    - name: bgp_neighbor_preshared_key
      rtx: "bgp neighbor pre-shared-key 1 text mysecret"
      terraform:
        neighbors:
          - id: 1
            password: "mysecret"

    # =============================================================================
    # BGP Network (Import Filter)
    # =============================================================================
    - name: bgp_network
      rtx: "bgp import filter 1 include 192.168.0.0/16"
      terraform:
        networks:
          - prefix: "192.168.0.0"
            mask: "255.255.0.0"

    - name: bgp_network_24
      rtx: "bgp import filter 1 include 10.0.0.0/24"
      terraform:
        networks:
          - prefix: "10.0.0.0"
            mask: "255.255.255.0"

    # =============================================================================
    # BGP Redistribution
    # =============================================================================
    - name: bgp_import_static
      rtx: "bgp import from static"
      terraform:
        redistribute_static: true

    - name: bgp_import_connected
      rtx: "bgp import from connected"
      terraform:
        redistribute_connected: true

    # =============================================================================
    # Delete Commands (build_only)
    # =============================================================================
    - name: delete_bgp_neighbor
      rtx: "no bgp neighbor 1"
      terraform:
        neighbor_id: 1
      build_only: true

    - name: delete_bgp_network
      rtx: "no bgp import filter 1"
      terraform:
        filter_id: 1
      build_only: true

  boundary_tests:
    asn:
      - value: "1"
        valid: true
        description: "最小値"
      - value: "65535"
        valid: true
        description: "2バイトAS最大値"
      - value: "0"
        valid: false
        error_contains: "invalid AS number"
      - value: "65536"
        valid: false
        description: "2バイトAS範囲外"
        error_contains: "invalid AS number"

    neighbor_id:
      - value: 1
        valid: true
      - value: 2147483647
        valid: true
        description: "最大値"
      - value: 0
        valid: false
        error_contains: "must be positive"

    hold_time:
      - value: 3
        valid: true
        description: "最小値"
      - value: 180
        valid: true
        description: "デフォルト値"
      - value: 28800
        valid: true
        description: "最大値"
      - value: 2
        valid: false
        description: "最小値未満"
        error_contains: "hold_time must be between 3 and 28800"
