# Schedule Command Specification
# Reference: RTX Command Reference Chapter 37
#
# Covers:
# - schedule at ID [DATE] TIME * COMMAND: 時刻指定スケジュール
# - schedule at ID startup * COMMAND: 起動時スケジュール
# - schedule at ID DATE TIME * COMMAND: 日時指定スケジュール（月/日形式）
# - schedule at ID DATE TIME pp N COMMAND: PP接続コンテキストスケジュール
# - schedule at ID +TIMER * COMMAND: タイマー形式スケジュール

command:
  name: schedule
  description: "スケジュール設定"

  applicable_models:
    - vRX
    - RTX5000
    - RTX3510
    - RTX3500
    - RTX1300
    - RTX1220
    - RTX1210
    - RTX840
    - RTX830

  syntax:
    # Reference: schedule at <id> [<date>] <time> * <command>
    set_time: "schedule at {id} {time} * {command}"
    set_startup: "schedule at {id} startup * {command}"
    set_datetime: "schedule at {id} {date} {time} * {command}"
    set_pp: "schedule at {id} {date} {time} pp {pp_num} {command}"
    set_tunnel: "schedule at {id} {date} {time} tunnel {tunnel_num} {command}"
    set_switch: "schedule at {id} {date} {time} switch {switch} {command}"
    set_timer: "schedule at {id} +{timer} * {command}"
    delete: "no schedule at {id}"

  terraform:
    resource_name: rtx_schedule
    struct_name: Schedule
    package: parsers

  parameters:
    id:
      description: "スケジュールID"
      required: true
      type: integer
      range: [1, 65535]
      boundaries: [1, 100, 1000, 65535]

    time:
      description: "実行時刻（HH:MM形式またはH:MM形式）"
      required: false
      type: string
      pattern: "\\d{1,2}:\\d{2}"

    date:
      description: "実行日（月/日形式、例: 1/1, */mon-fri, */*）"
      required: false
      type: string
      pattern: "(\\d{1,2}|\\*)/((\\d{1,2})|\\*|(mon|tue|wed|thu|fri|sat|sun)(-|,)?)+|\\d{4}/\\d{1,2}/\\d{1,2}"

    day_of_week:
      description: "曜日指定（mon, tue, wed, thu, fri, sat, sun、範囲形式 mon-fri、カンマ区切り sat,sun）"
      required: false
      type: string
      examples: ["mon", "tue", "mon-fri", "sat,sun", "mon,wed,fri"]

    pp_num:
      description: "PP番号"
      required: false
      type: integer
      range: [1, 150]

    timer:
      description: "タイマー秒数（+N形式で指定）"
      required: false
      type: integer
      range: [1, 3600]

    tunnel_num:
      description: "トンネル番号"
      required: false
      type: integer
      range: [1, 65535]

    switch:
      description: "スイッチ識別子（MACアドレスまたはパス）"
      required: false
      type: string
      examples: ["00:a0:de:01:02:03", "lan1:4"]

    command:
      description: "実行コマンド"
      required: true
      type: string

  syntax_tests:
    # =============================================================================
    # Time-based schedules (daily recurring)
    # Reference: schedule at <id> <time> * <command>
    # =============================================================================
    - name: schedule_at_time_noon
      rtx: "schedule at 1 8:00 * pp auth accept on"
      terraform:
        id: 1
        at_time: "8:00"
        recurring: true
        enabled: true
        commands: ["pp auth accept on"]

    - name: schedule_at_time_midnight
      rtx: "schedule at 2 0:00 * save"
      terraform:
        id: 2
        at_time: "0:00"
        recurring: true
        enabled: true
        commands: ["save"]

    - name: schedule_at_time_wildcard
      rtx: "schedule at 1 12:*:00 * lua script.lua"
      terraform:
        id: 1
        at_time: "12:*:00"
        recurring: true
        enabled: true
        commands: ["lua script.lua"]

    # =============================================================================
    # Startup schedules
    # Reference: schedule at <id> startup * <command>
    # =============================================================================
    - name: schedule_at_startup
      rtx: "schedule at 1 startup * console info on"
      terraform:
        id: 1
        on_startup: true
        recurring: false
        enabled: true
        commands: ["console info on"]

    - name: schedule_at_startup_connect
      rtx: "schedule at 2 startup * connect pp 1"
      terraform:
        id: 2
        on_startup: true
        recurring: false
        enabled: true
        commands: ["connect pp 1"]

    # =============================================================================
    # Date/time schedules
    # Reference: date format is month/day (e.g., 1/1, */mon-fri, */* for daily)
    # =============================================================================
    - name: schedule_at_datetime_new_year
      rtx: "schedule at 1 1/1 0:0 * ip route 192.168.0.0/24 gateway pp 2"
      terraform:
        id: 1
        date: "1/1"
        at_time: "0:0"
        recurring: true
        enabled: true
        commands: ["ip route 192.168.0.0/24 gateway pp 2"]

    - name: schedule_at_datetime_year_end
      rtx: "schedule at 2 2024/12/31 23:59 * restart"
      terraform:
        id: 2
        date: "2024/12/31"
        at_time: "23:59"
        recurring: false
        enabled: true
        commands: ["restart"]

    - name: schedule_at_weekday
      rtx: "schedule at 1 */mon-fri 8:00 * pp auth accept on"
      terraform:
        id: 1
        date: "*/mon-fri"
        at_time: "8:00"
        recurring: true
        enabled: true
        commands: ["pp auth accept on"]

    - name: schedule_at_weekend
      rtx: "schedule at 1 */sat,sun 9:00 * nat masquerade on"
      terraform:
        id: 1
        date: "*/sat,sun"
        at_time: "9:00"
        recurring: true
        enabled: true
        commands: ["nat masquerade on"]

    - name: schedule_at_daily
      rtx: "schedule at 1 */* 03:00 * restart"
      terraform:
        id: 1
        date: "*/*"
        at_time: "03:00"
        recurring: true
        enabled: true
        commands: ["restart"]

    # =============================================================================
    # PP context schedules
    # Reference: schedule at <id> [<date>] <time> pp <peer_num> <command>
    # =============================================================================
    - name: schedule_pp_weekday_connect
      rtx: "schedule at 1 */mon-fri 8:00 pp 1 isdn auto connect on"
      terraform:
        id: 1
        date: "*/mon-fri"
        at_time: "8:00"
        pp_num: 1
        recurring: true
        enabled: true
        commands: ["isdn auto connect on"]

    - name: schedule_pp_weekday_disconnect
      rtx: "schedule at 2 */mon-fri 17:00 pp 1 isdn auto connect off"
      terraform:
        id: 2
        date: "*/mon-fri"
        at_time: "17:00"
        pp_num: 1
        recurring: true
        enabled: true
        commands: ["isdn auto connect off"]

    - name: schedule_pp_hourly
      rtx: "schedule at 1 *:00 pp 1 isdn auto connect on"
      terraform:
        id: 1
        at_time: "*:00"
        pp_num: 1
        recurring: true
        enabled: true
        commands: ["isdn auto connect on"]

    # =============================================================================
    # Tunnel context schedules
    # Reference: schedule at <id> [<date>] <time> tunnel <tunnel_num> <command>
    # =============================================================================
    - name: schedule_tunnel_daily
      rtx: "schedule at 1 8:00 tunnel 1 ipsec sa delete 1"
      terraform:
        id: 1
        at_time: "8:00"
        tunnel_num: 1
        recurring: true
        enabled: true
        commands: ["ipsec sa delete 1"]

    # =============================================================================
    # Switch context schedules
    # Reference: schedule at <id> [<date>] <time> switch <switch> <command>
    # =============================================================================
    - name: schedule_switch_by_mac
      rtx: "schedule at 1 */* 03:00 switch 00:a0:de:01:02:03 switch control function execute restart"
      terraform:
        id: 1
        date: "*/*"
        at_time: "03:00"
        switch: "00:a0:de:01:02:03"
        recurring: true
        enabled: true
        commands: ["switch control function execute restart"]

    - name: schedule_switch_by_path
      rtx: "schedule at 2 */* 03:00 switch lan1:4 switch control function execute restart"
      terraform:
        id: 2
        date: "*/*"
        at_time: "03:00"
        switch: "lan1:4"
        recurring: true
        enabled: true
        commands: ["switch control function execute restart"]

    # =============================================================================
    # Timer schedules (+delay)
    # Reference: schedule at <id> +<timer> * <command>
    # =============================================================================
    - name: schedule_timer_restart
      rtx: "schedule at 1 +600 * restart"
      terraform:
        id: 1
        timer: 600
        recurring: false
        enabled: true
        commands: ["restart"]

    - name: schedule_timer_syslog
      rtx: "schedule at 2 +60 * syslog notice 'Timer expired'"
      terraform:
        id: 2
        timer: 60
        recurring: false
        enabled: true
        commands: ["syslog notice 'Timer expired'"]

    # =============================================================================
    # Delete schedules (build_only)
    # =============================================================================
    - name: delete_schedule_1
      rtx: "no schedule at 1"
      terraform:
        id: 1
      build_only: true

    - name: delete_schedule_100
      rtx: "no schedule at 100"
      terraform:
        id: 100
      build_only: true

    # =============================================================================
    # Multiline Configuration Parse Test
    # =============================================================================
    - name: multiple_schedules
      rtx: |
        schedule at 1 8:00 * pp auth accept on
        schedule at 2 startup * console info on
        schedule at 3 */mon-fri 17:00 pp 1 isdn auto connect off
        schedule at 4 +600 * restart
      terraform:
        - id: 1
          at_time: "8:00"
          recurring: true
          enabled: true
          commands: ["pp auth accept on"]
        - id: 2
          on_startup: true
          recurring: false
          enabled: true
          commands: ["console info on"]
        - id: 3
          date: "*/mon-fri"
          at_time: "17:00"
          pp_num: 1
          recurring: true
          enabled: true
          commands: ["isdn auto connect off"]
        - id: 4
          timer: 600
          recurring: false
          enabled: true
          commands: ["restart"]
      parse_only: true

  # =============================================================================
  # Boundary Value Tests
  # =============================================================================
  boundary_tests:
    id:
      - value: 1
        valid: true
        description: "最小値"
      - value: 100
        valid: true
        description: "一般的な値"
      - value: 1000
        valid: true
        description: "大きい値"
      - value: 65535
        valid: true
        description: "最大値"
      - value: 0
        valid: false
        error_contains: "must be between 1 and 65535"
      - value: 65536
        valid: false
        error_contains: "must be between 1 and 65535"
      - value: -1
        valid: false
        error_contains: "must be between 1 and 65535"

    hour:
      - value: 0
        valid: true
        description: "最小値（0時）"
      - value: 12
        valid: true
        description: "正午"
      - value: 23
        valid: true
        description: "最大値（23時）"
      - value: 24
        valid: false
        error_contains: "must be 0-23"
      - value: -1
        valid: false
        error_contains: "invalid"

    minute:
      - value: 0
        valid: true
        description: "最小値（0分）"
      - value: 30
        valid: true
        description: "中間値"
      - value: 59
        valid: true
        description: "最大値（59分）"
      - value: 60
        valid: false
        error_contains: "must be 0-59"

    timer:
      - value: 1
        valid: true
        description: "最小値"
      - value: 600
        valid: true
        description: "10分"
      - value: 3600
        valid: true
        description: "最大値（1時間）"
      - value: 0
        valid: false
        error_contains: "must be 1-3600"
      - value: 3601
        valid: false
        error_contains: "must be 1-3600"

    date:
      # Reference: 月/日 形式
      - value: "1/1"
        valid: true
        description: "1月1日"
      - value: "*/mon-fri"
        valid: true
        description: "毎月の月〜金"
      - value: "*/*"
        valid: true
        description: "毎日"
      - value: "*/sat,sun"
        valid: true
        description: "毎月の土日"
      - value: "12/31"
        valid: true
        description: "12月31日"
      - value: "2024/12/31"
        valid: true
        description: "完全日付形式（一度限り）"

    day_of_week:
      - value: "mon"
        valid: true
      - value: "tue"
        valid: true
      - value: "wed"
        valid: true
      - value: "thu"
        valid: true
      - value: "fri"
        valid: true
      - value: "sat"
        valid: true
      - value: "sun"
        valid: true
      - value: "mon-fri"
        valid: true
        description: "範囲形式"
      - value: "sat,sun"
        valid: true
        description: "カンマ区切り"
      - value: "mon,wed,fri"
        valid: true
        description: "複数カンマ区切り"
      - value: "invalid"
        valid: false
        error_contains: "invalid day"
      - value: "monday"
        valid: false
        error_contains: "invalid day"
