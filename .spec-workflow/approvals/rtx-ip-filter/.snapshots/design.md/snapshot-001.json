{
  "id": "snapshot_1768799798981_fvw9bvkkk",
  "approvalId": "approval_1768799798977_ubg934imh",
  "approvalTitle": "Design: rtx_ip_filter resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:38.981Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_ip_filter\n\n## Overview\n\nThe `rtx_ip_filter` resource enables Terraform-based management of IP packet filters (firewall rules) on Yamaha RTX series routers. Following Cisco IOS XE Terraform provider naming conventions, this resource manages extended access lists with support for protocol, source/destination addresses, ports, and logging.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with IP filter methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add IP filter methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **Interface binding**: Coordinate with interface security filter application\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_ip_filter.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        FilterService[ip_filter_service.go]\n    end\n\n    subgraph Parser Layer\n        FilterParser[ip_filter.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> FilterService\n    FilterService --> FilterParser\n    FilterParser --> Commands\n    FilterParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `IPFilterService` handles all filter CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all filter logic\n- **Utility Modularity**: Shared validation functions for IP/port operations\n\n## Components and Interfaces\n\n### Component 1: IPFilterService (`internal/client/ip_filter_service.go`)\n\n- **Purpose:** Handles all IP filter CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type IPFilterService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *IPFilterService) Create(ctx context.Context, filter IPFilter) error\n  func (s *IPFilterService) Get(ctx context.Context, filterNum int) (*IPFilter, error)\n  func (s *IPFilterService) Update(ctx context.Context, filter IPFilter) error\n  func (s *IPFilterService) Delete(ctx context.Context, filterNum int) error\n  func (s *IPFilterService) List(ctx context.Context) ([]IPFilter, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.IPFilterParser`\n- **Reuses:** Pattern from service layer implementations\n\n### Component 2: IPFilterParser (`internal/rtx/parsers/ip_filter.go`)\n\n- **Purpose:** Parses RTX router output for filter configuration and builds commands\n- **Interfaces:**\n  ```go\n  type IPFilter struct {\n      Number  int             `json:\"number\"`\n      Name    string          `json:\"name,omitempty\"`\n      Entries []IPFilterEntry `json:\"entries\"`\n  }\n\n  type IPFilterEntry struct {\n      Sequence           int    `json:\"sequence\"`\n      Remark             string `json:\"remark,omitempty\"`\n      Action             string `json:\"ace_rule_action\"`     // permit/deny (pass/reject)\n      Protocol           string `json:\"ace_rule_protocol\"`   // tcp/udp/icmp/ip\n      SourcePrefix       string `json:\"source_prefix,omitempty\"`\n      SourcePrefixMask   string `json:\"source_prefix_mask,omitempty\"`\n      SourceAny          bool   `json:\"source_any,omitempty\"`\n      SourcePort         string `json:\"source_port,omitempty\"`\n      DestPrefix         string `json:\"destination_prefix,omitempty\"`\n      DestPrefixMask     string `json:\"destination_prefix_mask,omitempty\"`\n      DestAny            bool   `json:\"destination_any,omitempty\"`\n      DestPort           string `json:\"destination_port_equal,omitempty\"`\n      Log                bool   `json:\"log\"`\n      Established        bool   `json:\"established,omitempty\"`\n  }\n\n  func ParseIPFilterConfig(raw string) ([]IPFilter, error)\n  func BuildIPFilterCommand(num int, entry IPFilterEntry) string\n  func BuildIPFilterDynamicCommand(num int, entry IPFilterEntry) string\n  func BuildIPFilterSetCommand(setNum int, filters []int) string\n  func BuildInterfaceSecureFilterCommand(iface, dir string, setNum int) string\n  func BuildDeleteIPFilterCommand(num int) string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_ip_filter.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXIPFilter() *schema.Resource\n  func resourceRTXIPFilterCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPFilterRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPFilterUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPFilterDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPFilterImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `IPFilter`, Terraform SDK\n- **Reuses:** Resource patterns from other implementations\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with IP filter methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetIPFilter(ctx context.Context, filterNum int) (*IPFilter, error)\n  CreateIPFilter(ctx context.Context, filter IPFilter) error\n  UpdateIPFilter(ctx context.Context, filter IPFilter) error\n  DeleteIPFilter(ctx context.Context, filterNum int) error\n  ListIPFilters(ctx context.Context) ([]IPFilter, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### IPFilter\n\n```go\n// IPFilter represents an IP filter (access list) on an RTX router\ntype IPFilter struct {\n    Number  int             `json:\"number\"`  // Filter number (1-65535)\n    Name    string          `json:\"name\"`    // Access list name (for Cisco compatibility)\n    Entries []IPFilterEntry `json:\"entries\"` // Filter entries\n}\n\n// IPFilterEntry represents a single filter rule\ntype IPFilterEntry struct {\n    Sequence         int    `json:\"sequence\"`                     // Entry sequence number\n    Remark           string `json:\"remark,omitempty\"`             // Comment\n    Action           string `json:\"ace_rule_action\"`              // permit/deny\n    Protocol         string `json:\"ace_rule_protocol\"`            // tcp/udp/icmp/ip\n    SourcePrefix     string `json:\"source_prefix,omitempty\"`      // Source IP\n    SourcePrefixMask string `json:\"source_prefix_mask,omitempty\"` // Source wildcard\n    SourceAny        bool   `json:\"source_any,omitempty\"`         // Any source\n    SourcePort       string `json:\"source_port,omitempty\"`        // Source port\n    DestPrefix       string `json:\"destination_prefix,omitempty\"`\n    DestPrefixMask   string `json:\"destination_prefix_mask,omitempty\"`\n    DestAny          bool   `json:\"destination_any,omitempty\"`\n    DestPort         string `json:\"destination_port_equal,omitempty\"`\n    Log              bool   `json:\"log\"`                          // Enable logging\n    Established      bool   `json:\"established,omitempty\"`        // TCP established\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_access_list_extended\" \"web_access\" {\n  name = \"WEB_ACCESS\"\n\n  entries = [\n    {\n      sequence                 = 10\n      remark                   = \"Allow HTTP/HTTPS to internal servers\"\n      ace_rule_action          = \"permit\"\n      ace_rule_protocol        = \"tcp\"\n      source_prefix            = \"0.0.0.0\"\n      source_prefix_mask       = \"255.255.255.255\"\n      destination_prefix       = \"192.168.1.0\"\n      destination_prefix_mask  = \"0.0.0.255\"\n      destination_port_equal   = \"80\"\n      log                      = true\n    },\n    {\n      sequence                 = 20\n      ace_rule_action          = \"permit\"\n      ace_rule_protocol        = \"tcp\"\n      source_prefix            = \"0.0.0.0\"\n      source_prefix_mask       = \"255.255.255.255\"\n      destination_prefix       = \"192.168.1.0\"\n      destination_prefix_mask  = \"0.0.0.255\"\n      destination_port_equal   = \"443\"\n    },\n    {\n      sequence          = 999\n      remark            = \"Deny all other traffic\"\n      ace_rule_action   = \"deny\"\n      ace_rule_protocol = \"ip\"\n      source_any        = true\n      destination_any   = true\n    }\n  ]\n}\n\n# Apply access list to interface\nresource \"rtx_interface_acl\" \"wan\" {\n  interface          = \"pp1\"\n  ip_access_group_in = \"WEB_ACCESS\"\n}\n```\n\n## RTX Command Mapping\n\n### Create IP Filter\n\n```\nip filter <n> <action> <src> <dst> <protocol> [<src_port>] [<dst_port>]\n```\n\nExample: `ip filter 100 pass 0.0.0.0/0 192.168.1.0/24 tcp * 80`\n\n### Create Dynamic Filter (Stateful)\n\n```\nip filter dynamic <n> <src> <dst> <protocol> [<options>]\n```\n\n### Create Filter Set\n\n```\nip filter set <set_n> <filter_list>\n```\n\nExample: `ip filter set 1 100 101 102`\n\n### Apply to Interface\n\n```\nip <interface> secure filter <direction> <set>\n```\n\nExample: `ip pp1 secure filter in 1`\n\n### Delete Filter\n\n```\nno ip filter <n>\n```\n\n### Show Configuration\n\n```\nshow config | grep \"ip filter\"\nshow ip filter\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Filter Number**\n   - **Handling:** Validate number is in range 1-65535\n   - **User Impact:** Clear validation error with valid range\n\n2. **Filter Already Exists**\n   - **Handling:** Parse RTX output for existing filter\n   - **User Impact:** Error suggesting import\n\n3. **Invalid IP Address**\n   - **Handling:** Validate IP address format\n   - **User Impact:** Clear error with expected format\n\n4. **Invalid Port**\n   - **Handling:** Validate port is in range 1-65535 or service name\n   - **User Impact:** Clear error with valid range\n\n5. **Invalid Protocol**\n   - **Handling:** Validate protocol name\n   - **User Impact:** Error with valid protocols\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`ip_filter_test.go`):\n  - Parse various RTX `show config` output for filters\n  - Test command builder functions with different parameters\n  - Test protocol and port validation\n\n- **Service Tests** (`ip_filter_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test entry ordering\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_ip_filter_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Multi-entry configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create filter with various protocols\n  - Create filter with port ranges\n  - Update filter entries\n  - Delete filter\n  - Import existing filter\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_ip_filter.go      # NEW: Terraform resource\n│   └── resource_rtx_ip_filter_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                   # MODIFY: Add IPFilter types and methods\n│   ├── client.go                       # MODIFY: Add filter service initialization\n│   ├── ip_filter_service.go           # NEW: Filter service implementation\n│   └── ip_filter_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── ip_filter.go               # NEW: Parser and command builders\n        └── ip_filter_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Action Mapping**: Map Cisco `permit/deny` to RTX `pass/reject`.\n\n2. **Wildcard Mask**: Cisco uses wildcard masks (0.0.0.255). RTX may use CIDR or similar.\n\n3. **Terraform ID**: Use filter number as Terraform resource ID.\n\n4. **Sequence Numbers**: Auto-generate or require explicit sequence numbers.\n\n5. **Order Sensitivity**: Filters are evaluated in order. First match wins.\n\n6. **Filter Sets**: Consider as separate resource or part of interface ACL binding.\n\n7. **Dynamic Filters**: Stateful filtering may need separate resource or attribute.\n\n8. **Interface ACL**: Consider separate resource `rtx_interface_acl` for binding.\n\n9. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n10. **Provider Registration**: Add `resourceRTXIPFilter` to provider's resource map.\n",
  "fileStats": {
    "size": 12617,
    "lines": 364,
    "lastModified": "2026-01-19T05:12:08.063Z"
  },
  "comments": []
}