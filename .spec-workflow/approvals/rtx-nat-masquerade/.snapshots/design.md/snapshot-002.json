{
  "id": "snapshot_1768800195868_iom80t87j",
  "approvalId": "approval_1768799794022_h3iaumzqm",
  "approvalTitle": "Design: rtx_nat_masquerade resource",
  "version": 2,
  "timestamp": "2026-01-19T05:23:15.868Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: rtx_nat_masquerade\n\n## Overview\n\nThe `rtx_nat_masquerade` resource enables Terraform-based management of NAT masquerade (dynamic NAPT/PAT) on Yamaha RTX series routers. This resource manages NAT descriptors configured for many-to-one address translation, following Cisco IOS XE Terraform provider naming conventions where applicable.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with NAT descriptor methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add NAT masquerade methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **Interface binding**: Coordinate with interface configuration\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_nat_masquerade.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        NATService[nat_masquerade_service.go]\n    end\n\n    subgraph Parser Layer\n        NATParser[nat_masquerade.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> NATService\n    NATService --> NATParser\n    NATParser --> Commands\n    NATParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `NATMasqueradeService` handles all NAT masquerade CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all NAT masquerade logic\n- **Utility Modularity**: Shared validation functions for IP/network operations\n\n## Components and Interfaces\n\n### Component 1: NATMasqueradeService (`internal/client/nat_masquerade_service.go`)\n\n- **Purpose:** Handles all NAT masquerade CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type NATMasqueradeService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *NATMasqueradeService) Create(ctx context.Context, nat NATMasquerade) error\n  func (s *NATMasqueradeService) Get(ctx context.Context, descriptorID int) (*NATMasquerade, error)\n  func (s *NATMasqueradeService) Update(ctx context.Context, nat NATMasquerade) error\n  func (s *NATMasqueradeService) Delete(ctx context.Context, descriptorID int) error\n  func (s *NATMasqueradeService) List(ctx context.Context) ([]NATMasquerade, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.NATMasqueradeParser`\n- **Reuses:** Pattern from `DHCPScopeService`, `Executor` interface\n\n### Component 2: NATMasqueradeParser (`internal/rtx/parsers/nat_masquerade.go`)\n\n- **Purpose:** Parses RTX router output for NAT descriptor configuration and builds commands\n- **Interfaces:**\n  ```go\n  type NATMasquerade struct {\n      DescriptorID   int            `json:\"descriptor_id\"`\n      OuterAddress   string         `json:\"outer_address\"`    // Interface name or IP\n      InnerNetwork   string         `json:\"inner_network\"`    // CIDR notation\n      Interface      string         `json:\"interface\"`        // Bound interface\n      StaticEntries  []StaticEntry  `json:\"static_entries,omitempty\"`\n  }\n\n  type StaticEntry struct {\n      InsideLocal      string `json:\"inside_local\"`\n      InsideLocalPort  int    `json:\"inside_local_port,omitempty\"`\n      OutsideGlobal    string `json:\"outside_global\"`\n      OutsideGlobalPort int   `json:\"outside_global_port,omitempty\"`\n      Protocol         string `json:\"protocol,omitempty\"` // tcp/udp\n  }\n\n  func ParseNATDescriptorConfig(raw string) ([]NATMasquerade, error)\n  func BuildNATDescriptorTypeCommand(id int) string\n  func BuildNATDescriptorAddressOuterCommand(id int, address string) string\n  func BuildNATDescriptorAddressInnerCommand(id int, network string) string\n  func BuildNATDescriptorStaticCommand(id int, entry StaticEntry) string\n  func BuildInterfaceNATCommand(iface string, id int) string\n  func BuildDeleteNATDescriptorCommand(id int) string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_nat_masquerade.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXNATMasquerade() *schema.Resource\n  func resourceRTXNATMasqueradeCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXNATMasqueradeRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXNATMasqueradeUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXNATMasqueradeDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXNATMasqueradeImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `NATMasquerade`, Terraform SDK\n- **Reuses:** `resourceRTXDHCPScope` patterns\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with NAT masquerade methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetNATMasquerade(ctx context.Context, descriptorID int) (*NATMasquerade, error)\n  CreateNATMasquerade(ctx context.Context, nat NATMasquerade) error\n  UpdateNATMasquerade(ctx context.Context, nat NATMasquerade) error\n  DeleteNATMasquerade(ctx context.Context, descriptorID int) error\n  ListNATMasquerades(ctx context.Context) ([]NATMasquerade, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### NATMasquerade\n\n```go\n// NATMasquerade represents a NAT masquerade descriptor on an RTX router\ntype NATMasquerade struct {\n    DescriptorID  int           `json:\"descriptor_id\"`    // NAT descriptor ID (1-65535)\n    OuterAddress  string        `json:\"outer_address\"`    // Outer IP or interface (e.g., \"ipcp\", \"pp1\")\n    InnerNetwork  string        `json:\"inner_network\"`    // Inner network CIDR\n    Interface     string        `json:\"interface\"`        // Interface to apply NAT\n    StaticEntries []StaticEntry `json:\"static_entries,omitempty\"` // Port forwarding entries\n}\n\n// StaticEntry represents a static port mapping in NAT masquerade\ntype StaticEntry struct {\n    InsideLocal       string `json:\"inside_local\"`         // Inside local IP\n    InsideLocalPort   int    `json:\"inside_local_port,omitempty\"`\n    OutsideGlobal     string `json:\"outside_global\"`       // Outside global IP\n    OutsideGlobalPort int    `json:\"outside_global_port,omitempty\"`\n    Protocol          string `json:\"protocol,omitempty\"`   // tcp/udp\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_nat_masquerade\" \"main\" {\n  id = 1  # Descriptor ID, Required, ForceNew\n\n  inside_source {\n    acl       = \"192.168.1.0/24\"  # Inner network\n    interface = \"pp1\"             # Outside interface\n    overload  = true              # Always true for masquerade\n  }\n\n  # Optional: static port mappings\n  static_entries = [\n    {\n      inside_local        = \"192.168.1.10\"\n      inside_local_port   = 80\n      outside_global      = \"ipcp\"  # Use PPPoE assigned IP\n      outside_global_port = 8080\n      protocol            = \"tcp\"\n    }\n  ]\n}\n```\n\n## RTX Command Mapping\n\n### Create NAT Descriptor\n\n```\nnat descriptor type <id> masquerade\nnat descriptor address outer <id> <interface/ip>\nnat descriptor address inner <id> <network>\n```\n\nExample:\n```\nnat descriptor type 1 masquerade\nnat descriptor address outer 1 ipcp\nnat descriptor address inner 1 192.168.1.0-192.168.1.255\n```\n\n### Configure Static Mapping\n\n```\nnat descriptor masquerade static <id> <n> <outer_ip>:<port>=<inner_ip>:<port> [<protocol>]\n```\n\nExample: `nat descriptor masquerade static 1 1 ipcp:8080=192.168.1.10:80 tcp`\n\n### Apply to Interface\n\n```\nip <interface> nat descriptor <id>\n```\n\nExample: `ip pp1 nat descriptor 1`\n\n### Delete NAT Descriptor\n\n```\nno nat descriptor type <id>\n```\n\n### Show NAT Configuration\n\n```\nshow nat descriptor address\nshow config | grep \"nat descriptor\"\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Descriptor ID**\n   - **Handling:** Validate ID is in range 1-65535\n   - **User Impact:** Clear validation error with valid range\n\n2. **Descriptor Already Exists**\n   - **Handling:** Parse RTX output for existing descriptor\n   - **User Impact:** Error suggesting import or different ID\n\n3. **Invalid Network Format**\n   - **Handling:** Validate CIDR notation for inner network\n   - **User Impact:** Clear error with expected format\n\n4. **Invalid Interface**\n   - **Handling:** Validate interface name exists\n   - **User Impact:** Error indicating invalid interface\n\n5. **Port Conflict**\n   - **Handling:** Check for port conflicts in static mappings\n   - **User Impact:** Error indicating conflicting port\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`nat_masquerade_test.go`):\n  - Parse various RTX `show nat descriptor` output formats\n  - Test command builder functions with different parameters\n  - Test static entry parsing\n\n- **Service Tests** (`nat_masquerade_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test static mapping handling\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_nat_masquerade_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Static mapping configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create basic NAT masquerade\n  - Create NAT with static port mappings\n  - Update static mappings\n  - Delete NAT descriptor\n  - Import existing NAT configuration\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_nat_masquerade.go      # NEW: Terraform resource\n│   └── resource_rtx_nat_masquerade_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                        # MODIFY: Add NATMasquerade type and methods\n│   ├── client.go                            # MODIFY: Add NAT service initialization\n│   ├── nat_masquerade_service.go           # NEW: NAT service implementation\n│   └── nat_masquerade_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── nat_masquerade.go               # NEW: Parser and command builders\n        └── nat_masquerade_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Descriptor Type**: RTX NAT descriptors support multiple types (masquerade, nat, twice-nat). This resource specifically handles `masquerade` type.\n\n2. **Outer Address**: Can be specific IP, interface name (e.g., \"pp1\"), or special keywords like \"ipcp\" for PPPoE.\n\n3. **Inner Network Format**: RTX uses range notation (192.168.1.0-192.168.1.255). Convert from CIDR in Terraform.\n\n4. **Terraform ID**: Use descriptor ID directly as Terraform resource ID.\n\n5. **ForceNew**: `descriptor_id` is ForceNew. Other attributes support in-place updates.\n\n6. **Static Entries**: Each static entry requires a sequence number. Auto-generate or require explicit specification.\n\n7. **Interface Binding**: The interface binding is a separate command. Consider as part of this resource or separate resource.\n\n8. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n9. **Provider Registration**: Add `resourceRTXNATMasquerade` to provider's resource map.\n",
  "fileStats": {
    "size": 11742,
    "lines": 328,
    "lastModified": "2026-01-19T05:08:40.692Z"
  },
  "comments": []
}