{
  "id": "snapshot_1768915858147_y0wqv0m78",
  "approvalId": "approval_1768915858138_fdw6swegd",
  "approvalTitle": "Design: Parser Pattern Catalogs",
  "version": 1,
  "timestamp": "2026-01-20T13:30:58.147Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Parser Pattern Catalogs\n\n## Overview\n\nThis feature creates YAML pattern catalogs for 7 parsers that currently lack explicit documentation, and adds test coverage for the IPsec transport mode parser. The catalogs follow the established schema and enable automated test generation.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Follow existing `schema.yaml` structure for all catalogs\n- Maintain consistency with existing catalogs (dns.yaml, vlan.yaml, etc.)\n- Include RTX documentation references\n\n### Project Structure (structure.md)\n- Pattern catalogs in `internal/rtx/testdata/patterns/*.yaml`\n- Test file in `internal/rtx/parsers/ipsec_transport_test.go`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **schema.yaml**: Base schema for all pattern catalogs\n- **Existing catalogs**: Reference structure from dns.yaml, vlan.yaml\n- **ipsec_tunnel_test.go**: Pattern for IPsec transport tests\n\n### Integration Points\n- **Parser registry**: Catalogs reference existing parser file names\n- **Test framework**: Enable YAML-driven test generation\n\n## Architecture\n\n```mermaid\ngraph TD\n    A[RTX Documentation] --> B[Pattern Extraction]\n    B --> C[YAML Catalog]\n    C --> D[Schema Validation]\n    D --> E[Test Generation]\n    E --> F[Parser Tests]\n```\n\n## Components and Interfaces\n\n### Component 1: ip_filter.yaml\n- **Purpose:** Document IP filter command patterns\n- **File:** `internal/rtx/testdata/patterns/ip_filter.yaml`\n- **Commands Covered:**\n  - `ip filter <n> <action> <src> <dst> <proto> [opts]`\n  - `ip filter set <interface> <filter-list>`\n  - `ip filter dynamic <n> <src> <dst> <proto> <trigger>`\n- **Reuses:** Schema from schema.yaml\n\n### Component 2: ethernet_filter.yaml\n- **Purpose:** Document Ethernet/MAC filter patterns\n- **File:** `internal/rtx/testdata/patterns/ethernet_filter.yaml`\n- **Commands Covered:**\n  - `ethernet filter <n> <action> <src-mac> <dst-mac>`\n  - `ethernet filter <n> vlan <vid>`\n  - `ethernet filter <n> ether-type <type>`\n- **Reuses:** Schema from schema.yaml\n\n### Component 3: bridge.yaml\n- **Purpose:** Document bridge interface patterns\n- **File:** `internal/rtx/testdata/patterns/bridge.yaml`\n- **Commands Covered:**\n  - `bridge member <bridge> <interface-list>`\n  - `bridge group <n> <interface-list>`\n  - `ip bridge address <bridge> <ip>/<mask>`\n- **Reuses:** Schema from schema.yaml\n\n### Component 4: service.yaml\n- **Purpose:** Document HTTPD/SSHD/SFTPD patterns\n- **File:** `internal/rtx/testdata/patterns/service.yaml`\n- **Commands Covered:**\n  - `httpd host <host-list>`\n  - `httpd listen <port>`\n  - `sshd host <host-list>`\n  - `sshd host key generate`\n  - `sftpd host <host-list>`\n- **Reuses:** Schema from schema.yaml\n\n### Component 5: system.yaml\n- **Purpose:** Document system configuration patterns\n- **File:** `internal/rtx/testdata/patterns/system.yaml`\n- **Commands Covered:**\n  - `timezone <offset>`\n  - `console character <encoding>`\n  - `console speed <baud>`\n  - `statistics <type> on/off`\n- **Reuses:** Schema from schema.yaml\n\n### Component 6: ipv6_interface.yaml\n- **Purpose:** Document IPv6 interface patterns\n- **File:** `internal/rtx/testdata/patterns/ipv6_interface.yaml`\n- **Commands Covered:**\n  - `ipv6 <interface> address <addr>/<prefix>`\n  - `ipv6 <interface> rtadv send <prefix> <opts>`\n  - `ipv6 <interface> dhcp service client`\n  - `ipv6 <interface> mtu <size>`\n- **Reuses:** Schema from schema.yaml\n\n### Component 7: ipv6_prefix.yaml\n- **Purpose:** Document IPv6 prefix patterns\n- **File:** `internal/rtx/testdata/patterns/ipv6_prefix.yaml`\n- **Commands Covered:**\n  - `ipv6 prefix <n> <prefix>/<len>`\n  - `ipv6 prefix <n> ra-prefix <interface>`\n  - `ipv6 prefix <n> dhcp-prefix <interface>`\n- **Reuses:** Schema from schema.yaml\n\n### Component 8: ipsec_transport_test.go\n- **Purpose:** Add test coverage for IPsec transport parser\n- **File:** `internal/rtx/parsers/ipsec_transport_test.go`\n- **Test Functions:**\n  - `TestParseIPsecTransportConfig`\n  - `TestParseIPsecTransportSA`\n  - `TestBuildIPsecTransportCommands`\n- **Reuses:** Patterns from ipsec_tunnel_test.go\n\n## Data Models\n\n### Pattern Catalog Schema\n```yaml\nmetadata:\n  name: string           # Catalog name\n  parser: string         # Parser file reference\n  chapter: string        # RTX doc chapter\n  last_updated: date\n\npatterns:\n  - name: string         # Pattern identifier\n    command: string      # Base command\n    format: string       # Full format with placeholders\n    parameters:\n      - name: string\n        type: enum       # int, string, ipv4, ipv6, mac, enum, bool\n        range: string    # For numeric types\n        values: []       # For enum types\n        default: any     # Default value\n        required: bool\n    examples:\n      - input: string\n        description: string\n        expected: object\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Invalid YAML syntax:**\n   - **Handling:** Schema validation fails with line number\n   - **User Impact:** Clear error message pointing to syntax issue\n\n2. **Missing required fields:**\n   - **Handling:** Schema validator reports missing fields\n   - **User Impact:** List of missing required fields\n\n## Testing Strategy\n\n### Unit Testing\n- Each catalog validated against schema.yaml\n- Test generation from catalog examples\n- Parser round-trip tests (parse → build → parse)\n\n### Validation Checklist\n| Catalog | Commands | Examples | Schema Valid |\n|---------|----------|----------|--------------|\n| ip_filter.yaml | 3+ | 6+ | ✓ |\n| ethernet_filter.yaml | 3+ | 4+ | ✓ |\n| bridge.yaml | 3+ | 4+ | ✓ |\n| service.yaml | 5+ | 6+ | ✓ |\n| system.yaml | 4+ | 5+ | ✓ |\n| ipv6_interface.yaml | 4+ | 6+ | ✓ |\n| ipv6_prefix.yaml | 3+ | 4+ | ✓ |\n",
  "fileStats": {
    "size": 5715,
    "lines": 173,
    "lastModified": "2026-01-20T13:30:48.376Z"
  },
  "comments": []
}