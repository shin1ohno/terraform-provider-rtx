{
  "id": "snapshot_1768799793121_fnosej03z",
  "approvalId": "approval_1768799793116_onizm77cc",
  "approvalTitle": "Design: rtx_static_route resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:33.121Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_static_route\n\n## Overview\n\nThe `rtx_static_route` resource enables Terraform-based management of static IP routes on Yamaha RTX series routers. Following Cisco IOS XE Terraform provider naming conventions, this resource uses `prefix/mask` notation with `next_hops` list supporting multi-path routing. The implementation follows established patterns from the existing `rtx_dhcp_scope` resource.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with static route methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add static route methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **IP validation utilities**: Reuse for prefix/mask validation\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_static_route.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        RouteService[static_route_service.go]\n    end\n\n    subgraph Parser Layer\n        RouteParser[static_route.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> RouteService\n    RouteService --> RouteParser\n    RouteParser --> Commands\n    RouteParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `StaticRouteService` handles all routing CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all route logic\n- **Utility Modularity**: Shared validation functions for IP/prefix operations\n\n## Components and Interfaces\n\n### Component 1: StaticRouteService (`internal/client/static_route_service.go`)\n\n- **Purpose:** Handles all static route CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type StaticRouteService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *StaticRouteService) CreateRoute(ctx context.Context, route StaticRoute) error\n  func (s *StaticRouteService) GetRoute(ctx context.Context, network string) (*StaticRoute, error)\n  func (s *StaticRouteService) UpdateRoute(ctx context.Context, route StaticRoute) error\n  func (s *StaticRouteService) DeleteRoute(ctx context.Context, network string) error\n  func (s *StaticRouteService) ListRoutes(ctx context.Context) ([]StaticRoute, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.StaticRouteParser`\n- **Reuses:** Pattern from `DHCPScopeService`, `Executor` interface\n\n### Component 2: StaticRouteParser (`internal/rtx/parsers/static_route.go`)\n\n- **Purpose:** Parses RTX router output for route configuration and builds commands\n- **Interfaces:**\n  ```go\n  type StaticRoute struct {\n      Prefix    string     `json:\"prefix\"`\n      Mask      string     `json:\"mask\"`\n      NextHops  []NextHop  `json:\"next_hops\"`\n  }\n\n  type NextHop struct {\n      NextHop   string `json:\"next_hop,omitempty\"`\n      Interface string `json:\"interface,omitempty\"`\n      Distance  int    `json:\"distance\"`\n      Name      string `json:\"name,omitempty\"`\n      Permanent bool   `json:\"permanent\"`\n      Filter    int    `json:\"filter,omitempty\"`\n  }\n\n  func ParseRouteConfig(raw string) ([]StaticRoute, error)\n  func BuildIPRouteCommand(route StaticRoute, hop NextHop) string\n  func BuildDeleteIPRouteCommand(prefix, mask string) string\n  func BuildShowIPRouteCommand() string\n  ```\n- **Dependencies:** `regexp`, `strings`, `net`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_static_route.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXStaticRoute() *schema.Resource\n  func resourceRTXStaticRouteCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXStaticRouteRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXStaticRouteUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXStaticRouteDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXStaticRouteImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `StaticRoute`, Terraform SDK\n- **Reuses:** `resourceRTXDHCPScope` patterns\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with static route methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetStaticRoute(ctx context.Context, network string) (*StaticRoute, error)\n  CreateStaticRoute(ctx context.Context, route StaticRoute) error\n  UpdateStaticRoute(ctx context.Context, route StaticRoute) error\n  DeleteStaticRoute(ctx context.Context, network string) error\n  ListStaticRoutes(ctx context.Context) ([]StaticRoute, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### StaticRoute\n\n```go\n// StaticRoute represents a static route configuration on an RTX router\ntype StaticRoute struct {\n    Prefix   string    `json:\"prefix\"`           // Route destination (e.g., \"0.0.0.0\" for default)\n    Mask     string    `json:\"mask\"`             // Subnet mask (e.g., \"0.0.0.0\" for default)\n    NextHops []NextHop `json:\"next_hops\"`        // List of next hops\n}\n\n// NextHop represents a next hop configuration for a static route\ntype NextHop struct {\n    NextHop   string `json:\"next_hop,omitempty\"`   // Gateway IP address\n    Interface string `json:\"interface,omitempty\"`  // Interface (pp 1, tunnel 1, etc.)\n    Distance  int    `json:\"distance\"`             // Administrative distance (weight)\n    Name      string `json:\"name,omitempty\"`       // Route description\n    Permanent bool   `json:\"permanent\"`            // Keep route when interface down\n    Filter    int    `json:\"filter,omitempty\"`     // IP filter number (RTX-specific)\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_static_route\" \"example\" {\n  prefix = \"0.0.0.0\"       # Required, ForceNew\n  mask   = \"0.0.0.0\"       # Required, ForceNew\n\n  next_hops = [\n    {\n      next_hop  = \"192.168.0.1\"\n      distance  = 1\n      name      = \"primary_gateway\"\n      permanent = true\n    },\n    {\n      next_hop  = \"192.168.0.2\"\n      distance  = 10\n      name      = \"backup_gateway\"\n    }\n  ]\n}\n\n# Tunnel interface route\nresource \"rtx_static_route\" \"vpn\" {\n  prefix = \"172.16.0.0\"\n  mask   = \"255.255.0.0\"\n\n  next_hops = [\n    {\n      interface = \"tunnel 1\"\n      distance  = 1\n      permanent = true\n    }\n  ]\n}\n```\n\n## RTX Command Mapping\n\n### Create Route\n\n```\nip route <network> gateway <gateway> [weight <n>] [hide] [filter <n>]\nip route <network> gateway pp <n> [weight <n>] [hide]\nip route <network> gateway tunnel <n> [weight <n>] [hide]\nip route <network> gateway dhcp <interface>\n```\n\nExample: `ip route default gateway 192.168.0.1`\nExample: `ip route 10.0.0.0/8 gateway 192.168.1.1 weight 10`\n\n### Delete Route\n\n```\nno ip route <network> [gateway <gateway>]\n```\n\n### Show Route\n\n```\nshow ip route\nshow config | grep \"ip route\"\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Network Format**\n   - **Handling:** Validate IP address and mask in Terraform schema\n   - **User Impact:** Clear validation error with expected format example\n\n2. **Route Already Exists**\n   - **Handling:** Parse RTX output for \"already exists\" pattern\n   - **User Impact:** Return error suggesting import or different prefix\n\n3. **Invalid Gateway**\n   - **Handling:** Validate gateway is reachable or interface exists\n   - **User Impact:** Error indicating invalid next hop\n\n4. **Invalid Interface**\n   - **Handling:** Validate interface name format (pp, tunnel, lan, etc.)\n   - **User Impact:** Clear error about valid interface names\n\n5. **Weight Out of Range**\n   - **Handling:** Validate weight is within valid range (typically 1-100)\n   - **User Impact:** Validation error with valid range\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`static_route_test.go`):\n  - Parse various RTX `show ip route` output formats\n  - Test command builder functions with different parameters\n  - Test network/mask validation functions\n\n- **Service Tests** (`static_route_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test multi-hop route handling\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_static_route_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Multi-hop configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create default route\n  - Create network route with multiple next hops\n  - Create tunnel/PP interface routes\n  - Update route weights\n  - Delete routes\n  - Import existing routes\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_static_route.go      # NEW: Terraform resource\n│   └── resource_rtx_static_route_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                      # MODIFY: Add StaticRoute type and methods\n│   ├── client.go                          # MODIFY: Add route service initialization\n│   ├── static_route_service.go           # NEW: Route service implementation\n│   └── static_route_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── static_route.go               # NEW: Parser and command builders\n        └── static_route_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Network Notation**: RTX uses `ip route <network>/<prefix>` or `ip route <network>` with separate mask. Convert from Terraform's `prefix`/`mask` format.\n\n2. **Default Route**: Handle special case where prefix=0.0.0.0 and mask=0.0.0.0 maps to `ip route default`.\n\n3. **Terraform ID**: Use `prefix/mask` as Terraform resource ID (e.g., \"0.0.0.0/0.0.0.0\" for default route).\n\n4. **ForceNew**: `prefix` and `mask` are ForceNew. Changes to `next_hops` support in-place updates.\n\n5. **Multi-hop Handling**: Each next_hop becomes a separate RTX command. Delete all then recreate on update.\n\n6. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n7. **Provider Registration**: Add `resourceRTXStaticRoute` to provider's resource map.\n",
  "fileStats": {
    "size": 10799,
    "lines": 313,
    "lastModified": "2026-01-19T05:08:40.477Z"
  },
  "comments": []
}