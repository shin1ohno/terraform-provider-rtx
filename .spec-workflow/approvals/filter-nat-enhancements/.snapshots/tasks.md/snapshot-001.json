{
  "id": "snapshot_1768919748980_7oq9wzsem",
  "approvalId": "approval_1768919748967_3zzc4ovaz",
  "approvalTitle": "Filter & NAT Enhancements - Tasks",
  "version": 1,
  "timestamp": "2026-01-20T14:35:48.980Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: Filter & NAT Enhancements\n\n## Phase 1: IP Filter Extensions (REQ-1, REQ-2)\n\n- [ ] 1. Extend IP filter action validation list\n  - File: internal/rtx/parsers/ip_filter.go\n  - Add `restrict-nolog` to `ValidIPFilterActions` slice\n  - Purpose: Enable restrict action without logging for IP filters\n  - _Leverage: Existing ValidIPFilterActions pattern_\n  - _Requirements: REQ-1_\n\n- [ ] 2. Extend IP filter protocol validation list\n  - File: internal/rtx/parsers/ip_filter.go\n  - Add `tcpfin`, `tcprst`, `tcpsyn`, `established` to `ValidIPFilterProtocols` slice\n  - Purpose: Enable TCP flag-based filtering protocols\n  - _Leverage: Existing ValidIPFilterProtocols pattern_\n  - _Requirements: REQ-2_\n\n- [ ] 3. Add parser tests for new actions and protocols\n  - File: internal/rtx/parsers/ip_filter_test.go\n  - Add test cases for `restrict-nolog` action parsing\n  - Add test cases for `tcpfin`, `tcprst`, `tcpsyn`, `established` protocol parsing\n  - Purpose: Ensure parser correctly handles new action and protocol values\n  - _Leverage: Existing test patterns in ip_filter_test.go_\n  - _Requirements: REQ-1, REQ-2_\n\n- [ ] 4. Update resource schema validation for rtx_access_list_ip\n  - File: internal/provider/resource_rtx_access_list_ip.go\n  - Update action enum validation to include `restrict-nolog`\n  - Update protocol enum validation to include TCP flag protocols\n  - Purpose: Allow Terraform users to specify new values in HCL\n  - _Leverage: Existing schema validation patterns_\n  - _Requirements: REQ-1, REQ-2_\n\n## Phase 2: Dynamic IP Filter Resource (REQ-3)\n\n- [ ] 5. Extend ValidDynamicProtocols list\n  - File: internal/rtx/parsers/ip_filter.go\n  - Add missing services: tftp, submission, https, imap, ldap, bgp, sip, ipsec-nat-t, etc.\n  - Purpose: Support all RTX dynamic filter protocols\n  - _Leverage: Existing ValidDynamicProtocols slice_\n  - _Requirements: REQ-3_\n\n- [ ] 6. Extend IPFilterDynamic struct for filter-reference form\n  - File: internal/rtx/parsers/ip_filter.go\n  - Add fields: FilterList, InFilterList, OutFilterList []int\n  - Add Timeout *int field for optional timeout parameter\n  - Purpose: Support both dynamic filter syntax forms\n  - _Leverage: Existing IPFilterDynamic struct_\n  - _Requirements: REQ-3_\n\n- [ ] 7. Create extended dynamic filter parser function\n  - File: internal/rtx/parsers/ip_filter.go\n  - Implement `ParseIPFilterDynamicConfigExtended()` to handle both forms\n  - Handle Form 1: `ip filter dynamic <id> <src> <dst> <protocol> [options]`\n  - Handle Form 2: `ip filter dynamic <id> <src> <dst> filter <list> [in <list>] [out <list>] [options]`\n  - Purpose: Parse all dynamic filter configurations from router output\n  - _Leverage: Existing ParseIPFilterDynamicConfig function_\n  - _Requirements: REQ-3_\n\n- [ ] 8. Create extended dynamic filter command builder\n  - File: internal/rtx/parsers/ip_filter.go\n  - Implement `BuildIPFilterDynamicCommandExtended()` for both forms\n  - Handle syslog=on/off and timeout=N options\n  - Purpose: Generate correct RTX commands for dynamic filters\n  - _Leverage: Existing BuildIPFilterDynamicCommand function_\n  - _Requirements: REQ-3_\n\n- [ ] 9. Add parser tests for extended dynamic filters\n  - File: internal/rtx/parsers/ip_filter_test.go\n  - Add test cases for Form 1 with various protocols\n  - Add test cases for Form 2 with filter/in/out lists\n  - Add test cases for syslog and timeout options\n  - Purpose: Verify parser handles all dynamic filter variations\n  - _Leverage: Existing dynamic filter test patterns_\n  - _Requirements: REQ-3_\n\n- [ ] 10. Create rtx_ip_filter_dynamic resource\n  - File: internal/provider/resource_rtx_ip_filter_dynamic.go\n  - Implement resourceRTXIPFilterDynamic() with schema definition\n  - Schema fields: number, source, destination, protocol (Form 1)\n  - Schema fields: filter_list, in_filter_list, out_filter_list (Form 2)\n  - Schema fields: syslog (bool), timeout (optional int)\n  - Purpose: New Terraform resource for dynamic IP filters\n  - _Leverage: resource_rtx_access_list_ip.go as template_\n  - _Requirements: REQ-3_\n\n- [ ] 11. Implement CRUD operations for rtx_ip_filter_dynamic\n  - File: internal/provider/resource_rtx_ip_filter_dynamic.go\n  - Implement Create, Read, Update, Delete functions\n  - Implement Import function for existing dynamic filters\n  - Purpose: Full lifecycle management of dynamic filters\n  - _Leverage: Existing resource CRUD patterns_\n  - _Requirements: REQ-3_\n\n- [ ] 12. Register rtx_ip_filter_dynamic in provider\n  - File: internal/provider/provider.go\n  - Add resource to ResourcesMap\n  - Purpose: Make resource available to Terraform users\n  - _Leverage: Existing resource registration pattern_\n  - _Requirements: REQ-3_\n\n- [ ] 13. Add acceptance tests for rtx_ip_filter_dynamic\n  - File: internal/provider/resource_rtx_ip_filter_dynamic_test.go\n  - Test Create/Read/Update/Delete lifecycle\n  - Test Import functionality\n  - Test both Form 1 and Form 2 configurations\n  - Purpose: Verify resource works correctly with real RTX router\n  - _Leverage: Existing acceptance test patterns_\n  - _Requirements: REQ-3_\n\n## Phase 3: NAT Protocol-Only Support (REQ-4)\n\n- [ ] 14. Modify MasqueradeStaticEntry struct for optional ports\n  - File: internal/rtx/parsers/nat_masquerade.go\n  - Change InsideLocalPort from int to *int (pointer for optional)\n  - Change OutsideGlobalPort from int to *int (pointer for optional)\n  - Purpose: Support protocol-only entries (ESP, AH, GRE) without ports\n  - _Leverage: Existing MasqueradeStaticEntry struct_\n  - _Requirements: REQ-4_\n\n- [ ] 15. Update NAT masquerade static command builder\n  - File: internal/rtx/parsers/nat_masquerade.go\n  - Modify BuildNATMasqueradeStaticCommand() to handle nil port values\n  - Generate `nat descriptor masquerade static <id> <num> <ip> <protocol>` when port is nil\n  - Generate full command with ports when port is provided\n  - Purpose: Build correct commands for protocol-only entries\n  - _Leverage: Existing command builder logic_\n  - _Requirements: REQ-4_\n\n- [ ] 16. Update NAT masquerade parser for protocol-only entries\n  - File: internal/rtx/parsers/nat_masquerade.go\n  - Modify ParseNATMasqueradeConfig() to handle entries without port\n  - Set port fields to nil when not present in config\n  - Purpose: Correctly parse existing protocol-only static entries\n  - _Leverage: Existing parser logic_\n  - _Requirements: REQ-4_\n\n- [ ] 17. Add parser tests for protocol-only NAT entries\n  - File: internal/rtx/parsers/nat_masquerade_test.go\n  - Test parsing `nat descriptor masquerade static 1000 1 192.168.1.253 esp`\n  - Test parsing entries with ah, gre, icmp protocols\n  - Test command building for protocol-only entries\n  - Purpose: Verify parser handles protocol-only entries correctly\n  - _Leverage: Existing NAT masquerade test patterns_\n  - _Requirements: REQ-4_\n\n- [ ] 18. Update rtx_nat_masquerade resource schema\n  - File: internal/provider/resource_rtx_nat_masquerade.go\n  - Make inside_local_port optional in static_entry block\n  - Make outside_global_port optional in static_entry block\n  - Add validation: port required for tcp/udp, not allowed for esp/ah/gre\n  - Purpose: Allow Terraform users to create protocol-only entries\n  - _Leverage: Existing static_entry schema_\n  - _Requirements: REQ-4_\n\n- [ ] 19. Update expandStaticEntries and flattenStaticEntries\n  - File: internal/provider/resource_rtx_nat_masquerade.go\n  - Handle nil port values in expansion and flattening\n  - Purpose: Correctly convert between Terraform state and Go structs\n  - _Leverage: Existing helper functions_\n  - _Requirements: REQ-4_\n\n- [ ] 20. Add acceptance tests for protocol-only NAT entries\n  - File: internal/provider/resource_rtx_nat_masquerade_test.go\n  - Test creating static entry with ESP protocol only\n  - Test import of existing protocol-only entries\n  - Purpose: Verify protocol-only entries work correctly\n  - _Leverage: Existing acceptance test patterns_\n  - _Requirements: REQ-4_\n\n## Phase 4: Ethernet Filter Resource (REQ-5)\n\n- [ ] 21. Create ethernet filter parser module\n  - File: internal/rtx/parsers/ethernet_filter.go\n  - Define EthernetFilter struct with fields: Number, Action, SourceMAC, DestinationMAC, DHCPType, DHCPScope, Offset, ByteList\n  - Define ValidEthernetFilterActions: pass-log, pass-nolog, reject-log, reject-nolog\n  - Purpose: Data structures for ethernet filter parsing\n  - _Leverage: ip_filter.go as template_\n  - _Requirements: REQ-5_\n\n- [ ] 22. Implement ethernet filter parser function\n  - File: internal/rtx/parsers/ethernet_filter.go\n  - Implement ParseEthernetFilterConfig() to parse `show config` output\n  - Handle MAC-based filters: `ethernet filter <id> <action> <src_mac> [<dst_mac>]`\n  - Handle DHCP-based filters: `ethernet filter <id> <action> dhcp-bind|dhcp-not-bind [scope]`\n  - Handle optional offset and byte_list parameters\n  - Purpose: Parse existing ethernet filter configurations\n  - _Leverage: ParseIPFilterConfig pattern_\n  - _Requirements: REQ-5_\n\n- [ ] 23. Implement ethernet filter command builders\n  - File: internal/rtx/parsers/ethernet_filter.go\n  - Implement BuildEthernetFilterCommand() for MAC-based and DHCP-based filters\n  - Implement BuildDeleteEthernetFilterCommand() for filter removal\n  - Implement BuildEthernetInterfaceFilterCommand() for interface application\n  - Purpose: Generate correct RTX commands for ethernet filters\n  - _Leverage: Existing command builder patterns_\n  - _Requirements: REQ-5_\n\n- [ ] 24. Implement ethernet filter validators\n  - File: internal/rtx/parsers/ethernet_filter.go\n  - Implement ValidateMACAddress() with regex for xx:xx:xx:xx:xx:xx or * format\n  - Implement ValidateEthernetFilterNumber() for range 1-512\n  - Implement ValidateEthernetFilter() for complete filter validation\n  - Purpose: Ensure valid ethernet filter configurations\n  - _Leverage: Existing validation patterns_\n  - _Requirements: REQ-5_\n\n- [ ] 25. Add ethernet filter parser tests\n  - File: internal/rtx/parsers/ethernet_filter_test.go\n  - Test parsing MAC-based filters with various MAC formats\n  - Test parsing DHCP-based filters with and without scope\n  - Test command building for all filter types\n  - Test MAC address and filter number validation\n  - Purpose: Verify parser handles all ethernet filter variations\n  - _Leverage: ip_filter_test.go as template_\n  - _Requirements: REQ-5_\n\n- [ ] 26. Create rtx_ethernet_filter resource\n  - File: internal/provider/resource_rtx_ethernet_filter.go\n  - Implement resourceRTXEthernetFilter() with schema definition\n  - Schema fields for MAC-based: number, action, source_mac, destination_mac\n  - Schema fields for DHCP-based: dhcp_type, dhcp_scope\n  - Schema fields for advanced: offset, byte_list\n  - Add ConflictsWith between MAC and DHCP fields\n  - Purpose: New Terraform resource for ethernet filters\n  - _Leverage: resource_rtx_access_list_ip.go as template_\n  - _Requirements: REQ-5_\n\n- [ ] 27. Implement CRUD operations for rtx_ethernet_filter\n  - File: internal/provider/resource_rtx_ethernet_filter.go\n  - Implement Create, Read, Update, Delete functions\n  - Implement Import function for existing ethernet filters\n  - Purpose: Full lifecycle management of ethernet filters\n  - _Leverage: Existing resource CRUD patterns_\n  - _Requirements: REQ-5_\n\n- [ ] 28. Register rtx_ethernet_filter in provider\n  - File: internal/provider/provider.go\n  - Add resource to ResourcesMap\n  - Purpose: Make resource available to Terraform users\n  - _Leverage: Existing resource registration pattern_\n  - _Requirements: REQ-5_\n\n- [ ] 29. Add acceptance tests for rtx_ethernet_filter\n  - File: internal/provider/resource_rtx_ethernet_filter_test.go\n  - Test Create/Read/Update/Delete lifecycle for MAC-based filters\n  - Test DHCP-based filters\n  - Test Import functionality\n  - Purpose: Verify resource works correctly with real RTX router\n  - _Leverage: Existing acceptance test patterns_\n  - _Requirements: REQ-5_\n\n## Final Integration\n\n- [ ] 30. Update examples/import/main.tf with new resources\n  - File: examples/import/main.tf\n  - Add examples for rtx_ip_filter_dynamic resource\n  - Add examples for rtx_ethernet_filter resource\n  - Update existing IP filter examples with new protocols\n  - Purpose: Provide usage examples for new features\n  - _Leverage: Existing example patterns_\n  - _Requirements: All_\n\n- [ ] 31. Update import.sh with new resource imports\n  - File: examples/import/import.sh\n  - Add import commands for dynamic filters\n  - Add import commands for ethernet filters\n  - Purpose: Support importing new resource types\n  - _Leverage: Existing import script patterns_\n  - _Requirements: All_\n\n- [ ] 32. Run full test suite and fix any issues\n  - Run `go test ./...` to verify all tests pass\n  - Run acceptance tests with `TF_ACC=1`\n  - Fix any integration issues discovered\n  - Purpose: Ensure all components work together correctly\n  - _Leverage: Existing test infrastructure_\n  - _Requirements: All_\n",
  "fileStats": {
    "size": 12866,
    "lines": 281,
    "lastModified": "2026-01-20T14:35:42.865Z"
  },
  "comments": []
}