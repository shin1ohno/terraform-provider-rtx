{
  "id": "snapshot_1768919450530_89i7661we",
  "approvalId": "approval_1768919450523_fzxbkdq2s",
  "approvalTitle": "Filter & NAT Enhancements - Design Document",
  "version": 1,
  "timestamp": "2026-01-20T14:30:50.530Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Filter & NAT Enhancements\n\n## Overview\n\nThis design document outlines the implementation approach for extending the terraform-provider-rtx's filtering and NAT capabilities. The enhancements include:\n1. Adding `restrict-nolog` action and TCP flag protocols (tcpfin, tcprst, tcpsyn, established) to IP filters\n2. Creating a new `rtx_ip_filter_dynamic` resource for dynamic/stateful filters\n3. Enabling protocol-only NAT masquerade static entries (ESP, AH, GRE)\n4. Creating a new `rtx_ethernet_filter` resource for Layer 2 MAC filtering\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Follow existing parser patterns in `internal/rtx/parsers/`\n- Use standard Terraform resource CRUD patterns\n- Implement comprehensive validation before SSH command execution\n- Support both create and import workflows\n\n### Project Structure (structure.md)\n- Parser modules: `internal/rtx/parsers/`\n- Resource files: `internal/provider/resource_rtx_*.go`\n- Test files alongside implementation with `_test.go` suffix\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/rtx/parsers/ip_filter.go`**:\n  - Extend `ValidIPFilterActions` to include `restrict-nolog`\n  - Extend `ValidIPFilterProtocols` to include `tcpfin`, `tcprst`, `tcpsyn`, `established`\n  - Extend `ValidDynamicProtocols` to include missing services\n  - Reuse `IPFilterDynamic` struct with enhancements\n\n- **`internal/rtx/parsers/nat_masquerade.go`**:\n  - Extend `MasqueradeStaticEntry` to support optional port fields\n  - Modify `BuildNATMasqueradeStaticCommand` to handle protocol-only entries\n\n- **`internal/provider/resource_rtx_access_list_ip.go`**:\n  - Use as template for new `rtx_ip_filter_dynamic` resource\n  - Reuse validation patterns and CRUD structure\n\n### Integration Points\n\n- **SSH Client (`internal/client/`)**: All commands execute via existing SSH infrastructure\n- **Working Session**: Reuse session management for atomic configuration changes\n\n## Architecture\n\n### Component Diagram\n\n```mermaid\ngraph TD\n    subgraph \"Terraform Resources\"\n        R1[rtx_access_list_ip<br/>Extended]\n        R2[rtx_ip_filter_dynamic<br/>New]\n        R3[rtx_nat_masquerade<br/>Extended]\n        R4[rtx_ethernet_filter<br/>New]\n    end\n\n    subgraph \"Parsers\"\n        P1[ip_filter.go<br/>Extended]\n        P2[nat_masquerade.go<br/>Extended]\n        P3[ethernet_filter.go<br/>New]\n    end\n\n    subgraph \"RTX Router\"\n        CMD1[ip filter]\n        CMD2[ip filter dynamic]\n        CMD3[nat descriptor masquerade static]\n        CMD4[ethernet filter]\n    end\n\n    R1 --> P1\n    R2 --> P1\n    R3 --> P2\n    R4 --> P3\n\n    P1 --> CMD1\n    P1 --> CMD2\n    P2 --> CMD3\n    P3 --> CMD4\n```\n\n## Components and Interfaces\n\n### Component 1: IP Filter Parser Extensions\n\n**File:** `internal/rtx/parsers/ip_filter.go`\n\n**Changes:**\n```go\n// Extend existing validation lists\nValidIPFilterActions = []string{\n    \"pass\", \"pass-log\", \"pass-nolog\",\n    \"reject\", \"reject-log\", \"reject-nolog\",\n    \"restrict\", \"restrict-log\", \"restrict-nolog\",  // Add restrict-nolog\n}\n\nValidIPFilterProtocols = []string{\n    \"tcp\", \"udp\", \"icmp\", \"ip\", \"*\", \"gre\", \"esp\", \"ah\", \"icmp6\",\n    \"tcpfin\", \"tcprst\", \"tcpsyn\", \"established\",  // Add TCP flag protocols\n}\n\nValidDynamicProtocols = []string{\n    // Existing\n    \"ftp\", \"www\", \"smtp\", \"pop3\", \"dns\", \"domain\", \"telnet\", \"ssh\", \"tcp\", \"udp\", \"*\",\n    // New services\n    \"tftp\", \"echo\", \"discard\", \"daytime\", \"chargen\", \"time\", \"whois\",\n    \"gopher\", \"finger\", \"http\", \"sunrpc\", \"ident\", \"nntp\", \"ntp\", \"ms-rpc\",\n    \"netbios_ns\", \"netbios_dgm\", \"netbios_ssn\", \"imap\", \"snmp\", \"snmptrap\",\n    \"bgp\", \"imap3\", \"ldap\", \"https\", \"ms-ds\", \"ike\", \"rlogin\", \"rwho\", \"rsh\",\n    \"syslog\", \"printer\", \"rip\", \"ripng\", \"ms-sql\", \"radius\", \"l2tp\", \"pptp\",\n    \"nfs\", \"msblast\", \"ipsec-nat-t\", \"sip\", \"ping\", \"ping6\", \"submission\", \"netmeeting\",\n}\n```\n\n**New Functions:**\n- `ParseIPFilterDynamicConfigExtended()` - Parse both forms of dynamic filter\n- `BuildIPFilterDynamicCommandExtended()` - Build command for filter-reference form\n- `ValidateIPFilterDynamicExtended()` - Validate all dynamic filter options\n\n### Component 2: rtx_ip_filter_dynamic Resource (New)\n\n**File:** `internal/provider/resource_rtx_ip_filter_dynamic.go`\n\n**Purpose:** Manage dynamic IP filters for stateful packet inspection\n\n**Schema:**\n```hcl\nresource \"rtx_ip_filter_dynamic\" \"example\" {\n  number = 200080\n\n  # Form 1: Protocol-based\n  source      = \"*\"\n  destination = \"*\"\n  protocol    = \"ftp\"  # or tcp, udp, www, etc.\n\n  # Form 2: Filter reference-based (mutually exclusive with protocol)\n  # filter_list     = [10, 11]\n  # in_filter_list  = [20]\n  # out_filter_list = [30]\n\n  # Options\n  syslog  = false   # syslog=off\n  timeout = 1800    # Optional timeout in seconds\n}\n```\n\n**Interfaces:**\n- `resourceRTXIPFilterDynamic()` - Resource definition\n- `resourceRTXIPFilterDynamicCreate()` - Create dynamic filter\n- `resourceRTXIPFilterDynamicRead()` - Read current state\n- `resourceRTXIPFilterDynamicUpdate()` - Update filter\n- `resourceRTXIPFilterDynamicDelete()` - Delete filter\n- `resourceRTXIPFilterDynamicImport()` - Import existing filter\n\n### Component 3: NAT Masquerade Parser Extensions\n\n**File:** `internal/rtx/parsers/nat_masquerade.go`\n\n**Changes to MasqueradeStaticEntry:**\n```go\ntype MasqueradeStaticEntry struct {\n    EntryNumber       int\n    InsideLocal       string\n    InsideLocalPort   *int    // Pointer - nil for protocol-only entries\n    OutsideGlobal     *string // Optional\n    OutsideGlobalPort *int    // Optional\n    Protocol          string  // esp, ah, gre, icmp, tcp, udp, or number\n}\n```\n\n**Changes to BuildNATMasqueradeStaticCommand:**\n```go\nfunc BuildNATMasqueradeStaticCommand(descriptorID int, entry MasqueradeStaticEntry) string {\n    if entry.InsideLocalPort == nil {\n        // Protocol-only: nat descriptor masquerade static 1000 1 192.168.1.253 esp\n        return fmt.Sprintf(\"nat descriptor masquerade static %d %d %s %s\",\n            descriptorID, entry.EntryNumber, entry.InsideLocal, entry.Protocol)\n    }\n    // With port: nat descriptor masquerade static 1000 2 192.168.1.253 udp 500\n    // ... existing logic\n}\n```\n\n### Component 4: rtx_ethernet_filter Resource (New)\n\n**File:** `internal/provider/resource_rtx_ethernet_filter.go`\n\n**Purpose:** Manage Layer 2 Ethernet (MAC) filters\n\n**Schema:**\n```hcl\nresource \"rtx_ethernet_filter\" \"example\" {\n  number = 1\n  action = \"reject-nolog\"  # pass-log, pass-nolog, reject-log, reject-nolog\n\n  # MAC-based filter\n  source_mac      = \"bc:5c:17:05:59:3a\"  # or \"*\"\n  destination_mac = \"*\"                   # Optional, defaults to \"*\"\n\n  # OR DHCP-based filter (mutually exclusive)\n  # dhcp_type = \"dhcp-bind\"  # or \"dhcp-not-bind\"\n  # dhcp_scope = 1           # Optional scope number\n\n  # Advanced byte filtering (optional)\n  # offset    = 0\n  # byte_list = \"08,00\"\n}\n```\n\n### Component 5: Ethernet Filter Parser (New)\n\n**File:** `internal/rtx/parsers/ethernet_filter.go`\n\n**Structs:**\n```go\ntype EthernetFilter struct {\n    Number         int\n    Action         string   // pass-log, pass-nolog, reject-log, reject-nolog\n    SourceMAC      string   // MAC address or \"*\"\n    DestinationMAC string   // MAC address or \"*\"\n    DHCPType       string   // dhcp-bind, dhcp-not-bind, or empty\n    DHCPScope      *int     // Optional scope number\n    Offset         *int     // Optional byte offset\n    ByteList       []string // Optional byte list\n}\n\nvar ValidEthernetFilterActions = []string{\n    \"pass-log\", \"pass-nolog\", \"reject-log\", \"reject-nolog\",\n}\n```\n\n**Functions:**\n- `ParseEthernetFilterConfig()` - Parse `show config` output for ethernet filters\n- `BuildEthernetFilterCommand()` - Generate `ethernet filter` command\n- `BuildDeleteEthernetFilterCommand()` - Generate `no ethernet filter` command\n- `BuildEthernetInterfaceFilterCommand()` - Generate interface application command\n- `ValidateEthernetFilterNumber()` - Validate filter number range\n- `ValidateMACAddress()` - Validate MAC address format\n- `ValidateEthernetFilter()` - Full filter validation\n\n## Data Models\n\n### IPFilterDynamic (Extended)\n```go\ntype IPFilterDynamic struct {\n    Number        int\n    Source        string\n    Destination   string\n    Protocol      string   // Form 1: service/protocol name\n    FilterList    []int    // Form 2: static filter references\n    InFilterList  []int    // Form 2: in direction filters\n    OutFilterList []int    // Form 2: out direction filters\n    SyslogOn      bool\n    Timeout       *int     // Optional timeout in seconds\n}\n```\n\n### MasqueradeStaticEntry (Extended)\n```go\ntype MasqueradeStaticEntry struct {\n    EntryNumber       int\n    InsideLocal       string\n    InsideLocalPort   *int    // nil for protocol-only\n    OutsideGlobal     *string\n    OutsideGlobalPort *int\n    Protocol          string\n}\n```\n\n### EthernetFilter (New)\n```go\ntype EthernetFilter struct {\n    Number         int\n    Action         string\n    SourceMAC      string\n    DestinationMAC string\n    DHCPType       string\n    DHCPScope      *int\n    Offset         *int\n    ByteList       []string\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Protocol Type**\n   - **Handling:** Return validation error before SSH execution\n   - **User Impact:** Clear error message: \"protocol 'xyz' is not valid; supported values are: tcp, udp, tcpfin, tcprst, ...\"\n\n2. **Invalid MAC Address Format**\n   - **Handling:** Regex validation in schema validator\n   - **User Impact:** \"MAC address must be in format xx:xx:xx:xx:xx:xx or '*'\"\n\n3. **Protocol-Only Entry with Port Specified**\n   - **Handling:** Schema conflict validation\n   - **User Impact:** \"Port cannot be specified for protocol 'esp'; remove port fields\"\n\n4. **Filter Number Out of Range**\n   - **Handling:** Range validation in schema\n   - **User Impact:** \"Ethernet filter number must be between 1 and 512\"\n\n5. **Import Parse Failure**\n   - **Handling:** Log warning and return partial state\n   - **User Impact:** Warning logged, non-matching lines skipped\n\n## Testing Strategy\n\n### Unit Testing\n\n**Parser Tests:**\n- `ip_filter_test.go` - Add tests for new protocols and actions\n- `nat_masquerade_test.go` - Add tests for protocol-only static entries\n- `ethernet_filter_test.go` - New comprehensive parser tests\n\n**Test Cases:**\n```go\n// IP Filter - new protocols\n{\"ip filter 100 pass * * tcpfin * 80\", IPFilter{Action: \"pass\", Protocol: \"tcpfin\", ...}}\n{\"ip filter 101 restrict-nolog * * * * *\", IPFilter{Action: \"restrict-nolog\", ...}}\n\n// Dynamic Filter - both forms\n{\"ip filter dynamic 100 * * ftp syslog=off\", IPFilterDynamic{Protocol: \"ftp\", SyslogOn: false}}\n{\"ip filter dynamic 101 * * filter 10 in 20\", IPFilterDynamic{FilterList: []int{10}, InFilterList: []int{20}}}\n\n// NAT - protocol-only\n{\"nat descriptor masquerade static 1000 1 192.168.1.253 esp\", MasqueradeStaticEntry{Protocol: \"esp\", InsideLocalPort: nil}}\n\n// Ethernet Filter\n{\"ethernet filter 1 reject-nolog bc:5c:17:* *\", EthernetFilter{Action: \"reject-nolog\", SourceMAC: \"bc:5c:17:*\"}}\n```\n\n### Integration Testing\n\n**Acceptance Tests:**\n- `resource_rtx_access_list_ip_test.go` - Add restrict-nolog and tcpfin tests\n- `resource_rtx_ip_filter_dynamic_test.go` - New resource tests\n- `resource_rtx_nat_masquerade_test.go` - Add protocol-only entry tests\n- `resource_rtx_ethernet_filter_test.go` - New resource tests\n\n**Test Scenarios:**\n1. Create IP filter with `restrict-nolog` action\n2. Create IP filter with `tcpfin` protocol\n3. Create dynamic filter with protocol form\n4. Create dynamic filter with filter-reference form\n5. Create NAT masquerade with ESP static entry (no port)\n6. Create ethernet filter with MAC addresses\n7. Create ethernet filter with DHCP binding\n8. Import existing filters of all types\n\n### End-to-End Testing\n\n**Manual Verification:**\n1. Apply configuration to real RTX router\n2. Verify `show config` output matches expected\n3. Verify import recreates exact state\n4. Verify plan shows no changes after apply + import cycle\n\n## Implementation Order\n\n1. **Phase 1: IP Filter Extensions** (REQ-1, REQ-2)\n   - Extend validation lists\n   - Update parser tests\n   - Update resource validation\n\n2. **Phase 2: Dynamic IP Filter Resource** (REQ-3)\n   - Create parser functions\n   - Create resource file\n   - Add comprehensive tests\n\n3. **Phase 3: NAT Protocol-Only Support** (REQ-4)\n   - Modify struct to use pointer types\n   - Update command builder\n   - Update resource schema\n   - Add tests\n\n4. **Phase 4: Ethernet Filter Resource** (REQ-5)\n   - Create new parser file\n   - Create new resource file\n   - Add comprehensive tests\n",
  "fileStats": {
    "size": 12561,
    "lines": 384,
    "lastModified": "2026-01-20T14:30:44.450Z"
  },
  "comments": []
}