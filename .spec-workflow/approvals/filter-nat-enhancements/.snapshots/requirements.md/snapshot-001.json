{
  "id": "snapshot_1768918376704_v1rmflctq",
  "approvalId": "approval_1768918376686_o3104u698",
  "approvalTitle": "Filter & NAT Enhancements - Requirements",
  "version": 1,
  "timestamp": "2026-01-20T14:12:56.704Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Filter & NAT Enhancements\n\n## Introduction\n\nThis specification addresses gaps in the terraform-provider-rtx's filtering and NAT functionality discovered during import reconciliation of actual RTX router configurations. The provider currently lacks support for several RTX-specific features including the `restrict` action for IP filters, protocol-specific filter types (tcpfin/tcprst), protocol-only NAT static entries (e.g., ESP), and Ethernet (MAC) filters. These features are essential for complete Infrastructure as Code management of RTX routers.\n\n## Alignment with Product Vision\n\nThis feature directly supports the product vision of \"comprehensive coverage of all RTX router features\" and specifically addresses:\n\n- **Security & Filtering**: Completing IP filter support with `restrict` action and protocol types\n- **Ethernet Filters**: Layer 2 packet filtering capability mentioned in product.md\n- **NAT/NAPT**: Protocol-only static mapping for IPsec/ESP support\n- **Import Support**: Enabling complete import of existing RTX configurations\n\n## Requirements\n\n### REQ-1: IP Filter Restrict Action Support\n\n**User Story:** As a network administrator, I want to use the `restrict` action in IP filters, so that I can implement stateful-like filtering behavior where specific traffic triggers dynamic filter activation.\n\n#### Acceptance Criteria\n\n1. WHEN creating an `rtx_access_list_ip` resource with `action = \"restrict\"` THEN the provider SHALL accept the configuration and generate the corresponding `ip filter <id> restrict ...` command\n2. WHEN importing an existing IP filter with `restrict` action THEN the provider SHALL correctly parse and store the action in state\n3. IF an IP filter has `restrict` action THEN the provider SHALL validate that it's used in conjunction with dynamic filters on the interface\n\n### REQ-2: IP Filter Protocol Type Extensions\n\n**User Story:** As a network administrator, I want to specify `tcpfin` and `tcprst` as protocol types in IP filters, so that I can create fine-grained TCP session control rules.\n\n#### Acceptance Criteria\n\n1. WHEN creating an `rtx_access_list_ip` resource with `protocol = \"tcpfin\"` THEN the provider SHALL accept the configuration and generate `ip filter <id> ... tcpfin ...`\n2. WHEN creating an `rtx_access_list_ip` resource with `protocol = \"tcprst\"` THEN the provider SHALL accept the configuration and generate `ip filter <id> ... tcprst ...`\n3. WHEN importing existing filters using tcpfin or tcprst THEN the provider SHALL correctly parse and store the protocol value\n\n### REQ-3: Dynamic IP Filter Support\n\n**User Story:** As a network administrator, I want to define dynamic IP filters in Terraform, so that I can configure stateful packet inspection rules for outbound traffic.\n\n#### Acceptance Criteria\n\n1. WHEN creating an `rtx_ip_filter_dynamic` resource THEN the provider SHALL generate the corresponding `ip filter dynamic <id> ...` command\n2. WHEN specifying a service type (ftp, domain, www, smtp, pop3, submission, tcp, udp) THEN the provider SHALL include it in the generated command\n3. WHEN the dynamic filter includes `syslog=off` option THEN the provider SHALL include this in the generated command\n4. WHEN importing existing dynamic filters THEN the provider SHALL correctly parse all parameters\n\n### REQ-4: NAT Masquerade Protocol-Only Static Entries\n\n**User Story:** As a network administrator, I want to create NAT masquerade static entries for protocols without port numbers (like ESP), so that I can configure IPsec passthrough for VPN connections.\n\n#### Acceptance Criteria\n\n1. WHEN creating an `rtx_nat_masquerade` with a static_entry specifying only `protocol = \"esp\"` (without ports) THEN the provider SHALL accept the configuration\n2. WHEN such entry is created THEN the provider SHALL generate `nat descriptor masquerade static <id> <entry_num> <ip> esp`\n3. WHEN importing existing protocol-only static entries THEN the provider SHALL correctly parse and store them without requiring port fields\n\n### REQ-5: Ethernet (MAC) Filter Support\n\n**User Story:** As a network administrator, I want to define Ethernet (MAC address-based) filters in Terraform, so that I can control Layer 2 traffic based on MAC addresses.\n\n#### Acceptance Criteria\n\n1. WHEN creating an `rtx_ethernet_filter` resource THEN the provider SHALL generate the corresponding `ethernet filter <id> <action> <src_mac> <dst_mac>` command\n2. WHEN the action is `pass`, `reject`, `reject-nolog`, or `restrict` THEN the provider SHALL accept it\n3. WHEN MAC addresses are specified as `*` (any) or specific MAC format THEN the provider SHALL validate and accept them\n4. WHEN importing existing ethernet filters THEN the provider SHALL correctly parse all parameters\n5. WHEN ethernet filters are applied to interfaces (`ethernet lan1 filter in/out ...`) THEN this SHALL be managed via the interface resource\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each new filter type should have its own parser module\n- **Modular Design**: Reuse existing rtx_access_list_ip patterns for new protocol and action types\n- **Dependency Management**: Dynamic filters may reference static filters by ID\n- **Clear Interfaces**: Maintain consistent schema patterns across filter resources\n\n### Performance\n- No additional performance requirements beyond existing SSH command execution\n\n### Security\n- Filter configurations should be validated before sending to router\n- No sensitive data (passwords) in filter configurations\n\n### Reliability\n- Parser must handle variations in RTX CLI output format\n- Import must not fail on unknown filter configurations (log warning instead)\n\n### Usability\n- Schema should follow established RTX provider conventions\n- Clear error messages for invalid filter configurations\n- Examples in documentation for each new feature\n",
  "fileStats": {
    "size": 5889,
    "lines": 94,
    "lastModified": "2026-01-20T14:12:50.857Z"
  },
  "comments": []
}