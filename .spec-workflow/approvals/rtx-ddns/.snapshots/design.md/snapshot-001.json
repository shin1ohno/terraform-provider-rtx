{
  "id": "snapshot_1768915858711_te350uf8u",
  "approvalId": "approval_1768915858703_qctchjyok",
  "approvalTitle": "Design: RTX DDNS Resource",
  "version": 1,
  "timestamp": "2026-01-20T13:30:58.711Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: RTX DDNS Resource\n\n## Overview\n\nThis feature implements Terraform resources for Dynamic DNS configuration on Yamaha RTX routers, including support for Yamaha's NetVolante DNS service and custom DDNS providers. The design follows the established parser → client → provider pattern.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Follow existing parser implementation patterns\n- Use SSH command execution via existing client infrastructure\n- Implement CRUD operations with import support\n\n### Project Structure (structure.md)\n- Parser: `internal/rtx/parsers/ddns.go`\n- Client: `internal/client/ddns_service.go`\n- Provider: `internal/provider/resource_rtx_ddns.go`, `resource_rtx_netvolante_dns.go`\n- Data Source: `internal/provider/data_source_rtx_ddns_status.go`\n- Tests: Corresponding `*_test.go` files\n- Examples: `examples/ddns/main.tf`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **SSH Client**: `internal/client/client.go` for command execution\n- **Parser patterns**: Follow `dns.go` structure\n- **Resource patterns**: Follow singleton resource patterns (like `resource_rtx_dns_server.go`)\n\n### Integration Points\n- **Interface system**: DDNS binds to specific interfaces for IP detection\n- **PP interfaces**: Common to update DNS when PPPoE reconnects\n- **VPN resources**: DDNS hostnames used as VPN endpoints\n\n## Architecture\n\n```mermaid\ngraph TD\n    A[Terraform Resource] --> B[Provider Layer]\n    B --> C[Client Service]\n    C --> D[SSH Executor]\n    D --> E[RTX Router]\n\n    F[Parser] --> G[Parse Config]\n    F --> H[Build Commands]\n\n    B --> F\n\n    I[Data Source] --> B\n    I --> J[Status Read]\n```\n\n## Components and Interfaces\n\n### Component 1: DDNS Parser\n- **Purpose:** Parse and build DDNS commands\n- **File:** `internal/rtx/parsers/ddns.go`\n- **Interfaces:**\n  ```go\n  func ParseDDNSConfig(output string) (*DDNSConfig, error)\n  func ParseNetVolanteDNS(output string) (*NetVolanteConfig, error)\n  func ParseDDNSStatus(output string) (*DDNSStatus, error)\n  func BuildNetVolanteCommand(config *NetVolanteConfig) []string\n  func BuildDDNSCommand(config *DDNSConfig) []string\n  ```\n- **Dependencies:** regexp, strings, strconv, time\n- **Reuses:** Parsing patterns from dns.go\n\n### Component 2: DDNS Service\n- **Purpose:** Execute DDNS operations via SSH\n- **File:** `internal/client/ddns_service.go`\n- **Interfaces:**\n  ```go\n  type DDNSService interface {\n      // NetVolante DNS\n      GetNetVolanteDNS() (*NetVolanteConfig, error)\n      ConfigureNetVolanteDNS(config *NetVolanteConfig) error\n      UpdateNetVolanteDNS(config *NetVolanteConfig) error\n      DeleteNetVolanteDNS() error\n      TriggerNetVolanteUpdate() error\n\n      // Custom DDNS\n      GetDDNS(id int) (*DDNSConfig, error)\n      ConfigureDDNS(config *DDNSConfig) error\n      DeleteDDNS(id int) error\n\n      // Status\n      GetDDNSStatus() (*DDNSStatus, error)\n  }\n  ```\n- **Dependencies:** client.Executor\n- **Reuses:** Command execution pattern from dns_service.go\n\n### Component 3: NetVolante DNS Resource\n- **Purpose:** Terraform resource for Yamaha NetVolante DNS\n- **File:** `internal/provider/resource_rtx_netvolante_dns.go`\n- **Schema:**\n  ```hcl\n  resource \"rtx_netvolante_dns\" \"main\" {\n    hostname      = \"myrouter\"        # or \"auto\" for MAC-based\n    server        = 1                 # 1 or 2\n    interface     = \"pp 1\"            # Interface for IP detection\n    update_interval = 60              # minutes, 0 = on change only\n    ipv6_enabled  = false\n  }\n  ```\n- **Dependencies:** DDNSService, schema package\n- **Reuses:** Singleton resource pattern from resource_rtx_dns_server.go\n\n### Component 4: Custom DDNS Resource\n- **Purpose:** Terraform resource for custom DDNS providers\n- **File:** `internal/provider/resource_rtx_ddns.go`\n- **Schema:**\n  ```hcl\n  resource \"rtx_ddns\" \"custom\" {\n    id            = 1\n    provider_url  = \"https://api.dyndns.org/nic/update\"\n    hostname      = \"myhost.dyndns.org\"\n    username      = \"user\"\n    password      = \"secret\"\n    interface     = \"pp 1\"\n    update_interval = 30              # minutes\n    retry_count   = 3\n    retry_delay   = 60                # seconds\n  }\n  ```\n- **Dependencies:** DDNSService, schema package\n\n### Component 5: DDNS Status Data Source\n- **Purpose:** Read current DDNS registration status\n- **File:** `internal/provider/data_source_rtx_ddns_status.go`\n- **Schema:**\n  ```hcl\n  data \"rtx_ddns_status\" \"current\" {}\n\n  # Outputs:\n  # - netvolante_hostname\n  # - netvolante_registered_ip\n  # - netvolante_last_update\n  # - netvolante_status\n  # - custom_ddns_status (list)\n  ```\n- **Dependencies:** DDNSService\n\n## Data Models\n\n### NetVolanteConfig\n```go\ntype NetVolanteConfig struct {\n    Hostname       string   // hostname or \"auto\"\n    Server         int      // 1 or 2\n    Interface      string   // \"pp 1\", \"lan2\", etc.\n    UpdateInterval int      // minutes\n    IPv6Enabled    bool\n}\n```\n\n### DDNSConfig\n```go\ntype DDNSConfig struct {\n    ID             int\n    ProviderURL    string\n    Hostname       string\n    Username       string\n    Password       string   // Sensitive\n    Interface      string\n    UpdateInterval int      // minutes\n    RetryCount     int\n    RetryDelay     int      // seconds\n}\n```\n\n### DDNSStatus\n```go\ntype DDNSStatus struct {\n    NetVolante     *NetVolanteStatus\n    CustomDDNS     []CustomDDNSStatus\n}\n\ntype NetVolanteStatus struct {\n    Hostname       string\n    RegisteredIP   string\n    LastUpdate     time.Time\n    Status         string    // \"success\", \"error\", \"pending\"\n    ErrorMessage   string\n}\n\ntype CustomDDNSStatus struct {\n    ID             int\n    Hostname       string\n    RegisteredIP   string\n    LastUpdate     time.Time\n    Status         string\n}\n```\n\n### RTX Commands Mapping\n\n#### NetVolante DNS\n| Terraform Attribute | RTX Command |\n|---------------------|-------------|\n| hostname | `netvolante-dns hostname host <name>` |\n| hostname = \"auto\" | `netvolante-dns auto hostname on` |\n| server | `netvolante-dns server <n>` |\n| interface | `netvolante-dns go <interface>` |\n| update_interval | `netvolante-dns timeout <minutes>` |\n| ipv6_enabled | `netvolante-dns ipv6 on` |\n\n#### Custom DDNS\n| Terraform Attribute | RTX Command |\n|---------------------|-------------|\n| provider_url | `ddns server <id> url <url>` |\n| hostname | `ddns server <id> hostname <name>` |\n| username | `ddns server <id> user <user>` |\n| password | `ddns server <id> password <pass>` |\n| interface | `ddns go <id> <interface>` |\n\n## Error Handling\n\n### Error Scenarios\n1. **Hostname already registered:**\n   - **Handling:** Check availability before registration\n   - **User Impact:** Suggest alternative hostname\n\n2. **Network connectivity failure:**\n   - **Handling:** Retry with configured delay\n   - **User Impact:** Report retry status and last error\n\n3. **Invalid provider URL:**\n   - **Handling:** Validate URL format before apply\n   - **User Impact:** Clear error about URL format\n\n## Testing Strategy\n\n### Unit Testing\n- Parser tests with sample RTX output\n- Command builder tests for all configurations\n- Status parsing tests\n\n### Integration Testing\n- Mock client tests for CRUD operations\n- State management tests\n- Multi-DDNS configuration tests\n\n### Acceptance Testing (requires RTX)\n- NetVolante DNS registration test\n- Custom DDNS update test\n- Status monitoring test\n",
  "fileStats": {
    "size": 7349,
    "lines": 248,
    "lastModified": "2026-01-20T13:30:49.018Z"
  },
  "comments": []
}