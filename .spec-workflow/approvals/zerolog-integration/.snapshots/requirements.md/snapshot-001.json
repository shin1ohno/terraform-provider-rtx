{
  "id": "snapshot_1768919444084_2u9ffvc8s",
  "approvalId": "approval_1768919444041_zci1ke9xp",
  "approvalTitle": "zerolog-integration Requirements",
  "version": 1,
  "timestamp": "2026-01-20T14:30:44.084Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nこのプロジェクトでは、構造化ロギングライブラリ `zerolog` を導入し、現在使用している標準 `log` パッケージを置き換えます。zerologは高性能でゼロアロケーションの構造化ロギングを提供し、JSON形式でのログ出力によりログの解析と監視を容易にします。\n\n## Alignment with Product Vision\n\nproduct.mdの「Monitoring & Visibility」セクションでは「Debug Logging: TF_LOG environment variable for detailed operation tracing」が言及されています。zerologの導入により：\n\n- **構造化ログ**: JSON形式のログにより、ログ集約ツール（Elasticsearch、Loki等）との連携が容易になる\n- **パフォーマンス**: ゼロアロケーションによりSSH通信のオーバーヘッドを最小化\n- **デバッグ効率化**: フィールドベースのログにより、問題の特定が迅速化\n- **Terraform統合**: terraform-plugin-logとの互換性を維持しながら、内部ログの品質を向上\n\n## Requirements\n\n### REQ-1: zerolog依存関係の追加\n\n**User Story:** As a developer, I want zerolog to be available as a dependency, so that I can use structured logging throughout the codebase.\n\n#### Acceptance Criteria\n\n1. WHEN go.mod is updated THEN the system SHALL include `github.com/rs/zerolog` as a dependency\n2. WHEN `go mod tidy` is run THEN the system SHALL resolve all zerolog dependencies without errors\n\n### REQ-2: グローバルロガーの設定\n\n**User Story:** As a developer, I want a centralized logger configuration, so that all components use consistent logging settings.\n\n#### Acceptance Criteria\n\n1. WHEN the provider initializes THEN the system SHALL configure a global zerolog logger\n2. WHEN TF_LOG=DEBUG is set THEN the system SHALL set zerolog level to debug\n3. WHEN TF_LOG=INFO is set THEN the system SHALL set zerolog level to info\n4. WHEN TF_LOG is not set THEN the system SHALL default to warn level\n5. WHEN running in development mode THEN the system SHALL use ConsoleWriter for human-readable output\n6. WHEN running in production mode THEN the system SHALL output JSON format\n\n### REQ-3: SSH/クライアント層のログ移行\n\n**User Story:** As a developer, I want SSH client operations to use structured logging, so that I can trace connection issues with relevant context.\n\n#### Acceptance Criteria\n\n1. WHEN an SSH connection is established THEN the system SHALL log with fields: host, port, user\n2. WHEN a command is executed THEN the system SHALL log with fields: command (sanitized), duration\n3. WHEN an error occurs THEN the system SHALL log with fields: error, operation, context\n4. IF sensitive data (passwords, keys) is present THEN the system SHALL NOT log those values\n\n### REQ-4: Provider/リソース層のログ移行\n\n**User Story:** As a developer, I want resource operations to use structured logging, so that I can trace CRUD operations with resource context.\n\n#### Acceptance Criteria\n\n1. WHEN a resource is created THEN the system SHALL log with fields: resource_type, resource_id, operation=\"create\"\n2. WHEN a resource is read THEN the system SHALL log with fields: resource_type, resource_id, operation=\"read\"\n3. WHEN a resource is updated THEN the system SHALL log with fields: resource_type, resource_id, operation=\"update\"\n4. WHEN a resource is deleted THEN the system SHALL log with fields: resource_type, resource_id, operation=\"delete\"\n\n### REQ-5: コンテキスト伝播\n\n**User Story:** As a developer, I want request context to be propagated through logging, so that I can correlate logs across operations.\n\n#### Acceptance Criteria\n\n1. WHEN a Terraform operation starts THEN the system SHALL create a logger with operation context\n2. WHEN nested operations occur THEN the system SHALL inherit parent context fields\n3. WHEN context.Context is available THEN the system SHALL extract and use the logger from context\n\n### REQ-6: 既存テストの互換性維持\n\n**User Story:** As a developer, I want existing tests to continue working, so that the migration doesn't break the test suite.\n\n#### Acceptance Criteria\n\n1. WHEN `go test ./...` is run THEN the system SHALL pass all existing tests\n2. WHEN tests produce log output THEN the system SHALL capture logs appropriately for test assertions\n3. IF test assertions depend on log output format THEN the system SHALL update those assertions\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: ロガー設定は単一のファイル（`internal/logging/logger.go`）に集約\n- **Modular Design**: 各パッケージは独自のサブロガーを取得可能\n- **Dependency Management**: zerologへの依存はloggingパッケージ経由で抽象化\n- **Clear Interfaces**: ロガー取得のためのシンプルなAPI提供\n\n### Performance\n- ログ出力によるSSH通信への影響を最小化（zerologのゼロアロケーション特性を活用）\n- ログレベルによる不要なログ生成の回避（条件付きログ生成）\n- ベンチマーク: 既存のlog.Printfと同等以上のパフォーマンス\n\n### Security\n- パスワード、秘密鍵、トークンなどの機密情報をログに出力しない\n- 既存のSanitizeCommandForLog関数との統合\n- ログファイルに機密情報が残らないことを検証\n\n### Reliability\n- ログ出力の失敗がメイン処理に影響しない\n- バッファリングによるログ損失を防止\n- パニック時のスタックトレース出力\n\n### Usability\n- TF_LOG環境変数との互換性維持\n- 開発時は人間が読みやすいフォーマット\n- 運用時はJSON形式で機械処理可能\n",
  "fileStats": {
    "size": 5762,
    "lines": 109,
    "lastModified": "2026-01-20T14:30:39.311Z"
  },
  "comments": []
}