{
  "id": "snapshot_1768918712341_xnq4julqc",
  "approvalId": "approval_1768918712313_d8xtqoihn",
  "approvalTitle": "Security Hardening Design",
  "version": 1,
  "timestamp": "2026-01-20T14:18:32.341Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Security Hardening\n\n## Overview\n\nThis design addresses three security improvements for the terraform-provider-rtx:\n1. Log sanitization to prevent sensitive data exposure in debug logs\n2. Warning messages for insecure SSH host key verification settings\n3. Enhanced .gitignore patterns for security best practices\n\nThese changes are non-breaking and require minimal code modifications.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **log.Printf pattern**: All logging uses standard Go `log.Printf` with `[DEBUG]` prefix\n- **Config struct** (`internal/client/client.go`): Contains `SkipHostKeyCheck` and `KnownHostsFile` fields\n- **ssh_dialer.go**: Contains `getHostKeyCallback()` method where warnings will be added\n\n### Integration Points\n\n- **Command execution**: `simple_executor.go:33`, `working_session.go:108`, and ~50+ service files log commands\n- **SSH connection**: `ssh_dialer.go` handles host key verification setup\n- **Provider configuration**: Provider schema already has `skip_host_key_check` attribute\n\n## Architecture\n\n### Log Sanitization Flow\n\n```mermaid\ngraph LR\n    A[Command String] --> B{sanitizeForLog}\n    B -->|Contains sensitive pattern| C[Return REDACTED]\n    B -->|Safe| D[Return Original]\n    C --> E[log.Printf]\n    D --> E\n```\n\n### Component Structure\n\n```\ninternal/client/\n├── log_sanitizer.go      # NEW: Sanitization utility\n├── simple_executor.go    # MODIFY: Use sanitizer\n├── working_session.go    # MODIFY: Use sanitizer\n├── ssh_dialer.go         # MODIFY: Add warnings\n└── *_service.go          # MODIFY: Use sanitizer (via helper)\n```\n\n## Components and Interfaces\n\n### Component 1: Log Sanitizer (`internal/client/log_sanitizer.go`)\n\n- **Purpose:** Centralized utility to redact sensitive data from log messages\n- **Interfaces:**\n  ```go\n  // SanitizeCommandForLog redacts sensitive patterns from command strings\n  func SanitizeCommandForLog(cmd string) string\n\n  // LogCommand logs a command with automatic sanitization\n  func LogCommand(prefix, cmd string)\n  ```\n- **Dependencies:** Standard library only (`strings`, `log`)\n- **Reuses:** None (new utility)\n\n### Component 2: SSH Warning Logger (`internal/client/ssh_dialer.go` modification)\n\n- **Purpose:** Warn users about insecure SSH host key verification settings\n- **Interfaces:** No new public interfaces; modifies `getHostKeyCallback()` internal behavior\n- **Dependencies:** Existing `Config` struct\n- **Reuses:** Existing `getHostKeyCallback()` method\n\n### Component 3: .gitignore Enhancement\n\n- **Purpose:** Exclude sensitive file patterns from version control\n- **Interfaces:** N/A (configuration file)\n- **Dependencies:** None\n- **Reuses:** Existing .gitignore patterns\n\n## Data Models\n\n### Sensitive Pattern Configuration\n\n```go\n// sensitivePatterns defines patterns that indicate sensitive data\nvar sensitivePatterns = []string{\n    \"password\",\n    \"pre-shared-key\",\n    \"secret\",\n    \"community\",  // SNMP community strings\n}\n```\n\nNo new data models required. All changes operate on existing string data.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid input to sanitizer**\n   - **Handling:** Return original string (fail-open for logging)\n   - **User Impact:** Log message appears unchanged; no security benefit but no crash\n\n2. **Empty command string**\n   - **Handling:** Return empty string\n   - **User Impact:** Empty log entry (acceptable)\n\n### Warning Message Format\n\n```\n[WARN] SSH host key verification is disabled (skip_host_key_check=true).\nThis makes the connection vulnerable to man-in-the-middle attacks.\nConsider using 'known_hosts_file' or 'host_key' for production environments.\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**File: `internal/client/log_sanitizer_test.go`**\n\n| Test Case | Input | Expected Output |\n|-----------|-------|-----------------|\n| Password command | `login password secret123` | `[REDACTED - contains sensitive data]` |\n| Pre-shared key | `ipsec pre-shared-key text mykey` | `[REDACTED - contains sensitive data]` |\n| Case insensitive | `LOGIN PASSWORD test` | `[REDACTED - contains sensitive data]` |\n| Safe command | `ip lan1 address 192.168.1.1/24` | `ip lan1 address 192.168.1.1/24` |\n| Empty string | `` | `` |\n| Partial match | `password` (keyword only) | `[REDACTED - contains sensitive data]` |\n\n### Integration Testing\n\n- Verify debug logs do not contain sensitive data when `TF_LOG=DEBUG`\n- Verify warning messages appear when `skip_host_key_check=true`\n- Verify no warnings when `known_hosts_file` is configured\n\n### Manual Testing\n\n1. Run provider with `TF_LOG=DEBUG` and create a resource with password\n2. Grep logs for `password`, `pre-shared-key`, `secret` - should find only `[REDACTED]`\n3. Configure provider without host key verification and check for warning\n\n## Implementation Notes\n\n### Minimal Change Approach\n\nTo minimize risk and scope, we will:\n\n1. **Create a single helper function** instead of modifying every log call\n2. **Add warnings only in one location** (`getHostKeyCallback`)\n3. **Keep existing log structure** - only wrap command strings\n\n### Files to Modify\n\n| File | Change Type | Description |\n|------|-------------|-------------|\n| `internal/client/log_sanitizer.go` | CREATE | New sanitization utility |\n| `internal/client/log_sanitizer_test.go` | CREATE | Unit tests |\n| `internal/client/simple_executor.go` | MODIFY | Use sanitizer for command logs |\n| `internal/client/working_session.go` | MODIFY | Use sanitizer for command logs |\n| `internal/client/ssh_dialer.go` | MODIFY | Add warning logs |\n| `.gitignore` | MODIFY | Add sensitive file patterns |\n\n### Service Files Strategy\n\nRather than modifying 50+ service files, we can:\n1. First implement sanitizer for core files (`simple_executor.go`, `working_session.go`)\n2. Service files log through these executors, so they will be covered\n3. If direct logging exists in service files, add as follow-up task\n\n## Security Considerations\n\n- Sanitization uses case-insensitive matching to catch `PASSWORD`, `Password`, etc.\n- Pattern list is extensible for future additions\n- Warnings use `[WARN]` prefix to stand out in logs\n- No sensitive data is logged even in error paths\n",
  "fileStats": {
    "size": 6185,
    "lines": 177,
    "lastModified": "2026-01-20T14:18:27.435Z"
  },
  "comments": []
}