{
  "id": "snapshot_1769253645361_rba0v2un4",
  "approvalId": "approval_1769253645355_aab3ij4sg",
  "approvalTitle": "Design: Optional Field Preservation",
  "version": 1,
  "timestamp": "2026-01-24T11:20:45.361Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Optional Field Preservation\n\n## Overview\n\nThis document describes the technical design for preserving optional field values when they are not explicitly specified in Terraform configurations. The solution introduces a consistent pattern using Terraform's `GetOk()` function and pointer-based structures to distinguish between \"not set\" and \"explicitly set to zero/false/empty\".\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThe design follows existing project conventions:\n- Uses Zerolog for structured logging\n- Follows interface-first design patterns\n- Uses existing error handling patterns with `fmt.Errorf`\n\n### Project Structure (structure.md)\n\nImplementation will follow the established structure:\n- Shared utilities in `internal/provider/field_tracking.go`\n- Resource-specific changes in `internal/provider/resource_*.go`\n- Client-side changes in `internal/client/*.go`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **Terraform SDK schema.ResourceData**: Use `GetOk()` method to detect explicitly set values\n- **parsers package**: Extend command builders to accept optional parameters\n- **client interfaces**: Update structs to use pointer types for optional fields\n\n### Integration Points\n\n- **Provider resources**: All Create/Update functions will use the new field tracking pattern\n- **Client services**: Service methods will accept optional configurations\n- **RTX parsers**: Command builders will conditionally include fields\n\n## Architecture\n\nThe solution uses a three-layer approach:\n\n1. **Schema Layer**: Mark fields as `Optional: true, Computed: true` where appropriate\n2. **Resource Layer**: Use `GetOk()` to detect explicitly set values\n3. **Client Layer**: Use pointer types to represent optional values\n\n```mermaid\ngraph TD\n    A[Terraform Config] -->|Parse| B[schema.ResourceData]\n    B -->|GetOk| C{Field Set?}\n    C -->|Yes| D[Include in struct]\n    C -->|No| E[Leave as nil]\n    D --> F[Build Command]\n    E --> F\n    F -->|Only set fields| G[RTX Router]\n```\n\n## Components and Interfaces\n\n### Component 1: OptionalFieldHelper\n\n- **Purpose:** Provide utility functions for extracting optional field values from ResourceData\n- **Location:** `internal/provider/field_tracking.go`\n- **Interfaces:**\n  ```go\n  // GetOptionalBool returns a pointer to bool if the field is set, nil otherwise\n  func GetOptionalBool(d *schema.ResourceData, key string) *bool\n\n  // GetOptionalInt returns a pointer to int if the field is set, nil otherwise\n  func GetOptionalInt(d *schema.ResourceData, key string) *int\n\n  // GetOptionalString returns a pointer to string if the field is set, nil otherwise\n  func GetOptionalString(d *schema.ResourceData, key string) *string\n\n  // GetOptionalStringList returns the list if set, nil otherwise\n  func GetOptionalStringList(d *schema.ResourceData, key string) []string\n  ```\n- **Dependencies:** `github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema`\n\n### Component 2: Updated AdminUserAttributes\n\n- **Purpose:** Represent optional user attributes with pointer types\n- **Location:** `internal/client/interfaces.go`\n- **Current Interface:**\n  ```go\n  type AdminUserAttributes struct {\n      Administrator bool     // Always has a value\n      Connection    []string\n      GUIPages      []string\n      LoginTimer    int      // 0 could be intentional\n  }\n  ```\n- **New Interface:**\n  ```go\n  type AdminUserAttributes struct {\n      Administrator *bool    // nil = not set, true/false = explicit\n      Connection    []string // nil = not set, empty = explicitly empty\n      GUIPages      []string // nil = not set\n      LoginTimer    *int     // nil = not set, 0 = infinite\n  }\n  ```\n\n### Component 3: Updated Command Builders\n\n- **Purpose:** Build RTX commands only for fields that are explicitly set\n- **Location:** `internal/rtx/parsers/admin.go`\n- **Current Behavior:**\n  ```go\n  if attrs.Administrator {\n      parts = append(parts, \"administrator=on\")\n  } else {\n      parts = append(parts, \"administrator=off\")  // Always sent!\n  }\n  ```\n- **New Behavior:**\n  ```go\n  if attrs.Administrator != nil {\n      if *attrs.Administrator {\n          parts = append(parts, \"administrator=on\")\n      } else {\n          parts = append(parts, \"administrator=off\")\n      }\n  }\n  // nil = don't include in command (preserve current value)\n  ```\n\n## Data Models\n\n### OptionalAdminUserAttributes\n\n```go\n// AdminUserAttributes with pointer types for optional field support\ntype AdminUserAttributes struct {\n    Administrator *bool    `json:\"administrator,omitempty\"` // nil = preserve current\n    Connection    []string `json:\"connection,omitempty\"`    // nil = preserve current\n    GUIPages      []string `json:\"gui_pages,omitempty\"`     // nil = preserve current\n    LoginTimer    *int     `json:\"login_timer,omitempty\"`   // nil = preserve current\n}\n```\n\n### Field Tracking Pattern for Resources\n\n```go\n// Example pattern for resource Update function\nfunc resourceRTXAdminUserUpdate(ctx context.Context, d *schema.ResourceData, meta interface{}) diag.Diagnostics {\n    user := AdminUser{\n        Username: d.Get(\"username\").(string),\n        Attributes: AdminUserAttributes{\n            Administrator: GetOptionalBool(d, \"administrator\"),\n            Connection:    GetOptionalStringList(d, \"connection\"),\n            GUIPages:      GetOptionalStringList(d, \"gui_pages\"),\n            LoginTimer:    GetOptionalInt(d, \"login_timer\"),\n        },\n    }\n    // Fields that are nil will not be sent to the router\n    return apiClient.UpdateAdminUser(ctx, user)\n}\n```\n\n## Schema Changes\n\n### Current Schema Pattern (Problematic)\n\n```go\n\"administrator\": {\n    Type:        schema.TypeBool,\n    Optional:    true,\n    Description: \"Whether user has administrator privileges\",\n},\n```\n\n### New Schema Pattern\n\n```go\n\"administrator\": {\n    Type:        schema.TypeBool,\n    Optional:    true,\n    Computed:    true,  // Allow reading current value\n    Description: \"Whether user has administrator privileges\",\n},\n```\n\nThe `Computed: true` flag allows Terraform to:\n1. Accept user-specified values (Optional)\n2. Read and preserve current values from the router (Computed)\n3. Show accurate diffs in `terraform plan`\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Field Type Mismatch**\n   - **Handling:** Use type assertions with ok check, return diagnostic on failure\n   - **User Impact:** Clear error message indicating which field has incorrect type\n\n2. **Router Command Failure**\n   - **Handling:** Existing error handling patterns apply\n   - **User Impact:** Command output included in error message\n\n3. **Partial Update Failure**\n   - **Handling:** If attribute command fails, user creation still succeeds but attributes may not be set\n   - **User Impact:** Error clearly indicates which part failed\n\n## Testing Strategy\n\n### Unit Testing\n\n- Test `GetOptional*` helper functions with:\n  - Value explicitly set\n  - Value not set (GetOk returns false)\n  - Value set to zero/false/empty (should be detected as set)\n- Test command builders with:\n  - All fields set\n  - No fields set (should return empty command)\n  - Mix of set and unset fields\n\n### Integration Testing\n\n- Test resource create with missing optional fields\n- Test resource update preserving unspecified fields\n- Test resource import followed by apply (no changes expected)\n\n### Regression Testing\n\n- **Administrator Lockout Scenario**: Create user without `administrator` field, verify it doesn't get set to `off`\n- **Full Attribute Test**: Create user with all attributes, update only username, verify attributes preserved\n\n## Implementation Order\n\n1. **Phase 1**: Create shared helper utilities (`field_tracking.go`)\n2. **Phase 2**: Update client interfaces to use pointer types\n3. **Phase 3**: Update command builders to handle nil values\n4. **Phase 4**: Update resource Create/Update functions\n5. **Phase 5**: Add/update tests\n6. **Phase 6**: Audit all other resources for same pattern\n\n## Backward Compatibility\n\n### Terraform State Compatibility\n\n- Existing state files remain compatible\n- `Computed: true` allows reading values not in config\n- No state migration required\n\n### Configuration Compatibility\n\n- Existing configs with explicit values continue to work\n- Configs without optional fields now correctly preserve router values\n- No breaking changes to HCL syntax\n\n## Performance Considerations\n\n- Minimal overhead: `GetOk()` is a simple map lookup\n- No additional router API calls required\n- Command strings may be shorter (fewer fields included)\n\n## Security Considerations\n\n- Prevents accidental removal of administrator privileges\n- Sensitive fields (passwords) already handled separately\n- No new security concerns introduced\n",
  "fileStats": {
    "size": 8695,
    "lines": 260,
    "lastModified": "2026-01-24T11:20:39.159Z"
  },
  "comments": []
}