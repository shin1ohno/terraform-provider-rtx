{
  "id": "snapshot_1768743732429_sje6f6rjh",
  "approvalId": "approval_1768741919518_ff9t1pz51",
  "approvalTitle": "Design Document for rtx_dhcp_scope",
  "version": 2,
  "timestamp": "2026-01-18T13:42:12.429Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: rtx_dhcp_scope\n\n## Overview\n\nThe `rtx_dhcp_scope` resource enables Terraform-based management of DHCP scopes on Yamaha RTX series routers. This is the parent resource for the existing `rtx_dhcp_binding` resource, completing the DHCP infrastructure management capability. The implementation follows established patterns from the existing `rtx_dhcp_binding` resource to ensure consistency and maintainability.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_service.go`**: Pattern for service layer implementation. The new `DHCPScopeService` will follow this structure for CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with scope management methods following the existing pattern.\n- **`internal/rtx/parsers/dhcp_bindings.go`**: Reference for parser implementation and command builders. The new scope parser will follow similar patterns.\n- **`internal/rtx/parsers/registry.go`**: Use the existing registry pattern for parser registration if model-specific parsing is needed.\n- **`internal/provider/resource_rtx_dhcp_binding.go`**: Template for Terraform resource structure including CRUD operations, import, and validation.\n\n### Integration Points\n\n- **`rtxClient`**: Add scope methods similar to existing binding methods\n- **`DHCPService`**: Reference for service layer patterns (but create separate `DHCPScopeService` for SRP)\n- **`rtx_dhcp_binding`**: Parent-child relationship via `scope_id` reference\n\n## Architecture\n\nThe implementation follows a three-layer architecture consistent with the existing codebase:\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_dhcp_scope.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        ScopeService[dhcp_scope_service.go]\n    end\n\n    subgraph Parser Layer\n        ScopeParser[dhcp_scope.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> ScopeService\n    ScopeService --> ScopeParser\n    ScopeParser --> Commands\n    ScopeParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `DHCPScopeService` separate from `DHCPService` (bindings)\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all scope CRUD logic\n- **Utility Modularity**: Shared validation functions for IP/CIDR operations\n\n## Components and Interfaces\n\n### Component 1: DHCPScopeService (`internal/client/dhcp_scope_service.go`)\n\n- **Purpose:** Handles all DHCP scope CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type DHCPScopeService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *DHCPScopeService) CreateScope(ctx context.Context, scope DHCPScope) error\n  func (s *DHCPScopeService) GetScope(ctx context.Context, scopeID int) (*DHCPScope, error)\n  func (s *DHCPScopeService) UpdateScope(ctx context.Context, scope DHCPScope) error\n  func (s *DHCPScopeService) DeleteScope(ctx context.Context, scopeID int) error\n  func (s *DHCPScopeService) ListScopes(ctx context.Context) ([]DHCPScope, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.DHCPScopeParser`\n- **Reuses:** Pattern from `DHCPService`, `Executor` interface, `containsError()` helper\n\n### Component 2: DHCPScopeParser (`internal/rtx/parsers/dhcp_scope.go`)\n\n- **Purpose:** Parses RTX router output for scope configuration and builds commands\n- **Interfaces:**\n  ```go\n  type DHCPScope struct {\n      ScopeID       int\n      Network       string\n      Gateway       string\n      DNSServers    []string\n      LeaseTime     string\n      ExcludeRanges []ExcludeRange\n  }\n\n  type ExcludeRange struct {\n      Start string\n      End   string\n  }\n\n  func ParseScopeConfig(raw string) ([]DHCPScope, error)\n  func BuildDHCPScopeCommand(scope DHCPScope) string\n  func BuildDHCPScopeOptionsCommand(scopeID int, dnsServers []string) string\n  func BuildDHCPScopeExceptCommand(scopeID int, ranges []ExcludeRange) string\n  func BuildDeleteDHCPScopeCommand(scopeID int) string\n  func BuildShowDHCPScopeCommand(scopeID int) string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** `NormalizeMACAddress` patterns for IP validation\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_dhcp_scope.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXDHCPScope() *schema.Resource\n  func resourceRTXDHCPScopeCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDHCPScopeRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDHCPScopeUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDHCPScopeDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDHCPScopeImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `DHCPScope`, Terraform SDK\n- **Reuses:** `resourceRTXDHCPBinding` patterns for structure and error handling\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with scope management methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetDHCPScope(ctx context.Context, scopeID int) (*DHCPScope, error)\n  CreateDHCPScope(ctx context.Context, scope DHCPScope) error\n  UpdateDHCPScope(ctx context.Context, scope DHCPScope) error\n  DeleteDHCPScope(ctx context.Context, scopeID int) error\n  ListDHCPScopes(ctx context.Context) ([]DHCPScope, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing DHCP binding methods\n\n## Data Models\n\n### DHCPScope\n\n```go\n// DHCPScope represents a DHCP scope configuration on an RTX router\ntype DHCPScope struct {\n    ScopeID       int            `json:\"scope_id\"`\n    Network       string         `json:\"network\"`        // CIDR notation: \"192.168.1.0/24\"\n    Gateway       string         `json:\"gateway,omitempty\"`\n    DNSServers    []string       `json:\"dns_servers,omitempty\"` // Max 3\n    LeaseTime     string         `json:\"lease_time,omitempty\"`  // Go duration or \"infinite\"\n    ExcludeRanges []ExcludeRange `json:\"exclude_ranges,omitempty\"`\n}\n\n// ExcludeRange represents an IP range excluded from DHCP allocation\ntype ExcludeRange struct {\n    Start string `json:\"start\"` // Start IP address\n    End   string `json:\"end\"`   // End IP address\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_dhcp_scope\" \"example\" {\n  scope_id = 1  # Required, ForceNew\n\n  # Network configuration\n  network = \"192.168.1.0/24\"  # Required, ForceNew\n\n  # Optional parameters\n  gateway     = \"192.168.1.1\"\n  dns_servers = [\"8.8.8.8\", \"8.8.4.4\"]\n\n  # Lease configuration\n  lease_time = \"72h\"  # Go duration format, or \"infinite\"\n\n  # Exclusions\n  exclude_ranges = [\n    {\n      start = \"192.168.1.1\"\n      end   = \"192.168.1.10\"\n    }\n  ]\n}\n```\n\n## RTX Command Mapping\n\n### Create Scope\n\n```\ndhcp scope <scope-id> <network>/<prefix> [gateway <gateway>] [expire <time>]\n```\n\nExample: `dhcp scope 1 192.168.1.0/24 gateway 192.168.1.1 expire 3:00`\n\n### Configure DNS\n\n```\ndhcp scope option <scope-id> dns=<dns1>[,<dns2>[,<dns3>]]\n```\n\nExample: `dhcp scope option 1 dns=8.8.8.8,8.8.4.4`\n\n### Configure Exclusions\n\n```\ndhcp scope <scope-id> except <start-ip>-<end-ip>\n```\n\nExample: `dhcp scope 1 except 192.168.1.1-192.168.1.10`\n\n### Delete Scope\n\n```\nno dhcp scope <scope-id>\n```\n\n### Show Scope\n\n```\nshow config | grep \"dhcp scope <scope-id>\"\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Network Format**\n   - **Handling:** Validate CIDR notation in Terraform schema before sending to router\n   - **User Impact:** Clear validation error with expected format example\n\n2. **Scope Already Exists**\n   - **Handling:** Parse RTX output for \"already exists\" pattern\n   - **User Impact:** Return error suggesting import or different scope_id\n\n3. **Scope Has Active Bindings**\n   - **Handling:** Check for bindings before delete, warn user\n   - **User Impact:** Error with list of active bindings, suggest removing bindings first\n\n4. **Invalid Exclusion Range**\n   - **Handling:** Validate exclusion IPs are within scope network\n   - **User Impact:** Validation error specifying which IPs are out of range\n\n5. **DNS Server Limit Exceeded**\n   - **Handling:** Validate max 3 DNS servers in schema\n   - **User Impact:** Clear validation error about RTX limitation\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error with retry option\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`dhcp_scope_test.go`):\n  - Parse various RTX output formats for scope configuration\n  - Test command builder functions with different parameter combinations\n  - Test validation functions for network, IP, and lease time formats\n\n- **Service Tests** (`dhcp_scope_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test validation of input parameters\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_dhcp_scope_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Dependency graph with `rtx_dhcp_binding`\n\n- **Client Integration**:\n  - Test scope methods through client interface\n  - Verify proper initialization of scope service\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create scope with all parameters\n  - Update scope options (DNS, lease time)\n  - Create binding within scope to verify dependency\n  - Delete scope (verify binding cleanup behavior)\n  - Import existing scope\n\n### Test Data Structure\n\n```\ninternal/rtx/testdata/\n├── RTX1210/\n│   ├── show_dhcp_scope.txt\n│   └── show_dhcp_scope.golden.json\n└── RTX830/\n    ├── show_dhcp_scope.txt\n    └── show_dhcp_scope.golden.json\n```\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_dhcp_scope.go      # NEW: Terraform resource\n│   └── resource_rtx_dhcp_scope_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                    # MODIFY: Add DHCPScope type and interface methods\n│   ├── client.go                        # MODIFY: Add scope service initialization and methods\n│   ├── dhcp_scope_service.go           # NEW: Scope service implementation\n│   └── dhcp_scope_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── dhcp_scope.go               # NEW: Parser and command builders\n        └── dhcp_scope_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Lease Time Format Conversion**: RTX uses `h:mm` format (e.g., `3:00` for 3 hours). Convert from Go duration format (e.g., `72h`) to RTX format in command builder.\n\n2. **Scope ID as Terraform ID**: Use `scope_id` directly as Terraform resource ID (simple integer) unlike binding which uses composite ID.\n\n3. **ForceNew vs Update**: `scope_id` and `network` are ForceNew (cannot change without recreating). Other attributes (gateway, dns_servers, lease_time, exclude_ranges) support in-place updates.\n\n4. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications to persist to router memory.\n\n5. **Provider Registration**: Add `resourceRTXDHCPScope` to provider's resource map in `provider.go`.\n",
  "fileStats": {
    "size": 11468,
    "lines": 327,
    "lastModified": "2026-01-18T13:11:47.618Z"
  },
  "comments": []
}