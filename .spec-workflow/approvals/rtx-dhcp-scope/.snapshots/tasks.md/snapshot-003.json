{
  "id": "snapshot_1768744017857_jz9n1qrvb",
  "approvalId": "approval_1768743858898_zda8x5otl",
  "approvalTitle": "Tasks Document for rtx_dhcp_scope",
  "version": 3,
  "timestamp": "2026-01-18T13:46:57.857Z",
  "trigger": "approved",
  "status": "approved",
  "content": "# Tasks Document: rtx_dhcp_scope\n\n## Phase 1: Parser Layer\n\n- [ ] 1. Create DHCPScope data model and parser\n  - File: internal/rtx/parsers/dhcp_scope.go\n  - Define DHCPScope and ExcludeRange structs\n  - Implement ParseScopeConfig() to parse RTX output\n  - Purpose: Parse \"show config | grep dhcp scope\" output\n  - _Leverage: internal/rtx/parsers/dhcp_bindings.go for patterns_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer specializing in text parsing and regex | Task: Create DHCPScope struct with ScopeID, Network, Gateway, DNSServers, LeaseTime, ExcludeRanges fields. Implement ParseScopeConfig() function to parse RTX router output from \"show config | grep dhcp scope\" command. Follow patterns from dhcp_bindings.go | Restrictions: Do not modify existing parser files, use standard library regexp, handle multi-line scope configurations | _Leverage: internal/rtx/parsers/dhcp_bindings.go, internal/rtx/parsers/registry.go | _Requirements: Requirement 1 (CRUD), Requirement 2 (IP Range), Requirement 3 (Gateway/DNS), Requirement 4 (Lease Time) | Success: Parser correctly extracts all scope attributes from sample RTX output, handles edge cases like missing optional fields | After completing, mark task as [-] in progress, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 2. Create command builder functions for DHCP scope\n  - File: internal/rtx/parsers/dhcp_scope.go (continue)\n  - Implement BuildDHCPScopeCommand() for scope creation\n  - Implement BuildDHCPScopeOptionsCommand() for DNS configuration\n  - Implement BuildDHCPScopeExceptCommand() for exclusion ranges\n  - Implement BuildDeleteDHCPScopeCommand() for deletion\n  - Implement BuildShowDHCPScopeCommand() for reading\n  - Purpose: Generate RTX CLI commands for scope management\n  - _Leverage: internal/rtx/parsers/dhcp_bindings.go BuildDHCPBindCommand pattern_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer with RTX router CLI knowledge | Task: Create command builder functions following RTX command syntax: \"dhcp scope <id> <network>/<prefix> [gateway <gw>] [expire <time>]\", \"dhcp scope option <id> dns=<dns1>,<dns2>\", \"dhcp scope <id> except <start>-<end>\", \"no dhcp scope <id>\". Convert Go duration to RTX format (72h -> 72:00) | Restrictions: Follow existing BuildDHCPBindCommand pattern exactly, validate inputs before building commands | _Leverage: internal/rtx/parsers/dhcp_bindings.go | _Requirements: Requirement 1 (CRUD Operations) | Success: All commands generate valid RTX CLI syntax, lease time conversion works correctly | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 3. Create parser unit tests\n  - File: internal/rtx/parsers/dhcp_scope_test.go\n  - Test ParseScopeConfig with various RTX output formats\n  - Test all command builder functions\n  - Test edge cases: missing fields, malformed input\n  - Purpose: Ensure parser reliability\n  - _Leverage: internal/rtx/parsers/dhcp_bindings_test.go for test patterns_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Test Developer | Task: Create comprehensive unit tests for dhcp_scope.go. Include test cases for parsing scope config output, command building with various parameter combinations, edge cases like empty DNS list, infinite lease time | Restrictions: Use table-driven tests, do not require actual RTX router, use testdata fixtures if needed | _Leverage: internal/rtx/parsers/dhcp_bindings_test.go | _Requirements: All functional requirements | Success: All tests pass, coverage > 80%, edge cases handled | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n## Phase 2: Client Layer\n\n- [ ] 4. Add DHCPScope type to client interfaces\n  - File: internal/client/interfaces.go (modify)\n  - Add DHCPScope struct with all fields\n  - Add ExcludeRange struct\n  - Extend Client interface with scope methods\n  - Purpose: Define client-level data types and interface contract\n  - _Leverage: existing DHCPBinding struct pattern_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer specializing in interface design | Task: Add DHCPScope struct (ScopeID int, Network string, Gateway string, DNSServers []string, LeaseTime string, ExcludeRanges []ExcludeRange). Add ExcludeRange struct (Start, End string). Extend Client interface with: GetDHCPScope(ctx, scopeID) (*DHCPScope, error), CreateDHCPScope(ctx, scope) error, UpdateDHCPScope(ctx, scope) error, DeleteDHCPScope(ctx, scopeID) error, ListDHCPScopes(ctx) ([]DHCPScope, error) | Restrictions: Do not break existing interface methods, maintain backward compatibility | _Leverage: internal/client/interfaces.go existing patterns | _Requirements: Requirement 1 (CRUD) | Success: Interface compiles, follows existing patterns | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 5. Create DHCPScopeService implementation\n  - File: internal/client/dhcp_scope_service.go (new)\n  - Implement DHCPScopeService struct with executor reference\n  - Implement CreateScope() with validation and command execution\n  - Implement GetScope() to parse scope configuration\n  - Implement UpdateScope() for modifying options\n  - Implement DeleteScope() with binding check warning\n  - Implement ListScopes() to retrieve all scopes\n  - Purpose: Service layer for scope CRUD operations\n  - _Leverage: internal/client/dhcp_service.go for service pattern_\n  - _Requirements: 1, 2, 3, 4, 5_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer with service layer expertise | Task: Create DHCPScopeService following DHCPService pattern. Include input validation (CIDR format, IP addresses, max 3 DNS servers). Use parsers.BuildDHCPScopeCommand and related functions. Call client.SaveConfig() after modifications. Handle scope update by deleting and recreating if network changes | Restrictions: Follow existing service patterns exactly, use containsError() for output checking, maintain separation from DHCPService | _Leverage: internal/client/dhcp_service.go | _Requirements: Requirements 1-5 | Success: All CRUD operations work, validation catches invalid input, configuration is saved | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 6. Integrate DHCPScopeService into rtxClient\n  - File: internal/client/client.go (modify)\n  - Add dhcpScopeService field to rtxClient struct\n  - Initialize service in Dial() method\n  - Implement Client interface scope methods delegating to service\n  - Purpose: Wire up scope service to main client\n  - _Leverage: existing dhcpService integration pattern_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer | Task: Add dhcpScopeService *DHCPScopeService field to rtxClient. Initialize in Dial(): c.dhcpScopeService = NewDHCPScopeService(c.executor, c). Implement GetDHCPScope, CreateDHCPScope, UpdateDHCPScope, DeleteDHCPScope, ListDHCPScopes methods delegating to service | Restrictions: Follow existing dhcpService integration pattern exactly, maintain mutex locking pattern | _Leverage: internal/client/client.go dhcpService integration | _Requirements: Requirement 1 | Success: Client compiles, all scope methods delegate correctly | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 7. Create service unit tests\n  - File: internal/client/dhcp_scope_service_test.go (new)\n  - Test CreateScope with valid and invalid inputs\n  - Test GetScope parsing\n  - Test UpdateScope behavior\n  - Test DeleteScope\n  - Mock executor for isolated testing\n  - Purpose: Ensure service reliability\n  - _Leverage: internal/client/dhcp_service_test.go for patterns_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Test Developer | Task: Create unit tests for DHCPScopeService. Mock Executor interface to simulate RTX responses. Test validation (invalid CIDR, too many DNS servers, invalid IPs). Test successful CRUD operations. Test error handling | Restrictions: Use mock executor, do not require real router, use table-driven tests | _Leverage: internal/client/dhcp_service_test.go | _Requirements: Requirements 1-4 | Success: All tests pass, validation logic tested, error paths covered | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n## Phase 3: Provider Layer\n\n- [ ] 8. Create Terraform resource schema\n  - File: internal/provider/resource_rtx_dhcp_scope.go (new)\n  - Define resourceRTXDHCPScope() with full schema\n  - Add scope_id (Required, ForceNew, Int)\n  - Add network (Required, ForceNew, String with CIDR validation)\n  - Add gateway (Optional, String)\n  - Add dns_servers (Optional, List of String, max 3)\n  - Add lease_time (Optional, String, default \"72h\")\n  - Add exclude_ranges (Optional, List of Object with start/end)\n  - Purpose: Define Terraform resource structure\n  - _Leverage: internal/provider/resource_rtx_dhcp_binding.go for patterns_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer | Task: Create resourceRTXDHCPScope() returning *schema.Resource. Define schema following rtx_dhcp_binding patterns. Add ValidateFunc for network (CIDR), dns_servers (max 3, valid IPs). Set ForceNew on scope_id and network. Use TypeList for exclude_ranges with nested schema (start, end strings) | Restrictions: Follow Terraform SDK v2 patterns, match existing resource style | _Leverage: internal/provider/resource_rtx_dhcp_binding.go | _Requirements: Requirements 1-4 | Success: Schema compiles, validation functions work | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 9. Implement CRUD operations for resource\n  - File: internal/provider/resource_rtx_dhcp_scope.go (continue)\n  - Implement resourceRTXDHCPScopeCreate()\n  - Implement resourceRTXDHCPScopeRead()\n  - Implement resourceRTXDHCPScopeUpdate()\n  - Implement resourceRTXDHCPScopeDelete()\n  - Purpose: Terraform lifecycle management\n  - _Leverage: resource_rtx_dhcp_binding.go CRUD patterns_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer | Task: Implement Create (build DHCPScope from ResourceData, call client.CreateDHCPScope, set ID to scope_id). Read (call GetDHCPScope, update ResourceData, handle not found by clearing ID). Update (call UpdateDHCPScope for mutable fields). Delete (call DeleteDHCPScope). Follow rtx_dhcp_binding patterns for apiClient access and error handling | Restrictions: Use diag.Diagnostics for errors, handle partial failures gracefully | _Leverage: internal/provider/resource_rtx_dhcp_binding.go | _Requirements: Requirement 1 | Success: All CRUD operations work end-to-end | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 10. Implement import functionality\n  - File: internal/provider/resource_rtx_dhcp_scope.go (continue)\n  - Implement resourceRTXDHCPScopeImport()\n  - Parse scope_id from import ID string\n  - Validate scope exists on router\n  - Purpose: Support terraform import command\n  - _Leverage: resource_rtx_dhcp_binding.go import pattern_\n  - _Requirements: 5_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer | Task: Implement resourceRTXDHCPScopeImport(). Parse import ID as scope_id integer. Call GetDHCPScope to verify existence. Populate all ResourceData fields from retrieved scope. Call Read to ensure state consistency | Restrictions: Handle invalid import ID format, non-existent scope errors gracefully | _Leverage: internal/provider/resource_rtx_dhcp_binding.go import function | _Requirements: Requirement 5 (Import) | Success: terraform import rtx_dhcp_scope.example 1 works correctly | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 11. Register resource in provider\n  - File: internal/provider/provider.go (modify)\n  - Add \"rtx_dhcp_scope\" to ResourcesMap\n  - Purpose: Make resource available to Terraform\n  - _Leverage: existing resource registrations_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer | Task: Add entry to ResourcesMap in provider.go: \"rtx_dhcp_scope\": resourceRTXDHCPScope() | Restrictions: Do not modify other resource entries, maintain alphabetical order if present | _Leverage: internal/provider/provider.go existing pattern | _Requirements: Requirement 1 | Success: Provider compiles with new resource registered | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 12. Create resource unit tests\n  - File: internal/provider/resource_rtx_dhcp_scope_test.go (new)\n  - Test schema validation\n  - Test CRUD operations with mock client\n  - Test import functionality\n  - Purpose: Ensure resource reliability\n  - _Leverage: resource_rtx_dhcp_binding_test.go patterns_\n  - _Requirements: 1, 5_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Test Developer with Terraform SDK experience | Task: Create unit tests for resource_rtx_dhcp_scope.go. Test schema validation (invalid CIDR, too many DNS servers). Test CRUD operations with mocked client. Test import with valid and invalid IDs | Restrictions: Use terraform-plugin-sdk testing utilities, mock API client | _Leverage: internal/provider/resource_rtx_dhcp_binding_test.go | _Requirements: Requirements 1, 5 | Success: All tests pass, good coverage of validation and CRUD paths | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n## Phase 4: Integration and Documentation\n\n- [ ] 13. Create acceptance tests\n  - File: internal/provider/resource_rtx_dhcp_scope_acc_test.go (new)\n  - Test full lifecycle with real RTX router (when TF_ACC=1)\n  - Test scope creation with all parameters\n  - Test scope update\n  - Test scope import\n  - Test dependency with rtx_dhcp_binding\n  - Purpose: Validate end-to-end functionality\n  - _Leverage: resource_rtx_dhcp_binding_test.go acceptance test patterns_\n  - _Requirements: 1, 5, 6_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Acceptance Test Developer | Task: Create acceptance tests using terraform-plugin-sdk/v2/helper/resource. Test config with scope creation, update DNS servers, import existing scope. Test rtx_dhcp_binding depends_on rtx_dhcp_scope. Use TF_ACC environment check | Restrictions: Tests require real RTX router, use skip if TF_ACC not set | _Leverage: existing acceptance test patterns | _Requirements: Requirements 1, 5, 6 | Success: Acceptance tests pass against real RTX router | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 14. Add example Terraform configurations\n  - File: examples/dhcp_scope/main.tf (new)\n  - Basic scope creation example\n  - Scope with all options example\n  - Scope with binding dependency example\n  - Purpose: User documentation and testing\n  - _Leverage: examples/dhcp/ existing examples_\n  - _Requirements: 1, 6_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with Terraform expertise | Task: Create example Terraform configurations. Basic: scope with network only. Full: scope with gateway, dns_servers, lease_time, exclude_ranges. Integration: rtx_dhcp_scope with rtx_dhcp_binding showing dependency | Restrictions: Use realistic IP addresses, include comments explaining options | _Leverage: examples/dhcp/ | _Requirements: Requirements 1, 6 | Success: Examples are valid Terraform, demonstrate all features | After completing, use log-implementation tool to record details, then mark as [x] complete_\n\n- [ ] 15. Final integration testing and cleanup\n  - Run all tests: go test ./...\n  - Run acceptance tests: TF_ACC=1 go test ./... -v\n  - Build provider: go build -o terraform-provider-rtx\n  - Test examples manually\n  - Purpose: Ensure everything works together\n  - _Leverage: Makefile or existing build scripts_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec rtx-dhcp-scope, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Run full test suite, fix any failures. Build provider and test with examples. Verify terraform plan/apply/destroy cycle works. Check terraform import functionality. Ensure no regressions in existing resources | Restrictions: All tests must pass, no compiler warnings | _Leverage: Makefile, existing CI scripts | _Requirements: All requirements | Success: All tests pass, provider builds cleanly, examples work end-to-end | After completing, use log-implementation tool to record details, then mark as [x] complete_\n",
  "fileStats": {
    "size": 18087,
    "lines": 171,
    "lastModified": "2026-01-18T13:44:06.762Z"
  },
  "comments": []
}