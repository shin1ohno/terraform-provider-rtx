{
  "id": "snapshot_1769346953057_f9oeng5sh",
  "approvalId": "approval_1769346952866_2fblfvjf2",
  "approvalTitle": "Design: State Drift Fix for Access List Resources",
  "version": 1,
  "timestamp": "2026-01-25T13:15:53.057Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: State Drift Fix for Access List Resources\n\n## Overview\n\nThis design addresses persistent terraform plan diffs where Read functions don't properly preserve state for access list related attributes. The fix ensures that configuration values set by Terraform are correctly maintained in state across plan/apply cycles.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n> **Terraform State Handling**: Persist only configuration attributes in Terraform state; Do not store operational/runtime status values to avoid perpetual diffs\n\nThe access list name attributes (`access_list_ip_in`, etc.) ARE configuration attributes, not runtime status. The current bug prevents them from being persisted correctly.\n\n### Project Structure (structure.md)\n\n- Changes follow the existing service/resource layer separation\n- Parser layer parses filter numbers; service layer handles name-to-number mapping\n- Resource layer manages Terraform schema and state\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **InterfaceService**: Already has `fromParserConfig` method that needs modification\n- **IPv6InterfaceService**: Already has `fromParserConfig` method that needs modification\n- **EthernetFilterService**: Has `fromParserFilterToMACEntry` that needs action normalization fix\n- **DiffSuppressFunc**: Terraform SDK's built-in diff suppression mechanism\n\n### Integration Points\n\n- **Parser Layer**: `parsers.InterfaceConfig` returns `SecureFilterIn []int` (filter numbers), not names\n- **Resource Layer**: Schema expects `access_list_ip_in string` (access list names)\n- **State Management**: Read functions must preserve state values that can't be derived from router\n\n## Architecture\n\nThe key insight is that RTX routers store filter NUMBERS, while Terraform uses access list NAMES for user convenience. There's no way to reverse-lookup names from numbers. The solution is to preserve state values during Read.\n\n```mermaid\ngraph TD\n    subgraph \"Current (Broken)\"\n        A1[terraform apply] --> B1[Set access_list_ip_in = 'wan-secure']\n        B1 --> C1[Service: Map name to filter numbers]\n        C1 --> D1[Router: Store filter numbers]\n        D1 --> E1[terraform plan]\n        E1 --> F1[Read: Parser returns filter numbers]\n        F1 --> G1[Service: fromParserConfig sets empty string]\n        G1 --> H1[State: access_list_ip_in = '' WRONG]\n        H1 --> I1[Diff: '' → 'wan-secure']\n    end\n\n    subgraph \"Fixed\"\n        A2[terraform apply] --> B2[Set access_list_ip_in = 'wan-secure']\n        B2 --> C2[Service: Map name to filter numbers]\n        C2 --> D2[Router: Store filter numbers]\n        D2 --> E2[terraform plan]\n        E2 --> F2[Read: Parser returns filter numbers]\n        F2 --> G2[Resource: Preserve existing state value]\n        G2 --> H2[State: access_list_ip_in = 'wan-secure' CORRECT]\n        H2 --> I2[No diff]\n    end\n```\n\n## Components and Interfaces\n\n### Component 1: Interface Resource Read Logic Fix\n\n- **Purpose:** Preserve access list name attributes during Read\n- **File:** `internal/provider/resource_rtx_interface.go`\n- **Change:** Don't call `d.Set()` for access list attributes when service returns empty; let state keep existing value\n- **Interfaces:** No interface changes\n- **Dependencies:** terraform-plugin-sdk `d.Get()` to check existing value\n\n### Component 2: IPv6 Interface Resource Read Logic Fix\n\n- **Purpose:** Preserve IPv6 access list name attributes during Read\n- **File:** `internal/provider/resource_rtx_ipv6_interface.go`\n- **Change:** Don't call `d.Set()` for access list attributes when service returns empty\n- **Interfaces:** No interface changes\n- **Dependencies:** terraform-plugin-sdk\n\n### Component 3: MAC Access List Entry Normalization Fix\n\n- **Purpose:** Fix ace_action and address field normalization issues\n- **File:** `internal/client/ethernet_filter_service.go`\n- **Changes:**\n  1. Normalize `pass` and `pass-nolog` to consistent value\n  2. Normalize `reject` and `reject-nolog` to consistent value\n  3. Fix `*:*:*:*:*:*` → `*_any = true` conversion\n- **Interfaces:** No interface changes\n- **Dependencies:** None\n\n### Component 4: MAC Access List DiffSuppressFunc\n\n- **Purpose:** Suppress diffs for equivalent action values\n- **File:** `internal/provider/resource_rtx_access_list_mac.go`\n- **Changes:**\n  1. Add `DiffSuppressFunc` to `ace_action` schema field\n  2. Treat \"pass\" = \"pass-nolog\" = \"permit\" as equivalent\n  3. Treat \"reject\" = \"reject-nolog\" = \"deny\" as equivalent\n- **Interfaces:** No interface changes\n- **Dependencies:** terraform-plugin-sdk\n\n### Component 5: MAC Access List Address Field Handling\n\n- **Purpose:** Fix source/destination address vs `*_any` field handling\n- **File:** `internal/provider/resource_rtx_access_list_mac.go`\n- **Changes:**\n  1. When `source_any = true`, don't show diff for `source_address`\n  2. When `destination_any = true`, don't show diff for `destination_address`\n  3. Use `ConflictsWith` or `ExactlyOneOf` schema validation\n- **Interfaces:** No interface changes\n- **Dependencies:** terraform-plugin-sdk\n\n## Data Models\n\nNo data model changes required. Existing models are sufficient:\n\n### InterfaceConfig (unchanged)\n```go\ntype InterfaceConfig struct {\n    Name                    string\n    AccessListIPIn          string\n    AccessListIPOut         string\n    AccessListIPDynamicIn   string\n    AccessListIPDynamicOut  string\n    AccessListMACIn         string\n    AccessListMACOut        string\n    // ... other fields\n}\n```\n\n### AccessListMACEntry (unchanged)\n```go\ntype AccessListMACEntry struct {\n    Sequence           int\n    FilterID           int\n    AceAction          string\n    SourceAny          bool\n    SourceAddress      string\n    DestinationAny     bool\n    DestinationAddress string\n    // ... other fields\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Access list not found during apply**\n   - **Handling:** Return error with clear message about missing access list\n   - **User Impact:** Apply fails with descriptive error\n\n2. **Invalid filter numbers from router**\n   - **Handling:** Log warning, continue with best effort\n   - **User Impact:** State may be incomplete but not fail\n\n## Testing Strategy\n\n### Unit Testing\n\n- Test `DiffSuppressFunc` with all action value combinations\n- Test address normalization with wildcard patterns\n- Test state preservation logic in mock scenarios\n\n### Integration Testing\n\n- Verify `terraform plan` shows no changes after `terraform apply`\n- Verify import works correctly and subsequent plan shows no drift\n- Test with various access list configurations\n\n### End-to-End Testing\n\n- Apply interface with access list bindings\n- Run `terraform plan` - expect \"No changes\"\n- Modify access list entries, apply\n- Run `terraform plan` - expect \"No changes\"\n",
  "fileStats": {
    "size": 6777,
    "lines": 180,
    "lastModified": "2026-01-25T13:15:48.321Z"
  },
  "comments": []
}