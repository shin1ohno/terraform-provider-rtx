{
  "id": "snapshot_1769085424115_fbzj73fe9",
  "approvalId": "approval_1769085424106_i7iezsbn1",
  "approvalTitle": "Design: Test Architecture for 15 Resources",
  "version": 1,
  "timestamp": "2026-01-22T12:37:04.115Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Comprehensive CRUD Tests\n\n## Overview\n\nThis design defines the test architecture for adding comprehensive CRUD tests to 15 Provider resources and 15 Client services. Tests follow established patterns using MockExecutor for Client tests and schema.TestResourceDataRaw for Provider tests.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Go 1.21+ with testify/mock for mocking\n- Terraform Plugin SDK v2 testing utilities\n- Table-driven tests for comprehensive coverage\n- Real RTX command formats in test fixtures\n\n### Project Structure (structure.md)\n- Client tests: `internal/client/*_service_test.go`\n- Provider tests: `internal/provider/resource_rtx_*_test.go`\n- Test helpers reused from existing patterns\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **MockExecutor**: Mock SSH executor for Client tests (`internal/client/executor.go`)\n- **schema.TestResourceDataRaw**: Terraform SDK testing utility for Provider tests\n- **testify/assert**: Assertion library for readable test code\n- **Existing test fixtures**: Real RTX command/response formats from parser tests\n\n### Integration Points\n\n- **Parser layer**: Reuse RTX command formats from `internal/rtx/parsers/*_test.go`\n- **Interfaces**: Use `internal/client/interfaces.go` type definitions\n\n## Architecture\n\n### Test Patterns\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                     Test Architecture                        │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Provider Tests                    Client Tests             │\n│  ┌─────────────────────┐          ┌─────────────────────┐  │\n│  │ TestResourceDataRaw │          │    MockExecutor     │  │\n│  │         ↓           │          │         ↓           │  │\n│  │ Build*FromResource  │          │   Service.Get()     │  │\n│  │         ↓           │          │   Service.Create()  │  │\n│  │   Assert fields     │          │   Service.Update()  │  │\n│  └─────────────────────┘          │   Service.Delete()  │  │\n│                                    │         ↓           │  │\n│                                    │  Assert commands    │  │\n│                                    │  Assert parsing     │  │\n│                                    └─────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n## Components and Interfaces\n\n### Client Test Pattern\n\n- **Purpose:** Test SSH command generation and response parsing\n- **Interfaces:** Table-driven tests with `mockSetup`, `expected`, `expectedErr`\n- **Dependencies:** MockExecutor, testify/mock, testify/assert\n- **Reuses:** MockExecutor pattern from dns_service_test.go\n\n```go\nfunc TestXxxService_Get(t *testing.T) {\n    tests := []struct {\n        name        string\n        mockSetup   func(*MockExecutor)\n        expected    *XxxConfig\n        expectedErr bool\n        errMessage  string\n    }{...}\n\n    for _, tt := range tests {\n        t.Run(tt.name, func(t *testing.T) {\n            mockExecutor := new(MockExecutor)\n            tt.mockSetup(mockExecutor)\n\n            service := &XxxService{executor: mockExecutor}\n            result, err := service.Get(context.Background())\n\n            // assertions...\n            mockExecutor.AssertExpectations(t)\n        })\n    }\n}\n```\n\n### Provider Test Pattern\n\n- **Purpose:** Test Terraform schema handling and data conversion\n- **Interfaces:** schema.TestResourceDataRaw with map[string]interface{}\n- **Dependencies:** terraform-plugin-sdk/v2/helper/schema\n- **Reuses:** Pattern from resource_rtx_dns_server_test.go\n\n```go\nfunc TestBuildXxxFromResourceData_BasicConfig(t *testing.T) {\n    resourceData := schema.TestResourceDataRaw(t, resourceRTXXxx().Schema, map[string]interface{}{\n        \"field1\": \"value1\",\n        \"field2\": 123,\n    })\n\n    config := buildXxxFromResourceData(resourceData)\n\n    // assertions...\n}\n```\n\n## Test Coverage Matrix\n\n### Client Layer Tests (15 services)\n\n| Service | Get | Create | Update | Delete | Edge Cases |\n|---------|-----|--------|--------|--------|------------|\n| bgp_service | ✓ | ✓ | ✓ | ✓ | Empty config, partial neighbors |\n| dhcp_scope_service | ✓ | ✓ | ✓ | ✓ | IP range format, expire time |\n| ipsec_tunnel_service | ✓ | ✓ | ✓ | ✓ | Multiple SAs, transport mode |\n| nat_masquerade_service | ✓ | ✓ | ✓ | ✓ | Protocol-only entries |\n| nat_static_service | ✓ | ✓ | ✓ | ✓ | Port mappings, IP ranges |\n| ospf_service | ✓ | ✓ | ✓ | ✓ | Multiple areas, networks |\n| pptp_service | ✓ | ✓ | ✓ | ✓ | Server/client modes |\n| system_service | ✓ | ✓ | ✓ | ✓ | Timezone, console settings |\n| config_service | ✓ | - | - | - | Show config parsing |\n| ethernet_filter_service | ✓ | ✓ | ✓ | ✓ | MAC filter rules |\n| interface_service | ✓ | ✓ | ✓ | ✓ | Multiple interface types |\n| ip_filter_service | ✓ | ✓ | ✓ | ✓ | Extended ACLs |\n| ipsec_transport_service | ✓ | ✓ | ✓ | ✓ | SA policies |\n| ipv6_prefix_service | ✓ | ✓ | ✓ | ✓ | Prefix delegation |\n| schedule_service | ✓ | ✓ | ✓ | ✓ | Time schedules |\n| syslog_service | ✓ | ✓ | ✓ | ✓ | Multiple hosts |\n| vlan_service | ✓ | ✓ | ✓ | ✓ | Tagged/untagged ports |\n\n### Provider Layer Tests (15 resources)\n\n| Resource | Build | Read | Validation | Edge Cases |\n|----------|-------|------|------------|------------|\n| rtx_access_list_extended | ✓ | ✓ | ✓ | Multiple rules, any/host |\n| rtx_access_list_extended_ipv6 | ✓ | ✓ | ✓ | IPv6 prefixes |\n| rtx_access_list_mac | ✓ | ✓ | ✓ | MAC address formats |\n| rtx_bgp | ✓ | ✓ | ✓ | Multiple neighbors, AS |\n| rtx_dhcp_scope | ✓ | ✓ | ✓ | IP ranges, options |\n| rtx_interface_acl | ✓ | ✓ | ✓ | In/out directions |\n| rtx_interface_mac_acl | ✓ | ✓ | ✓ | MAC ACL binding |\n| rtx_ipsec_tunnel | ✓ | ✓ | ✓ | SA policies, IKE |\n| rtx_l2tp | ✓ | ✓ | ✓ | Tunnel parameters |\n| rtx_nat_masquerade | ✓ | ✓ | ✓ | Static entries, protocols |\n| rtx_nat_static | ✓ | ✓ | ✓ | Port mappings |\n| rtx_ospf | ✓ | ✓ | ✓ | Areas, networks |\n| rtx_pptp | ✓ | ✓ | ✓ | Server settings |\n| rtx_static_route | ✓ | ✓ | ✓ | Gateway, interface |\n| rtx_system | ✓ | ✓ | ✓ | Timezone, console |\n\n## Data Models\n\n### Test Case Structure (Client)\n\n```go\ntype clientTestCase struct {\n    name        string                    // Test description\n    mockSetup   func(*MockExecutor)       // Mock expectations\n    expected    interface{}               // Expected result\n    expectedErr bool                      // Error expected?\n    errMessage  string                    // Error substring to match\n}\n```\n\n### Test Case Structure (Provider)\n\n```go\ntype providerTestCase struct {\n    name     string                      // Test description\n    input    map[string]interface{}      // Schema input\n    expected interface{}                 // Expected config\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Connection failure**\n   - **Handling:** MockExecutor returns error\n   - **Test Verify:** Error propagated correctly\n\n2. **Parse error**\n   - **Handling:** Invalid response format\n   - **Test Verify:** Meaningful error message\n\n3. **Validation error**\n   - **Handling:** Invalid configuration values\n   - **Test Verify:** Validation rejects bad input\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Client tests:** Mock SSH execution, verify command generation\n- **Provider tests:** Mock schema data, verify conversion functions\n- **Coverage target:** 80%+ line coverage per file\n\n### Test Organization\n\nEach test file follows this structure:\n1. Test Get/Read operations (successful cases)\n2. Test Create operations (successful cases)\n3. Test Update operations (successful cases)\n4. Test Delete operations (successful cases)\n5. Test error handling cases\n6. Test edge cases (empty config, partial config)\n\n### RTX Command Examples\n\nTests should use real RTX command formats:\n\n```\n# BGP\nbgp use on\nbgp local-as 65001\nbgp neighbor 1 address 192.168.1.1 remote-as 65002\n\n# DHCP Scope\ndhcp scope 1 192.168.1.20-192.168.1.99/24 gateway 192.168.1.1\n\n# IPsec Tunnel\nipsec tunnel 1\nipsec sa policy 101 1 esp aes-cbc sha-hmac\n\n# NAT Masquerade\nnat descriptor masquerade static 1000 1 192.168.1.1 tcp 80\n\n# OSPF\nospf use on\nospf area backbone\nospf area 0.0.0.1 stub\n\n# PPTP\npptp service on\npptp tunnel 1\n\n# System\ntimezone jst\nconsole character euc\n```\n",
  "fileStats": {
    "size": 9175,
    "lines": 247,
    "lastModified": "2026-01-22T12:36:59.123Z"
  },
  "comments": []
}