{
  "id": "snapshot_1769087842523_jg0ug6qbv",
  "approvalId": "approval_1769087793709_xwyicyayx",
  "approvalTitle": "Design Document - All Resources Use Batch Execution",
  "version": 2,
  "timestamp": "2026-01-22T13:17:22.523Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Comprehensive CRUD Tests\n\n## Overview\n\nThis design defines the test architecture for adding comprehensive CRUD tests to 15 Provider resources and 15 Client services. Tests follow established patterns using MockExecutor for Client tests and schema.TestResourceDataRaw for Provider tests.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Go 1.21+ with testify/mock for mocking\n- Terraform Plugin SDK v2 testing utilities\n- Table-driven tests for comprehensive coverage\n- Real RTX command formats in test fixtures\n\n### Project Structure (structure.md)\n- Client tests: `internal/client/*_service_test.go`\n- Provider tests: `internal/provider/resource_rtx_*_test.go`\n- Test helpers reused from existing patterns\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **MockExecutor**: Mock SSH executor for Client tests (`internal/client/executor.go`)\n- **schema.TestResourceDataRaw**: Terraform SDK testing utility for Provider tests\n- **testify/assert**: Assertion library for readable test code\n- **Existing test fixtures**: Real RTX command/response formats from parser tests\n\n### Integration Points\n\n- **Parser layer**: Reuse RTX command formats from `internal/rtx/parsers/*_test.go`\n- **Interfaces**: Use `internal/client/interfaces.go` type definitions\n\n## Architecture\n\n### Test Patterns\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                     Test Architecture                        │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Provider Tests                    Client Tests             │\n│  ┌─────────────────────┐          ┌─────────────────────┐  │\n│  │ TestResourceDataRaw │          │    MockExecutor     │  │\n│  │         ↓           │          │         ↓           │  │\n│  │ Build*FromResource  │          │   Service.Get()     │  │\n│  │         ↓           │          │   Service.Create()  │  │\n│  │   Assert fields     │          │   Service.Update()  │  │\n│  └─────────────────────┘          │   Service.Delete()  │  │\n│                                    │         ↓           │  │\n│                                    │  Assert commands    │  │\n│                                    │  Assert parsing     │  │\n│                                    └─────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n## Components and Interfaces\n\n### Client Test Pattern\n\n- **Purpose:** Test SSH command generation and response parsing\n- **Interfaces:** Table-driven tests with `mockSetup`, `expected`, `expectedErr`\n- **Dependencies:** MockExecutor, testify/mock, testify/assert\n- **Reuses:** MockExecutor pattern from dns_service_test.go\n\n#### Get (単一コマンド)\n```go\nfunc TestXxxService_Get(t *testing.T) {\n    tests := []struct {\n        name        string\n        mockSetup   func(*MockExecutor)\n        expected    *XxxConfig\n        expectedErr bool\n        errMessage  string\n    }{...}\n\n    for _, tt := range tests {\n        t.Run(tt.name, func(t *testing.T) {\n            mockExecutor := new(MockExecutor)\n            tt.mockSetup(mockExecutor)\n\n            service := &XxxService{executor: mockExecutor}\n            result, err := service.Get(context.Background())\n\n            // assertions...\n            mockExecutor.AssertExpectations(t)\n        })\n    }\n}\n```\n\n#### Create/Update/Delete (バッチ送信)\n```go\nfunc TestXxxService_Create(t *testing.T) {\n    tests := []struct {\n        name             string\n        config           *XxxConfig\n        expectedCommands []string  // バッチで送信されるコマンド列\n        mockResponse     string\n        expectedErr      bool\n    }{\n        {\n            name: \"create basic config\",\n            config: &XxxConfig{\n                Enabled: true,\n                Value:   \"test\",\n            },\n            expectedCommands: []string{\n                \"xxx use on\",\n                \"xxx value test\",\n            },\n            mockResponse: \"# xxx use on\\n# xxx value test\\n>\",\n            expectedErr:  false,\n        },\n    }\n\n    for _, tt := range tests {\n        t.Run(tt.name, func(t *testing.T) {\n            mockExecutor := new(MockExecutor)\n            // バッチ送信をモック\n            mockExecutor.On(\"RunBatch\", mock.Anything, tt.expectedCommands).\n                Return([]byte(tt.mockResponse), nil)\n\n            service := &XxxService{executor: mockExecutor}\n            err := service.Create(context.Background(), tt.config)\n\n            if tt.expectedErr {\n                assert.Error(t, err)\n            } else {\n                assert.NoError(t, err)\n            }\n            mockExecutor.AssertExpectations(t)\n        })\n    }\n}\n```\n\n### Provider Test Pattern\n\n- **Purpose:** Test Terraform schema handling and data conversion\n- **Interfaces:** schema.TestResourceDataRaw with map[string]interface{}\n- **Dependencies:** terraform-plugin-sdk/v2/helper/schema\n- **Reuses:** Pattern from resource_rtx_dns_server_test.go\n\n```go\nfunc TestBuildXxxFromResourceData_BasicConfig(t *testing.T) {\n    resourceData := schema.TestResourceDataRaw(t, resourceRTXXxx().Schema, map[string]interface{}{\n        \"field1\": \"value1\",\n        \"field2\": 123,\n    })\n\n    config := buildXxxFromResourceData(resourceData)\n\n    // assertions...\n}\n```\n\n## Test Coverage Matrix\n\n### Client Layer Tests (15 services)\n\n| Service | Get | Create | Update | Delete | Edge Cases |\n|---------|-----|--------|--------|--------|------------|\n| bgp_service | ✓ | ✓ | ✓ | ✓ | Empty config, partial neighbors |\n| dhcp_scope_service | ✓ | ✓ | ✓ | ✓ | IP range format, expire time |\n| ipsec_tunnel_service | ✓ | ✓ | ✓ | ✓ | Multiple SAs, transport mode |\n| nat_masquerade_service | ✓ | ✓ | ✓ | ✓ | Protocol-only entries |\n| nat_static_service | ✓ | ✓ | ✓ | ✓ | Port mappings, IP ranges |\n| ospf_service | ✓ | ✓ | ✓ | ✓ | Multiple areas, networks |\n| pptp_service | ✓ | ✓ | ✓ | ✓ | Server/client modes |\n| system_service | ✓ | ✓ | ✓ | ✓ | Timezone, console settings |\n| config_service | ✓ | - | - | - | Show config parsing |\n| ethernet_filter_service | ✓ | ✓ | ✓ | ✓ | MAC filter rules |\n| interface_service | ✓ | ✓ | ✓ | ✓ | Multiple interface types |\n| ip_filter_service | ✓ | ✓ | ✓ | ✓ | Extended ACLs |\n| ipsec_transport_service | ✓ | ✓ | ✓ | ✓ | SA policies |\n| ipv6_prefix_service | ✓ | ✓ | ✓ | ✓ | Prefix delegation |\n| schedule_service | ✓ | ✓ | ✓ | ✓ | Time schedules |\n| syslog_service | ✓ | ✓ | ✓ | ✓ | Multiple hosts |\n| vlan_service | ✓ | ✓ | ✓ | ✓ | Tagged/untagged ports |\n\n### Provider Layer Tests (15 resources)\n\n| Resource | Build | Read | Validation | Edge Cases |\n|----------|-------|------|------------|------------|\n| rtx_access_list_extended | ✓ | ✓ | ✓ | Multiple rules, any/host |\n| rtx_access_list_extended_ipv6 | ✓ | ✓ | ✓ | IPv6 prefixes |\n| rtx_access_list_mac | ✓ | ✓ | ✓ | MAC address formats |\n| rtx_bgp | ✓ | ✓ | ✓ | Multiple neighbors, AS |\n| rtx_dhcp_scope | ✓ | ✓ | ✓ | IP ranges, options |\n| rtx_interface_acl | ✓ | ✓ | ✓ | In/out directions |\n| rtx_interface_mac_acl | ✓ | ✓ | ✓ | MAC ACL binding |\n| rtx_ipsec_tunnel | ✓ | ✓ | ✓ | SA policies, IKE |\n| rtx_l2tp | ✓ | ✓ | ✓ | Tunnel parameters |\n| rtx_nat_masquerade | ✓ | ✓ | ✓ | Static entries, protocols |\n| rtx_nat_static | ✓ | ✓ | ✓ | Port mappings |\n| rtx_ospf | ✓ | ✓ | ✓ | Areas, networks |\n| rtx_pptp | ✓ | ✓ | ✓ | Server settings |\n| rtx_static_route | ✓ | ✓ | ✓ | Gateway, interface |\n| rtx_system | ✓ | ✓ | ✓ | Timezone, console |\n\n## Data Models\n\n### Test Case Structure (Client)\n\n```go\ntype clientTestCase struct {\n    name        string                    // Test description\n    mockSetup   func(*MockExecutor)       // Mock expectations\n    expected    interface{}               // Expected result\n    expectedErr bool                      // Error expected?\n    errMessage  string                    // Error substring to match\n}\n```\n\n### Test Case Structure (Provider)\n\n```go\ntype providerTestCase struct {\n    name     string                      // Test description\n    input    map[string]interface{}      // Schema input\n    expected interface{}                 // Expected config\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Connection failure**\n   - **Handling:** MockExecutor returns error\n   - **Test Verify:** Error propagated correctly\n\n2. **Parse error**\n   - **Handling:** Invalid response format\n   - **Test Verify:** Meaningful error message\n\n3. **Validation error**\n   - **Handling:** Invalid configuration values\n   - **Test Verify:** Validation rejects bad input\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Client tests:** Mock SSH execution, verify command generation\n- **Provider tests:** Mock schema data, verify conversion functions\n- **Coverage target:** 80%+ line coverage per file\n\n### Test Organization\n\nEach test file follows this structure:\n1. Test Get/Read operations (successful cases)\n2. Test Create operations (successful cases)\n3. Test Update operations (successful cases)\n4. Test Delete operations (successful cases)\n5. Test error handling cases\n6. Test edge cases (empty config, partial config)\n\n## RTX Command Specification by CRUD Operation\n\n### 1. BGP (Border Gateway Protocol)\n\n#### Read (Get)\n```\nshow config | grep bgp\n```\n**Response parsing:**\n```\nbgp use on\nbgp autonomous-system 65001\nbgp router id 10.0.0.1\nbgp neighbor 1 address 192.168.1.2 as 65002\nbgp neighbor 1 hold-time 90\nbgp import filter 1 include 10.0.0.0/8\nbgp import from static\n```\n\n#### Create\n```\nbgp use on\nbgp autonomous-system 65001\nbgp router id 10.0.0.1\nbgp neighbor 1 address 192.168.1.2 as 65002\nbgp neighbor 1 hold-time 90\nbgp neighbor 1 keepalive 30\nbgp neighbor 1 password secret123\nbgp import filter 1 include 10.0.0.0/8\nbgp import from static\n```\n\n#### Update\n```\n# Remove old settings first\nno bgp neighbor 1\nno bgp import filter 1\nno bgp import from static\n# Apply new settings\nbgp neighbor 1 address 192.168.1.3 as 65003\nbgp neighbor 1 hold-time 180\nbgp import filter 1 include 172.16.0.0/12\n# Apply configuration to running router (required)\nbgp configure refresh\n```\n\n#### Delete\n```\nno bgp neighbor 1\nno bgp import filter 1\nno bgp import from static\nno bgp import from connected\nbgp use off\n```\n\n---\n\n### 2. DHCP Scope\n\n#### Read (Get)\n```\nshow config | grep \"dhcp scope\"\n```\n**Response parsing:**\n```\ndhcp scope 1 192.168.1.0/24 expire 24:00\ndhcp scope option 1 dns=8.8.8.8,8.8.4.4 router=192.168.1.1 domain=example.com\ndhcp scope 1 except 192.168.1.1-192.168.1.10\n```\nOr IP range format:\n```\ndhcp scope 1 192.168.1.20-192.168.1.99/16 gateway 192.168.1.253\n```\n\n#### Create\n```\ndhcp scope 1 192.168.1.0/24 expire 24:00\ndhcp scope option 1 dns=8.8.8.8,8.8.4.4\ndhcp scope option 1 router=192.168.1.1\ndhcp scope option 1 domain=example.com\ndhcp scope 1 except 192.168.1.1-192.168.1.10\n```\n\n#### Update\n```\n# Remove old scope completely\nno dhcp scope 1 except 192.168.1.1-192.168.1.10\nno dhcp scope option 1\nno dhcp scope 1\n# Create with new settings\ndhcp scope 1 192.168.1.0/24 expire 12:00\ndhcp scope option 1 dns=1.1.1.1\ndhcp scope option 1 router=192.168.1.254\n```\n\n#### Delete\n```\nno dhcp scope 1 except 192.168.1.1-192.168.1.10\nno dhcp scope option 1\nno dhcp scope 1\n```\n\n---\n\n### 3. IPsec Tunnel\n\n#### Read (Get)\n```\nshow config | grep ipsec\nshow config | grep \"tunnel select\"\n```\n**Response parsing:**\n```\ntunnel select 1\nipsec tunnel 1\nipsec ike local address 1 192.168.1.1\nipsec ike remote address 1 203.0.113.1\nipsec ike pre-shared-key 1 text mysecret\nipsec ike encryption 1 aes256\nipsec ike hash 1 sha256\nipsec ike group 1 modp2048\nipsec ike keepalive use 1 on dpd 30 3\nipsec sa policy 101 1 esp aes256-cbc sha256-hmac\n```\n\n#### Create\n```\ntunnel select 1\nipsec tunnel 1\nipsec ike local address 1 192.168.1.1\nipsec ike remote address 1 203.0.113.1\nipsec ike pre-shared-key 1 text mysecret\nipsec ike encryption 1 aes256\nipsec ike hash 1 sha256\nipsec ike group 1 modp2048\nipsec ike keepalive use 1 on dpd 30 3\nipsec sa policy 101 1 esp aes256-cbc sha256-hmac\ntunnel enable 1\n```\n\n#### Update (Atomic Update Pattern)\n```\n# Phase 1: SendBatch - 一括送信（saveなし）\ntunnel select 1\nipsec ike remote address 1 203.0.113.2\nipsec ike encryption 1 aes128\nipsec ike keepalive use 1 on dpd 60 5\ntunnel disable 1\ntunnel enable 1\n# ← この時点で接続が切断される（想定内）\n\n# Phase 2: Polling - VPN再確立を待つ\n\n# Phase 3: Reconnect & Save\nsave\n```\n\n#### Delete\n```\ntunnel select 1\ntunnel disable 1\nno ipsec sa policy 101\nno ipsec ike keepalive use 1\nno ipsec ike pre-shared-key 1\nno ipsec ike remote address 1\nno ipsec ike local address 1\nno ipsec tunnel 1\nno tunnel select 1\n```\n\n---\n\n### 4. NAT Masquerade\n\n#### Read (Get)\n```\nshow config | grep \"nat descriptor\"\n```\n**Response parsing:**\n```\nnat descriptor type 1000 masquerade\nnat descriptor address outer 1000 ipcp\nnat descriptor address inner 1000 192.168.1.0-192.168.1.255\nnat descriptor masquerade static 1000 1 192.168.1.253 esp\nnat descriptor masquerade static 1000 2 192.168.1.100:80=192.168.1.100:8080 tcp\nip pp nat descriptor 1000\n```\n\n#### Create\n```\nnat descriptor type 1000 masquerade\nnat descriptor address outer 1000 ipcp\nnat descriptor address inner 1000 192.168.1.0-192.168.1.255\nnat descriptor masquerade static 1000 1 192.168.1.253 esp\nnat descriptor masquerade static 1000 2 192.168.1.100:80=192.168.1.100:8080 tcp\nip pp nat descriptor 1000\n```\n\n#### Update\n```\n# Modify static entries\nno nat descriptor masquerade static 1000 2\nnat descriptor masquerade static 1000 2 192.168.1.101:443=192.168.1.101:8443 tcp\n# Add new entry\nnat descriptor masquerade static 1000 3 192.168.1.102:22=192.168.1.102:22 tcp\n```\n\n#### Delete\n```\nno ip pp nat descriptor 1000\nno nat descriptor masquerade static 1000 1\nno nat descriptor masquerade static 1000 2\nno nat descriptor address inner 1000\nno nat descriptor address outer 1000\nno nat descriptor type 1000\n```\n\n---\n\n### 5. NAT Static\n\n#### Read (Get)\n```\nshow config | grep \"nat descriptor\"\n```\n**Response parsing:**\n```\nnat descriptor type 2000 static\nnat descriptor static 2000 203.0.113.10=192.168.1.10\nnat descriptor static 2000 203.0.113.11:80=192.168.1.11:8080 tcp\nip wan nat descriptor 2000\n```\n\n#### Create\n```\nnat descriptor type 2000 static\nnat descriptor static 2000 203.0.113.10=192.168.1.10\nnat descriptor static 2000 203.0.113.11:80=192.168.1.11:8080 tcp\nip wan nat descriptor 2000\n```\n\n#### Update\n```\nno nat descriptor static 2000 203.0.113.10=192.168.1.10\nnat descriptor static 2000 203.0.113.10=192.168.1.20\n```\n\n#### Delete\n```\nno ip wan nat descriptor 2000\nno nat descriptor static 2000 203.0.113.10=192.168.1.10\nno nat descriptor static 2000 203.0.113.11:80=192.168.1.11:8080 tcp\nno nat descriptor type 2000\n```\n\n---\n\n### 6. OSPF\n\n#### Read (Get)\n```\nshow config | grep ospf\n```\n**Response parsing:**\n```\nospf use on\nospf router id 10.0.0.1\nospf area backbone\nospf area 0.0.0.1 stub\nospf area 0.0.0.2 nssa no-summary\nip lan1 ospf area backbone\nip tunnel1 ospf area 0.0.0.1\nospf import from static\nospf import from connected\n```\n\n#### Create\n```\nospf use on\nospf router id 10.0.0.1\nospf area backbone\nospf area 0.0.0.1 stub\nip lan1 ospf area backbone\nip tunnel1 ospf area 0.0.0.1\nospf import from static\n```\n\n#### Update\n```\n# Change area type\nno ospf area 0.0.0.1 stub\nospf area 0.0.0.1 nssa\n# Add new interface to area\nip lan2 ospf area backbone\n# Apply configuration to running router (required)\nospf configure refresh\n```\n\n#### Delete\n```\nno ip lan1 ospf area\nno ip tunnel1 ospf area\nno ospf import from static\nno ospf import from connected\nno ospf area 0.0.0.1\nno ospf area backbone\nospf use off\n```\n\n---\n\n### 7. PPTP\n\n#### Read (Get)\n```\nshow config | grep pptp\nshow config | grep \"pp select anonymous\"\nshow config | grep \"pp auth\"\n```\n**Response parsing:**\n```\npptp service on\npptp tunnel disconnect time 900\npptp keepalive use on\npp select anonymous\npp auth accept mschap-v2\npp auth myname user1 password123\nppp ccp type mppe-128 require\nip pp remote address pool 192.168.1.100-192.168.1.150\n```\n\n#### Create\n```\npptp service on\npptp tunnel disconnect time 900\npptp keepalive use on\npp select anonymous\npp auth accept mschap-v2\npp auth myname user1 password123\nppp ccp type mppe-128 require\nip pp remote address pool 192.168.1.100-192.168.1.150\n```\n\n#### Update\n```\npptp tunnel disconnect time 1800\npp select anonymous\npp auth myname newuser newpassword\nip pp remote address pool 192.168.1.200-192.168.1.250\n```\n\n#### Delete\n```\npp select anonymous\nno ip pp remote address pool\nno ppp ccp type\nno pp auth myname\nno pp auth accept\npptp keepalive use off\npptp service off\n```\n\n---\n\n### 8. L2TP\n\n#### Read (Get)\n```\nshow config | grep l2tp\nshow config | grep \"tunnel select\"\nshow config | grep \"tunnel encapsulation\"\n```\n**Response parsing (L2TPv2 LNS):**\n```\nl2tp service on\npp select anonymous\npp bind tunnel1\npp auth accept mschap-v2\nip pp remote address pool 192.168.1.100-192.168.1.150\n```\n**Response parsing (L2TPv3):**\n```\ntunnel select 1\ntunnel encapsulation l2tpv3\ntunnel endpoint address 10.0.0.1 203.0.113.1\nl2tp local router-id 10.0.0.1\nl2tp remote router-id 10.0.0.2\nl2tp remote end-id remote-router\nl2tp always-on on\nl2tp keepalive use on 30 3\nl2tp tunnel disconnect time 900\n```\n\n#### Create (L2TPv3)\n```\ntunnel select 1\ntunnel encapsulation l2tpv3\ntunnel endpoint address 10.0.0.1 203.0.113.1\nl2tp local router-id 10.0.0.1\nl2tp remote router-id 10.0.0.2\nl2tp remote end-id remote-router\nl2tp always-on on\nl2tp keepalive use on 30 3\ntunnel enable 1\n```\n\n#### Update (Atomic Update Pattern)\n```\n# Phase 1: SendBatch - 一括送信（saveなし）\ntunnel select 1\nl2tp keepalive use on 60 5\nl2tp tunnel disconnect time 1800\ntunnel disable 1\ntunnel enable 1\n# ← この時点で接続が切断される（想定内）\n\n# Phase 2: Polling - VPN再確立を待つ\n\n# Phase 3: Reconnect & Save\nsave\n```\n\n#### Delete\n```\ntunnel select 1\ntunnel disable 1\nl2tp keepalive use off\nno l2tp remote end-id\nno l2tp remote router-id\nno l2tp local router-id\nno tunnel endpoint address\nno tunnel encapsulation\nno tunnel select 1\n```\n\n---\n\n### 9. System Configuration\n\n#### Read (Get)\n```\nshow config | grep timezone\nshow config | grep console\nshow config | grep \"system packet-buffer\"\nshow config | grep statistics\n```\n**Response parsing:**\n```\ntimezone +09:00\nconsole character ja.utf8\nconsole lines 24\nconsole prompt \"RTX>\"\nsystem packet-buffer small max-buffer=5000 max-free=1300\nstatistics traffic on\nstatistics nat on\n```\n\n#### Create/Update\n```\ntimezone +09:00\nconsole character ja.utf8\nconsole lines infinity\nconsole prompt \"Router>\"\nsystem packet-buffer small max-buffer=5000 max-free=1300\nstatistics traffic on\nstatistics nat on\n```\n\n#### Delete (Reset to defaults)\n```\nno timezone\nno console character\nno console lines\nno console prompt\nno system packet-buffer small\nno statistics traffic\nno statistics nat\n```\n\n---\n\n### 10. Static Route\n\n#### Read (Get)\n```\nshow config | grep \"ip route\"\n```\n**Response parsing:**\n```\nip route default gateway pp 1\nip route 10.0.0.0/8 gateway 192.168.1.1\nip route 172.16.0.0/12 gateway tunnel 1\nip route 192.168.100.0/24 gateway pp 1 weight 10\n```\n\n#### Create\n```\nip route default gateway pp 1\nip route 10.0.0.0/8 gateway 192.168.1.1\nip route 172.16.0.0/12 gateway tunnel 1\n```\n\n#### Update\n```\nno ip route 10.0.0.0/8\nip route 10.0.0.0/8 gateway 192.168.1.254\n```\n\n#### Delete\n```\nno ip route default\nno ip route 10.0.0.0/8\nno ip route 172.16.0.0/12\n```\n\n---\n\n### 11. Access List Extended (IPv4)\n\n#### Read (Get)\n```\nshow config | grep \"ip access-list\"\nshow config | grep \"ip .* access-group\"\n```\n**Response parsing:**\n```\nip access-list extended DENY_SSH\n 10 deny tcp any any eq 22\n 20 permit ip any any\nip lan1 access-group DENY_SSH in\n```\n\n#### Create\n```\nip access-list extended DENY_SSH\n 10 deny tcp any any eq 22\n 20 permit ip any any\nip lan1 access-group DENY_SSH in\n```\n\n#### Update\n```\nip access-list extended DENY_SSH\n no 10\n 10 deny tcp any any eq 2222\n 15 deny tcp any any eq 23\n```\n\n#### Delete\n```\nno ip lan1 access-group in\nno ip access-list extended DENY_SSH\n```\n\n---\n\n### 12. Access List Extended (IPv6)\n\n#### Read (Get)\n```\nshow config | grep \"ipv6 access-list\"\nshow config | grep \"ipv6 .* access-group\"\n```\n**Response parsing:**\n```\nipv6 access-list extended DENY_SSH_V6\n 10 deny tcp any any eq 22\n 20 permit ipv6 any any\nipv6 lan1 access-group DENY_SSH_V6 in\n```\n\n#### Create\n```\nipv6 access-list extended DENY_SSH_V6\n 10 deny tcp any any eq 22\n 20 permit ipv6 any any\nipv6 lan1 access-group DENY_SSH_V6 in\n```\n\n#### Update\n```\nipv6 access-list extended DENY_SSH_V6\n no 10\n 10 deny tcp any any eq 2222\n```\n\n#### Delete\n```\nno ipv6 lan1 access-group in\nno ipv6 access-list extended DENY_SSH_V6\n```\n\n---\n\n### 13. MAC Access List\n\n#### Read (Get)\n```\nshow config | grep \"mac access-list\"\nshow config | grep \"mac .* access-group\"\n```\n**Response parsing:**\n```\nmac access-list extended ALLOW_KNOWN\n 10 permit host 00:11:22:33:44:55 any\n 20 deny any any\nmac lan1 access-group ALLOW_KNOWN in\n```\n\n#### Create\n```\nmac access-list extended ALLOW_KNOWN\n 10 permit host 00:11:22:33:44:55 any\n 20 deny any any\nmac lan1 access-group ALLOW_KNOWN in\n```\n\n#### Update\n```\nmac access-list extended ALLOW_KNOWN\n 15 permit host 00:11:22:33:44:66 any\n```\n\n#### Delete\n```\nno mac lan1 access-group in\nno mac access-list extended ALLOW_KNOWN\n```\n\n---\n\n### 14. Interface ACL Binding\n\n#### Read (Get)\n```\nshow config | grep \"access-group\"\n```\n**Response parsing:**\n```\nip lan1 access-group INBOUND_FILTER in\nip lan1 access-group OUTBOUND_FILTER out\n```\n\n#### Create\n```\nip lan1 access-group INBOUND_FILTER in\nip lan1 access-group OUTBOUND_FILTER out\n```\n\n#### Update\n```\nno ip lan1 access-group in\nip lan1 access-group NEW_INBOUND_FILTER in\n```\n\n#### Delete\n```\nno ip lan1 access-group in\nno ip lan1 access-group out\n```\n\n---\n\n### 15. Interface MAC ACL Binding\n\n#### Read (Get)\n```\nshow config | grep \"mac .* access-group\"\n```\n**Response parsing:**\n```\nmac lan1 access-group MAC_FILTER in\n```\n\n#### Create\n```\nmac lan1 access-group MAC_FILTER in\n```\n\n#### Update\n```\nno mac lan1 access-group in\nmac lan1 access-group NEW_MAC_FILTER in\n```\n\n#### Delete\n```\nno mac lan1 access-group in\nno mac lan1 access-group out\n```\n\n## Command Execution Strategy (コマンド送信方式)\n\n### 現状の問題\n\n現在の実装は**1コマンドずつ送信・応答待ち**を行っている：\n\n```go\n// 現在の実装（例: bgp_service.go）\nfor _, cmd := range commands {\n    output, err := s.executor.Run(ctx, cmd)  // 1コマンドごとにプロンプト待ち\n    if err != nil {\n        return err\n    }\n}\n```\n\n**問題点:**\n- RTXへのラウンドトリップが多い（コマンド数×往復）\n- 実行が遅い\n- VPN安全更新パターン（disable→enable）が実装できない\n\n### 提案: バッチ送信方式\n\n#### レベル1: リソース単位バッチ（必須）\n\n1リソースの全コマンドをまとめて送信：\n\n```go\n// 提案: リソース単位バッチ\nfunc (s *BGPService) Create(ctx context.Context, config *BGPConfig) error {\n    commands := buildBGPCommands(config)\n    return s.executor.RunBatch(ctx, commands)  // 一括送信\n}\n```\n\n**Pros:**\n- ラウンドトリップ削減（リソースあたり1往復）\n- VPN安全更新パターンが実装可能\n- 実行速度向上\n\n**Cons:**\n- エラー発生時、どのコマンドで失敗したか特定しにくい\n- 部分適用の問題（途中でエラー→一部のみ適用済み）\n\n#### レベル2: Terraform Apply単位バッチ（オプション）\n\n`terraform apply`で変更される全リソースをまとめて送信：\n\n```go\n// Provider層で全リソースのコマンドを収集\ntype CommandCollector struct {\n    commands []string\n}\n\nfunc (c *CommandCollector) Add(cmds ...string) {\n    c.commands = append(c.commands, cmds...)\n}\n\n// Apply終了時に一括送信\nfunc (c *CommandCollector) Flush(ctx context.Context, executor Executor) error {\n    if len(c.commands) == 0 {\n        return nil\n    }\n    return executor.RunBatch(ctx, c.commands)\n}\n```\n\n**Pros:**\n- 最速の実行速度\n- ネットワーク効率最大化\n\n**Cons:**\n- Terraform Provider SDKとの統合が複雑\n- リソース間の依存関係管理が必要\n- エラー発生時のロールバックが非常に複雑\n- どのリソースで失敗したか特定困難\n\n### 推奨実装\n\n**Phase 1（この仕様のスコープ）:** レベル1（リソース単位バッチ）を**全リソースに適用**\n\n| リソース | Create | Update | Delete | 備考 |\n|----------|--------|--------|--------|------|\n| rtx_bgp | Batch | Batch | Batch | +`bgp configure refresh` |\n| rtx_ospf | Batch | Batch | Batch | +`ospf configure refresh` |\n| rtx_ipsec_tunnel | Batch | Batch+Polling+Save | Batch | VPN安全更新パターン |\n| rtx_l2tp | Batch | Batch+Polling+Save | Batch | VPN安全更新パターン |\n| rtx_pptp | Batch | Batch+Polling+Save | Batch | VPN安全更新パターン |\n| rtx_dhcp_scope | Batch | Batch | Batch | 即時反映 |\n| rtx_nat_masquerade | Batch | Batch | Batch | 即時反映 |\n| rtx_nat_static | Batch | Batch | Batch | 即時反映 |\n| rtx_system | Batch | Batch | Batch | 即時反映 |\n| rtx_static_route | Batch | Batch | Batch | 即時反映 |\n| rtx_access_list_extended | Batch | Batch | Batch | 即時反映 |\n| rtx_access_list_extended_ipv6 | Batch | Batch | Batch | 即時反映 |\n| rtx_access_list_mac | Batch | Batch | Batch | 即時反映 |\n| rtx_interface_acl | Batch | Batch | Batch | 即時反映 |\n| rtx_interface_mac_acl | Batch | Batch | Batch | 即時反映 |\n\n**実装内容:**\n- `Executor.RunBatch(ctx, []string)` メソッド追加\n- **全15リソース**のServiceメソッドをバッチ送信に変更\n- テストもバッチ送信を前提に設計\n\n**Phase 2（将来の検討）:** レベル2（Apply単位バッチ）\n- 要件とConsを精査してから判断\n\n### 実装要件\n\n```go\n// Executor interface extension\ntype Executor interface {\n    Run(ctx context.Context, cmd string) ([]byte, error)\n    RunBatch(ctx context.Context, cmds []string) ([]byte, error)  // 新規追加\n}\n\n// Session interface extension\ntype Session interface {\n    Send(cmd string) ([]byte, error)\n    SendBatch(cmds []string) ([]byte, error)  // 新規追加\n    Close() error\n    SetAdminMode(bool)\n}\n```\n\n---\n\n## Configuration Application Commands (設定反映コマンド)\n\nRTXルーターでは、設定変更が即座にルーターの動作に反映されるものと、追加のコマンドや再起動が必要なものがあります。以下は各リソースの設定反映方法を示します。\n\n### Summary Table\n\n| Resource | Application Method | Command | Notes |\n|----------|-------------------|---------|-------|\n| BGP | Refresh required | `bgp configure refresh` | BGPの設定を変更したら、ルーターを再起動するか、このコマンドを実行する必要がある |\n| OSPF | Refresh required | `ospf configure refresh` | OSPF関係の設定を変更したら、ルーターを再起動するか、あるいはこのコマンドを実行しなくてはいけない |\n| IPsec Tunnel | Atomic Update Pattern | `SendBatch` → polling → `save` | VPN安全更新パターン（詳細下記） |\n| L2TP | Atomic Update Pattern | `SendBatch` → polling → `save` | VPN安全更新パターン（詳細下記） |\n| PPTP | Atomic Update Pattern | `SendBatch` → polling → `save` | VPN安全更新パターン（詳細下記） |\n| NAT Masquerade | Immediate (most) | N/A | 一部の設定変更（特にdescriptor type）はルーター再起動が必要 |\n| NAT Static | Immediate (most) | N/A | 一部の設定変更はルーター再起動が必要 |\n| DHCP Scope | Immediate | N/A | スコープ設定変更は即時反映 |\n| System | Immediate | N/A | システム設定変更は即時反映 |\n| Static Route | Immediate | N/A | 経路設定は既存設定を上書き可能、即時反映 |\n| Access List | Immediate | N/A | ACL設定変更は即時反映 |\n| Interface ACL | Immediate | N/A | インターフェースへのACL適用は即時反映 |\n| MAC ACL | Immediate | N/A | MACフィルタ設定は即時反映 |\n\n### Detailed Application Commands by Resource\n\n#### BGP\n\n**RTX Documentation Reference:** 29_BGP.md\n> 「BGPの設定を変更したら、ルーターを再起動するか、このコマンドを実行する必要がある」\n\n```\n# After BGP configuration changes\nbgp configure refresh\n```\n\n**Test Pattern for Update:**\n```go\n// MockExecutor should expect the refresh command after settings change\nmockExecutor.On(\"Execute\", ctx, \"bgp configure refresh\").Return(\"\", nil)\n```\n\n#### OSPF\n\n**RTX Documentation Reference:** 28_OSPF.md\n> 「OSPF関係の設定を変更したら、ルーターを再起動するか、あるいはこのコマンドを実行しなくてはいけない」\n\n```\n# After OSPF configuration changes\nospf configure refresh\n```\n\n**Test Pattern for Update:**\n```go\n// MockExecutor should expect the refresh command after settings change\nmockExecutor.On(\"Execute\", ctx, \"ospf configure refresh\").Return(\"\", nil)\n```\n\n#### IPsec Tunnel / L2TP / PPTP - VPN安全更新パターン (Atomic Update Pattern)\n\n**RTX Documentation Reference:** 14_トンネリング.md\n> 「トンネル先の設定を行う場合は、disable状態で行うのが望ましい」\n\n**課題:** VPN経由でリモートRTXを管理している場合、単純に`tunnel disable`を実行すると接続が切断され、`tunnel enable`を実行できなくなる。\n\n**解決策: Atomic Update Pattern（VPN安全更新パターン）**\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 1: SendBatch (saveなし)                                │\n├─────────────────────────────────────────────────────────────┤\n│ 複数コマンドを一括送信（プロンプト待ちなし）                    │\n│ [\"tunnel select 1\",                                         │\n│  \"ipsec ike remote address 1 203.0.113.2\",                  │\n│  \"ipsec ike encryption 1 aes128\",                           │\n│  \"tunnel disable 1\",                                        │\n│  \"tunnel enable 1\"]                                         │\n│                                                             │\n│ ※ saveしないので、失敗時は再起動で元に戻る                     │\n│ ※ 接続切断は想定内（エラーとして扱わない）                      │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 2: WaitForReconnection (Polling)                      │\n├─────────────────────────────────────────────────────────────┤\n│ VPN再確立を待つ                                              │\n│ - SSH接続試行を繰り返す（例: 10秒間隔、最大5分）              │\n│ - 成功 → Phase 3へ                                          │\n│ - タイムアウト → エラー返却                                   │\n│   「設定に問題がある可能性があります。リモート拠点で            │\n│    ルーターを再起動してください（saveしていないので復旧します）」│\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 3: Reconnect & Save                                   │\n├─────────────────────────────────────────────────────────────┤\n│ 新しいSSHセッションを確立                                     │\n│ \"save\" を実行して設定を永続化                                 │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**利点:**\n- ✅ 設定ミス時: 再起動で元に戻る（saveしてないから）\n- ✅ 設定正常時: 自動的に接続再確立→save\n- ✅ 物理アクセス不要（最悪でも再起動依頼のみ）\n\n**実装要件:**\n1. `SendBatch()` - 複数コマンドを一括送信する新メソッド\n2. `WaitForReconnection()` - SSH接続試行をpollingする機能\n3. 接続切断時のエラーハンドリング（切断を想定内として扱う）\n\n**Test Pattern for Update:**\n```go\nfunc TestIPsecTunnelService_Update_AtomicPattern(t *testing.T) {\n    tests := []struct {\n        name              string\n        batchCommands     []string\n        reconnectSuccess  bool\n        expectedSaveCalled bool\n        expectedErr       bool\n    }{\n        {\n            name: \"successful update with reconnection\",\n            batchCommands: []string{\n                \"tunnel select 1\",\n                \"ipsec ike remote address 1 203.0.113.2\",\n                \"tunnel disable 1\",\n                \"tunnel enable 1\",\n            },\n            reconnectSuccess:   true,\n            expectedSaveCalled: true,\n            expectedErr:        false,\n        },\n        {\n            name: \"failed reconnection - user must restart router\",\n            batchCommands: []string{\n                \"tunnel select 1\",\n                \"ipsec ike remote address 1 invalid\",\n                \"tunnel disable 1\",\n                \"tunnel enable 1\",\n            },\n            reconnectSuccess:   false,\n            expectedSaveCalled: false,\n            expectedErr:        true, // Error message guides user to restart\n        },\n    }\n    // ... test implementation\n}\n```\n\n#### NAT (Masquerade/Static)\n\n**RTX Documentation Reference:** 23_NAT_機能.md\n\nNATの多くの設定変更は即時反映されますが、NAT descriptor typeの変更などの基本設定変更は再起動が必要な場合があります。\n\n```\n# Most changes are immediate\nnat descriptor masquerade static 1000 3 192.168.1.103:443=192.168.1.103:8443 tcp\n\n# But changing descriptor type may require restart\n# (Provider should document this limitation)\n```\n\n**Test Pattern for Update:**\n```go\n// Simple static entry changes are immediate\nmockExecutor.On(\"Execute\", ctx, \"nat descriptor masquerade static 1000 3 ...\").Return(\"\", nil)\n```\n\n#### DHCP Scope\n\n**RTX Documentation Reference:** 12_DHCP_の設定.md\n\nDHCPスコープの設定変更は即時反映されます。既存のリースには影響しませんが、新規リースには新しい設定が適用されます。\n\n```\n# Changes are immediate\ndhcp scope 1 192.168.1.0/24 expire 12:00\ndhcp scope option 1 dns=1.1.1.1\n```\n\n#### System Configuration\n\nシステム設定（timezone, console設定等）は即時反映されます。\n\n```\n# Changes are immediate\ntimezone +09:00\nconsole lines infinity\n```\n\n#### Static Route\n\n**RTX Documentation Reference:** 08_IP_の設定.md\n> 「既に存在する経路を上書きすることができる」\n\n静的ルートの変更は即時反映されます。\n\n```\n# Existing route can be overwritten\nip route 10.0.0.0/8 gateway 192.168.1.254\n```\n\n#### Access Lists\n\nACL設定の変更は即時反映されます。インターフェースに適用されているACLを変更すると、その瞬間から新しいルールが適用されます。\n\n```\n# Changes take effect immediately\nip access-list extended DENY_SSH\n no 10\n 10 deny tcp any any eq 2222\n```\n\n## Command Parameter Variations\n\n### IP Address Formats\n- CIDR: `192.168.1.0/24`\n- Dotted mask: `192.168.1.0/255.255.255.0`\n- Host: `host 192.168.1.1`\n- Any: `any`\n\n### Interface Types\n- `lan`, `lan1`, `lan2`\n- `wan`, `wan1`\n- `pp 1`, `pp 2`\n- `tunnel 1`, `tunnel 2`\n- `ipcp`\n\n### Protocol Types\n- `tcp`, `udp`, `icmp`\n- `esp`, `ah`, `gre`\n- `ip` (any IPv4)\n- `ipv6` (any IPv6)\n\n### Time Formats\n- RTX format: `h:mm` (e.g., `24:00`)\n- Seconds: integer value\n- UTC offset: `+09:00`, `-05:00`\n",
  "fileStats": {
    "size": 37735,
    "lines": 1317,
    "lastModified": "2026-01-22T13:16:29.324Z"
  },
  "comments": []
}