{
  "id": "snapshot_1768799801046_fw51ju3mg",
  "approvalId": "approval_1768799801040_25tok2xw1",
  "approvalTitle": "Design: rtx_snmp resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:41.046Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_snmp\n\n## Overview\n\nThe `rtx_snmp` resource enables Terraform-based management of SNMP (Simple Network Management Protocol) configuration on Yamaha RTX series routers. Following Cisco IOS XE `iosxe_snmp_server` naming patterns, this resource manages SNMP agent settings, community strings, trap destinations, and SNMPv3 users.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with SNMP methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add SNMP methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_snmp.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        SNMPService[snmp_service.go]\n    end\n\n    subgraph Parser Layer\n        SNMPParser[snmp.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> SNMPService\n    SNMPService --> SNMPParser\n    SNMPParser --> Commands\n    SNMPParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `SNMPService` handles all SNMP CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all SNMP logic\n- **Utility Modularity**: Shared validation functions for community strings\n\n## Components and Interfaces\n\n### Component 1: SNMPService (`internal/client/snmp_service.go`)\n\n- **Purpose:** Handles all SNMP CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type SNMPService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *SNMPService) Create(ctx context.Context, snmp SNMPConfig) error\n  func (s *SNMPService) Get(ctx context.Context) (*SNMPConfig, error)\n  func (s *SNMPService) Update(ctx context.Context, snmp SNMPConfig) error\n  func (s *SNMPService) Delete(ctx context.Context) error\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.SNMPParser`\n- **Reuses:** Pattern from service layer implementations\n\n### Component 2: SNMPParser (`internal/rtx/parsers/snmp.go`)\n\n- **Purpose:** Parses RTX router output for SNMP configuration and builds commands\n- **Interfaces:**\n  ```go\n  type SNMPConfig struct {\n      Location     string          `json:\"location,omitempty\"`\n      Contact      string          `json:\"contact,omitempty\"`\n      SysName      string          `json:\"sysname,omitempty\"`\n      Communities  []SNMPCommunity `json:\"communities\"`\n      Hosts        []SNMPHost      `json:\"hosts\"`\n      EnableTraps  []string        `json:\"enable_traps\"`\n  }\n\n  type SNMPCommunity struct {\n      Name       string `json:\"name\"`\n      Permission string `json:\"permission\"`  // ro, rw\n      ACL        string `json:\"acl,omitempty\"`\n  }\n\n  type SNMPHost struct {\n      Address   string `json:\"address\"`\n      Community string `json:\"community,omitempty\"`\n      Version   string `json:\"version\"`  // 1, 2c, 3\n  }\n\n  func ParseSNMPConfig(raw string) (*SNMPConfig, error)\n  func BuildSNMPSysLocationCommand(location string) string\n  func BuildSNMPSysContactCommand(contact string) string\n  func BuildSNMPSysNameCommand(name string) string\n  func BuildSNMPCommunityCommand(community SNMPCommunity) string\n  func BuildSNMPHostCommand(host SNMPHost) string\n  func BuildSNMPTrapEnableCommand(trapType string) string\n  func BuildDeleteSNMPCommand() string\n  ```\n- **Dependencies:** `regexp`, `strings`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_snmp.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXSNMP() *schema.Resource\n  func resourceRTXSNMPCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXSNMPRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXSNMPUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXSNMPDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXSNMPImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `SNMPConfig`, Terraform SDK\n- **Reuses:** Resource patterns from other implementations\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with SNMP methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetSNMP(ctx context.Context) (*SNMPConfig, error)\n  CreateSNMP(ctx context.Context, snmp SNMPConfig) error\n  UpdateSNMP(ctx context.Context, snmp SNMPConfig) error\n  DeleteSNMP(ctx context.Context) error\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### SNMPConfig\n\n```go\n// SNMPConfig represents SNMP configuration on an RTX router\ntype SNMPConfig struct {\n    Location    string          `json:\"location,omitempty\"`  // sysLocation\n    Contact     string          `json:\"contact,omitempty\"`   // sysContact\n    SysName     string          `json:\"sysname,omitempty\"`   // sysName\n    Communities []SNMPCommunity `json:\"communities\"`         // Community strings\n    Hosts       []SNMPHost      `json:\"hosts\"`               // Trap destinations\n    EnableTraps []string        `json:\"enable_traps\"`        // Enabled trap types\n}\n\n// SNMPCommunity represents a community string configuration\ntype SNMPCommunity struct {\n    Name       string `json:\"name\"`       // Community string (sensitive)\n    Permission string `json:\"permission\"` // ro or rw\n    ACL        string `json:\"acl\"`        // Access control list name\n}\n\n// SNMPHost represents a trap destination\ntype SNMPHost struct {\n    Address   string `json:\"address\"`   // Manager IP address\n    Community string `json:\"community\"` // Trap community (sensitive)\n    Version   string `json:\"version\"`   // SNMP version (1, 2c, 3)\n}\n```\n\n### Terraform Schema\n\n```hcl\n# SNMP server configuration\nresource \"rtx_snmp_server\" \"monitoring\" {\n  location = \"Tokyo DC Rack 42\"\n  contact  = \"noc@example.com\"\n\n  # Community strings\n  communities = [\n    {\n      name       = var.snmp_community_ro\n      permission = \"ro\"\n      acl        = \"SNMP_ACCESS\"\n    },\n    {\n      name       = var.snmp_community_rw\n      permission = \"rw\"\n      acl        = \"SNMP_ACCESS\"\n    }\n  ]\n\n  # Trap destinations\n  hosts = [\n    {\n      address   = \"10.0.0.100\"\n      community = var.snmp_trap_community\n      version   = \"2c\"\n    },\n    {\n      address   = \"10.0.0.101\"\n      community = var.snmp_trap_community\n      version   = \"2c\"\n    }\n  ]\n\n  # Enable traps\n  enable_traps = [\"snmp\", \"linkdown\", \"linkup\", \"coldstart\"]\n}\n\n# SNMPv3 user (separate resource)\nresource \"rtx_snmp_server_user\" \"admin\" {\n  username = \"snmpadmin\"\n  group    = \"ADMIN_GROUP\"\n\n  auth_protocol = \"sha\"\n  auth_password = var.snmpv3_auth_password\n\n  priv_protocol = \"aes128\"\n  priv_password = var.snmpv3_priv_password\n}\n```\n\n## RTX Command Mapping\n\n### Configure System Information\n\n```\nsnmp sysname <name>\nsnmp syslocation <location>\nsnmp syscontact <contact>\n```\n\n### Configure Community Strings\n\n```\nsnmp community read-only <string>\nsnmp community read-write <string>\n```\n\n### Configure Trap Destination\n\n```\nsnmp host <ip> [community <string>]\nsnmp trap host <ip>\n```\n\n### Configure Trap Community\n\n```\nsnmp trap community <string>\n```\n\n### Enable Traps\n\n```\nsnmp trap enable snmp [all|<trap_type>]\n```\n\nExample: `snmp trap enable snmp linkdown linkup`\n\n### Delete SNMP Configuration\n\n```\nno snmp host <ip>\nno snmp community read-only\nno snmp community read-write\n```\n\n### Show Configuration\n\n```\nshow config | grep snmp\nshow snmp\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid IP Address**\n   - **Handling:** Validate trap destination IP format\n   - **User Impact:** Clear validation error with expected format\n\n2. **Invalid SNMP Version**\n   - **Handling:** Validate version is 1, 2c, or 3\n   - **User Impact:** Error with valid versions\n\n3. **Invalid Trap Type**\n   - **Handling:** Validate trap type is supported\n   - **User Impact:** Error with valid trap types\n\n4. **Empty Community String**\n   - **Handling:** Require non-empty community string\n   - **User Impact:** Validation error\n\n5. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`snmp_test.go`):\n  - Parse various RTX `show config` output for SNMP\n  - Test command builder functions with different parameters\n  - Test community string handling\n\n- **Service Tests** (`snmp_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test trap configuration\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_snmp_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Sensitive attribute handling\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create SNMP with communities\n  - Configure trap destinations\n  - Enable traps\n  - Update configuration\n  - Delete SNMP settings\n  - Import existing SNMP\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_snmp.go      # NEW: Terraform resource\n│   └── resource_rtx_snmp_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go              # MODIFY: Add SNMP types and methods\n│   ├── client.go                  # MODIFY: Add SNMP service initialization\n│   ├── snmp_service.go           # NEW: SNMP service implementation\n│   └── snmp_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── snmp.go               # NEW: Parser and command builders\n        └── snmp_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Singleton Resource**: SNMP is a singleton resource. Only one SNMP configuration can exist.\n\n2. **Terraform ID**: Use \"snmp\" as the fixed Terraform resource ID.\n\n3. **Sensitive Data**: Community strings must be marked as sensitive in Terraform state.\n\n4. **SNMPv3**: Consider as separate resource `rtx_snmp_server_user` due to complexity.\n\n5. **ACL Integration**: Community ACLs reference IP filter resources.\n\n6. **Trap Types**: Common types: snmp, linkdown, linkup, coldstart, warmstart.\n\n7. **In-place Updates**: Most SNMP settings support in-place updates.\n\n8. **Security**: Recommend using SNMPv3 over v1/v2c for sensitive environments.\n\n9. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n10. **Provider Registration**: Add `resourceRTXSNMP` to provider's resource map.\n",
  "fileStats": {
    "size": 11053,
    "lines": 371,
    "lastModified": "2026-01-19T05:14:43.554Z"
  },
  "comments": []
}