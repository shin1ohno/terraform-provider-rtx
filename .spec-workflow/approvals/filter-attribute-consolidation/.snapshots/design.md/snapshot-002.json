{
  "id": "snapshot_1769331109141_a0cmrhwnb",
  "approvalId": "approval_1769328539062_bhdrw9ayu",
  "approvalTitle": "Design: Filter Consolidation (Unified Access List Pattern)",
  "version": 2,
  "timestamp": "2026-01-25T08:51:49.141Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design: Filter Attribute Consolidation\n\n## Overview\n\nThis document describes the technical design for consolidating filter management into a consistent access list pattern with simplified interface binding.\n\n## Architecture\n\n### Current Architecture (Fragmented)\n\n```mermaid\ngraph TD\n    subgraph \"Filter Definition\"\n        AL_IP[rtx_access_list_ip]\n        AL_IPv6[rtx_access_list_ipv6]\n        AL_MAC[rtx_access_list_mac]\n        FD_IP[rtx_ip_filter_dynamic]\n        FD_IPv6[rtx_ipv6_filter_dynamic]\n    end\n\n    subgraph \"Filter Binding\"\n        IF[rtx_interface]\n        IF_ACL[rtx_interface_acl]\n        IF_MAC[rtx_interface_mac_acl]\n    end\n\n    AL_IP --> IF_ACL\n    AL_IPv6 --> IF_ACL\n    AL_MAC --> IF_MAC\n    FD_IP --> IF_ACL\n    FD_IPv6 --> IF_ACL\n    IF --> RTX[RTX Router]\n    IF_ACL --> RTX\n    IF_MAC --> RTX\n```\n\n### Target Architecture (Unified)\n\n```mermaid\ngraph TD\n    subgraph \"Filter Definition (All Access Lists)\"\n        AL_IP[rtx_access_list_ip]\n        AL_IPv6[rtx_access_list_ipv6]\n        AL_MAC[rtx_access_list_mac]\n        AL_IP_DYN[rtx_access_list_ip_dynamic]\n        AL_IPv6_DYN[rtx_access_list_ipv6_dynamic]\n    end\n\n    subgraph \"Filter Binding (Single Resource)\"\n        IF[rtx_interface]\n    end\n\n    AL_IP --> IF\n    AL_IPv6 --> IF\n    AL_MAC --> IF\n    AL_IP_DYN --> IF\n    AL_IPv6_DYN --> IF\n    IF --> RTX[RTX Router]\n```\n\n## Implementation Plan\n\n### Phase 1: Create New Dynamic Filter Access List Resources\n\nCreate `rtx_access_list_ip_dynamic`:\n- Name-based grouping of dynamic IP filter rules\n- Entry block with sequence, source, destination, protocol, etc.\n\nCreate `rtx_access_list_ipv6_dynamic`:\n- Name-based grouping of dynamic IPv6 filter rules\n- Entry block with sequence, source, destination, protocol, etc.\n\n### Phase 2: Add Access List Attributes to rtx_interface\n\nAdd new attributes:\n- `access_list_ip_in`, `access_list_ip_out`\n- `access_list_ipv6_in`, `access_list_ipv6_out`\n- `access_list_ip_dynamic_in`, `access_list_ip_dynamic_out`\n- `access_list_ipv6_dynamic_in`, `access_list_ipv6_dynamic_out`\n- `access_list_mac_in`, `access_list_mac_out`\n\n### Phase 3: Remove Old Filter Attributes from rtx_interface\n\nRemove:\n- `secure_filter_in`, `secure_filter_out`\n- `dynamic_filter_out`\n- `ethernet_filter_in`, `ethernet_filter_out`\n\n### Phase 4: Remove Redundant Resources\n\nDelete:\n- `rtx_interface_acl`\n- `rtx_interface_mac_acl`\n- `rtx_ip_filter_dynamic`\n- `rtx_ipv6_filter_dynamic`\n\n### Phase 5: Update Documentation\n\n- Update resource documentation\n- Create migration guide\n- Update examples\n\n## Schema Definitions\n\n### rtx_access_list_ip_dynamic (New)\n\n```go\nSchema: map[string]*schema.Schema{\n    \"name\": {\n        Type:        schema.TypeString,\n        Required:    true,\n        ForceNew:    true,\n        Description: \"Access list name (identifier)\",\n    },\n    \"entry\": {\n        Type:        schema.TypeList,\n        Required:    true,\n        Description: \"List of dynamic filter entries\",\n        Elem: &schema.Resource{\n            Schema: map[string]*schema.Schema{\n                \"sequence\": {\n                    Type:        schema.TypeInt,\n                    Required:    true,\n                    Description: \"Sequence number (determines order)\",\n                },\n                \"source\": {\n                    Type:        schema.TypeString,\n                    Required:    true,\n                    Description: \"Source address or * for any\",\n                },\n                \"destination\": {\n                    Type:        schema.TypeString,\n                    Required:    true,\n                    Description: \"Destination address or * for any\",\n                },\n                \"protocol\": {\n                    Type:        schema.TypeString,\n                    Required:    true,\n                    Description: \"Protocol (www, ftp, smtp, tcp, udp, etc.)\",\n                },\n                \"syslog\": {\n                    Type:        schema.TypeBool,\n                    Optional:    true,\n                    Default:     false,\n                    Description: \"Enable syslog logging\",\n                },\n                \"timeout\": {\n                    Type:        schema.TypeInt,\n                    Optional:    true,\n                    Description: \"Timeout in seconds\",\n                },\n            },\n        },\n    },\n}\n```\n\n### rtx_access_list_ipv6_dynamic (New)\n\n```go\nSchema: map[string]*schema.Schema{\n    \"name\": {\n        Type:        schema.TypeString,\n        Required:    true,\n        ForceNew:    true,\n        Description: \"Access list name (identifier)\",\n    },\n    \"entry\": {\n        Type:        schema.TypeList,\n        Required:    true,\n        Description: \"List of dynamic IPv6 filter entries\",\n        Elem: &schema.Resource{\n            Schema: map[string]*schema.Schema{\n                \"sequence\": {\n                    Type:        schema.TypeInt,\n                    Required:    true,\n                    Description: \"Sequence number (determines order)\",\n                },\n                \"source\": {\n                    Type:        schema.TypeString,\n                    Required:    true,\n                    Description: \"Source IPv6 address or * for any\",\n                },\n                \"destination\": {\n                    Type:        schema.TypeString,\n                    Required:    true,\n                    Description: \"Destination IPv6 address or * for any\",\n                },\n                \"protocol\": {\n                    Type:        schema.TypeString,\n                    Required:    true,\n                    Description: \"Protocol (www, ftp, smtp, tcp, udp, etc.)\",\n                },\n                \"syslog\": {\n                    Type:        schema.TypeBool,\n                    Optional:    true,\n                    Default:     false,\n                    Description: \"Enable syslog logging\",\n                },\n            },\n        },\n    },\n}\n```\n\n### rtx_interface (Updated - Filter Attributes Only)\n\n```go\n// New attributes to add\n\"access_list_ip_in\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Inbound IP access list name\",\n},\n\"access_list_ip_out\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Outbound IP access list name\",\n},\n\"access_list_ip_dynamic_in\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Inbound dynamic IP access list name\",\n},\n\"access_list_ip_dynamic_out\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Outbound dynamic IP access list name\",\n},\n\"access_list_ipv6_in\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Inbound IPv6 access list name\",\n},\n\"access_list_ipv6_out\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Outbound IPv6 access list name\",\n},\n\"access_list_ipv6_dynamic_in\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Inbound dynamic IPv6 access list name\",\n},\n\"access_list_ipv6_dynamic_out\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Outbound dynamic IPv6 access list name\",\n},\n\"access_list_mac_in\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Inbound MAC access list name\",\n},\n\"access_list_mac_out\": {\n    Type:        schema.TypeString,\n    Optional:    true,\n    Description: \"Outbound MAC access list name\",\n},\n```\n\n## RTX Command Mapping\n\n### Access List to Filter Number Mapping\n\nEach access list resource internally manages filter numbers. When an access list is referenced by name, the provider:\n\n1. Looks up the access list by name\n2. Retrieves the filter numbers from entries (based on sequence or filter_id)\n3. Generates the appropriate RTX commands\n\n### Interface Filter Commands\n\n| Access List Attribute | RTX Command |\n|----------------------|-------------|\n| `access_list_ip_in` | `ip {interface} secure filter in {filter_nums...}` |\n| `access_list_ip_out` | `ip {interface} secure filter out {filter_nums...}` |\n| `access_list_ip_dynamic_in` | `ip {interface} secure filter in ... dynamic {filter_nums...}` |\n| `access_list_ip_dynamic_out` | `ip {interface} secure filter out ... dynamic {filter_nums...}` |\n| `access_list_ipv6_in` | `ipv6 {interface} secure filter in {filter_nums...}` |\n| `access_list_ipv6_out` | `ipv6 {interface} secure filter out {filter_nums...}` |\n| `access_list_mac_in` | `ethernet {interface} filter in {filter_nums...}` |\n| `access_list_mac_out` | `ethernet {interface} filter out {filter_nums...}` |\n\n## Usage Example\n\n### Complete Configuration\n\n```hcl\n# Static IP filters\nresource \"rtx_access_list_ip\" \"inbound\" {\n  name = \"ip-inbound\"\n\n  entry {\n    sequence    = 10\n    ace_action  = \"permit\"\n    protocol    = \"tcp\"\n    destination_port = \"80\"\n  }\n\n  entry {\n    sequence    = 20\n    ace_action  = \"permit\"\n    protocol    = \"tcp\"\n    destination_port = \"443\"\n  }\n\n  entry {\n    sequence    = 100\n    ace_action  = \"deny\"\n    source_any  = true\n  }\n}\n\n# Dynamic IP filters (stateful inspection)\nresource \"rtx_access_list_ip_dynamic\" \"stateful\" {\n  name = \"ip-stateful\"\n\n  entry {\n    sequence    = 10\n    source      = \"*\"\n    destination = \"*\"\n    protocol    = \"www\"\n  }\n\n  entry {\n    sequence    = 20\n    source      = \"*\"\n    destination = \"*\"\n    protocol    = \"ftp\"\n    syslog      = true\n  }\n}\n\n# MAC filters\nresource \"rtx_access_list_mac\" \"trusted\" {\n  name = \"mac-trusted\"\n\n  entry {\n    sequence       = 10\n    ace_action     = \"pass\"\n    source_address = \"00:11:22:33:44:55\"\n    destination_any = true\n  }\n\n  entry {\n    sequence       = 100\n    ace_action     = \"pass\"\n    source_any     = true\n    destination_any = true\n  }\n}\n\n# Interface with all filters\nresource \"rtx_interface\" \"lan1\" {\n  name       = \"lan1\"\n  ip_address = \"192.168.1.1\"\n  ip_mask    = \"255.255.255.0\"\n\n  # IP filters\n  access_list_ip_in          = rtx_access_list_ip.inbound.name\n  access_list_ip_dynamic_out = rtx_access_list_ip_dynamic.stateful.name\n\n  # MAC filters\n  access_list_mac_in = rtx_access_list_mac.trusted.name\n}\n```\n\n## Migration Example\n\n### Before (Current Design)\n\n```hcl\n# Individual dynamic filter resources\nresource \"rtx_ip_filter_dynamic\" \"http\" {\n  sequence    = 100\n  source      = \"*\"\n  destination = \"*\"\n  protocol    = \"www\"\n}\n\nresource \"rtx_ip_filter_dynamic\" \"ftp\" {\n  sequence    = 101\n  source      = \"*\"\n  destination = \"*\"\n  protocol    = \"ftp\"\n}\n\n# Interface with filter numbers\nresource \"rtx_interface\" \"lan1\" {\n  name              = \"lan1\"\n  secure_filter_in  = [1, 2, 3]\n  dynamic_filter_out = [100, 101]\n  ethernet_filter_in = [1, 2]\n}\n\n# Separate ACL binding\nresource \"rtx_interface_acl\" \"lan1\" {\n  interface           = \"lan1\"\n  ip_access_group_in  = \"my-acl\"\n}\n\nresource \"rtx_interface_mac_acl\" \"lan1\" {\n  interface            = \"lan1\"\n  mac_access_group_in  = \"mac-acl\"\n}\n```\n\n### After (New Design)\n\n```hcl\n# Grouped dynamic filter resource\nresource \"rtx_access_list_ip_dynamic\" \"stateful\" {\n  name = \"stateful-rules\"\n\n  entry {\n    sequence    = 10\n    source      = \"*\"\n    destination = \"*\"\n    protocol    = \"www\"\n  }\n\n  entry {\n    sequence    = 20\n    source      = \"*\"\n    destination = \"*\"\n    protocol    = \"ftp\"\n  }\n}\n\n# Interface with access list references\nresource \"rtx_interface\" \"lan1\" {\n  name       = \"lan1\"\n  ip_address = \"192.168.1.1\"\n  ip_mask    = \"255.255.255.0\"\n\n  access_list_ip_in          = rtx_access_list_ip.inbound.name\n  access_list_ip_dynamic_out = rtx_access_list_ip_dynamic.stateful.name\n  access_list_mac_in         = rtx_access_list_mac.trusted.name\n}\n```\n\n## File Changes\n\n### Files to Delete (Complete List)\n\n#### Resource Implementation Files\n| File | Reason |\n|------|--------|\n| `internal/provider/resource_rtx_interface_acl.go` | Replaced by `rtx_interface` attributes |\n| `internal/provider/resource_rtx_interface_acl_test.go` | Test for deleted resource |\n| `internal/provider/resource_rtx_interface_mac_acl.go` | Replaced by `rtx_interface` attributes |\n| `internal/provider/resource_rtx_interface_mac_acl_test.go` | Test for deleted resource |\n| `internal/provider/resource_rtx_ip_filter_dynamic.go` | Replaced by `rtx_access_list_ip_dynamic` |\n| `internal/provider/resource_rtx_ip_filter_dynamic_test.go` | Test for deleted resource |\n| `internal/provider/resource_rtx_ipv6_filter_dynamic.go` | Replaced by `rtx_access_list_ipv6_dynamic` |\n| `internal/provider/resource_rtx_ipv6_filter_dynamic_test.go` | Test for deleted resource |\n\n#### Documentation Files\n| File | Reason |\n|------|--------|\n| `docs/resources/interface_acl.md` | Documentation for deleted resource |\n| `docs/resources/interface_mac_acl.md` | Documentation for deleted resource |\n| `docs/resources/ip_filter_dynamic.md` | Documentation for deleted resource |\n| `docs/resources/ipv6_filter_dynamic.md` | Documentation for deleted resource |\n\n### Files to Create (Complete List)\n\n#### Resource Implementation Files\n| File | Purpose |\n|------|---------|\n| `internal/provider/resource_rtx_access_list_ip_dynamic.go` | Dynamic IP filter access list resource |\n| `internal/provider/resource_rtx_access_list_ip_dynamic_test.go` | Tests |\n| `internal/provider/resource_rtx_access_list_ipv6_dynamic.go` | Dynamic IPv6 filter access list resource |\n| `internal/provider/resource_rtx_access_list_ipv6_dynamic_test.go` | Tests |\n\n#### Documentation Files\n| File | Purpose |\n|------|---------|\n| `docs/resources/access_list_ip_dynamic.md` | Resource documentation |\n| `docs/resources/access_list_ipv6_dynamic.md` | Resource documentation |\n\n### Files to Modify\n\n#### `internal/provider/provider.go`\n\nRemove from ResourcesMap:\n```go\n// DELETE these lines\n\"rtx_interface_acl\":       resourceRTXInterfaceACL(),\n\"rtx_interface_mac_acl\":   resourceRTXInterfaceMACACL(),\n\"rtx_ip_filter_dynamic\":   resourceRTXIPFilterDynamic(),\n\"rtx_ipv6_filter_dynamic\": resourceRTXIPv6FilterDynamic(),\n```\n\nAdd to ResourcesMap:\n```go\n// ADD these lines\n\"rtx_access_list_ip_dynamic\":   resourceRTXAccessListIPDynamic(),\n\"rtx_access_list_ipv6_dynamic\": resourceRTXAccessListIPv6Dynamic(),\n```\n\n#### `internal/provider/resource_rtx_interface.go`\n\nRemove attributes:\n- `secure_filter_in`\n- `secure_filter_out`\n- `dynamic_filter_out`\n- `ethernet_filter_in`\n- `ethernet_filter_out`\n\nAdd attributes:\n- `access_list_ip_in`\n- `access_list_ip_out`\n- `access_list_ipv6_in`\n- `access_list_ipv6_out`\n- `access_list_ip_dynamic_in`\n- `access_list_ip_dynamic_out`\n- `access_list_ipv6_dynamic_in`\n- `access_list_ipv6_dynamic_out`\n- `access_list_mac_in`\n- `access_list_mac_out`\n\n#### `internal/provider/resource_rtx_interface_test.go`\n\n- Remove tests for old filter attributes\n- Add tests for new access_list_* attributes\n\n#### `docs/resources/interface.md`\n\n- Remove documentation for old filter attributes\n- Add documentation for new access_list_* attributes\n- Add migration note\n\n#### `internal/client/interface_service.go`\n\n- Remove filter number handling from Configure/Update/Reset methods\n- Add access list name lookup and filter number resolution\n\n#### `internal/client/interfaces.go`\n\nUpdate InterfaceConfig struct:\n```go\n// Remove these fields\nSecureFilterIn    []int\nSecureFilterOut   []int\nDynamicFilterOut  []int\nEthernetFilterIn  []int\nEthernetFilterOut []int\n\n// Add these fields\nAccessListIPIn           string\nAccessListIPOut          string\nAccessListIPv6In         string\nAccessListIPv6Out        string\nAccessListIPDynamicIn    string\nAccessListIPDynamicOut   string\nAccessListIPv6DynamicIn  string\nAccessListIPv6DynamicOut string\nAccessListMACIn          string\nAccessListMACOut         string\n```\n\n## Testing Strategy\n\n### Unit Tests\n\n1. Schema validation for new access list resources\n2. Entry ordering by sequence number\n3. Filter number generation from access list entries\n\n### Integration Tests\n\n1. Create access list → reference in interface\n2. Update access list entries → verify interface filters update\n3. Multiple access lists on single interface\n4. All filter types (IP, IPv6, MAC, dynamic)\n\n### Migration Tests\n\n1. Verify old resources are rejected\n2. Verify clear error messages for deprecated attributes\n\n## Change History\n\n| Date | Author | Changes |\n|------|--------|---------|\n| 2026-01-25 | Claude | Initial design |\n| 2026-01-25 | Claude | Simplified to unified access list pattern |\n",
  "fileStats": {
    "size": 16290,
    "lines": 590,
    "lastModified": "2026-01-25T08:08:53.511Z"
  },
  "comments": []
}