{
  "id": "snapshot_1769326281200_j7gsqdzo1",
  "approvalId": "approval_1769326281121_tmwn7dh25",
  "approvalTitle": "Design: Filter Attribute Consolidation",
  "version": 1,
  "timestamp": "2026-01-25T07:31:21.200Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design: Filter Attribute Consolidation\n\n## Overview\n\nThis document describes the technical design for consolidating filter attributes from `rtx_interface` into dedicated ACL resources with standardized naming.\n\n## Architecture\n\n### Current Architecture\n\n```mermaid\ngraph TD\n    subgraph rtx_interface\n        IF_secure_in[secure_filter_in]\n        IF_secure_out[secure_filter_out]\n        IF_dynamic_out[dynamic_filter_out]\n        IF_eth_in[ethernet_filter_in]\n        IF_eth_out[ethernet_filter_out]\n    end\n\n    subgraph rtx_interface_acl\n        ACL_ip_in[ip_access_group_in]\n        ACL_ip_out[ip_access_group_out]\n        ACL_dyn_in[dynamic_filters_in]\n        ACL_dyn_out[dynamic_filters_out]\n    end\n\n    subgraph rtx_interface_mac_acl\n        MAC_in[mac_access_group_in]\n        MAC_out[mac_access_group_out]\n    end\n\n    IF_secure_in --> RTX[RTX Router]\n    IF_secure_out --> RTX\n    IF_dynamic_out --> RTX\n    IF_eth_in --> RTX\n    IF_eth_out --> RTX\n    ACL_ip_in --> RTX\n    ACL_ip_out --> RTX\n    ACL_dyn_in --> RTX\n    ACL_dyn_out --> RTX\n    MAC_in --> RTX\n    MAC_out --> RTX\n```\n\n### Target Architecture\n\n```mermaid\ngraph TD\n    subgraph rtx_interface\n        IF_basic[Basic config only]\n    end\n\n    subgraph rtx_interface_acl\n        ACL_ip_in[access_list_ip_in]\n        ACL_ip_out[access_list_ip_out]\n        ACL_ipv6_in[access_list_ipv6_in]\n        ACL_ipv6_out[access_list_ipv6_out]\n        ACL_flt_in[ip_filter_in]\n        ACL_flt_out[ip_filter_out]\n        ACL_dyn_in[ip_filter_dynamic_in]\n        ACL_dyn_out[ip_filter_dynamic_out]\n        ACL_v6dyn_in[ipv6_filter_dynamic_in]\n        ACL_v6dyn_out[ipv6_filter_dynamic_out]\n    end\n\n    subgraph rtx_interface_mac_acl\n        MAC_al_in[access_list_mac_in]\n        MAC_al_out[access_list_mac_out]\n        MAC_flt_in[ethernet_filter_in]\n        MAC_flt_out[ethernet_filter_out]\n    end\n\n    ACL_ip_in --> RTX[RTX Router]\n    ACL_ip_out --> RTX\n    ACL_flt_in --> RTX\n    ACL_flt_out --> RTX\n    ACL_dyn_in --> RTX\n    ACL_dyn_out --> RTX\n    MAC_al_in --> RTX\n    MAC_al_out --> RTX\n    MAC_flt_in --> RTX\n    MAC_flt_out --> RTX\n```\n\n## Implementation Plan\n\n### Phase 1: Add New Attributes to ACL Resources\n\nAdd new attributes to `rtx_interface_acl`:\n- `ip_filter_in` (List of Number)\n- `ip_filter_out` (List of Number)\n\nAdd new attributes to `rtx_interface_mac_acl`:\n- `ethernet_filter_in` (List of Number)\n- `ethernet_filter_out` (List of Number)\n\n### Phase 2: Rename Existing Attributes\n\nRename attributes in `rtx_interface_acl`:\n- `ip_access_group_in` → `access_list_ip_in`\n- `ip_access_group_out` → `access_list_ip_out`\n- `ipv6_access_group_in` → `access_list_ipv6_in`\n- `ipv6_access_group_out` → `access_list_ipv6_out`\n- `dynamic_filters_in` → `ip_filter_dynamic_in`\n- `dynamic_filters_out` → `ip_filter_dynamic_out`\n- `ipv6_dynamic_filters_in` → `ipv6_filter_dynamic_in`\n- `ipv6_dynamic_filters_out` → `ipv6_filter_dynamic_out`\n\nRename attributes in `rtx_interface_mac_acl`:\n- `mac_access_group_in` → `access_list_mac_in`\n- `mac_access_group_out` → `access_list_mac_out`\n\n### Phase 3: Remove Filter Attributes from rtx_interface\n\nRemove from `rtx_interface`:\n- `secure_filter_in`\n- `secure_filter_out`\n- `dynamic_filter_out`\n- `ethernet_filter_in`\n- `ethernet_filter_out`\n\nUpdate `InterfaceConfig` struct and service layer accordingly.\n\n### Phase 4: Update Documentation and Examples\n\n- Update resource documentation\n- Update examples\n- Add migration guide\n- Update master specs\n\n## Schema Definitions\n\n### rtx_interface_acl (Updated)\n\n```go\nSchema: map[string]*schema.Schema{\n    \"interface\": {\n        Type:        schema.TypeString,\n        Required:    true,\n        ForceNew:    true,\n        Description: \"Interface name (lan1, pp1, tunnel1, etc.)\",\n    },\n    // IP Access Lists (by name)\n    \"access_list_ip_in\": {\n        Type:        schema.TypeString,\n        Optional:    true,\n        Description: \"Inbound IPv4 access list name\",\n    },\n    \"access_list_ip_out\": {\n        Type:        schema.TypeString,\n        Optional:    true,\n        Description: \"Outbound IPv4 access list name\",\n    },\n    // IPv6 Access Lists (by name)\n    \"access_list_ipv6_in\": {\n        Type:        schema.TypeString,\n        Optional:    true,\n        Description: \"Inbound IPv6 access list name\",\n    },\n    \"access_list_ipv6_out\": {\n        Type:        schema.TypeString,\n        Optional:    true,\n        Description: \"Outbound IPv6 access list name\",\n    },\n    // IP Filters (by number)\n    \"ip_filter_in\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Inbound IPv4 filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntAtLeast(1),\n        },\n    },\n    \"ip_filter_out\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Outbound IPv4 filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntAtLeast(1),\n        },\n    },\n    // Dynamic Filters\n    \"ip_filter_dynamic_in\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Inbound IPv4 dynamic filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntAtLeast(1),\n        },\n    },\n    \"ip_filter_dynamic_out\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Outbound IPv4 dynamic filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntAtLeast(1),\n        },\n    },\n    // IPv6 Dynamic Filters\n    \"ipv6_filter_dynamic_in\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Inbound IPv6 dynamic filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntAtLeast(1),\n        },\n    },\n    \"ipv6_filter_dynamic_out\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Outbound IPv6 dynamic filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntAtLeast(1),\n        },\n    },\n}\n```\n\n### rtx_interface_mac_acl (Updated)\n\n```go\nSchema: map[string]*schema.Schema{\n    \"interface\": {\n        Type:        schema.TypeString,\n        Required:    true,\n        ForceNew:    true,\n        Description: \"Interface name (lan1, bridge1, vlan1, etc.)\",\n    },\n    // MAC Access Lists (by name)\n    \"access_list_mac_in\": {\n        Type:        schema.TypeString,\n        Optional:    true,\n        Description: \"Inbound MAC access list name\",\n    },\n    \"access_list_mac_out\": {\n        Type:        schema.TypeString,\n        Optional:    true,\n        Description: \"Outbound MAC access list name\",\n    },\n    // Ethernet Filters (by number)\n    \"ethernet_filter_in\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Inbound ethernet filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntBetween(1, 512),\n        },\n    },\n    \"ethernet_filter_out\": {\n        Type:        schema.TypeList,\n        Optional:    true,\n        Description: \"Outbound ethernet filter numbers\",\n        Elem: &schema.Schema{\n            Type:         schema.TypeInt,\n            ValidateFunc: validation.IntBetween(1, 512),\n        },\n    },\n}\n```\n\n## RTX Command Mapping\n\n### IP Secure Filters\n\n| Attribute | RTX Command |\n|-----------|-------------|\n| `ip_filter_in` | `ip {interface} secure filter in {n1} {n2} ...` |\n| `ip_filter_out` | `ip {interface} secure filter out {n1} {n2} ...` |\n| `ip_filter_dynamic_in` | `ip {interface} secure filter in ... dynamic {n1} {n2} ...` |\n| `ip_filter_dynamic_out` | `ip {interface} secure filter out ... dynamic {n1} {n2} ...` |\n\n### Ethernet Filters\n\n| Attribute | RTX Command |\n|-----------|-------------|\n| `ethernet_filter_in` | `ethernet {interface} filter in {n1} {n2} ...` |\n| `ethernet_filter_out` | `ethernet {interface} filter out {n1} {n2} ...` |\n\n## Migration Example\n\n### Before (Using rtx_interface)\n\n```hcl\nresource \"rtx_interface\" \"lan1\" {\n  name              = \"lan1\"\n  secure_filter_in  = [100, 101]\n  secure_filter_out = [200, 201]\n  dynamic_filter_out = [300]\n  ethernet_filter_in = [1, 2]\n}\n```\n\n### After (Using Dedicated Resources)\n\n```hcl\nresource \"rtx_interface\" \"lan1\" {\n  name = \"lan1\"\n}\n\nresource \"rtx_interface_acl\" \"lan1\" {\n  interface            = rtx_interface.lan1.interface_name\n  ip_filter_in         = [100, 101]\n  ip_filter_out        = [200, 201]\n  ip_filter_dynamic_out = [300]\n}\n\nresource \"rtx_interface_mac_acl\" \"lan1\" {\n  interface          = rtx_interface.lan1.interface_name\n  ethernet_filter_in = [1, 2]\n}\n```\n\n## File Changes\n\n### Files to Modify\n\n1. `internal/provider/resource_rtx_interface.go`\n   - Remove filter attributes from schema\n   - Remove filter handling from CRUD operations\n   - Update tests\n\n2. `internal/provider/resource_rtx_interface_acl.go`\n   - Rename existing attributes\n   - Add `ip_filter_in`, `ip_filter_out`\n   - Update service method calls\n\n3. `internal/provider/resource_rtx_interface_mac_acl.go`\n   - Rename existing attributes\n   - Add `ethernet_filter_in`, `ethernet_filter_out`\n   - Update service method calls\n\n4. `internal/client/interface_service.go`\n   - Remove filter-related methods from InterfaceService\n   - Update InterfaceConfig struct\n\n5. `internal/client/interfaces.go`\n   - Update InterfaceConfig struct definition\n\n6. `docs/resources/interface.md`\n   - Remove filter attributes documentation\n\n7. `docs/resources/interface_acl.md`\n   - Update with new attribute names\n\n8. `docs/resources/interface_mac_acl.md`\n   - Update with new attribute names\n\n## Testing Strategy\n\n### Unit Tests\n\n1. Schema validation tests for new attributes\n2. Service method tests for filter application\n3. Parser tests for command generation\n\n### Integration Tests\n\n1. Apply IP filters via rtx_interface_acl\n2. Apply ethernet filters via rtx_interface_mac_acl\n3. Update filter configuration\n4. Remove filter configuration\n\n### Migration Tests\n\n1. Test that old attribute names are rejected\n2. Test clear error messages for deprecated attributes\n\n## Risks and Mitigations\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| Breaking change for existing users | High | Clear migration documentation, changelog entry |\n| Incomplete migration | Medium | Thorough testing of all filter combinations |\n| Service layer complexity | Low | Maintain existing RTX command generation |\n\n## Change History\n\n| Date | Author | Changes |\n|------|--------|---------|\n| 2026-01-25 | Claude | Initial design |\n",
  "fileStats": {
    "size": 10823,
    "lines": 389,
    "lastModified": "2026-01-25T07:02:42.265Z"
  },
  "comments": []
}