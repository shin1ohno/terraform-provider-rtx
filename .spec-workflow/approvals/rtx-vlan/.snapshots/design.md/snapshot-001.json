{
  "id": "snapshot_1768799794886_0nn3g0u7i",
  "approvalId": "approval_1768799794882_r4vg4tsmj",
  "approvalTitle": "Design: rtx_vlan resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:34.886Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_vlan\n\n## Overview\n\nThe `rtx_vlan` resource enables Terraform-based management of VLAN configuration on Yamaha RTX series routers. Following Cisco IOS XE Terraform provider naming conventions, this resource manages VLAN interfaces with 802.1Q tagging, IP address assignment, and port mappings.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with VLAN methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add VLAN methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **IP configuration**: Coordinate with interface IP settings\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_vlan.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        VLANService[vlan_service.go]\n    end\n\n    subgraph Parser Layer\n        VLANParser[vlan.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> VLANService\n    VLANService --> VLANParser\n    VLANParser --> Commands\n    VLANParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `VLANService` handles all VLAN CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all VLAN logic\n- **Utility Modularity**: Shared validation functions for VLAN ID and IP operations\n\n## Components and Interfaces\n\n### Component 1: VLANService (`internal/client/vlan_service.go`)\n\n- **Purpose:** Handles all VLAN CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type VLANService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *VLANService) Create(ctx context.Context, vlan VLAN) error\n  func (s *VLANService) Get(ctx context.Context, iface string, vlanID int) (*VLAN, error)\n  func (s *VLANService) Update(ctx context.Context, vlan VLAN) error\n  func (s *VLANService) Delete(ctx context.Context, iface string, vlanID int) error\n  func (s *VLANService) List(ctx context.Context) ([]VLAN, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.VLANParser`\n- **Reuses:** Pattern from `DHCPScopeService`, `Executor` interface\n\n### Component 2: VLANParser (`internal/rtx/parsers/vlan.go`)\n\n- **Purpose:** Parses RTX router output for VLAN configuration and builds commands\n- **Interfaces:**\n  ```go\n  type VLAN struct {\n      VlanID       int    `json:\"vlan_id\"`\n      Name         string `json:\"name,omitempty\"`\n      Interface    string `json:\"interface\"`       // Parent interface (lan1, lan2)\n      VlanInterface string `json:\"vlan_interface\"` // Derived: lan1/1, etc.\n      IPAddress    string `json:\"ip_address,omitempty\"`\n      IPMask       string `json:\"ip_mask,omitempty\"`\n      Shutdown     bool   `json:\"shutdown\"`\n  }\n\n  func ParseVLANConfig(raw string) ([]VLAN, error)\n  func BuildVLANCommand(vlan VLAN) string\n  func BuildVLANIPCommand(vlanIface, ip, mask string) string\n  func BuildDeleteVLANCommand(iface string, vlanID int) string\n  func BuildShowVLANCommand() string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_vlan.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXVLAN() *schema.Resource\n  func resourceRTXVLANCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXVLANRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXVLANUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXVLANDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXVLANImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `VLAN`, Terraform SDK\n- **Reuses:** `resourceRTXDHCPScope` patterns\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with VLAN methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetVLAN(ctx context.Context, iface string, vlanID int) (*VLAN, error)\n  CreateVLAN(ctx context.Context, vlan VLAN) error\n  UpdateVLAN(ctx context.Context, vlan VLAN) error\n  DeleteVLAN(ctx context.Context, iface string, vlanID int) error\n  ListVLANs(ctx context.Context) ([]VLAN, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### VLAN\n\n```go\n// VLAN represents a VLAN configuration on an RTX router\ntype VLAN struct {\n    VlanID        int    `json:\"vlan_id\"`          // VLAN ID (1-4094)\n    Name          string `json:\"name,omitempty\"`   // VLAN name/description\n    Interface     string `json:\"interface\"`        // Parent interface (lan1, lan2)\n    VlanInterface string `json:\"vlan_interface\"`   // Computed: lan1/1, lan1/2, etc.\n    IPAddress     string `json:\"ip_address,omitempty\"`\n    IPMask        string `json:\"ip_mask,omitempty\"`\n    Shutdown      bool   `json:\"shutdown\"`         // Admin state\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_vlan\" \"management\" {\n  vlan_id   = 10              # Required, ForceNew\n  name      = \"Management\"    # Optional\n  shutdown  = false           # Optional, default false\n\n  # RTX-specific: parent interface\n  interface = \"lan1\"          # Required, ForceNew\n\n  # IP configuration\n  ip_address = \"192.168.10.1\" # Optional\n  ip_mask    = \"255.255.255.0\" # Required if ip_address set\n}\n\nresource \"rtx_vlan\" \"users\" {\n  vlan_id   = 20\n  name      = \"Users\"\n  shutdown  = false\n  interface = \"lan1\"\n\n  ip_address = \"192.168.20.1\"\n  ip_mask    = \"255.255.255.0\"\n}\n```\n\n## RTX Command Mapping\n\n### Create VLAN Interface\n\n```\nvlan <interface>/<n> 802.1q vid=<vlan_id>\n```\n\nExample: `vlan lan1/1 802.1q vid=10`\n\n### Configure VLAN IP\n\n```\nip <vlan_interface> address <ip>/<prefix>\n```\n\nExample: `ip lan1/1 address 192.168.10.1/24`\n\n### Configure VLAN Description\n\n```\ndescription <vlan_interface> <name>\n```\n\n### Shutdown/No Shutdown\n\n```\n<vlan_interface> enable\nno <vlan_interface> enable\n```\n\n### Port Mapping\n\n```\nvlan port mapping <interface> <vlan_list>\n```\n\nExample: `vlan port mapping lan1 vlan1 vlan2`\n\n### Delete VLAN\n\n```\nno vlan <interface>/<n>\n```\n\n### Show VLAN Configuration\n\n```\nshow config | grep vlan\nshow status lan1\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid VLAN ID**\n   - **Handling:** Validate VLAN ID is in range 1-4094\n   - **User Impact:** Clear validation error with valid range\n\n2. **VLAN Already Exists**\n   - **Handling:** Parse RTX output for existing VLAN\n   - **User Impact:** Error suggesting import or different ID\n\n3. **Invalid Parent Interface**\n   - **Handling:** Validate interface name exists and supports VLAN\n   - **User Impact:** Error indicating invalid interface\n\n4. **Invalid IP Configuration**\n   - **Handling:** Validate IP address and mask format\n   - **User Impact:** Clear error with expected format\n\n5. **VLAN Slot Exhausted**\n   - **Handling:** Check available VLAN slots on interface\n   - **User Impact:** Error indicating maximum VLANs reached\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`vlan_test.go`):\n  - Parse various RTX `show config` output for VLAN configuration\n  - Test command builder functions with different parameters\n  - Test VLAN ID validation\n\n- **Service Tests** (`vlan_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test IP configuration handling\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_vlan_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - IP configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create VLAN with IP address\n  - Create VLAN without IP address\n  - Update VLAN name\n  - Update VLAN IP configuration\n  - Toggle shutdown state\n  - Delete VLAN\n  - Import existing VLAN\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_vlan.go      # NEW: Terraform resource\n│   └── resource_rtx_vlan_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go              # MODIFY: Add VLAN type and methods\n│   ├── client.go                  # MODIFY: Add VLAN service initialization\n│   ├── vlan_service.go           # NEW: VLAN service implementation\n│   └── vlan_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── vlan.go               # NEW: Parser and command builders\n        └── vlan_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **VLAN Interface Naming**: RTX uses `lan1/1`, `lan1/2` format. The `/n` suffix is auto-assigned or can be specified.\n\n2. **VLAN ID vs Interface Number**: VLAN ID (vid) and interface number can be different. `lan1/1 vid=10` creates VLAN 10 on interface slot 1.\n\n3. **Terraform ID**: Use `interface/vlan_id` as Terraform resource ID (e.g., \"lan1/10\").\n\n4. **ForceNew**: `vlan_id` and `interface` are ForceNew. IP and name support in-place updates.\n\n5. **IP Mask Format**: RTX accepts both dotted decimal (255.255.255.0) and prefix length (/24). Normalize to one format.\n\n6. **Port Mapping**: Consider as separate resource or attribute for tagged/untagged port assignment.\n\n7. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n8. **Provider Registration**: Add `resourceRTXVLAN` to provider's resource map.\n\n9. **Computed Attribute**: `vlan_interface` (e.g., \"lan1/1\") is computed from `interface` and `vlan_id`.\n",
  "fileStats": {
    "size": 10136,
    "lines": 323,
    "lastModified": "2026-01-19T05:08:40.959Z"
  },
  "comments": []
}