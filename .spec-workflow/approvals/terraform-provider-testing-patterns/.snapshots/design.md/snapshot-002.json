{
  "id": "snapshot_1769256919522_7vekiow5u",
  "approvalId": "approval_1769256891986_9zbh3nrj3",
  "approvalTitle": "Design: Terraform Provider Testing Patterns",
  "version": 2,
  "timestamp": "2026-01-24T12:15:19.522Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Terraform Provider Testing Patterns\n\n## Overview\n\nThis document describes the technical design for implementing comprehensive testing patterns in the Terraform provider for RTX routers. The design establishes reusable test utilities, consistent test structures, and patterns that ensure provider reliability across all resources.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Testing Framework**: Go testing package + stretchr/testify v1.10.0\n- **SDK**: terraform-plugin-sdk/v2 v2.37.0 with testing helpers\n- **Logging**: Zerolog for test debugging output\n- **Code Style**: golangci-lint compliance\n\n### Project Structure (structure.md)\n\nImplementation will follow the established structure:\n- Test utilities in `internal/provider/acctest/`\n- Resource tests in `internal/provider/resource_*_test.go`\n- Parser tests in `internal/rtx/parsers/*_test.go`\n- Test fixtures in `internal/provider/testdata/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **terraform-plugin-sdk/v2/helper/resource**: Core acceptance test framework\n- **terraform-plugin-sdk/v2/helper/acctest**: Random name generation\n- **testify/assert and require**: Assertion helpers\n- **Existing test patterns**: Current tests in `*_test.go` files\n\n### Integration Points\n\n- **Provider factory**: `testAccProviderFactories` for test provider instantiation\n- **SSH client**: Reuse existing client for router connectivity checks\n- **Parser utilities**: Reuse parsers for verifying router state\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Test Infrastructure\"\n        A[acctest Package] --> B[Config Builders]\n        A --> C[Check Functions]\n        A --> D[PreCheck/PostCheck]\n    end\n\n    subgraph \"Test Types\"\n        E[Unit Tests] --> F[Field Helpers]\n        E --> G[Parsers]\n        H[Acceptance Tests] --> I[CRUD Lifecycle]\n        H --> J[Import Tests]\n        H --> K[State Migration]\n    end\n\n    subgraph \"Assertions\"\n        L[Plan Checks] --> M[ExpectEmptyPlan]\n        L --> N[ExpectKnownValue]\n        O[State Checks] --> P[ValueComparers]\n        O --> Q[AttributeChecks]\n    end\n\n    A --> E\n    A --> H\n    H --> L\n    H --> O\n```\n\n## Components and Interfaces\n\n### Component 1: AccTest Package\n\n- **Purpose:** Provide reusable test utilities and configuration builders\n- **Location:** `internal/provider/acctest/acctest.go`\n- **Interfaces:**\n  ```go\n  // PreCheck verifies test prerequisites (router connectivity, credentials)\n  func PreCheck(t *testing.T)\n\n  // ConfigBuilder builds HCL configurations for tests\n  type ConfigBuilder struct {\n      resourceType string\n      resourceName string\n      attributes   map[string]interface{}\n  }\n\n  // NewConfigBuilder creates a new configuration builder\n  func NewConfigBuilder(resourceType, resourceName string) *ConfigBuilder\n\n  // Build generates HCL configuration string\n  func (b *ConfigBuilder) Build() string\n\n  // RandomName generates a unique resource name for parallel tests\n  func RandomName(prefix string) string\n  ```\n- **Dependencies:** `terraform-plugin-sdk/v2/helper/acctest`\n\n### Component 2: Check Functions\n\n- **Purpose:** Provide reusable check functions for common assertions\n- **Location:** `internal/provider/acctest/checks.go`\n- **Interfaces:**\n  ```go\n  // CheckResourceAttrNotEmpty verifies attribute is set and non-empty\n  func CheckResourceAttrNotEmpty(resourceName, attrName string) resource.TestCheckFunc\n\n  // CheckNoPlannedChanges verifies no changes in plan (SDK v2 pattern)\n  func CheckNoPlannedChanges(resourceName string) resource.TestCheckFunc\n\n  // CheckResourceImportState verifies import populates expected attributes\n  func CheckResourceImportState(resourceName string, attrs []string) resource.ImportStateCheckFunc\n  ```\n- **Dependencies:** `terraform-plugin-sdk/v2/helper/resource`\n\n### Component 3: Test Step Builders\n\n- **Purpose:** Build standard test steps for consistent test structure\n- **Location:** `internal/provider/acctest/steps.go`\n- **Interfaces:**\n  ```go\n  // BasicCreateStep returns a TestStep for basic resource creation\n  func BasicCreateStep(config string, checks ...resource.TestCheckFunc) resource.TestStep\n\n  // UpdateStep returns a TestStep for resource updates\n  func UpdateStep(config string, checks ...resource.TestCheckFunc) resource.TestStep\n\n  // ImportStep returns a TestStep for import testing\n  func ImportStep(resourceName string) resource.TestStep\n\n  // NoChangeStep returns a TestStep that verifies no changes (perpetual diff check)\n  func NoChangeStep(config string) resource.TestStep\n  ```\n- **Dependencies:** `terraform-plugin-sdk/v2/helper/resource`\n\n### Component 4: State Migration Test Helpers\n\n- **Purpose:** Provide utilities for testing schema version upgrades\n- **Location:** `internal/provider/acctest/migration.go`\n- **Interfaces:**\n  ```go\n  // StateMigrationTestCase defines a state migration test scenario\n  type StateMigrationTestCase struct {\n      Name          string\n      OldState      map[string]interface{}\n      ExpectedState map[string]interface{}\n      UpgradeFunc   schema.StateUpgradeFunc\n  }\n\n  // RunStateMigrationTests executes state migration test cases\n  func RunStateMigrationTests(t *testing.T, cases []StateMigrationTestCase)\n\n  // CrossVersionTestStep returns a TestStep using ExternalProviders\n  func CrossVersionTestStep(providerVersion, config string) resource.TestStep\n  ```\n- **Dependencies:** `terraform-plugin-sdk/v2/helper/schema`\n\n## Data Models\n\n### TestConfig\n\n```go\n// TestConfig holds configuration for a test resource\ntype TestConfig struct {\n    ResourceType string                 `json:\"resource_type\"`\n    ResourceName string                 `json:\"resource_name\"`\n    Attributes   map[string]interface{} `json:\"attributes\"`\n    DependsOn    []string               `json:\"depends_on,omitempty\"`\n}\n```\n\n### TestFixture\n\n```go\n// TestFixture represents expected router state for verification\ntype TestFixture struct {\n    ResourceID     string                 `json:\"resource_id\"`\n    ExpectedAttrs  map[string]interface{} `json:\"expected_attrs\"`\n    RouterCommands []string               `json:\"router_commands\"`\n}\n```\n\n## Test Pattern Implementations\n\n### Pattern 1: Perpetual Diff Prevention\n\n```go\nfunc TestAccResource_noDiff(t *testing.T) {\n    resourceName := \"rtx_admin_user.test\"\n    config := testAccAdminUserConfig_basic()\n\n    resource.Test(t, resource.TestCase{\n        PreCheck:          func() { acctest.PreCheck(t) },\n        ProviderFactories: testAccProviderFactories,\n        Steps: []resource.TestStep{\n            // Step 1: Create resource\n            {\n                Config: config,\n                Check: resource.ComposeTestCheckFunc(\n                    resource.TestCheckResourceAttrSet(resourceName, \"username\"),\n                ),\n            },\n            // Step 2: Re-apply same config - should be no-op\n            {\n                Config:   config,\n                PlanOnly: true,\n                // In SDK v2, empty plan is verified automatically\n                // Test fails if any changes are planned\n            },\n        },\n    })\n}\n```\n\n### Pattern 2: Import Testing\n\n```go\nfunc TestAccResource_import(t *testing.T) {\n    resourceName := \"rtx_admin_user.test\"\n    config := testAccAdminUserConfig_basic()\n\n    resource.Test(t, resource.TestCase{\n        PreCheck:          func() { acctest.PreCheck(t) },\n        ProviderFactories: testAccProviderFactories,\n        Steps: []resource.TestStep{\n            // Step 1: Create resource\n            {\n                Config: config,\n            },\n            // Step 2: Import and verify\n            {\n                ResourceName:      resourceName,\n                ImportState:       true,\n                ImportStateVerify: true,\n                // Fields that cannot be imported (e.g., passwords)\n                ImportStateVerifyIgnore: []string{\"password\"},\n            },\n        },\n    })\n}\n```\n\n### Pattern 3: State Migration Testing\n\n```go\nfunc TestAdminUser_StateUpgradeV0(t *testing.T) {\n    cases := []acctest.StateMigrationTestCase{\n        {\n            Name: \"basic upgrade\",\n            OldState: map[string]interface{}{\n                \"name\": \"admin\",  // Old field name\n            },\n            ExpectedState: map[string]interface{}{\n                \"username\": \"admin\",  // New field name\n            },\n            UpgradeFunc: resourceAdminUserStateUpgradeV0,\n        },\n    }\n    acctest.RunStateMigrationTests(t, cases)\n}\n```\n\n### Pattern 4: Optional+Computed Field Preservation\n\n```go\nfunc TestAccAdminUser_preserveAdministrator(t *testing.T) {\n    resourceName := \"rtx_admin_user.test\"\n\n    // Config with administrator=true\n    configWithAdmin := `\nresource \"rtx_admin_user\" \"test\" {\n    username      = \"testuser\"\n    password      = \"testpass\"\n    administrator = true\n}`\n\n    // Config without administrator (should preserve existing value)\n    configWithoutAdmin := `\nresource \"rtx_admin_user\" \"test\" {\n    username = \"testuser\"\n    password = \"testpass\"\n}`\n\n    resource.Test(t, resource.TestCase{\n        PreCheck:          func() { acctest.PreCheck(t) },\n        ProviderFactories: testAccProviderFactories,\n        Steps: []resource.TestStep{\n            // Step 1: Create with administrator=true\n            {\n                Config: configWithAdmin,\n                Check: resource.ComposeTestCheckFunc(\n                    resource.TestCheckResourceAttr(resourceName, \"administrator\", \"true\"),\n                ),\n            },\n            // Step 2: Apply without administrator - should preserve true\n            {\n                Config: configWithoutAdmin,\n                Check: resource.ComposeTestCheckFunc(\n                    resource.TestCheckResourceAttr(resourceName, \"administrator\", \"true\"),\n                ),\n            },\n        },\n    })\n}\n```\n\n### Pattern 5: WriteOnly Attribute Testing\n\n```go\nfunc TestAccAdminUser_passwordNotInState(t *testing.T) {\n    resourceName := \"rtx_admin_user.test\"\n\n    resource.Test(t, resource.TestCase{\n        PreCheck:          func() { acctest.PreCheck(t) },\n        ProviderFactories: testAccProviderFactories,\n        Steps: []resource.TestStep{\n            {\n                Config: testAccAdminUserConfig_withPassword(\"secretpass\"),\n                Check: resource.ComposeTestCheckFunc(\n                    // Password should not be readable from state\n                    resource.TestCheckNoResourceAttr(resourceName, \"password\"),\n                    // Or if Sensitive, verify it's set but masked\n                    testCheckSensitiveAttrSet(resourceName, \"password\"),\n                ),\n            },\n        },\n    })\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Router Connectivity Failure in PreCheck**\n   - **Handling:** Skip test with clear message\n   - **User Impact:** Test marked as skipped, not failed\n\n2. **Resource Creation Failure**\n   - **Handling:** Test fails with router error message\n   - **User Impact:** Clear error indicating what failed\n\n3. **Import ID Not Found**\n   - **Handling:** Test fails with \"resource not found\" error\n   - **User Impact:** Indicates import ID format may be incorrect\n\n4. **State Migration Failure**\n   - **Handling:** Test fails with comparison diff\n   - **User Impact:** Shows expected vs actual state\n\n## Testing Strategy\n\n### Unit Testing\n\n- Test config builders produce valid HCL\n- Test check functions work with mock data\n- Test state migration upgraders with various input formats\n\n### Integration Testing\n\n- Full CRUD lifecycle with real router\n- Import from existing router resources\n- Cross-version state migration\n\n### Test Organization\n\n```\ninternal/provider/\n├── acctest/\n│   ├── acctest.go      # PreCheck, provider setup\n│   ├── checks.go       # Reusable check functions\n│   ├── config.go       # Config builders\n│   ├── migration.go    # State migration helpers\n│   └── steps.go        # Test step builders\n├── resource_rtx_admin_user_test.go\n├── resource_rtx_admin_test.go\n└── testdata/\n    ├── admin_user_basic.tf\n    └── fixtures/\n        └── admin_user.json\n```\n\n## Performance Considerations\n\n- Use `t.Parallel()` for independent tests\n- Share provider instance across test steps\n- Minimize router commands in tests\n- Use test fixtures where possible instead of live router calls\n\n## Security Considerations\n\n- Never log actual passwords in test output\n- Use dedicated test users/resources\n- Clean up test resources in CheckDestroy\n- Don't commit real credentials in test fixtures\n",
  "fileStats": {
    "size": 12561,
    "lines": 396,
    "lastModified": "2026-01-24T12:14:41.643Z"
  },
  "comments": []
}