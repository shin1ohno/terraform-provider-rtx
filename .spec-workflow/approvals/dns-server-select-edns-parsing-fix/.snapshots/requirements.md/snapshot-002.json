{
  "id": "snapshot_1769072946792_l4pixm0qo",
  "approvalId": "approval_1769072875210_f6qllbi8z",
  "approvalTitle": "Requirements: DNS Server Select Per-Server EDNS Support",
  "version": 2,
  "timestamp": "2026-01-22T09:09:06.792Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: DNS Server Select Per-Server EDNS Support\n\n## Introduction\n\nThis spec addresses a parsing issue with `dns server select` entries and extends the schema to support per-server EDNS configuration, aligning with RTX router capabilities.\n\n**Current Problem**: `server_select[500100]` shows `query_pattern: \"edns\"` (should be \".\") and `record_type: \"\"` (should be \"aaaa\") after import from RTX router.\n\n**Root Cause**: The current schema uses a single `edns` boolean for all servers, but RTX routers support per-server EDNS options. The parser incorrectly handles the interleaved `edns=on` tokens in the command output.\n\n**Solution**: Restructure the schema to support per-server EDNS configuration, which will also fix the parsing issue.\n\n## RTX Command Syntax Reference\n\nPer [Yamaha RTX Manual](https://www.rtpro.yamaha.co.jp/RT/manual/rt-common/dns/dns_server_select.html):\n\n```\ndns server select id server [edns=sw] [server2 [edns=sw]] [type] query\n```\n\nEach server can have its own `edns=on` or `edns=off` setting independently.\n\n## Problem Evidence\n\n### Current Terraform State (Incorrect)\n```json\n{\n  \"id\": 500100,\n  \"servers\": [\"2606:4700:4700::1111\", \"2606:4700:4700::1001\"],\n  \"edns\": true,\n  \"query_pattern\": \"edns\",\n  \"record_type\": \"\"\n}\n```\n\n### Expected Values\n```json\n{\n  \"id\": 500100,\n  \"servers\": [\n    {\"address\": \"2606:4700:4700::1111\", \"edns\": true},\n    {\"address\": \"2606:4700:4700::1001\", \"edns\": true}\n  ],\n  \"query_pattern\": \".\",\n  \"record_type\": \"aaaa\"\n}\n```\n\n## Alignment with Product Vision\n\nPer product.md:\n- **Cisco-Compatible Syntax**: Nested blocks for complex configurations\n- **Follow RTX CLI Semantics**: Mirror RTX router terminology\n- **State Clarity**: Accurately represent router configuration in state\n\nThis change enables full fidelity import of DNS server select configurations.\n\n## Requirements\n\n### REQ-1: Per-Server EDNS Schema\n\n**User Story:** As a Terraform user, I want to specify EDNS settings for each DNS server independently, so that I can accurately represent RTX configurations where servers have different EDNS settings.\n\n#### Acceptance Criteria\n\n1. WHEN defining a server_select block THEN user SHALL be able to specify EDNS per server:\n   ```hcl\n   server_select {\n     id            = 500100\n     record_type   = \"aaaa\"\n     query_pattern = \".\"\n\n     server {\n       address = \"2606:4700:4700::1111\"\n       edns    = true\n     }\n     server {\n       address = \"2606:4700:4700::1001\"\n       edns    = true\n     }\n   }\n   ```\n\n2. WHEN a server block omits `edns` THEN it SHALL default to `false`\n\n3. WHEN more than 2 server blocks are specified THEN validation SHALL fail with clear error (RTX limit)\n\n4. WHEN building RTX command THEN output SHALL be:\n   ```\n   dns server select 500100 2606:4700:4700::1111 edns=on 2606:4700:4700::1001 edns=on aaaa .\n   ```\n\n### REQ-2: Backward Compatibility (Deprecation)\n\n**User Story:** As a Terraform user with existing configurations, I want my current `servers` and `edns` attributes to continue working during migration, so that I don't have breaking changes.\n\n#### Acceptance Criteria\n\n1. WHEN using deprecated `servers` attribute THEN provider SHALL emit deprecation warning\n\n2. WHEN using deprecated `servers` with `edns=true` THEN all servers SHALL have EDNS enabled\n\n3. WHEN both `servers` (deprecated) and `server` blocks are specified THEN validation SHALL fail\n\n4. IF `servers` is used without `edns` THEN all servers SHALL have EDNS disabled (default)\n\n5. WHEN reading state with old schema THEN provider SHALL convert to new schema format\n\n### REQ-3: Correct Parsing of RTX Output\n\n**User Story:** As a Terraform user, I want DNS server select entries to be parsed correctly from RTX output, so that imported state matches the actual router configuration.\n\n#### Acceptance Criteria\n\n1. WHEN RTX output contains `dns server select <id> <server1> edns=on <server2> edns=on <type> <pattern>` THEN parser SHALL extract:\n   - server1 with edns=true\n   - server2 with edns=true\n   - record_type correctly\n   - query_pattern correctly\n\n2. WHEN RTX output contains `dns server select <id> <server1> <server2> edns=on <pattern>` (trailing EDNS) THEN parser SHALL apply EDNS to all servers\n\n3. WHEN RTX output contains `dns server select <id> <server1> edns=off <server2> edns=on <pattern>` THEN parser SHALL correctly capture per-server settings\n\n4. WHEN RTX output is line-wrapped THEN parser SHALL preprocess lines before parsing\n\n5. WHEN running `terraform refresh` after implementation THEN server_select[500100] SHALL show correct values\n\n### REQ-4: Command Building\n\n**User Story:** As a Terraform user, I want the provider to generate correct RTX commands when applying configurations, so that my intended settings are applied to the router.\n\n#### Acceptance Criteria\n\n1. WHEN all servers have `edns=true` THEN command SHALL include `edns=on` after each server\n\n2. WHEN all servers have `edns=false` THEN command SHALL omit `edns=on` options\n\n3. WHEN servers have mixed EDNS settings THEN command SHALL include appropriate option after each server\n\n4. WHEN only one server is specified THEN command SHALL be valid single-server format\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- Update DNSServerSelect struct to use nested Server struct\n- Maintain separation between parser, builder, and client layers\n- Follow existing code patterns in `internal/rtx/parsers/`\n\n### Migration\n- Terraform state upgrade path from old to new schema\n- Clear deprecation warnings with migration guidance\n- Documentation for migration steps\n\n### Testing\n- Unit tests for parser with all EDNS variations\n- Unit tests for command builder\n- Integration test with actual RTX router\n- State migration tests\n\n### Reliability\n- Graceful handling of malformed input\n- Clear error messages for validation failures\n- No data loss during state migration\n",
  "fileStats": {
    "size": 5875,
    "lines": 165,
    "lastModified": "2026-01-22T09:07:49.682Z"
  },
  "comments": []
}