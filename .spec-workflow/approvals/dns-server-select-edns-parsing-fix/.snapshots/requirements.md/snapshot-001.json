{
  "id": "snapshot_1769069157540_rje8t59nh",
  "approvalId": "approval_1769069157526_mx6e01qzq",
  "approvalTitle": "Requirements: DNS Server Select EDNS Parsing Fix",
  "version": 1,
  "timestamp": "2026-01-22T08:05:57.540Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: DNS Server Select EDNS Parsing Fix\n\n## Introduction\n\nThis spec addresses a critical parsing issue where `dns server select` entries with interleaved `edns=on` options fail to parse correctly when imported from actual RTX router output. Specifically, the `query_pattern` is incorrectly set to \"edns\" (should be \".\") and `record_type` is empty (should be \"aaaa\").\n\n**Current State**: Unit tests pass with the expected format, but terraform state shows incorrect values after importing from a real RTX router, indicating the actual RTX output format differs from test assumptions.\n\n## Problem Evidence\n\n### Terraform State (Actual)\n```json\n{\n  \"id\": 500100,\n  \"servers\": [\"2606:4700:4700::1111\", \"2606:4700:4700::1001\"],\n  \"edns\": true,\n  \"query_pattern\": \"edns\",     // WRONG: should be \".\"\n  \"record_type\": \"\",           // WRONG: should be \"aaaa\"\n}\n```\n\n### Expected Values\n```json\n{\n  \"id\": 500100,\n  \"servers\": [\"2606:4700:4700::1111\", \"2606:4700:4700::1001\"],\n  \"edns\": true,\n  \"query_pattern\": \".\",\n  \"record_type\": \"aaaa\"\n}\n```\n\n### RTX Command (Expected Format)\nAccording to [Yamaha RTX Manual](https://www.rtpro.yamaha.co.jp/RT/manual/rt-common/dns/dns_server_select.html):\n```\ndns server select 500100 2606:4700:4700::1111 edns=on 2606:4700:4700::1001 edns=on aaaa .\n```\n\n## Root Cause Hypotheses\n\n### H1: Line Wrapping Issue\nRTX routers wrap long lines at ~80 characters. If the command wraps such that `edns=on` appears at the start of a continuation line:\n```\ndns server select 500100 2606:4700:4700::1111 edns=on 2606:4700:4700::1001\nedns=on aaaa .\n```\nThe `preprocessWrappedLines` function in interface_config.go may not be used by the DNS parser, or may not handle this correctly.\n\n### H2: Alternate EDNS Format\nRTX may output `edns` without `=on`, or with different syntax (`edns=off`, `edns off`, etc.) that the current parser doesn't recognize.\n\n### H3: DNS Parser Lacks Line Preprocessing\nThe DNS parser may process raw output without the line-joining preprocessing that interface_config.go uses, causing split lines to be parsed incorrectly.\n\n### H4: Token Order Assumption\nThe parser assumes `edns=on` immediately follows each server, but RTX output may place all EDNS options at the end or in a different order.\n\n## Alignment with Product Vision\n\nImport fidelity is critical for:\n- Accurate drift detection during `terraform plan`\n- Safe adoption of Infrastructure as Code for existing RTX deployments\n- Correct round-trip behavior (import â†’ plan shows no changes)\n\nPer product.md: \"Fail Safely: Validate configurations before applying; provide clear error messages\"\n\n## Requirements\n\n### REQ-1: Diagnose Actual RTX Output Format\n\n**User Story:** As a developer, I need to capture and analyze the actual RTX output for `dns server select` commands with interleaved EDNS options, so that I can understand why parsing fails.\n\n#### Acceptance Criteria\n\n1. WHEN running `show config | grep dns` on the RTX router THEN the exact raw output SHALL be captured and documented\n2. IF the output contains line wrapping THEN the exact wrap positions SHALL be noted\n3. WHEN comparing raw output to test input THEN all differences SHALL be identified\n\n### REQ-2: Fix DNS Server Select EDNS Parsing\n\n**User Story:** As a Terraform user, I want `dns server select` entries with multiple servers and per-server EDNS options to be parsed correctly from actual RTX output, so that imported state matches the router configuration.\n\n#### Acceptance Criteria\n\n1. WHEN config contains `dns server select <id> <server1> edns=on <server2> edns=on <type> <pattern>` THEN parser SHALL correctly extract:\n   - servers = [server1, server2]\n   - edns = true\n   - record_type = type\n   - query_pattern = pattern\n\n2. WHEN DNS config line is wrapped across multiple lines THEN parser SHALL reconstruct the full command before parsing\n\n3. WHEN `edns=off` or other EDNS variants appear THEN parser SHALL handle them appropriately\n\n4. WHEN running `terraform refresh` after fix THEN server_select[500100] SHALL show:\n   - query_pattern = \".\"\n   - record_type = \"aaaa\"\n\n### REQ-3: Add Diagnostic Logging\n\n**User Story:** As a developer, I want to see the exact raw output being parsed, so that I can debug parsing issues more easily.\n\n#### Acceptance Criteria\n\n1. WHEN parsing DNS config in debug mode THEN raw input lines SHALL be logged before preprocessing\n2. WHEN preprocessing modifies lines THEN both before and after values SHALL be logged\n3. WHEN parsing server_select entries THEN parsed field values SHALL be logged\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- Extend existing parsers without breaking changes\n- Maintain backward compatibility with existing configurations\n- Reuse `preprocessWrappedLines` logic if applicable to DNS parsing\n\n### Testing\n- Add unit tests with actual RTX output samples (line-wrapped)\n- Test edge cases: single server with EDNS, trailing EDNS format, no EDNS\n- Verify no regressions in existing DNS parsing tests\n\n### Reliability\n- Graceful handling of malformed input\n- Clear error messages for unsupported formats\n",
  "fileStats": {
    "size": 5096,
    "lines": 124,
    "lastModified": "2026-01-22T08:05:52.527Z"
  },
  "comments": []
}