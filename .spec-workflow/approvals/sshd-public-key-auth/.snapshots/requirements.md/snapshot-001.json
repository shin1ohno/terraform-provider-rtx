{
  "id": "snapshot_1769437655399_lqs2ya10t",
  "approvalId": "approval_1769437655035_coeh3hgma",
  "approvalTitle": "SSHD Public Key Authentication Requirements",
  "version": 1,
  "timestamp": "2026-01-26T14:27:35.399Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: SSHD Public Key Authentication\n\n## Introduction\n\nThis feature enables Terraform-based management of SSH public key authentication on Yamaha RTX routers. It covers host key generation, authorized key management for users, and authentication method configuration. This allows network administrators to automate secure SSH access setup through Infrastructure as Code.\n\n## Alignment with Product Vision\n\nThis feature directly supports the product goal of comprehensive IaC management for RTX routers. SSH public key authentication is a fundamental security feature for enterprise network management, enabling:\n\n- Passwordless, secure remote access to routers\n- Centralized key management across multiple devices\n- Compliance with security policies requiring key-based authentication\n- Integration with existing SSH key infrastructure (e.g., 1Password SSH Agent)\n\nFollowing the Cisco-compatibility principle, resource naming will align with similar Terraform provider conventions where applicable.\n\n## Requirements\n\n### Requirement 1: SSH Host Key Generation\n\n**User Story:** As a network administrator, I want to generate SSH host keys on RTX routers via Terraform, so that I can establish a secure SSH server identity during initial setup.\n\n#### Acceptance Criteria\n\n1. WHEN `rtx_sshd_host_key` resource is created THEN the system SHALL execute `sshd host key generate` command on the router\n2. IF host key already exists THEN the system SHALL read the existing key without regenerating (idempotent behavior)\n3. WHEN resource is deleted THEN the system SHALL NOT delete the host key (host keys should persist for security continuity)\n4. WHEN resource is imported THEN the system SHALL read the existing host key fingerprint\n\n### Requirement 2: SSH Authorized Keys Management\n\n**User Story:** As a network administrator, I want to manage SSH authorized keys for router users via Terraform, so that I can control who can access routers using public key authentication.\n\n#### Acceptance Criteria\n\n1. WHEN `rtx_sshd_authorized_keys` resource is created THEN the system SHALL register all specified public keys for the user via `import sshd authorized-keys` command\n2. IF public keys are added or removed in configuration THEN the system SHALL delete all existing keys and re-register the desired keys (RTX limitation: no individual key deletion)\n3. WHEN resource is deleted THEN the system SHALL remove all authorized keys for the user via `delete /ssh/authorized_keys/<username>`\n4. WHEN user specifies multiple keys THEN the system SHALL register all keys for that user\n5. WHEN resource is imported THEN the system SHALL read existing authorized keys via `show sshd authorized-keys <username>`\n\n### Requirement 3: SSH Authentication Method Configuration\n\n**User Story:** As a network administrator, I want to configure SSH authentication methods via Terraform, so that I can enforce security policies such as \"public key only\" authentication.\n\n#### Acceptance Criteria\n\n1. WHEN `auth_method` attribute is set on `rtx_sshd` resource THEN the system SHALL execute `sshd auth method <method>` command\n2. IF `auth_method` is \"publickey\" THEN the system SHALL configure `sshd auth method publickey`\n3. IF `auth_method` is \"password\" THEN the system SHALL configure `sshd auth method password`\n4. IF `auth_method` is \"any\" (default) THEN the system SHALL allow both password and public key authentication\n5. WHEN `auth_method` is changed from \"any\" to \"publickey\" THEN the system SHALL warn if no authorized keys are configured\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each resource file handles one RTX feature area\n- **Modular Design**: Reuse existing SSH client infrastructure and parser patterns\n- **Dependency Management**: Leverage existing `rtx_sshd` resource patterns\n- **Clear Interfaces**: Service methods in client package, parsing in parsers package\n\n### Performance\n\n- SSH command execution should complete within the configured timeout (default 30s)\n- Key import operations may require multiple commands; total operation time proportional to key count\n\n### Security\n\n- Public keys in state file are not sensitive (public by definition)\n- Host key fingerprints in state are acceptable; full private keys must never be stored\n- Warn users when disabling password authentication without configured authorized keys\n\n### Reliability\n\n- Handle router responses gracefully; RTX CLI output may vary slightly between firmware versions\n- Provide clear error messages when key format is invalid\n- Support retry logic for transient SSH connection failures\n\n### Usability\n\n- Resource schemas should be intuitive for users familiar with OpenSSH `authorized_keys` format\n- Documentation should include examples for common use cases (single key, multiple keys, key rotation)\n- Import support allows adopting existing configurations into Terraform management\n\n## RTX Command Reference\n\n### Host Key Commands\n\n```\nsshd host key generate              # Generate new host key\nshow status sshd                    # Show host key fingerprint\n```\n\n### Authorized Keys Commands\n\n```\nimport sshd authorized-keys <user>  # Add public key (interactive prompt)\nshow sshd authorized-keys <user>    # List registered keys\ndelete /ssh/authorized_keys/<user>  # Delete all keys for user\n```\n\n### Authentication Method Commands\n\n```\nsshd auth method password           # Password only\nsshd auth method publickey          # Public key only\nsshd auth method                    # Both (default)\nno sshd auth method                 # Reset to default\n```\n\n## Resource Design Overview\n\n### Proposed Resources\n\n| Resource | Description | Singleton |\n|----------|-------------|-----------|\n| `rtx_sshd` (existing) | SSH service and listener config | Yes |\n| `rtx_sshd` + `auth_method` | Extend existing resource | Yes |\n| `rtx_sshd_host_key` | Host key generation | Yes |\n| `rtx_sshd_authorized_keys` | Authorized keys per user | No (per user) |\n\n### Example Usage\n\n```hcl\n# Enable SSH with public key authentication only\nresource \"rtx_sshd\" \"main\" {\n  enabled     = true\n  hosts       = [\"lan1\"]\n  auth_method = \"publickey\"\n}\n\n# Ensure host key exists\nresource \"rtx_sshd_host_key\" \"main\" {}\n\n# Configure authorized keys for admin user\nresource \"rtx_sshd_authorized_keys\" \"admin\" {\n  username = \"admin\"\n  keys = [\n    \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... user1@workstation\",\n    \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQAB... user2@laptop\",\n  ]\n}\n```\n",
  "fileStats": {
    "size": 6498,
    "lines": 146,
    "lastModified": "2026-01-26T14:27:29.978Z"
  },
  "comments": []
}