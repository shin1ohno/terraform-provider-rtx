{
  "id": "snapshot_1768966386990_wpc2taumn",
  "approvalId": "approval_1768966386980_wdz2sv23g",
  "approvalTitle": "Filter Enhancements Design",
  "version": 1,
  "timestamp": "2026-01-21T03:33:06.990Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Filter Enhancements\n\n## Overview\n\nThis document describes the technical design for three filter enhancement features in the RTX Terraform provider. The implementation follows existing patterns and minimizes changes to core infrastructure.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Go-based Terraform provider using `terraform-plugin-sdk/v2`\n- SSH-based communication with RTX routers via `rtx/client`\n- Parser-based command generation in `rtx/parsers`\n\n### Project Structure (structure.md)\n- Resources: `internal/provider/resource_rtx_*.go`\n- Parsers: `internal/rtx/parsers/*.go`\n- Client services: `internal/client/*_service.go`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`resource_rtx_interface.go`**: Add ethernet filter attributes to existing interface resource\n- **`parsers/ethernet_filter.go`**: Existing parser for ethernet filter definitions\n- **`resource_rtx_ipv6_filter_dynamic.go`**: Add `submission` to protocol validation\n- **`parsers/ip_filter.go`**: Already supports `restrict`/`tcpfin`/`tcprst` - **no changes needed**\n\n### Integration Points\n- **Interface service**: Extend to handle `ethernet <interface> filter in/out` commands\n- **Parser infrastructure**: Reuse existing validation and command generation patterns\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Requirement 1: Ethernet Filter Application\"\n        A[rtx_interface resource] --> B[InterfaceService]\n        B --> C[Parser: interface_filter.go]\n        C --> D[RTX Router CLI]\n    end\n\n    subgraph \"Requirement 2: IPv6 submission protocol\"\n        E[rtx_ipv6_filter_dynamic resource] --> F[Schema validation update]\n    end\n\n    subgraph \"Requirement 3: Restrict Action\"\n        G[Already implemented] --> H[No changes required]\n    end\n```\n\n## Feature 1: Ethernet Filter Interface Application\n\n### Design Decision\nExtend `rtx_interface` resource with new attributes rather than creating a new resource. This approach:\n- Keeps all interface configuration in one place\n- Follows existing pattern for `secure_filter_in/out` and `dynamic_filter_out`\n- Simplifies lifecycle management\n\n### Schema Changes\n\nAdd to `resource_rtx_interface.go`:\n\n```go\n\"ethernet_filter_in\": {\n    Type:        schema.TypeList,\n    Optional:    true,\n    Description: \"Ethernet (MAC) filter numbers for inbound traffic. Order matters.\",\n    Elem: &schema.Schema{\n        Type:         schema.TypeInt,\n        ValidateFunc: validation.IntBetween(1, 512),\n    },\n},\n\"ethernet_filter_out\": {\n    Type:        schema.TypeList,\n    Optional:    true,\n    Description: \"Ethernet (MAC) filter numbers for outbound traffic. Order matters.\",\n    Elem: &schema.Schema{\n        Type:         schema.TypeInt,\n        ValidateFunc: validation.IntBetween(1, 512),\n    },\n},\n```\n\n### Command Generation\n\nCommands to generate:\n```\nethernet lan1 filter in 1 100\nethernet lan1 filter out 2 100\n```\n\nDelete commands:\n```\nno ethernet lan1 filter in\nno ethernet lan1 filter out\n```\n\n### Parser Changes\n\nAdd to `parsers/interface.go` or create `parsers/interface_filter.go`:\n\n```go\n// EthernetFilterApplication represents ethernet filter binding to interface\ntype EthernetFilterApplication struct {\n    Interface string // lan1, lan2, etc.\n    Direction string // in, out\n    Filters   []int  // Filter numbers in order\n}\n\n// ParseEthernetFilterApplication parses \"ethernet <interface> filter in/out\" commands\nfunc ParseEthernetFilterApplication(raw string) ([]EthernetFilterApplication, error)\n\n// BuildEthernetFilterApplicationCommand generates the CLI command\nfunc BuildEthernetFilterApplicationCommand(app EthernetFilterApplication) string\n```\n\n### Client Service Changes\n\nExtend `InterfaceService` in `internal/client/interface_service.go`:\n\n```go\ntype InterfaceConfig struct {\n    // ... existing fields ...\n    EthernetFilterIn  []int `json:\"ethernet_filter_in,omitempty\"`\n    EthernetFilterOut []int `json:\"ethernet_filter_out,omitempty\"`\n}\n```\n\n## Feature 2: IPv6 Dynamic Filter Protocol Extensions\n\n### Design Decision\nSimple schema validation update. No parser changes needed as parsers accept arbitrary protocol strings.\n\n### Schema Changes\n\nUpdate `resource_rtx_ipv6_filter_dynamic.go` line 52:\n\n```go\n// Before\nValidateFunc: validation.StringInSlice([]string{\"ftp\", \"www\", \"smtp\", \"pop3\", \"dns\", \"domain\", \"telnet\", \"ssh\", \"tcp\", \"udp\", \"*\"}, false),\n\n// After\nValidateFunc: validation.StringInSlice([]string{\"ftp\", \"www\", \"smtp\", \"pop3\", \"dns\", \"domain\", \"telnet\", \"ssh\", \"tcp\", \"udp\", \"submission\", \"*\"}, false),\n```\n\n### Parser Impact\n- No changes required - parser already passes protocol string through\n\n### Documentation\nUpdate resource documentation to include `submission` in valid protocols list.\n\n## Feature 3: Restrict Action Support\n\n### Implementation Status: **ALREADY COMPLETE**\n\nInvestigation reveals this feature is already implemented:\n\n1. **IP Filter Parser** (`internal/rtx/parsers/ip_filter.go:44`):\n   ```go\n   var ValidIPFilterActions = []string{\"pass\", \"reject\", \"restrict\", \"restrict-log\", \"restrict-nolog\"}\n   ```\n\n2. **Protocol Support** (`internal/rtx/parsers/ip_filter.go:47`):\n   ```go\n   var ValidIPFilterProtocols = []string{\"tcp\", \"udp\", \"icmp\", \"ip\", \"*\", \"gre\", \"esp\", \"ah\", \"icmp6\", \"tcpfin\", \"tcprst\", \"tcpsyn\", \"established\"}\n   ```\n\n3. **Resource Schema** (`internal/provider/resource_rtx_access_list_ip.go:38-39`):\n   ```go\n   ValidateFunc: validation.StringInSlice([]string{\"pass\", \"reject\", \"restrict\", \"restrict-log\"}, false),\n   ```\n\n4. **Tests exist** (`internal/rtx/parsers/ip_filter_test.go:524-565`):\n   - `restrict-log action` test\n   - `restrict-nolog action` test\n   - `tcpfin protocol` test\n   - `tcprst protocol` test\n\n### Recommendation\n- Mark this requirement as **complete** in requirements.md\n- No implementation work needed\n- Document existing capability for users\n\n## Data Models\n\n### InterfaceConfig (Extended)\n\n```go\ntype InterfaceConfig struct {\n    Name              string   `json:\"name\"`\n    Description       string   `json:\"description,omitempty\"`\n    IPAddress         *IPAddressConfig `json:\"ip_address,omitempty\"`\n    SecureFilterIn    []int    `json:\"secure_filter_in,omitempty\"`\n    SecureFilterOut   []int    `json:\"secure_filter_out,omitempty\"`\n    DynamicFilterOut  []int    `json:\"dynamic_filter_out,omitempty\"`\n    // New fields:\n    EthernetFilterIn  []int    `json:\"ethernet_filter_in,omitempty\"`\n    EthernetFilterOut []int    `json:\"ethernet_filter_out,omitempty\"`\n    NatDescriptor     int      `json:\"nat_descriptor,omitempty\"`\n    // ... other existing fields ...\n}\n```\n\n### IPv6FilterDynamicEntry (Updated Description)\n\n```go\ntype IPv6FilterDynamicEntry struct {\n    Number   int    `json:\"number\"`\n    Source   string `json:\"source\"`\n    Dest     string `json:\"destination\"`\n    Protocol string `json:\"protocol\"` // Now includes: submission\n    Syslog   bool   `json:\"syslog\"`\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid interface for ethernet filter**\n   - **Handling:** Validate interface name supports ethernet filters (lan1, lan2, etc.)\n   - **User Impact:** Clear error message: \"Ethernet filters can only be applied to LAN interfaces\"\n\n2. **Invalid filter number reference**\n   - **Handling:** Validate filter number is within range (1-512)\n   - **User Impact:** Error message with valid range\n\n3. **Unknown protocol in IPv6 dynamic filter**\n   - **Handling:** Schema validation rejects unknown protocols\n   - **User Impact:** List of valid protocols shown in error\n\n## Testing Strategy\n\n### Unit Testing\n\nFor Feature 1 (Ethernet Filter Application):\n- Parser tests for `ethernet <if> filter in/out` parsing\n- Command generation tests\n- Interface validation tests\n\nFor Feature 2 (IPv6 submission):\n- Schema validation test with `submission` protocol\n\n### Integration Testing\n\n- Acceptance test: Create interface with ethernet_filter_in/out\n- Acceptance test: Update ethernet filter application\n- Acceptance test: Import interface with existing ethernet filter application\n- Acceptance test: IPv6 dynamic filter with submission protocol\n\n### Test Cases\n\n```go\n// Feature 1: Ethernet filter application\nfunc TestAccRTXInterface_EthernetFilter(t *testing.T) {\n    resource.Test(t, resource.TestCase{\n        // Test ethernet filter in/out on lan1\n    })\n}\n\n// Feature 2: IPv6 submission protocol\nfunc TestAccRTXIPv6FilterDynamic_Submission(t *testing.T) {\n    resource.Test(t, resource.TestCase{\n        // Test IPv6 dynamic filter with submission protocol\n    })\n}\n```\n\n## Implementation Summary\n\n| Feature | Effort | Files Changed |\n|---------|--------|---------------|\n| 1. Ethernet Filter Application | Medium | 4-5 files |\n| 2. IPv6 submission protocol | Trivial | 1 file |\n| 3. Restrict Action Support | **None** | Already implemented |\n\n### Files to Modify\n\n1. `internal/provider/resource_rtx_interface.go` - Add schema attributes\n2. `internal/client/interface_service.go` - Add fields and command handling\n3. `internal/client/interfaces.go` - Add struct fields\n4. `internal/rtx/parsers/interface.go` or new `interface_filter.go` - Parser logic\n5. `internal/provider/resource_rtx_ipv6_filter_dynamic.go` - Add `submission` to validation\n",
  "fileStats": {
    "size": 9173,
    "lines": 283,
    "lastModified": "2026-01-21T03:33:02.440Z"
  },
  "comments": []
}