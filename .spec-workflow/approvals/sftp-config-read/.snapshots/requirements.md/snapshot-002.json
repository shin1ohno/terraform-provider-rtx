{
  "id": "snapshot_1769167819012_w4ouyeqad",
  "approvalId": "approval_1769167063818_2ch9u852w",
  "approvalTitle": "SFTP-Based Configuration Reading - Requirements",
  "version": 2,
  "timestamp": "2026-01-23T11:30:19.012Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: SFTP-Based Configuration Reading\n\n## Introduction\n\nThis feature enables high-performance configuration reading from Yamaha RTX routers using SFTP file transfer instead of sequential SSH CLI commands. The current implementation reads configuration for each Terraform resource by executing individual SSH commands, resulting in approximately 5-minute read times during `terraform refresh`, `terraform import`, and `terraform plan` operations.\n\nSFTP-based bulk reading will dramatically reduce this time by downloading the entire configuration file (`config.txt` or `config0`) in a single SFTP transfer, then parsing it in memory to extract resource states.\n\n### Key Benefits\n\n1. **Performance**: Single SFTP transfer vs. hundreds of individual SSH commands\n2. **Completeness**: Access to raw configuration including passwords and secrets that are masked in CLI output\n3. **Consistency**: Atomic snapshot of configuration state (no mid-read changes)\n\n### Trade-offs\n\nUsers must enable SFTP server on their RTX router, which has minor security implications:\n- Opens an additional network service\n- Requires admin password for SFTP authentication\n\n## Alignment with Product Vision\n\nThis feature directly supports the product vision of providing reliable, production-ready infrastructure automation:\n\n- **Performance**: Addresses the critical performance bottleneck in read operations\n- **Reliability**: Provides complete configuration data without CLI masking\n- **User Experience**: Dramatically reduces wait times for Terraform operations\n\n## Requirements\n\n### Requirement 1: Provider-Level SFTP Configuration\n\n**User Story:** As a Terraform user, I want to configure SFTP credentials in the provider block, so that the provider can use SFTP for faster configuration reads.\n\n#### Acceptance Criteria\n\n1. WHEN the provider block includes `sftp_enabled = true` AND `admin_password` is provided THEN the provider SHALL use SFTP for bulk configuration reading.\n2. IF `sftp_enabled = true` AND `admin_password` is not provided THEN the provider SHALL return a configuration error.\n3. WHEN `sftp_enabled = false` or not specified THEN the provider SHALL use the existing SSH CLI method for all operations.\n4. WHEN SFTP connection fails AND `sftp_enabled = true` THEN the provider SHALL fall back to SSH CLI method AND emit a warning log indicating the fallback reason.\n5. WHEN fallback to SSH occurs THEN the provider SHALL log the specific error that caused SFTP failure (e.g., \"SFTP connection refused\", \"authentication failed\", \"file not found\").\n6. WHEN fallback to SSH occurs THEN the provider SHALL continue to attempt SFTP for subsequent operations (not permanently disable SFTP for the session).\n\n### Requirement 2: SFTP Client Implementation\n\n**User Story:** As a Terraform user, I want the provider to download configuration via SFTP, so that read operations are significantly faster.\n\n#### Acceptance Criteria\n\n1. WHEN SFTP is enabled THEN the provider SHALL connect to the RTX router using the configured SSH connection parameters (host, port, username) with the admin password for SFTP authentication.\n2. WHEN the SFTP connection is established THEN the provider SHALL download the configuration file from a configurable path (default: `/config.txt` or `/config0`).\n3. WHEN the configuration file is downloaded THEN the provider SHALL store it ONLY in memory (never written to disk).\n4. WHEN the download completes THEN the provider SHALL close the SFTP connection immediately.\n5. IF the configuration file path does not exist THEN the provider SHALL return a clear error message indicating the file path.\n\n### Requirement 3: Configuration Parsing and Resource Extraction\n\n**User Story:** As a Terraform user, I want the downloaded configuration to be parsed into individual resource states, so that `terraform refresh` shows accurate state.\n\n#### Acceptance Criteria\n\n1. WHEN configuration is downloaded THEN the provider SHALL parse it to extract individual command blocks.\n2. WHEN parsing configuration THEN the provider SHALL identify resource types by command prefixes (e.g., `ip route`, `nat descriptor`, `dhcp scope`).\n3. WHEN parsing configuration THEN the provider SHALL extract unmasked sensitive values (passwords, keys) that would be hidden in CLI output.\n4. WHEN multiple resources of the same type exist THEN the provider SHALL correctly distinguish them by their identifiers.\n\n### Requirement 4: Cached Configuration for Batch Reads\n\n**User Story:** As a Terraform user, I want a single SFTP download to serve multiple resource reads within one Terraform operation, so that performance is maximized.\n\n#### Acceptance Criteria\n\n1. WHEN a Terraform operation begins (plan, apply, refresh) THEN the provider SHALL download configuration at most ONCE per operation.\n2. WHEN multiple resources request configuration data THEN the provider SHALL serve them from the cached in-memory configuration.\n3. WHEN the Terraform operation ends THEN the provider SHALL clear the cached configuration from memory.\n4. WHEN a write operation occurs during the Terraform run THEN the provider SHALL invalidate the cache and re-download on next read.\n\n### Requirement 5: Password and Sensitive Value Extraction\n\n**User Story:** As a Terraform user, I want to import resources with their actual passwords, so that the imported state matches the real configuration.\n\n#### Acceptance Criteria\n\n1. WHEN parsing configuration from SFTP download THEN the provider SHALL extract plaintext passwords that appear in the config file.\n2. WHEN a password field contains a plaintext value THEN the provider SHALL set it in the resource state.\n3. WHEN a password field contains a hashed/encrypted value (e.g., `*encrypted*`) THEN the provider SHALL treat it as unknown.\n4. WHEN importing a resource THEN the provider SHALL use the SFTP-extracted password values to populate the state.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: SFTP client, configuration parser, and cache manager shall be separate modules\n- **Modular Design**: SFTP reading shall be an alternative to SSH reading, using the same resource extraction interfaces\n- **Dependency Management**: SFTP functionality shall use Go's standard `sftp` library (github.com/pkg/sftp)\n- **Clear Interfaces**: Define `ConfigurationReader` interface that both SSH and SFTP implementations satisfy\n\n### Performance\n\n- SFTP connection establishment: < 3 seconds\n- Configuration file download (typical 10-50KB): < 2 seconds\n- Configuration parsing: < 1 second\n- Total read time improvement: From ~5 minutes to < 10 seconds\n\n### Security\n\n- Admin password must be handled with the same security as SSH password (Terraform sensitive variable)\n- Configuration data in memory must not be logged or exposed\n- SFTP session must use the same encryption as SSH (it runs over SSH subsystem)\n- Sensitive values extracted from config shall be marked as sensitive in Terraform state\n\n### Reliability\n\n- Clear error messages when SFTP is not enabled on the router\n- Clear error messages for authentication failures\n- Graceful handling of partial downloads or corrupted files\n- Validation of downloaded configuration before parsing\n\n### Usability\n\n- Optional feature: existing users need not change anything\n- Clear documentation on enabling SFTP on RTX routers\n- Migration path: can enable/disable without breaking existing configurations\n\n## Appendix A: Sample Configuration File Format\n\nThe following is a representative sample of RTX config.txt format with test data:\n\n```\n#\n# Admin\n#\nlogin password test-login-password-123\nadministrator password test-admin-password-456\nlogin user testuser encrypted TESTENCRYPTEDHASH123456789\nuser attribute administrator=off connection=off gui-page=dashboard,lan-map,config login-timer=300\nuser attribute testuser connection=serial,telnet,remote,ssh,sftp,http gui-page=dashboard,lan-map,config login-timer=3600\ntimezone +09:00\nconsole character ja.utf8\nconsole prompt \"[TEST-RTX] \"\n\nhttpd host any\nsshd service on\nsshd host lan1\nsftpd host lan1\n\n#\n# WAN connection\n#\ndescription lan2 test-wan\nip lan2 address 198.51.100.1/24\nip lan2 nat descriptor 1000\nip lan2 secure filter in 200020 200099\nip lan2 secure filter out 200099 dynamic 200080 200081\n\n#\n# IP configuration\n#\nip route default gateway 198.51.100.254\nip route 10.0.0.0/8 gateway 192.0.2.1\n\n#\n# LAN configuration\n#\nip lan1 address 192.0.2.253/24\n\n#\n# Services\n#\ndhcp service server\ndhcp scope 1 192.0.2.100-192.0.2.199/24 gateway 192.0.2.253 expire 12:00\ndhcp scope bind 1 192.0.2.100 01:00:11:22:33:44:55\ndhcp scope option 1 dns=192.0.2.10\n\ndns host lan1\ndns service recursive\ndns server select 1 192.0.2.10 edns=on any example.local\ndns server select 500000 8.8.8.8 edns=on 8.8.4.4 edns=on any .\n\n#\n# Tunnels\n#\npp select anonymous\n pp bind tunnel1\n pp auth request mschap-v2\n pp auth username vpnuser test-vpn-password-789\n ppp ipcp ipaddress on\n pp enable anonymous\n\ntunnel select 1\n tunnel encapsulation l2tpv3\n tunnel endpoint name test.example.com fqdn\n ipsec tunnel 101\n  ipsec sa policy 101 1 esp aes-cbc sha-hmac\n  ipsec ike pre-shared-key 1 text test-ike-psk-secret\n  ipsec ike remote address 1 test.example.com\n l2tp tunnel auth on test-l2tp-auth-secret\n tunnel enable 1\n\n#\n# Filters\n#\nip filter 200020 reject * * udp,tcp 135 *\nip filter 200099 pass * * * * *\nip filter dynamic 200080 * * ftp\nip filter dynamic 200081 * * www\n\nnat descriptor type 1000 masquerade\nnat descriptor masquerade static 1000 1 192.0.2.253 tcp 22\n```\n\n### Key Observations for Parser Implementation\n\n1. **Password formats**: Plaintext passwords appear directly after keywords (`login password`, `administrator password`, `pp auth username ... <password>`, `ipsec ike pre-shared-key ... text <secret>`, `l2tp tunnel auth on <secret>`)\n2. **Hierarchical context**: Some commands are context-dependent (e.g., commands after `tunnel select 1` apply to tunnel 1)\n3. **Numbered resources**: Many resources use numeric identifiers (filter numbers, NAT descriptor IDs, tunnel numbers)\n4. **Interface references**: Commands reference interfaces by name (`lan1`, `lan2`, `bridge1`, `tunnel1`)\n5. **Comment blocks**: Lines starting with `#` are comments and should be ignored\n",
  "fileStats": {
    "size": 10258,
    "lines": 219,
    "lastModified": "2026-01-23T11:28:18.731Z"
  },
  "comments": []
}