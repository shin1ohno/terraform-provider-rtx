{
  "id": "snapshot_1769498225596_29wxt8uvt",
  "approvalId": "approval_1769498225426_g39c3k3as",
  "approvalTitle": "Requirements: Plugin Framework Migration",
  "version": 1,
  "timestamp": "2026-01-27T07:17:05.596Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Plugin Framework Migration\n\n## Introduction\n\nThis specification defines the requirements for migrating the terraform-provider-rtx from Terraform Plugin SDK v2 to Terraform Plugin Framework. The primary motivation is to enable true write-only attributes for sensitive values (passwords, pre-shared keys) that should not be stored in Terraform state, addressing the current security limitation where sensitive values are stored in state files.\n\n## Background\n\n### Current State (SDK v2)\n- Provider uses `Sensitive: true` which only masks output but still stores values in state\n- Pre-shared keys, passwords, and other secrets are stored in `terraform.tfstate`\n- Import operations cannot read sensitive values from router (by design)\n- Results in perpetual plan diffs for sensitive attributes after import\n\n### Target State (Plugin Framework)\n- True write-only attributes using `WriteOnly: true` modifier\n- Sensitive values not stored in state at all\n- Support for ephemeral values (Terraform 1.11+)\n- Cleaner separation of concerns with typed schema definitions\n\n## Alignment with Product Vision\n\nThis migration supports the provider's goal of being a production-ready, secure infrastructure-as-code solution for Yamaha RTX routers. Enterprise users require that sensitive credentials not be persisted in state files, which may be stored in shared backends.\n\n## Requirements\n\n### Requirement 1: Muxed Provider Architecture\n\n**User Story:** As a provider maintainer, I want to migrate resources incrementally using terraform-plugin-mux, so that I can maintain stability while progressively adopting the framework.\n\n#### Acceptance Criteria\n\n1. WHEN the provider starts THEN it SHALL combine SDK v2 and Framework resources via mux\n2. IF a resource exists in both SDK v2 and Framework THEN the Framework version SHALL take precedence\n3. WHEN adding a new Framework resource THEN existing SDK v2 resources SHALL continue to function\n4. IF migration is incomplete THEN the provider SHALL still pass all existing acceptance tests\n\n### Requirement 2: Write-Only Sensitive Attributes\n\n**User Story:** As a Terraform user, I want sensitive values (passwords, pre-shared keys) to not be stored in state, so that my secrets are not exposed in backend storage.\n\n#### Acceptance Criteria\n\n1. WHEN `pre_shared_key` is set on `rtx_ipsec_tunnel` THEN the value SHALL NOT appear in state\n2. WHEN `tunnel_auth_password` is set on `rtx_l2tp` THEN the value SHALL NOT appear in state\n3. WHEN `admin_password` is set on `rtx_admin` THEN the value SHALL NOT appear in state\n4. WHEN `password` is set on any resource THEN the value SHALL NOT appear in state\n5. IF Terraform version < 1.11 THEN provider SHALL emit a clear error about version requirement\n6. WHEN a write-only attribute is configured THEN terraform plan SHALL NOT show perpetual diffs\n\n### Requirement 3: Resource Migration Priority\n\n**User Story:** As a provider maintainer, I want to migrate resources with sensitive attributes first, so that security benefits are realized early.\n\n#### Acceptance Criteria\n\n1. WHEN migration begins THEN resources with sensitive attributes SHALL be migrated first:\n   - `rtx_ipsec_tunnel` (pre_shared_key)\n   - `rtx_l2tp` (tunnel_auth_password, ipsec_profile.pre_shared_key)\n   - `rtx_admin` (admin_password, login_password)\n   - `rtx_admin_user` (password)\n   - `rtx_ddns` (password)\n2. WHEN a resource is migrated THEN its acceptance tests SHALL pass\n3. IF a resource has no sensitive attributes THEN migration priority SHALL be lower\n\n### Requirement 4: Backward Compatibility\n\n**User Story:** As an existing user, I want my current configurations to continue working after provider upgrade, so that I don't have to rewrite my Terraform code.\n\n#### Acceptance Criteria\n\n1. WHEN upgrading provider THEN existing `.tf` configurations SHALL remain valid\n2. IF user has SDK v2 style attribute THEN provider SHALL accept it with deprecation warning\n3. WHEN state contains old sensitive values THEN provider SHALL handle migration gracefully\n4. IF user runs terraform plan after upgrade THEN no unexpected resource recreation SHALL occur\n\n### Requirement 5: Migration Validation\n\n**User Story:** As a provider maintainer, I want validators to guide users toward write-only attributes, so that security best practices are adopted.\n\n#### Acceptance Criteria\n\n1. WHEN user configures deprecated sensitive attribute THEN warning SHALL recommend write-only version\n2. IF both old and new attribute are set THEN provider SHALL emit conflict error\n3. WHEN deprecation period ends THEN old attributes SHALL be removed in major version\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each migrated resource should be self-contained in Framework style\n- **Modular Design**: Schema definitions, CRUD operations, and validators should be separate\n- **Dependency Management**: Minimize coupling between SDK v2 and Framework code\n- **Clear Interfaces**: Use terraform-plugin-mux interfaces consistently\n\n### Performance\n- Migration SHALL NOT introduce measurable performance regression\n- Muxed provider startup time SHALL be under 500ms additional overhead\n\n### Security\n- Write-only attributes SHALL be the default for all password/key fields\n- State files SHALL NOT contain any sensitive credential after migration\n- Logging SHALL sanitize sensitive values (existing behavior maintained)\n\n### Reliability\n- All existing acceptance tests SHALL pass after migration\n- New Framework resources SHALL have equivalent test coverage\n- Migration SHALL be reversible if critical issues discovered\n\n### Usability\n- Clear documentation for Terraform 1.11+ version requirement\n- Migration guide for existing users\n- Deprecation warnings SHALL include actionable guidance\n\n## References\n\n- [Terraform Plugin Framework Migration Guide](https://developer.hashicorp.com/terraform/plugin/framework/migrating)\n- [Write-Only Arguments Documentation](https://developer.hashicorp.com/terraform/plugin/framework/resources/write-only-arguments)\n- [Plugin Framework Benefits](https://developer.hashicorp.com/terraform/plugin/framework-benefits)\n- [Migrating Resources](https://developer.hashicorp.com/terraform/plugin/framework/migrating/resources)\n",
  "fileStats": {
    "size": 6272,
    "lines": 120,
    "lastModified": "2026-01-27T07:16:59.722Z"
  },
  "comments": []
}