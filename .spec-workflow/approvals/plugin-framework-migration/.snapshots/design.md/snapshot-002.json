{
  "id": "snapshot_1769499040766_2ctx3ga5d",
  "approvalId": "approval_1769498995691_zavb6p97i",
  "approvalTitle": "Design: Plugin Framework Migration",
  "version": 2,
  "timestamp": "2026-01-27T07:30:40.766Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Plugin Framework Migration\n\n## Overview\n\nThis document describes the technical design for migrating terraform-provider-rtx from Terraform Plugin SDK v2 to Terraform Plugin Framework. The migration involves rewriting ~45,000 lines of provider code across 97 resource files while maintaining functional equivalence.\n\n## Current Architecture (SDK v2)\n\n```\ninternal/\n├── provider/\n│   ├── provider.go              # SDK v2 provider definition\n│   ├── resource_rtx_*.go        # 97 resource implementations\n│   ├── data_source_rtx_*.go     # Data sources\n│   ├── schema_helpers.go        # WriteOnlyStringSchema, etc.\n│   ├── state_funcs.go           # State manipulation helpers\n│   └── acctest/                 # Acceptance test helpers\n├── client/\n│   ├── client.go                # SSH client (keep as-is)\n│   └── *_service.go             # CRUD services (keep as-is)\n├── rtx/\n│   └── parsers/                 # RTX output parsers (keep as-is)\n└── logging/                     # Zerolog logging (keep as-is)\n```\n\n## Target Architecture (Plugin Framework)\n\n```\ninternal/\n├── provider/\n│   ├── provider.go              # Framework provider definition\n│   ├── resources/\n│   │   ├── ipsec_tunnel/\n│   │   │   ├── resource.go      # Resource implementation\n│   │   │   ├── model.go         # Typed Go struct for state\n│   │   │   └── schema.go        # Schema definition\n│   │   ├── l2tp/\n│   │   │   ├── resource.go\n│   │   │   ├── model.go\n│   │   │   └── schema.go\n│   │   └── ...                  # Other resources\n│   ├── datasources/\n│   │   └── ...                  # Data sources\n│   ├── planmodifiers/           # Custom plan modifiers\n│   ├── validators/              # Custom validators\n│   └── fwhelpers/               # Framework helpers\n├── client/                      # Keep as-is\n├── rtx/                         # Keep as-is\n└── logging/                     # Keep as-is\n```\n\n## Code Reuse Analysis\n\n### Components to Keep Unchanged\n- **internal/client/**: SSH client and all `*_service.go` files - business logic unchanged\n- **internal/rtx/parsers/**: RTX output parsers - no changes needed\n- **internal/logging/**: Zerolog infrastructure - works with Framework\n\n### Components to Migrate\n- **provider.go**: Complete rewrite to Framework pattern\n- **resource_rtx_*.go**: Rewrite each resource to Framework pattern\n- **schema_helpers.go**: Replace with Framework equivalents\n- **state_funcs.go**: Replace with typed model operations\n\n## Architecture\n\n### Provider Structure\n\n```go\n// internal/provider/provider.go\npackage provider\n\nimport (\n    \"github.com/hashicorp/terraform-plugin-framework/provider\"\n    \"github.com/hashicorp/terraform-plugin-framework/provider/schema\"\n)\n\ntype rtxProvider struct {\n    version string\n}\n\nfunc New(version string) func() provider.Provider {\n    return func() provider.Provider {\n        return &rtxProvider{version: version}\n    }\n}\n\nfunc (p *rtxProvider) Schema(ctx context.Context, req provider.SchemaRequest, resp *provider.SchemaResponse) {\n    resp.Schema = schema.Schema{\n        Attributes: map[string]schema.Attribute{\n            \"host\": schema.StringAttribute{\n                Required:    true,\n                Description: \"RTX router hostname or IP\",\n            },\n            \"password\": schema.StringAttribute{\n                Optional:    true,\n                Sensitive:   true,\n                WriteOnly:   true,  // NEW: Not stored in state\n                Description: \"SSH password\",\n            },\n            // ...\n        },\n    }\n}\n```\n\n### Resource Pattern\n\n```go\n// internal/provider/resources/ipsec_tunnel/resource.go\npackage ipsec_tunnel\n\nimport (\n    \"github.com/hashicorp/terraform-plugin-framework/resource\"\n    \"github.com/hashicorp/terraform-plugin-framework/resource/schema\"\n    \"github.com/hashicorp/terraform-plugin-framework/resource/schema/planmodifier\"\n    \"github.com/hashicorp/terraform-plugin-framework/resource/schema/stringplanmodifier\"\n)\n\ntype Resource struct {\n    client *client.Client\n}\n\nfunc NewResource() resource.Resource {\n    return &Resource{}\n}\n\nfunc (r *Resource) Metadata(ctx context.Context, req resource.MetadataRequest, resp *resource.MetadataResponse) {\n    resp.TypeName = req.ProviderTypeName + \"_ipsec_tunnel\"\n}\n\nfunc (r *Resource) Schema(ctx context.Context, req resource.SchemaRequest, resp *resource.SchemaResponse) {\n    resp.Schema = schema.Schema{\n        Attributes: map[string]schema.Attribute{\n            \"id\": schema.StringAttribute{\n                Computed: true,\n                PlanModifiers: []planmodifier.String{\n                    stringplanmodifier.UseStateForUnknown(),\n                },\n            },\n            \"tunnel_id\": schema.Int64Attribute{\n                Required: true,\n            },\n            \"pre_shared_key\": schema.StringAttribute{\n                Optional:    true,\n                Sensitive:   true,\n                WriteOnly:   true,  // KEY: Not stored in state\n                Description: \"IKE pre-shared key (write-only)\",\n            },\n            // ...\n        },\n    }\n}\n```\n\n### Typed Model Pattern\n\n```go\n// internal/provider/resources/ipsec_tunnel/model.go\npackage ipsec_tunnel\n\nimport \"github.com/hashicorp/terraform-plugin-framework/types\"\n\n// Model represents the Terraform state for rtx_ipsec_tunnel\ntype Model struct {\n    ID            types.String `tfsdk:\"id\"`\n    TunnelID      types.Int64  `tfsdk:\"tunnel_id\"`\n    Enabled       types.Bool   `tfsdk:\"enabled\"`\n    PreSharedKey  types.String `tfsdk:\"pre_shared_key\"`  // WriteOnly, not in state\n    LocalAddress  types.String `tfsdk:\"local_address\"`\n    RemoteAddress types.String `tfsdk:\"remote_address\"`\n    DPDEnabled    types.Bool   `tfsdk:\"dpd_enabled\"`\n    DPDInterval   types.Int64  `tfsdk:\"dpd_interval\"`\n    DPDRetry      types.Int64  `tfsdk:\"dpd_retry\"`\n    // Nested blocks\n    IKEv2Proposal  *IKEv2ProposalModel  `tfsdk:\"ikev2_proposal\"`\n    IPsecTransform *IPsecTransformModel `tfsdk:\"ipsec_transform\"`\n}\n\ntype IKEv2ProposalModel struct {\n    EncryptionAES256 types.Bool  `tfsdk:\"encryption_aes256\"`\n    GroupFourteen    types.Bool  `tfsdk:\"group_fourteen\"`\n    IntegritySHA256  types.Bool  `tfsdk:\"integrity_sha256\"`\n    LifetimeSeconds  types.Int64 `tfsdk:\"lifetime_seconds\"`\n}\n```\n\n### CRUD Implementation\n\n```go\n// internal/provider/resources/ipsec_tunnel/resource.go (continued)\n\nfunc (r *Resource) Create(ctx context.Context, req resource.CreateRequest, resp *resource.CreateResponse) {\n    var plan Model\n    diags := req.Plan.Get(ctx, &plan)\n    resp.Diagnostics.Append(diags...)\n    if resp.Diagnostics.HasError() {\n        return\n    }\n\n    // Convert to domain model and call service\n    tunnel := r.modelToIPsecTunnel(plan)\n    if err := r.client.IPsecTunnel().Create(ctx, tunnel); err != nil {\n        resp.Diagnostics.AddError(\"Create failed\", err.Error())\n        return\n    }\n\n    // Set state (pre_shared_key is WriteOnly, not saved)\n    plan.ID = types.StringValue(fmt.Sprintf(\"%d\", plan.TunnelID.ValueInt64()))\n    diags = resp.State.Set(ctx, &plan)\n    resp.Diagnostics.Append(diags...)\n}\n\nfunc (r *Resource) Read(ctx context.Context, req resource.ReadRequest, resp *resource.ReadResponse) {\n    var state Model\n    diags := req.State.Get(ctx, &state)\n    resp.Diagnostics.Append(diags...)\n    if resp.Diagnostics.HasError() {\n        return\n    }\n\n    // Read from router\n    tunnel, err := r.client.IPsecTunnel().Read(ctx, int(state.TunnelID.ValueInt64()))\n    if err != nil {\n        resp.State.RemoveResource(ctx)\n        return\n    }\n\n    // Update state from router (pre_shared_key not read back)\n    r.ipsecTunnelToModel(tunnel, &state)\n    diags = resp.State.Set(ctx, &state)\n    resp.Diagnostics.Append(diags...)\n}\n```\n\n## Components and Interfaces\n\n### Provider Component\n- **Purpose**: Initialize provider, configure client, register resources\n- **Interfaces**: `provider.Provider`, `provider.ProviderWithMetaSchema`\n- **Dependencies**: internal/client\n\n### Resource Components (per resource)\n- **Purpose**: Implement CRUD for single resource type\n- **Interfaces**: `resource.Resource`, `resource.ResourceWithImportState`, `resource.ResourceWithConfigure`\n- **Dependencies**: internal/client/*_service.go\n\n### Plan Modifiers\n- **Purpose**: Custom plan modification logic\n- **Location**: internal/provider/planmodifiers/\n- **Examples**: `UseStateForUnknown()`, `RequiresReplace()`\n\n### Validators\n- **Purpose**: Custom validation logic\n- **Location**: internal/provider/validators/\n- **Examples**: IP address validation, CIDR validation\n\n## Data Models\n\n### Write-Only Attributes\n\nResources with write-only sensitive attributes:\n\n| Resource | Attribute | Type |\n|----------|-----------|------|\n| rtx_ipsec_tunnel | pre_shared_key | string |\n| rtx_l2tp | tunnel_auth_password | string |\n| rtx_l2tp | ipsec_profile.pre_shared_key | string |\n| rtx_admin | admin_password | string |\n| rtx_admin | login_password | string |\n| rtx_admin_user | password | string |\n| rtx_ddns | password | string |\n| provider | password | string |\n| provider | private_key | string |\n| provider | private_key_passphrase | string |\n| provider | admin_password | string |\n\n### Migration Mapping\n\nSDK v2 → Framework type mapping:\n\n| SDK v2 | Framework |\n|--------|-----------|\n| schema.TypeString | types.String |\n| schema.TypeInt | types.Int64 |\n| schema.TypeBool | types.Bool |\n| schema.TypeFloat | types.Float64 |\n| schema.TypeList | types.List |\n| schema.TypeSet | types.Set |\n| schema.TypeMap | types.Map |\n| Nested *schema.Resource | Nested attribute/block |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Terraform Version < 1.11**\n   - **Handling**: Check version in provider Configure, return error diagnostic\n   - **User Impact**: Clear message: \"This provider requires Terraform 1.11 or later for write-only attribute support\"\n\n2. **SSH Connection Failure**\n   - **Handling**: Return error diagnostic with connection details\n   - **User Impact**: Same as current behavior\n\n3. **Invalid Configuration**\n   - **Handling**: Use Framework validators\n   - **User Impact**: Validation errors shown during plan\n\n## Testing Strategy\n\n### Unit Testing\n- Test typed model conversions\n- Test validators in isolation\n- Test plan modifiers\n\n### Integration Testing\n- Migrate existing acceptance tests to Framework testing patterns\n- Use `resource.Test()` from `terraform-plugin-testing`\n\n```go\nfunc TestAccIPsecTunnel_basic(t *testing.T) {\n    resource.Test(t, resource.TestCase{\n        ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,\n        Steps: []resource.TestStep{\n            {\n                Config: testAccIPsecTunnelConfig_basic(),\n                Check: resource.ComposeTestCheckFunc(\n                    resource.TestCheckResourceAttr(\"rtx_ipsec_tunnel.test\", \"tunnel_id\", \"1\"),\n                ),\n            },\n        },\n    })\n}\n```\n\n### Write-Only Testing\n- Verify sensitive values not in state after apply\n- Use `terraform show -json` to confirm absence\n\n## Migration Phases\n\n### Phase 1: Infrastructure Setup\n1. Add Framework dependencies to go.mod\n2. Create new directory structure\n3. Implement provider skeleton\n4. Setup acceptance test infrastructure\n\n### Phase 2: High-Priority Resources (Sensitive)\n1. rtx_ipsec_tunnel\n2. rtx_l2tp\n3. rtx_admin\n4. rtx_admin_user\n5. rtx_ddns\n\n### Phase 3: Normal-Priority Resources\n1. Migrate remaining resources alphabetically\n2. Each resource: schema → model → CRUD → tests\n\n### Phase 4: Cleanup\n1. Remove SDK v2 dependencies\n2. Remove old resource files\n3. Update documentation\n4. Release as v1.0.0\n\n## File Changes Summary\n\n| Action | Files | Estimated LOC |\n|--------|-------|---------------|\n| Delete | internal/provider/resource_rtx_*.go (old) | -40,000 |\n| Delete | internal/provider/schema_helpers.go | -200 |\n| Delete | internal/provider/state_funcs.go | -200 |\n| Create | internal/provider/provider.go (new) | +300 |\n| Create | internal/provider/resources/*/resource.go | +25,000 |\n| Create | internal/provider/resources/*/model.go | +5,000 |\n| Create | internal/provider/resources/*/schema.go | +10,000 |\n| Create | internal/provider/validators/*.go | +500 |\n| Create | internal/provider/planmodifiers/*.go | +300 |\n| Modify | go.mod | Framework deps |\n| Keep | internal/client/* | 0 |\n| Keep | internal/rtx/* | 0 |\n| Keep | internal/logging/* | 0 |\n\n**Net change**: ~-5,000 LOC (cleaner typed code)\n",
  "fileStats": {
    "size": 12632,
    "lines": 384,
    "lastModified": "2026-01-27T07:29:49.946Z"
  },
  "comments": []
}