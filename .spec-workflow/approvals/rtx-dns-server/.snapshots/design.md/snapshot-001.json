{
  "id": "snapshot_1768799797557_gumn5ykyo",
  "approvalId": "approval_1768799797554_ggipaj88i",
  "approvalTitle": "Design: rtx_dns_server resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:37.557Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_dns_server\n\n## Overview\n\nThe `rtx_dns_server` resource enables Terraform-based management of DNS server and resolver configuration on Yamaha RTX series routers. Following Cisco IOS XE naming patterns, this resource manages DNS server settings, upstream DNS servers, static host entries, and domain-based routing.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with DNS methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add DNS methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_dns_server.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        DNSService[dns_service.go]\n    end\n\n    subgraph Parser Layer\n        DNSParser[dns.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> DNSService\n    DNSService --> DNSParser\n    DNSParser --> Commands\n    DNSParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `DNSService` handles all DNS CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all DNS logic\n- **Utility Modularity**: Shared validation functions for IP/domain operations\n\n## Components and Interfaces\n\n### Component 1: DNSService (`internal/client/dns_service.go`)\n\n- **Purpose:** Handles all DNS CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type DNSService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *DNSService) Create(ctx context.Context, dns DNSConfig) error\n  func (s *DNSService) Get(ctx context.Context) (*DNSConfig, error)\n  func (s *DNSService) Update(ctx context.Context, dns DNSConfig) error\n  func (s *DNSService) Delete(ctx context.Context) error\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.DNSParser`\n- **Reuses:** Pattern from service layer implementations\n\n### Component 2: DNSParser (`internal/rtx/parsers/dns.go`)\n\n- **Purpose:** Parses RTX router output for DNS configuration and builds commands\n- **Interfaces:**\n  ```go\n  type DNSConfig struct {\n      DomainLookup  bool              `json:\"domain_lookup\"`\n      DomainName    string            `json:\"domain_name,omitempty\"`\n      NameServers   []string          `json:\"name_servers\"`\n      ServerSelect  []DNSServerSelect `json:\"server_select,omitempty\"`\n      Hosts         []DNSHost         `json:\"hosts,omitempty\"`\n      ServiceOn     bool              `json:\"service_on\"`\n      PrivateSpoof  bool              `json:\"private_address_spoof\"`\n  }\n\n  type DNSServerSelect struct {\n      ID      int      `json:\"id\"`\n      Servers []string `json:\"servers\"`\n      Domains []string `json:\"domains\"`\n  }\n\n  type DNSHost struct {\n      Name    string `json:\"name\"`\n      Address string `json:\"address\"`\n  }\n\n  func ParseDNSConfig(raw string) (*DNSConfig, error)\n  func BuildDNSServerCommand(servers []string) string\n  func BuildDNSServerSelectCommand(sel DNSServerSelect) string\n  func BuildDNSStaticCommand(host DNSHost) string\n  func BuildDNSServiceCommand(on bool) string\n  func BuildDeleteDNSCommand() string\n  ```\n- **Dependencies:** `regexp`, `strings`, `net`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_dns_server.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXDNSServer() *schema.Resource\n  func resourceRTXDNSServerCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDNSServerRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDNSServerUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDNSServerDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXDNSServerImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `DNSConfig`, Terraform SDK\n- **Reuses:** Resource patterns from other implementations\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with DNS methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetDNS(ctx context.Context) (*DNSConfig, error)\n  CreateDNS(ctx context.Context, dns DNSConfig) error\n  UpdateDNS(ctx context.Context, dns DNSConfig) error\n  DeleteDNS(ctx context.Context) error\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### DNSConfig\n\n```go\n// DNSConfig represents DNS configuration on an RTX router\ntype DNSConfig struct {\n    DomainLookup  bool              `json:\"domain_lookup\"`  // Enable DNS resolution\n    DomainName    string            `json:\"domain_name\"`    // Default domain\n    NameServers   []string          `json:\"name_servers\"`   // Upstream DNS servers\n    ServerSelect  []DNSServerSelect `json:\"server_select\"`  // Domain-based routing\n    Hosts         []DNSHost         `json:\"hosts\"`          // Static host entries\n    ServiceOn     bool              `json:\"service_on\"`     // DNS service enabled\n    PrivateSpoof  bool              `json:\"private_address_spoof\"` // Spoof private addresses\n}\n\n// DNSServerSelect represents domain-based DNS routing\ntype DNSServerSelect struct {\n    ID      int      `json:\"id\"`      // Selection rule ID\n    Servers []string `json:\"servers\"` // DNS servers for this rule\n    Domains []string `json:\"domains\"` // Domains to match\n}\n\n// DNSHost represents a static host entry\ntype DNSHost struct {\n    Name    string `json:\"name\"`    // Hostname\n    Address string `json:\"address\"` // IP address\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_dns\" \"main\" {\n  domain_lookup = true\n  domain_name   = \"example.local\"\n\n  name_servers = [\"8.8.8.8\", \"8.8.4.4\"]\n\n  # Domain-specific DNS routing\n  server_select = [\n    {\n      id      = 1\n      domains = [\"internal.example.com\", \"corp.example.com\"]\n      servers = [\"192.168.1.53\"]\n    },\n    {\n      id      = 2\n      domains = [\"partner.example.com\"]\n      servers = [\"10.0.0.53\", \"10.0.0.54\"]\n    }\n  ]\n\n  # Static host entries\n  hosts = [\n    {\n      name    = \"router.local\"\n      address = \"192.168.1.1\"\n    },\n    {\n      name    = \"nas.local\"\n      address = \"192.168.1.100\"\n    }\n  ]\n\n  private_address_spoof = true\n}\n```\n\n## RTX Command Mapping\n\n### Configure DNS Servers\n\n```\ndns server <ip1> [<ip2>]\n```\n\nExample: `dns server 8.8.8.8 8.8.4.4`\n\n### Configure DNS from PP Interface\n\n```\ndns server pp <n>\n```\n\n### Configure Domain-based DNS Routing\n\n```\ndns server select <id> <server> <domain>...\n```\n\nExample: `dns server select 1 192.168.1.53 internal.example.com corp.example.com`\n\n### Configure Static Host\n\n```\ndns static <hostname> <ip>\n```\n\nExample: `dns static router.local 192.168.1.1`\n\n### Enable DNS Service\n\n```\ndns service on\n```\n\n### Configure Private Address Spoofing\n\n```\ndns private address spoof on\n```\n\n### Delete DNS Configuration\n\n```\nno dns server\nno dns static <hostname>\nno dns server select <id>\n```\n\n### Show DNS Configuration\n\n```\nshow config | grep dns\nshow dns cache\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid DNS Server IP**\n   - **Handling:** Validate IP address format\n   - **User Impact:** Clear validation error with expected format\n\n2. **Invalid Domain Name**\n   - **Handling:** Validate domain name format\n   - **User Impact:** Clear error with valid format\n\n3. **Duplicate Server Select ID**\n   - **Handling:** Check for duplicate IDs\n   - **User Impact:** Error indicating duplicate\n\n4. **Invalid Hostname**\n   - **Handling:** Validate hostname format\n   - **User Impact:** Clear error with valid format\n\n5. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`dns_test.go`):\n  - Parse various RTX `show config` output for DNS\n  - Test command builder functions with different parameters\n  - Test domain and IP validation\n\n- **Service Tests** (`dns_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test server select configuration\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_dns_server_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Static host configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create DNS with basic servers\n  - Create DNS with server select rules\n  - Create static hosts\n  - Update configuration\n  - Delete DNS settings\n  - Import existing configuration\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_dns_server.go      # NEW: Terraform resource\n│   └── resource_rtx_dns_server_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                    # MODIFY: Add DNS types and methods\n│   ├── client.go                        # MODIFY: Add DNS service initialization\n│   ├── dns_service.go                  # NEW: DNS service implementation\n│   └── dns_service_test.go             # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── dns.go                      # NEW: Parser and command builders\n        └── dns_test.go                 # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Singleton Resource**: DNS is a singleton resource. Only one DNS configuration can exist.\n\n2. **Terraform ID**: Use \"dns\" as the fixed Terraform resource ID.\n\n3. **Server Priority**: DNS servers are used in order. First server is primary.\n\n4. **Server Select**: Domain-based routing takes precedence over general DNS servers.\n\n5. **In-place Updates**: Most DNS settings support in-place updates.\n\n6. **PP Interface DNS**: Consider handling `dns server pp <n>` as special case for PPPoE.\n\n7. **Cache Clearing**: May need to clear DNS cache after configuration changes.\n\n8. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n9. **Provider Registration**: Add `resourceRTXDNSServer` to provider's resource map.\n",
  "fileStats": {
    "size": 10626,
    "lines": 359,
    "lastModified": "2026-01-19T05:12:07.341Z"
  },
  "comments": []
}