{
  "id": "snapshot_1768915868732_19t8lecgg",
  "approvalId": "approval_1768915858459_v7eod903w",
  "approvalTitle": "Design: RTX PPP/PPPoE Resource",
  "version": 2,
  "timestamp": "2026-01-20T13:31:08.732Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: RTX PPP/PPPoE Resource\n\n## Overview\n\nThis feature implements Terraform resources for PPP/PPPoE WAN connectivity on Yamaha RTX routers. The design follows the established parser → client → provider pattern used by all existing resources.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Follow existing parser implementation patterns\n- Use SSH command execution via existing client infrastructure\n- Implement CRUD operations with import support\n\n### Project Structure (structure.md)\n- Parser: `internal/rtx/parsers/ppp.go`\n- Client: `internal/client/ppp_service.go`\n- Provider: `internal/provider/resource_rtx_pppoe.go`, `resource_rtx_pp_interface.go`\n- Tests: Corresponding `*_test.go` files\n- Examples: `examples/pppoe/main.tf`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **SSH Client**: `internal/client/client.go` for command execution\n- **Parser patterns**: Follow `interface_config.go` structure\n- **Resource patterns**: Follow `resource_rtx_interface.go` structure\n- **Validation helpers**: Reuse IP address and interface validators\n\n### Integration Points\n- **Interface system**: PP interfaces integrate with existing interface management\n- **DNS configuration**: PPPoE can provide DNS servers (integrate with dns_server)\n- **Static routes**: Default route via PP interface\n\n## Architecture\n\n```mermaid\ngraph TD\n    A[Terraform Resource] --> B[Provider Layer]\n    B --> C[Client Service]\n    C --> D[SSH Executor]\n    D --> E[RTX Router]\n\n    F[Parser] --> G[Parse Config]\n    F --> H[Build Commands]\n\n    B --> F\n```\n\n## Components and Interfaces\n\n### Component 1: PPP Parser\n- **Purpose:** Parse and build PPP/PPPoE commands\n- **File:** `internal/rtx/parsers/ppp.go`\n- **Interfaces:**\n  ```go\n  func ParsePPPConfig(output string) (*PPPConfig, error)\n  func ParsePPPoEConfig(output string, ppNum int) (*PPPoEConfig, error)\n  func BuildPPPoECommand(config *PPPoEConfig) []string\n  func BuildPPInterfaceCommand(config *PPInterfaceConfig) []string\n  ```\n- **Dependencies:** regexp, strings, strconv\n- **Reuses:** Validation patterns from interface_config.go\n\n### Component 2: PPP Service\n- **Purpose:** Execute PPP/PPPoE operations via SSH\n- **File:** `internal/client/ppp_service.go`\n- **Interfaces:**\n  ```go\n  type PPPService interface {\n      GetPPPoE(ppNum int) (*PPPoEConfig, error)\n      ConfigurePPPoE(config *PPPoEConfig) error\n      UpdatePPPoE(config *PPPoEConfig) error\n      DeletePPPoE(ppNum int) error\n      GetPPInterface(ppNum int) (*PPInterfaceConfig, error)\n      ConfigurePPInterface(config *PPInterfaceConfig) error\n      GetConnectionStatus(ppNum int) (*PPConnectionStatus, error)\n  }\n  ```\n- **Dependencies:** client.Executor\n- **Reuses:** Command execution pattern from interface_service.go\n\n### Component 3: PPPoE Resource\n- **Purpose:** Terraform resource for PPPoE client configuration\n- **File:** `internal/provider/resource_rtx_pppoe.go`\n- **Schema:**\n  ```hcl\n  resource \"rtx_pppoe\" \"wan\" {\n    pp_number      = 1\n    bind_interface = \"lan2\"\n    username       = \"user@isp.ne.jp\"\n    password       = \"secret\"\n    auth_method    = \"chap\"  # pap, chap, mschap, mschapv2\n    service_name   = \"\"       # optional\n    auto_connect   = true\n    lcp_echo {\n      interval      = 30\n      failure_count = 3\n    }\n  }\n  ```\n- **Dependencies:** PPPService, schema package\n- **Reuses:** Resource CRUD pattern from resource_rtx_interface.go\n\n### Component 4: PP Interface Resource\n- **Purpose:** Terraform resource for PP interface IP configuration\n- **File:** `internal/provider/resource_rtx_pp_interface.go`\n- **Schema:**\n  ```hcl\n  resource \"rtx_pp_interface\" \"wan\" {\n    pp_number    = 1\n    ip_address   = \"ipcp\"  # or static IP\n    netmask      = \"ipcp\"  # or static mask\n    mtu          = 1454\n    tcp_mss      = 1414\n    nat_descriptor = 1000\n    default_route = true\n    route_metric  = 1\n  }\n  ```\n- **Dependencies:** PPPService, schema package\n- **Reuses:** Interface configuration patterns\n\n## Data Models\n\n### PPPoEConfig\n```go\ntype PPPoEConfig struct {\n    PPNumber       int\n    BindInterface  string\n    Username       string\n    Password       string   // Sensitive\n    AuthMethod     string   // pap, chap, mschap, mschapv2\n    ServiceName    string\n    ACName         string\n    AutoConnect    bool\n    LCPEcho        LCPEchoConfig\n}\n\ntype LCPEchoConfig struct {\n    Interval     int  // seconds\n    FailureCount int\n}\n```\n\n### PPInterfaceConfig\n```go\ntype PPInterfaceConfig struct {\n    PPNumber      int\n    IPAddress     string  // \"ipcp\" or static IP\n    Netmask       string  // \"ipcp\" or static mask\n    MTU           int\n    TCPMSS        int\n    NATDescriptor int\n    DefaultRoute  bool\n    RouteMetric   int\n    DNSServers    []string  // from IPCP or static\n}\n```\n\n### RTX Commands Mapping\n| Terraform Attribute | RTX Command |\n|---------------------|-------------|\n| bind_interface | `pp bind lan2` |\n| username/password | `pp auth myname <user> <pass>` |\n| auth_method | `pp auth accept <method>` |\n| service_name | `pppoe service-name <name>` |\n| auto_connect | `pp always-on on` |\n| lcp_echo.interval | `ppp lcp echo <interval>` |\n| ip_address | `ip pp address <ip>/<mask>` |\n| mtu | `ip pp mtu <size>` |\n| tcp_mss | `ip pp tcp mss <size>` |\n| nat_descriptor | `ip pp nat descriptor <id>` |\n| default_route | `ip route default gateway pp 1` |\n\n## Error Handling\n\n### Error Scenarios\n1. **Authentication failure:**\n   - **Handling:** Return error with ISP authentication failure message\n   - **User Impact:** Clear message about username/password issue\n\n2. **Interface already bound:**\n   - **Handling:** Check existing binding before configure\n   - **User Impact:** Suggest unbinding or using different PP number\n\n3. **Connection timeout:**\n   - **Handling:** Retry with exponential backoff\n   - **User Impact:** Report timeout with troubleshooting hints\n\n## Testing Strategy\n\n### Unit Testing\n- Parser tests with sample RTX output\n- Command builder tests for all configurations\n- Validation tests for auth methods, MTU ranges\n\n### Integration Testing\n- Mock client tests for CRUD operations\n- State management tests\n\n### Acceptance Testing (requires RTX)\n- Full PPPoE lifecycle test\n- Import existing configuration test\n- Multi-PP interface test\n",
  "fileStats": {
    "size": 6267,
    "lines": 205,
    "lastModified": "2026-01-20T13:30:48.684Z"
  },
  "comments": []
}