{
  "id": "snapshot_1768889719987_9naefm3z3",
  "approvalId": "approval_1768888945727_og00n0xmj",
  "approvalTitle": "Requirements: Import Fidelity Bug Fix",
  "version": 2,
  "timestamp": "2026-01-20T06:15:19.987Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Import Fidelity Fix\n\n## Introduction\n\nThis specification addresses critical bugs in the terraform import functionality where imported resources do not accurately reflect the actual router configuration. When comparing the router's live config (`show config` output) with the Terraform-generated `main.tf`, significant discrepancies were identified. These bugs prevent users from reliably importing existing RTX router configurations into Terraform management.\n\n## Bug Report Summary\n\n**Discovered**: 2026-01-20\n**Severity**: High\n**Impact**: Import functionality produces incomplete/incorrect Terraform configurations\n\n### Identified Discrepancies\n\n| Category | Issue | Severity |\n|----------|-------|----------|\n| Static Routes | Multiple gateways not imported (only first gateway captured) | High |\n| DHCP Scope | Entire resource not being imported | High |\n| Admin User | `login_timer` value incorrect (0 instead of 3600) | Medium |\n| NAT Masquerade | Static NAT entries not imported | High |\n| DNS Server | `edns=on` flags mixed into domains list (parser issue) | Medium |\n| IP Filters | Resources not imported at all | Medium |\n| IPv6 Filters | Resources not imported at all | Medium |\n| Ethernet Filters | Resources not imported at all | Medium |\n| L2TP Service | Global service enablement not captured | Low |\n| IPsec Transport | Transport mode mappings not imported | Medium |\n\n## Alignment with Product Vision\n\nFrom `product.md`:\n- \"Enable complete IaC management of Yamaha RTX router configurations\"\n- \"Support enterprise deployment patterns with proper state management\"\n- \"Import Support: Import existing configurations into Terraform state\"\n\nThe current import bugs directly violate these objectives. Users cannot trust that an imported configuration accurately represents their router state.\n\n## Requirements\n\n### REQ-1: Static Route Multi-Gateway Import\n\n**User Story:** As a network administrator, I want static routes with multiple gateways to be fully imported, so that my failover routing configurations are accurately represented in Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN a static route has multiple gateways defined THEN the parser SHALL capture all gateways in the `next_hops` list\n2. WHEN importing `ip route 10.0.0.0/8 gateway 192.168.1.20 gateway 192.168.1.21` THEN the resource SHALL contain both gateways with appropriate distance values\n3. IF a route has N gateways THEN the imported resource SHALL have exactly N entries in `next_hops`\n\n### REQ-2: DHCP Scope Import\n\n**User Story:** As a network administrator, I want DHCP scope configurations to be imported, so that my IP address management is fully represented in Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `dhcp scope N` is defined in router config THEN a `rtx_dhcp_scope` resource SHALL be created\n2. WHEN scope has static bindings (`dhcp scope bind`) THEN they SHALL be included in the resource\n3. WHEN scope has options (`dhcp scope option`) THEN they SHALL be included in the resource\n4. WHEN scope defines gateway, expire, and maxexpire THEN these SHALL be captured accurately\n\n### REQ-3: Admin User Attribute Import\n\n**User Story:** As an administrator, I want user attributes to be imported correctly, so that access control settings are accurately maintained.\n\n#### Acceptance Criteria\n\n1. WHEN `login-timer=N` is set for a user THEN `login_timer` attribute SHALL equal N\n2. WHEN `login-timer` is not explicitly set THEN the default value SHALL be used (not 0)\n3. WHEN user has `connection=serial,telnet,remote,ssh,sftp,http` THEN all connection methods SHALL be imported\n\n### REQ-4: NAT Masquerade Static Entries Import\n\n**User Story:** As a network administrator, I want NAT masquerade static entries to be imported, so that port forwarding and protocol mappings are preserved.\n\n#### Acceptance Criteria\n\n1. WHEN `nat descriptor masquerade static N M addr protocol` is defined THEN it SHALL be included in the resource\n2. WHEN multiple static entries exist THEN all entries SHALL be imported as a list\n3. WHEN static entry specifies protocol (esp, udp, tcp) and port THEN these SHALL be captured\n\n### REQ-5: DNS Server Select Parsing\n\n**User Story:** As a network administrator, I want DNS server select statements to be parsed correctly, so that DNS forwarding rules work properly.\n\n#### Acceptance Criteria\n\n1. WHEN `dns server select N server edns=on domain` is parsed THEN `edns=on` SHALL NOT appear in domains list\n2. WHEN server has edns flag THEN it SHALL be captured as a separate boolean attribute\n3. WHEN multiple servers are specified THEN each server's edns flag SHALL be individually captured\n\n### REQ-6: IP Filter Import (Future)\n\n**User Story:** As a network administrator, I want IP filter rules to be importable, so that firewall configurations can be managed via Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `ip filter N action src dst proto sport dport` is defined THEN a filter resource SHALL be creatable\n2. IF filter references are used in interfaces THEN they SHALL be resolvable\n\n**Note:** This may require new resource types. Mark as future enhancement if scope is too large.\n\n### REQ-7: Ethernet Filter Import (Future)\n\n**User Story:** As a network administrator, I want Ethernet filter rules to be importable, so that Layer 2 filtering can be managed.\n\n#### Acceptance Criteria\n\n1. WHEN `ethernet filter N action mac-src mac-dst` is defined THEN a filter resource SHALL be creatable\n2. WHEN `ethernet lanN filter in/out` is defined THEN interface filter bindings SHALL be captured\n\n**Note:** May require new resource types. Mark as future enhancement if scope is too large.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Parser Accuracy**: Each parser must produce output that, when re-serialized to RTX commands, produces equivalent configuration\n- **Round-Trip Fidelity**: Import → Export → Import should produce identical Terraform state\n- **Test Coverage**: Each parser fix must include unit tests with real config samples\n\n### Performance\n\n- Import of full router configuration should complete within 60 seconds\n\n### Reliability\n\n- Parser failures should produce clear error messages indicating which line failed to parse\n- Partial import failures should not corrupt already-imported resources\n\n### Usability\n\n- Imported resources should require minimal manual adjustment before being usable\n- Documentation should clearly indicate any known import limitations\n\n## Out of Scope (Phase 1)\n\nThe following items are documented but deferred:\n\n- IPv6 filter import (requires new resource type)\n- IP filter import (requires new resource type)\n- Ethernet filter import (requires new resource type)\n- L2TP service global settings\n- IPsec transport mode import\n\nThese will be addressed in a future specification after core import fidelity is restored.\n\n## Priority Order\n\n1. **P0 - Critical**: Static Routes, DHCP Scope, NAT Masquerade Static Entries\n2. **P1 - High**: Admin User attributes, DNS Server parsing\n3. **P2 - Medium**: Filter resources (new resource types - future spec)\n",
  "fileStats": {
    "size": 7067,
    "lines": 151,
    "lastModified": "2026-01-20T06:02:18.287Z"
  },
  "comments": []
}