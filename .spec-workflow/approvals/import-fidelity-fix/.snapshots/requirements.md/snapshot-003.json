{
  "id": "snapshot_1768907794335_8gqtlz6cx",
  "approvalId": "approval_1768907396795_h2b0gpm4o",
  "approvalTitle": "Requirements: Import Fidelity Fix (6 parser bugs)",
  "version": 3,
  "timestamp": "2026-01-20T11:16:34.335Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Import Fidelity Fix\n\n## Introduction\n\nThis specification addresses critical bugs in the RTX Terraform provider's import functionality that cause data loss and incorrect configuration parsing when importing existing router configurations into Terraform state. These bugs result in incomplete or corrupted state, requiring manual intervention and preventing reliable Infrastructure as Code management.\n\nThe import fidelity issues were discovered during validation testing with RTX1210-Ebisu production router configuration, comparing `show config` output against generated Terraform state (`main.tf`).\n\n## Alignment with Product Vision\n\nPer `product.md`, the provider's key principles include:\n\n- **Import Support**: \"Import existing configurations into Terraform state\"\n- **Fail Safely**: \"Validate configurations before applying; provide clear error messages\"\n- **State Clarity**: \"Persist only configuration in Terraform state\"\n\nCurrent import bugs violate these principles by silently corrupting state data. Fixing these issues is essential for the provider to fulfill its core mission of enabling IaC management of existing RTX infrastructure.\n\n## Requirements\n\n### REQ-1: DNS Server Select Parser Accuracy\n\n**User Story:** As a network administrator, I want the DNS server select configuration to be imported correctly, so that my domain-based DNS forwarding rules are preserved in Terraform state.\n\n**Bug Evidence:**\n- server_select 500000: Second server `1.0.0.1` incorrectly parsed as `original_sender`\n- server_select 500100: `record_type` defaulted to `a` instead of actual `aaaa`, `query_pattern` `.` misread as `edns`\n\n#### Acceptance Criteria\n\n1. WHEN importing `dns server select <id> <server1> <server2> <query_pattern>` THEN the parser SHALL capture both servers in the `servers` array\n2. WHEN a dns server select entry has `record_type` specified (e.g., `aaaa`) THEN the parser SHALL preserve the exact record type, not default to `a`\n3. WHEN the `query_pattern` is `.` (all domains) THEN the parser SHALL capture `.` as the query_pattern, not misinterpret other fields\n4. IF `edns=on` appears in the command THEN the parser SHALL set `edns = true`\n5. WHEN `original_sender` IP/CIDR is specified after query_pattern THEN the parser SHALL capture it correctly without confusing it with a second server\n\n### REQ-2: Interface Secure Filter Complete Parsing\n\n**User Story:** As a network administrator, I want all security filter IDs to be imported for each interface, so that my firewall rules remain intact after Terraform import.\n\n**Bug Evidence:**\n- `secure_filter_in` truncated: `[200020, 200021, ..., 200103, 20010]` (last ID `20010` is corrupted)\n- `secure_filter_out` truncated: `[200020, ..., 200026, 2000]` (last ID `2000` is corrupted)\n\n#### Acceptance Criteria\n\n1. WHEN an interface has more than 8 filter IDs in `secure_filter_in` THEN the parser SHALL capture all filter IDs without truncation\n2. WHEN an interface has more than 8 filter IDs in `secure_filter_out` THEN the parser SHALL capture all filter IDs without truncation\n3. WHEN filter output includes `dynamic` keyword THEN the parser SHALL correctly separate static and dynamic filter lists\n4. IF SSH output contains long lines THEN the parser SHALL handle complete line content\n\n### REQ-3: Static Route Multi-Gateway Support\n\n**User Story:** As a network administrator, I want all next-hop gateways for a route to be imported, so that my load-balanced and failover routing remains functional.\n\n**Bug Evidence:**\n- Routes with gateways `192.168.1.20` and `192.168.1.21` only import first gateway\n\n#### Acceptance Criteria\n\n1. WHEN a static route has multiple gateway entries (same prefix/mask) THEN the parser SHALL aggregate all gateways into the `next_hops` array\n2. WHEN each gateway has different `weight` values THEN the parser SHALL preserve the weight for each next_hop\n3. IF a gateway has `filter` attribute THEN the parser SHALL capture it in the corresponding next_hop\n\n### REQ-4: L2TP Tunnel Authentication Parsing\n\n**User Story:** As a VPN administrator, I want L2TP tunnel authentication settings to be imported correctly, so that my L2TPv3 VPN tunnels maintain their security configuration.\n\n**Bug Evidence:**\n- Router config: `l2tp tunnel auth on Example!Pass123`\n- Import result: `tunnel_auth_enabled = false`\n\n#### Acceptance Criteria\n\n1. WHEN `l2tp tunnel auth on <password>` is configured THEN the parser SHALL set `tunnel_auth_enabled = true`\n2. WHEN tunnel auth is enabled THEN the parser SHALL capture the password value (if visible in config)\n3. IF tunnel auth setting appears in config THEN it SHALL be associated with the correct tunnel ID based on `tunnel select` context\n\n### REQ-5: Admin User Attribute Parsing\n\n**User Story:** As a system administrator, I want user account attributes to be imported completely, so that login permissions and GUI access settings are preserved.\n\n**Bug Evidence:**\n- `login_timer`: Router has `3600`, import shows `0`\n- `gui_pages`: Router has `dashboard,lan-map,config`, import shows empty\n\n#### Acceptance Criteria\n\n1. WHEN `login-timer=<value>` is set in user attributes THEN the parser SHALL capture the exact timer value, not default to 0\n2. WHEN `gui-page=<pages>` is set THEN the parser SHALL capture all GUI page permissions as a list\n3. IF attribute format uses hyphens (e.g., `login-timer`) THEN the parser SHALL correctly map to schema attributes (e.g., `login_timer`)\n\n### REQ-6: Schema Import Compatibility\n\n**User Story:** As a Terraform user, I want to import existing configurations without encountering validation errors, so that I can adopt Terraform for managing existing infrastructure.\n\n#### Acceptance Criteria\n\n1. WHEN importing a resource THEN the provider SHALL NOT require attributes that aren't present in router config\n2. IF an attribute has a default value in schema THEN import SHALL use the actual router value, not the schema default\n3. WHEN `Computed: true` is set on an attribute THEN the provider SHALL allow the value to be populated from import\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each parser fix should be isolated to its respective parser file\n- **Modular Design**: Parser functions should remain independent and testable\n- **Backward Compatibility**: Fixes should not break existing configurations that import successfully\n- **Clear Interfaces**: Parser output structures should match Terraform schema expectations\n\n### Performance\n- Parser fixes SHALL NOT increase import time by more than 10%\n- SSH output handling SHALL support outputs up to 64KB per command\n\n### Reliability\n- All parser fixes SHALL include unit tests with real-world RTX config samples\n- Parser error handling SHALL provide descriptive messages identifying the parsing failure location\n\n### Testability\n- Each parser fix SHALL include test cases for:\n  - Normal case (valid input)\n  - Edge case (boundary conditions)\n  - Error case (malformed input)\n  - Regression case (previously working configurations)\n\n## Out of Scope\n\nThe following items are explicitly excluded from this specification:\n\n- Adding new resource types (e.g., `rtx_dhcp_server`, `rtx_pp_anonymous`)\n- Adding missing resources to main.tf (Phase 3 items in SESSION_PROGRESS.md)\n- SSH client architecture changes\n- Performance optimization beyond parser fixes\n- Multi-router support\n\n## Priority Order\n\n| Priority | Requirement | Complexity | Impact |\n|----------|-------------|------------|--------|\n| P0 | REQ-1: DNS server_select | Medium | DNS routing |\n| P0 | REQ-2: Interface secure_filter | Low | Firewall |\n| P1 | REQ-3: Static route multi-GW | Low | Routing |\n| P1 | REQ-5: Admin user attributes | Low | User mgmt |\n| P2 | REQ-4: L2TP tunnel_auth | Medium | VPN |\n| P2 | REQ-6: Schema compatibility | Low | All resources |\n",
  "fileStats": {
    "size": 7847,
    "lines": 146,
    "lastModified": "2026-01-20T11:09:51.095Z"
  },
  "comments": []
}