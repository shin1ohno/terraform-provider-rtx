{
  "id": "snapshot_1768800123835_g0lx3vx8k",
  "approvalId": "approval_1768799798431_si0rir6hc",
  "approvalTitle": "Design: rtx_ipsec_tunnel resource",
  "version": 2,
  "timestamp": "2026-01-19T05:22:03.835Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: rtx_ipsec_tunnel\n\n## Overview\n\nThe `rtx_ipsec_tunnel` resource enables Terraform-based management of IPsec VPN tunnels on Yamaha RTX series routers. Following Cisco IOS XE Terraform provider naming conventions, this resource manages complete IPsec tunnel configuration including IKE Phase 1, IPsec Phase 2, peer settings, and DPD configuration.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with IPsec methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add IPsec methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **Tunnel interface**: Coordinate with tunnel interface configuration\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_ipsec_tunnel.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        IPsecService[ipsec_tunnel_service.go]\n    end\n\n    subgraph Parser Layer\n        IPsecParser[ipsec_tunnel.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> IPsecService\n    IPsecService --> IPsecParser\n    IPsecParser --> Commands\n    IPsecParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `IPsecTunnelService` handles all IPsec CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all IPsec logic\n- **Utility Modularity**: Shared validation functions for cryptographic parameters\n\n## Components and Interfaces\n\n### Component 1: IPsecTunnelService (`internal/client/ipsec_tunnel_service.go`)\n\n- **Purpose:** Handles all IPsec tunnel CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type IPsecTunnelService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *IPsecTunnelService) Create(ctx context.Context, tunnel IPsecTunnel) error\n  func (s *IPsecTunnelService) Get(ctx context.Context, tunnelID int) (*IPsecTunnel, error)\n  func (s *IPsecTunnelService) Update(ctx context.Context, tunnel IPsecTunnel) error\n  func (s *IPsecTunnelService) Delete(ctx context.Context, tunnelID int) error\n  func (s *IPsecTunnelService) List(ctx context.Context) ([]IPsecTunnel, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.IPsecTunnelParser`\n- **Reuses:** Pattern from service layer implementations\n\n### Component 2: IPsecTunnelParser (`internal/rtx/parsers/ipsec_tunnel.go`)\n\n- **Purpose:** Parses RTX router output for IPsec configuration and builds commands\n- **Interfaces:**\n  ```go\n  type IPsecTunnel struct {\n      ID            int              `json:\"id\"`\n      Name          string           `json:\"name,omitempty\"`\n      LocalAddress  string           `json:\"local_address\"`\n      RemoteAddress string           `json:\"remote_address\"`\n      PreSharedKey  string           `json:\"pre_shared_key\"`\n      IKEv2Proposal IKEv2Proposal    `json:\"ikev2_proposal\"`\n      IPsecTransform IPsecTransform  `json:\"ipsec_transform\"`\n      LocalNetwork  string           `json:\"local_network\"`\n      RemoteNetwork string           `json:\"remote_network\"`\n      DPDEnabled    bool             `json:\"dpd_enabled\"`\n      DPDInterval   int              `json:\"dpd_interval\"`\n  }\n\n  type IKEv2Proposal struct {\n      EncryptionAES256 bool `json:\"encryption_aes_cbc_256\"`\n      IntegritySHA256  bool `json:\"integrity_sha256\"`\n      GroupFourteen    bool `json:\"group_fourteen\"`\n      LifetimeSeconds  int  `json:\"lifetime_seconds\"`\n  }\n\n  type IPsecTransform struct {\n      Protocol          string `json:\"protocol\"`\n      EncryptionAES256  bool   `json:\"encryption_aes_cbc_256\"`\n      IntegritySHA256   bool   `json:\"integrity_sha256_hmac\"`\n      PFSGroupFourteen  bool   `json:\"pfs_group_fourteen\"`\n      LifetimeSeconds   int    `json:\"lifetime_seconds\"`\n  }\n\n  func ParseIPsecTunnelConfig(raw string) ([]IPsecTunnel, error)\n  func BuildTunnelSelectCommand(id int) string\n  func BuildIPsecTunnelCommand(id int) string\n  func BuildIPsecSAPolicyCommand(tunnel IPsecTunnel) string\n  func BuildIPsecIKEPreSharedKeyCommand(id int, key string) string\n  func BuildIPsecIKERemoteAddressCommand(id int, addr string) string\n  func BuildIPsecIKEEncryptionCommand(id int, algo string) string\n  func BuildIPsecIKEGroupCommand(id int, group string) string\n  func BuildIPsecIKEKeepaliveCommand(id int, enabled bool) string\n  func BuildDeleteIPsecTunnelCommand(id int) string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_ipsec_tunnel.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXIPsecTunnel() *schema.Resource\n  func resourceRTXIPsecTunnelCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPsecTunnelRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPsecTunnelUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPsecTunnelDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXIPsecTunnelImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `IPsecTunnel`, Terraform SDK\n- **Reuses:** Resource patterns from other implementations\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with IPsec methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetIPsecTunnel(ctx context.Context, tunnelID int) (*IPsecTunnel, error)\n  CreateIPsecTunnel(ctx context.Context, tunnel IPsecTunnel) error\n  UpdateIPsecTunnel(ctx context.Context, tunnel IPsecTunnel) error\n  DeleteIPsecTunnel(ctx context.Context, tunnelID int) error\n  ListIPsecTunnels(ctx context.Context) ([]IPsecTunnel, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### IPsecTunnel\n\n```go\n// IPsecTunnel represents an IPsec tunnel configuration on an RTX router\ntype IPsecTunnel struct {\n    ID             int            `json:\"id\"`               // Tunnel ID (1-100+)\n    Name           string         `json:\"name,omitempty\"`   // Tunnel description\n    LocalAddress   string         `json:\"local_address\"`    // Local endpoint IP\n    RemoteAddress  string         `json:\"remote_address\"`   // Remote endpoint IP\n    PreSharedKey   string         `json:\"pre_shared_key\"`   // IKE PSK (sensitive)\n    IKEv2Proposal  IKEv2Proposal  `json:\"ikev2_proposal\"`   // Phase 1 settings\n    IPsecTransform IPsecTransform `json:\"ipsec_transform\"`  // Phase 2 settings\n    LocalNetwork   string         `json:\"local_network\"`    // Local interesting traffic\n    RemoteNetwork  string         `json:\"remote_network\"`   // Remote interesting traffic\n    DPDEnabled     bool           `json:\"dpd_enabled\"`      // Dead Peer Detection\n    DPDInterval    int            `json:\"dpd_interval\"`     // DPD interval seconds\n}\n\n// IKEv2Proposal represents IKE Phase 1 settings\ntype IKEv2Proposal struct {\n    EncryptionAES256 bool `json:\"encryption_aes_cbc_256\"`\n    IntegritySHA256  bool `json:\"integrity_sha256\"`\n    GroupFourteen    bool `json:\"group_fourteen\"` // DH Group 14\n    LifetimeSeconds  int  `json:\"lifetime_seconds\"`\n}\n\n// IPsecTransform represents IPsec Phase 2 settings\ntype IPsecTransform struct {\n    Protocol         string `json:\"protocol\"`              // esp or ah\n    EncryptionAES256 bool   `json:\"encryption_aes_cbc_256\"`\n    IntegritySHA256  bool   `json:\"integrity_sha256_hmac\"`\n    PFSGroupFourteen bool   `json:\"pfs_group_fourteen\"`\n    LifetimeSeconds  int    `json:\"lifetime_seconds\"`\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_ipsec_tunnel\" \"site_to_site\" {\n  id   = 1\n  name = \"site-to-site-vpn\"\n\n  local_address  = \"203.0.113.1\"\n  remote_address = \"198.51.100.1\"\n\n  pre_shared_key = var.ipsec_psk\n\n  # IKE Phase 1 (IKEv2)\n  ikev2_proposal {\n    encryption_aes_cbc_256 = true\n    integrity_sha256       = true\n    group_fourteen         = true  # DH Group 14\n    lifetime_seconds       = 28800\n  }\n\n  # IPsec Phase 2\n  ipsec_transform {\n    protocol               = \"esp\"\n    encryption_aes_cbc_256 = true\n    integrity_sha256_hmac  = true\n    pfs_group_fourteen     = true\n    lifetime_seconds       = 3600\n  }\n\n  local_network  = \"192.168.1.0/24\"\n  remote_network = \"192.168.2.0/24\"\n\n  dpd_enabled  = true\n  dpd_interval = 30\n}\n```\n\n## RTX Command Mapping\n\n### Create Tunnel\n\n```\ntunnel select <n>\nipsec tunnel <n>\n```\n\n### Configure IKE Pre-Shared Key\n\n```\nipsec ike pre-shared-key <n> text <key>\n```\n\n### Configure Remote Address\n\n```\nipsec ike remote address <n> <ip>\n```\n\n### Configure IKE Encryption\n\n```\nipsec ike encryption <n> aes-cbc\n```\n\n### Configure IKE Hash\n\n```\nipsec ike hash <n> sha256\n```\n\n### Configure IKE DH Group\n\n```\nipsec ike group <n> modp2048\n```\n\n### Configure IPsec SA Policy\n\n```\nipsec sa policy <n> <tunnel> esp aes-cbc sha-hmac\n```\n\n### Configure Keepalive/DPD\n\n```\nipsec ike keepalive use <n> on dpd <interval>\n```\n\n### Configure Interesting Traffic\n\n```\nipsec ike local address <n> <network>\nipsec ike remote address <n> <network>\n```\n\n### Delete Tunnel\n\n```\nno tunnel select <n>\nno ipsec tunnel <n>\n```\n\n### Show Configuration\n\n```\nshow config | grep ipsec\nshow ipsec sa\nshow ipsec sa gateway\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Tunnel ID**\n   - **Handling:** Validate ID is positive integer\n   - **User Impact:** Clear validation error\n\n2. **Invalid IP Address**\n   - **Handling:** Validate IP address format\n   - **User Impact:** Clear error with expected format\n\n3. **Invalid Algorithm Combination**\n   - **Handling:** Validate supported algorithm combinations\n   - **User Impact:** Error indicating invalid combination\n\n4. **Tunnel Already Exists**\n   - **Handling:** Parse RTX output for existing tunnel\n   - **User Impact:** Error suggesting import\n\n5. **Invalid Network CIDR**\n   - **Handling:** Validate CIDR notation\n   - **User Impact:** Clear error with expected format\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`ipsec_tunnel_test.go`):\n  - Parse various RTX `show config` output for IPsec\n  - Test command builder functions with different parameters\n  - Test algorithm validation\n\n- **Service Tests** (`ipsec_tunnel_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test proposal/transform configuration\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_ipsec_tunnel_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Sensitive attribute handling (PSK)\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create IPsec tunnel with various algorithms\n  - Configure DPD\n  - Update tunnel parameters\n  - Delete tunnel\n  - Import existing tunnel\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_ipsec_tunnel.go      # NEW: Terraform resource\n│   └── resource_rtx_ipsec_tunnel_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                      # MODIFY: Add IPsec types and methods\n│   ├── client.go                          # MODIFY: Add IPsec service initialization\n│   ├── ipsec_tunnel_service.go           # NEW: IPsec service implementation\n│   └── ipsec_tunnel_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── ipsec_tunnel.go               # NEW: Parser and command builders\n        └── ipsec_tunnel_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Sensitive Data**: Pre-shared key must be marked as sensitive in Terraform state.\n\n2. **Terraform ID**: Use tunnel ID directly as Terraform resource ID.\n\n3. **ForceNew**: Tunnel ID is ForceNew. Most other attributes support in-place updates.\n\n4. **Algorithm Mapping**: Map Cisco-style attribute names to RTX commands (e.g., `encryption_aes_cbc_256` -> `aes-cbc`).\n\n5. **DH Group Mapping**: Map group names (group_fourteen -> modp2048).\n\n6. **IKE Version**: RTX supports both IKEv1 and IKEv2. Consider as separate attribute or auto-detect.\n\n7. **Tunnel Interface**: IPsec tunnel creates a tunnel interface. Consider relationship with static routes.\n\n8. **SA Clearing**: May need to clear SAs when updating configuration.\n\n9. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n10. **Provider Registration**: Add `resourceRTXIPsecTunnel` to provider's resource map.\n",
  "fileStats": {
    "size": 13076,
    "lines": 399,
    "lastModified": "2026-01-19T05:12:07.693Z"
  },
  "comments": []
}