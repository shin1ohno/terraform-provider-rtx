{
  "id": "snapshot_1769186107949_4mwejrdnl",
  "approvalId": "approval_1769186105818_r75c2p663",
  "approvalTitle": "Tasks for SFTP Config Parsing Fixes (Updated with iteration cycle)",
  "version": 2,
  "timestamp": "2026-01-23T16:35:07.949Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: SFTP Config Parsing Fixes\n\n## Task Overview\n\n| Phase | Tasks | Description | Files | Requirements |\n|-------|-------|-------------|-------|--------------|\n| 1 | 1.1 | Write holistic tests (Red) | config_file_sftp_test.go | REQ-7 |\n| 2 | 2.1-2.5 | Fix parsers (Green) | l2tp.go, l2tp_service.go, system.go, dhcp_binding.go, config_file.go | REQ-1 to REQ-5 |\n| 3 | 3.1 | Update main.tf | examples/import/main.tf | REQ-6 |\n| 4 | 4.1 | Verify all tests pass | - | All |\n\n**Total: 8 tasks**\n\n## TDD Cycle\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 1: Write Tests (Red)                                  │\n│ - Create config_file_sftp_test.go with actual RTX config    │\n│ - Tests WILL fail initially (this is expected)              │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 2: Fix Implementation (Green)                         │\n│ - Fix each parser issue one by one                          │\n│ - Run tests after each fix                                  │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 3: Update Config                                      │\n│ - Update main.tf dns_servers order                          │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Phase 4: Verify Green                                       │\n│ - Run: go test ./internal/rtx/parsers/... -v                │\n│ - All tests must pass                                       │\n└─────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## Phase 1: Write Holistic Tests (Red)\n\n- [ ] 1.1. Create holistic SFTP config tests\n  - File: `internal/rtx/parsers/config_file_sftp_test.go`\n  - Use actual RTX config from `.spec-workflow/specs/sftp-config-parsing-fixes/test-data/rtx_config_raw.txt`\n  - Mask sensitive data in test constant\n  - Write test cases for:\n    - L2TP Tunnel 1: AlwaysOn, KeepaliveEnabled, Name, Version, Mode\n    - L2TP Tunnel 2: Version=\"l2tp\", Mode=\"lns\"\n    - L2TP Service: Enabled, Protocols=[\"l2tpv3\", \"l2tp\"]\n    - System: Timezone, Console, PacketBuffers, Statistics\n    - DHCP Bindings: 5 bindings with ScopeID=1\n  - Tests WILL fail initially (expected - Red phase)\n  - _Leverage: Existing patterns from config_file_test.go_\n  - _Requirements: REQ-7_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Go Test Developer | Task: Create config_file_sftp_test.go with holistic tests using actual RTX config. Tests should verify all parsing issues identified in requirements. Use table-driven tests where appropriate | Restrictions: Tests will fail initially - this is expected TDD Red phase | Success: Test file created with comprehensive coverage | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n---\n\n## Phase 2: Fix Implementation (Green)\n\n### 2.1 Fix L2TP Tunnel Context Parsing\n\n- [ ] 2.1. Fix L2TP tunnel attributes parsing\n  - File: `internal/rtx/parsers/l2tp.go`\n  - Fix parsing for:\n    - `l2tp always-on on` → AlwaysOn = true\n    - `l2tp hostname <name>` → Name = name\n    - `l2tp keepalive use on <interval> <retry>` → KeepaliveEnabled = true\n  - Run: `go test ./internal/rtx/parsers/... -v -run SFTP`\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Go Developer | Task: Fix l2tp.go to correctly parse l2tp always-on, l2tp hostname, and l2tp keepalive use commands from tunnel context | Restrictions: Do not break existing functionality | Success: L2TP Tunnel 1 tests pass | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n### 2.2 Fix L2TPv2 Mode Detection\n\n- [ ] 2.2. Fix L2TPv2 mode detection\n  - File: `internal/rtx/parsers/l2tp.go`\n  - When `tunnel encapsulation l2tp` is detected:\n    - Set Version = \"l2tp\"\n    - Set Mode = \"lns\" (not default \"l2vpn\")\n  - Run: `go test ./internal/rtx/parsers/... -v -run SFTP`\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Go Developer | Task: Fix l2tp.go so that when tunnel encapsulation l2tp is detected, Mode is set to \"lns\" instead of staying as default \"l2vpn\" | Restrictions: L2TPv3 should keep Mode=\"l2vpn\" | Success: L2TP Tunnel 2 tests pass with Mode=\"lns\" | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n### 2.3 Fix L2TP Service Protocol Parsing\n\n- [ ] 2.3. Fix L2TP service protocol parsing\n  - File: `internal/rtx/parsers/l2tp_service.go`\n  - Parse protocols from `l2tp service on <proto1> <proto2>` format\n  - Example: `l2tp service on l2tpv3 l2tp` → Protocols = [\"l2tpv3\", \"l2tp\"]\n  - Run: `go test ./internal/rtx/parsers/... -v -run SFTP`\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Go Developer | Task: Fix l2tp_service.go to extract protocol list from l2tp service on command. Protocols appear after \"on\" keyword | Restrictions: Handle case with no protocols (empty list) | Success: L2TP Service tests pass with Protocols=[\"l2tpv3\", \"l2tp\"] | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n### 2.4 Fix System Config Extraction\n\n- [ ] 2.4. Fix system config extraction and parsing\n  - Files: `internal/rtx/parsers/config_file.go`, `internal/rtx/parsers/system.go`\n  - Debug ExtractSystem to verify commands are collected\n  - Fix ParseSystemConfig to handle all formats:\n    - timezone, console character/lines/prompt\n    - system packet-buffer, statistics traffic/nat\n  - Run: `go test ./internal/rtx/parsers/... -v -run SFTP`\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Go Developer | Task: Fix system config extraction and parsing. First debug ExtractSystem in config_file.go to verify commands are collected. Then fix ParseSystemConfig in system.go to handle timezone, console, packet-buffer, and statistics commands | Restrictions: Preserve existing functionality | Success: System config tests pass with all fields populated | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n### 2.5 Fix DHCP Binding Scope ID\n\n- [ ] 2.5. Fix DHCP binding scope ID extraction\n  - Files: `internal/rtx/parsers/config_file.go`, `internal/rtx/parsers/dhcp_binding.go`\n  - Extract scope ID from each `dhcp scope bind <id> <ip> <mac>` line\n  - Don't use hardcoded scopeID=0\n  - Run: `go test ./internal/rtx/parsers/... -v -run SFTP`\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Go Developer | Task: Fix DHCP binding parsing to extract scope ID from each line instead of using hardcoded value. In config_file.go ExtractDHCPBindings or dhcp_binding.go ParseBindings, extract scope ID from line format: dhcp scope bind <scope_id> <ip> <mac> | Restrictions: Maintain backward compatibility | Success: DHCP binding tests pass with correct ScopeID=1 for all bindings | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n---\n\n## Phase 3: Update Configuration\n\n- [ ] 3.1. Update main.tf dns_servers order\n  - File: `examples/import/main.tf`\n  - Change: `dns_servers = [\"1.0.0.1\", \"1.1.1.1\"]` → `dns_servers = [\"1.1.1.1\", \"1.0.0.1\"]`\n  - This matches the actual RTX config order\n  - _Requirements: REQ-6_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: Configuration Manager | Task: Update dns_servers order in examples/import/main.tf to match actual RTX config. The correct order is [\"1.1.1.1\", \"1.0.0.1\"] | Restrictions: Only change this specific value | Success: dns_servers order matches RTX config | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n---\n\n## Phase 4: Verification\n\n- [ ] 4.1. Run all parser tests\n  - Execute: `go test ./internal/rtx/parsers/... -v`\n  - Verify no regressions in existing tests\n  - Verify all new SFTP config tests pass\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: QA Engineer | Task: Run full parser test suite, verify all tests pass including new SFTP config tests | Restrictions: Do not skip failing tests | Success: All parser tests pass | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n- [ ] 4.2. Build provider and run terraform plan\n  - Execute in project root: `go build -o terraform-provider-rtx`\n  - Execute in examples/import: `terraform plan`\n  - Verify no unexpected differences\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: QA Engineer | Task: Build the provider binary and run terraform plan in examples/import directory. Document any differences found | Restrictions: Use latest built binary | Success: terraform plan output captured | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n- [ ] 4.3. Iterate until no differences (if needed)\n  - IF terraform plan shows differences:\n    1. Analyze the differences\n    2. Create new spec for each issue (requirements.md, design.md, tasks.md)\n    3. Execute fix tasks in parallel where possible\n    4. Re-run terraform plan\n    5. Repeat until no differences\n  - Continue this cycle until `terraform plan` shows no changes\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec sftp-config-parsing-fixes: Role: QA Engineer + Developer | Task: If terraform plan shows differences, analyze each difference, create new spec if needed, implement fixes, and re-run terraform plan. Repeat until no differences remain. Execute independent fixes in parallel | Restrictions: Each new issue needs its own spec if not covered by existing requirements | Success: terraform plan shows no unexpected changes | Instructions: Before starting, mark this task as in-progress in tasks.md by changing [ ] to [-]. After completing, use log-implementation tool to record what was done, then mark as complete [x]._\n\n### Iteration Cycle Diagram\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│ Step 1: Build & Plan                                        │\n│ - go build -o terraform-provider-rtx                        │\n│ - cd examples/import && terraform plan                      │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Step 2: Check Differences                                   │\n│ - No differences? → DONE ✓                                  │\n│ - Has differences? → Continue to Step 3                     │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Step 3: Analyze & Create Spec                               │\n│ - Identify root cause for each difference                   │\n│ - Create new spec (requirements/design/tasks)               │\n│ - Or add to existing spec if related                        │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Step 4: Implement Fixes (Parallel)                          │\n│ - Execute independent tasks in parallel                     │\n│ - Run unit tests after each fix                             │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n              (Return to Step 1)\n```\n",
  "fileStats": {
    "size": 14898,
    "lines": 189,
    "lastModified": "2026-01-23T16:34:57.536Z"
  },
  "comments": []
}