{
  "id": "snapshot_1769185808342_uqp2j7v8l",
  "approvalId": "approval_1769185735505_tl34healq",
  "approvalTitle": "Requirements for SFTP Config Parsing Fixes (Updated with TDD pattern)",
  "version": 2,
  "timestamp": "2026-01-23T16:30:08.342Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements: SFTP Config Parsing Fixes\n\n## Overview\n\nWhen using SFTP-based config reading (`sftp_enabled = true`), several resources show incorrect state compared to SSH-based reading. This causes `terraform plan` to show changes that shouldn't exist.\n\n## Problem Statement\n\nAfter switching from SSH to SFTP for configuration reading, `terraform plan` shows unexpected differences for several resources. The raw config from RTX is correctly retrieved via SFTP, but the parsing logic has issues extracting certain fields.\n\n## Raw RTX Config (Masked)\n\nThe following is the actual config retrieved via SFTP from RTX router, with sensitive information replaced with test data:\n\n```\n#\n# Admin\n#\nlogin password TEST_LOGIN_PASS\nadministrator password TEST_ADMIN_PASS\nlogin user testuser TEST_USER_PASS\nuser attribute administrator=off connection=off gui-page=dashboard,lan-map,config login-timer=300\nuser attribute testuser connection=serial,telnet,remote,ssh,sftp,http gui-page=dashboard,lan-map,config login-timer=3600\ntimezone +09:00\nconsole character ja.utf8\nconsole lines infinity\nconsole prompt \"[RTX1210] \"\nsystem packet-buffer small max-buffer=5000 max-free=1300\nsystem packet-buffer middle max-buffer=10000 max-free=4950\nsystem packet-buffer large max-buffer=20000 max-free=5600\nswitch control use bridge1 on terminal=on\nlan-map snapshot use bridge1 on terminal=wired-only\n\nhttpd host any\nhttpd proxy-access l2ms permit on\n\noperation http revision-up permit on\ndescription yno RTX1210-Test\nsshd service on\nsshd host lan2 bridge1\nsshd host key generate ... [SSH_KEY_OMITTED]\nsftpd host bridge1\nexternal-memory statistics filename prefix usb1:rtx1210\nstatistics traffic on\nstatistics nat on\nswitch control watch interval 2 5\nlan-map terminal watch interval 1800 10\nlan-map sysname RTX1210_Test\n\nsyslog host 192.168.1.20\nsyslog local address 192.168.1.253\nsyslog facility local0\nsyslog notice on\nsyslog info on\nsyslog debug on\n\n#\n# WAN connection\n#\n\ndescription lan2 wan\nip lan2 address dhcp\nip lan2 nat descriptor 1000\nip lan2 secure filter in  200020 200021 200022 200023 200024 200025 200103 200100 200102 200104 200101 200105 200099\nip lan2 secure filter out 200020 200021 200022 200023 200024 200025 200026 200027 200099 dynamic 200080 200081 200082 200083 200084 200085\n\nipv6 lan2 mtu 1500\nipv6 lan2 dhcp service client ir=on\nipv6 lan2 secure filter in 101000 101002 101099\nipv6 lan2 secure filter out 101099 dynamic 101080 101081 101082 101083 101084 101085 101098 101099\n\nngn type lan2 off\nsip use off\n\n#\n# IP configuration\n#\n\nip routing process fast\nip route change log on\nip filter source-route on\nip filter directed-broadcast on\nip route default gateway dhcp lan2\nip route 10.33.128.0/21 gateway 192.168.1.20 gateway 192.168.1.21\nip route 100.64.0.0/10 gateway 192.168.1.20 gateway 192.168.1.21\n\nipv6 routing process fast\nipv6 prefix 1 ra-prefix@lan2::/64\nipv6 bridge1 address ra-prefix@lan2::1/64\nipv6 lan1 address ra-prefix@lan2::2/64\nipv6 lan1 rtadv send 1 o_flag=on\nipv6 lan1 dhcp service server\n\nbridge member bridge1 lan1 tunnel1\nip bridge1 address 192.168.1.253/16\nip lan1 proxyarp on\n\n#\n# Services\n#\n\ndhcp service server\ndhcp server rfc2131 compliant except remain-silent\ndhcp scope 1 192.168.1.20-192.168.1.99/16 gateway 192.168.1.253 expire 12:00 maxexpire 24:00\ndhcp scope bind 1 192.168.1.20 01 00 30 93 11 0e 33\ndhcp scope bind 1 192.168.1.21 01 00 3e e1 c3 54 b4\ndhcp scope bind 1 192.168.1.22 01 00 3e e1 c3 54 b5\ndhcp scope bind 1 192.168.1.28 24:59:e5:54:5e:5a\ndhcp scope bind 1 192.168.1.29 b8:0b:da:ef:77:33\ndhcp scope option 1 dns=1.1.1.1,1.0.0.1\ndhcp scope option 1 router=192.168.1.253\n\ndhcp client release linkdown on\ndns host bridge1\ndns service recursive\ndns cache use off\ndns server select 1 100.100.100.100 edns=on any home.local\ndns server select 500000 1.1.1.1 edns=on 1.0.0.1 edns=on a .\ndns server select 500100 2606:4700:4700::1111 edns=on 2606:4700:4700::1001 edns=on aaaa .\ndns private address spoof on\n\n#\n# Tunnels\n#\n\npp disable all\npp select anonymous\n pp bind tunnel2\n pp auth request mschap-v2\n pp auth username testuser TEST_PP_PASS\n ppp ipcp ipaddress on\n ppp ipcp msext on\n ppp ccp type none\n ip pp remote address pool dhcp\n ip pp mtu 1258\n pp enable anonymous\nno tunnel enable all\ntunnel select 1\n tunnel encapsulation l2tpv3\n tunnel endpoint name remote.example.com fqdn\n ipsec tunnel 101\n  ipsec sa policy 101 1 esp aes-cbc sha-hmac\n  ipsec ike keepalive log 1 off\n  ipsec ike keepalive use 1 on heartbeat 10 6\n  ipsec ike local address 1 192.168.1.253\n  ipsec ike log 1 key-info message-info payload-info\n  ipsec ike nat-traversal 1 on\n  ipsec ike pre-shared-key 1 text TEST_IPSEC_PSK\n  ipsec ike remote address 1 remote.example.com\n  ipsec ike remote name 1 l2tpv3 key-id\n l2tp always-on on\n l2tp hostname test-RTX1210\n l2tp tunnel auth on TEST_L2TP_AUTH\n l2tp tunnel disconnect time off\n l2tp keepalive use on 60 3\n l2tp keepalive log off\n l2tp syslog on\n l2tp local router-id 192.168.1.253\n l2tp remote router-id 192.168.1.254\n l2tp remote end-id remote1\n ip tunnel secure filter in 200028 200099\n ip tunnel tcp mss limit auto\n tunnel enable 1\n\n tunnel select 2\n tunnel encapsulation l2tp\n ipsec tunnel 1\n  ipsec sa policy 1 2 esp aes-cbc sha-hmac\n  ipsec ike keepalive use 2 off\n  ipsec ike nat-traversal 2 on\n  ipsec ike pre-shared-key 2 text TEST_IPSEC_PSK2\n  ipsec ike remote address 2 any\n l2tp tunnel disconnect time off\n ip tunnel tcp mss limit auto\n tunnel enable 2\n\n... [IP filters omitted - not relevant to this issue]\n\nipsec auto refresh on\nipsec transport 1 101 udp 1701\nipsec transport 3 3 udp 1701\nl2tp service on l2tpv3 l2tp\n\n... [IPv6 filters omitted - not relevant to this issue]\n```\n\n## Identified Discrepancies\n\n### 1. rtx_l2tp.tunnel1 - L2TPv3 tunnel fields not parsed\n\n**Raw Config (tunnel select 1 context):**\n```\ntunnel select 1\n tunnel encapsulation l2tpv3\n ...\n l2tp always-on on\n l2tp hostname test-RTX1210\n l2tp keepalive use on 60 3\n ...\n tunnel enable 1\n```\n\n**Current Parse Result:**\n```hcl\nalways_on         = false\nkeepalive_enabled = false\nname              = null\n```\n\n**Expected Result (from main.tf):**\n```hcl\nalways_on          = true\nkeepalive_enabled  = true\nname               = \"ebisu-RTX1210\"  # from l2tp hostname\n```\n\n**Root Cause Analysis:**\n- The `l2tp always-on on`, `l2tp hostname`, and `l2tp keepalive use on` commands are inside `tunnel select 1` context\n- `ExtractL2TPTunnels` in `config_file.go` builds raw config from context commands and passes to `ParseL2TPConfig`\n- However, the parser may not be receiving these commands correctly due to context handling\n\n### 2. rtx_l2tp.tunnel2 - Mode incorrectly detected as l2vpn\n\n**Raw Config (tunnel select 2 context):**\n```\ntunnel select 2\n tunnel encapsulation l2tp\n ipsec tunnel 1\n ...\n tunnel enable 2\n```\n\n**Current Parse Result:**\n```hcl\nmode = \"l2vpn\"\n```\n\n**Expected Result:**\n```hcl\nmode = \"lns\"\n```\n\n**Root Cause Analysis:**\n- In `l2tp.go` line 203-213, when `tunnel encapsulation l2tp` is detected, only `Version` is set to `\"l2tp\"`, but `Mode` is not changed from the default `\"l2vpn\"`\n- For L2TPv2 (`tunnel encapsulation l2tp`), the mode should be `\"lns\"` (L2TP Network Server)\n\n### 3. rtx_l2tp_service.main - Protocols not parsed\n\n**Raw Config:**\n```\nl2tp service on l2tpv3 l2tp\n```\n\n**Current Parse Result:**\n```hcl\nprotocols = []\n```\n\n**Expected Result:**\n```hcl\nprotocols = [\"l2tpv3\", \"l2tp\"]\n```\n\n**Root Cause Analysis:**\n- `ParseL2TPServiceConfig` function is not parsing the protocol list from `l2tp service on <protocol1> <protocol2>` format\n- Need to verify `l2tp_service.go` parser implementation\n\n### 4. rtx_system.main - All system fields null\n\n**Raw Config:**\n```\ntimezone +09:00\nconsole character ja.utf8\nconsole lines infinity\nconsole prompt \"[RTX1210] \"\nsystem packet-buffer small max-buffer=5000 max-free=1300\nsystem packet-buffer middle max-buffer=10000 max-free=4950\nsystem packet-buffer large max-buffer=20000 max-free=5600\nstatistics traffic on\nstatistics nat on\n```\n\n**Current Parse Result:**\n```hcl\ntimezone = null\nconsole = null\npacket_buffer = null\nstatistics = null\n```\n\n**Expected Result:**\n```hcl\ntimezone = \"+09:00\"\nconsole {\n  character = \"ja.utf8\"\n  lines     = \"infinity\"\n  prompt    = \"[RTX1210] \"\n}\npacket_buffer {\n  size       = \"small\"\n  max_buffer = 5000\n  max_free   = 1300\n}\npacket_buffer {\n  size       = \"middle\"\n  max_buffer = 10000\n  max_free   = 4950\n}\npacket_buffer {\n  size       = \"large\"\n  max_buffer = 20000\n  max_free   = 5600\n}\nstatistics {\n  traffic = true\n  nat     = true\n}\n```\n\n**Root Cause Analysis:**\n- `ExtractSystem` in `config_file.go` filters global commands starting with `timezone `, `console `, `system packet-buffer `, `statistics `\n- Need to verify these commands are being found in global context\n- The system parser `ParseSystemConfig` may have issues\n\n### 5. rtx_dhcp_binding - All bindings show as \"create\"\n\n**Raw Config:**\n```\ndhcp scope bind 1 192.168.1.20 01 00 30 93 11 0e 33\ndhcp scope bind 1 192.168.1.21 01 00 3e e1 c3 54 b4\ndhcp scope bind 1 192.168.1.22 01 00 3e e1 c3 54 b5\ndhcp scope bind 1 192.168.1.28 24:59:e5:54:5e:5a\ndhcp scope bind 1 192.168.1.29 b8:0b:da:ef:77:33\n```\n\n**Current Parse Result:**\n- All 5 bindings appear to be missing from state, causing \"create\" actions\n\n**Expected Result:**\n- Bindings should match existing terraform state and show no changes\n\n**Root Cause Analysis:**\n- In `config_file.go` line 920-923, `ExtractDHCPBindings` calls `parser.ParseBindings(raw, 0)` with `scopeID=0`\n- The `ParseBindings` function may be using this passed `scopeID` instead of extracting it from each line\n- Resource ID format may not match between SFTP read and existing state\n\n### 6. rtx_dhcp_scope.scope1 - DNS servers order reversed\n\n**Raw Config:**\n```\ndhcp scope option 1 dns=1.1.1.1,1.0.0.1\n```\n\n**Current Parse Result:**\n```hcl\ndns_servers = [\"1.1.1.1\", \"1.0.0.1\"]\n```\n\n**main.tf Definition:**\n```hcl\ndns_servers = [\"1.0.0.1\", \"1.1.1.1\"]\n```\n\n**Analysis:**\n- The parser correctly extracts the order from config: `1.1.1.1` first, then `1.0.0.1`\n- The `main.tf` definition has the order reversed\n- This is NOT a parser bug - the `main.tf` should be corrected to match the actual config\n\n## Requirements\n\n### REQ-1: Fix L2TP tunnel context parsing\n- **User Story:** As a Terraform user, I want L2TP tunnel attributes (always_on, keepalive_enabled, name) to be correctly parsed from tunnel context\n- **Acceptance Criteria:**\n  - `l2tp always-on on` in tunnel context sets `AlwaysOn = true`\n  - `l2tp hostname <name>` in tunnel context sets `Name = <name>`\n  - `l2tp keepalive use on <interval> <retry>` in tunnel context sets `KeepaliveEnabled = true`\n\n### REQ-2: Fix L2TPv2 mode detection\n- **User Story:** As a Terraform user, I want L2TPv2 tunnels to be correctly identified with mode=\"lns\"\n- **Acceptance Criteria:**\n  - When `tunnel encapsulation l2tp` is detected, `Mode` should be set to `\"lns\"`\n  - L2TPv3 tunnels (`tunnel encapsulation l2tpv3`) should keep `Mode = \"l2vpn\"`\n\n### REQ-3: Fix L2TP service protocol parsing\n- **User Story:** As a Terraform user, I want the L2TP service protocols to be parsed correctly\n- **Acceptance Criteria:**\n  - `l2tp service on l2tpv3 l2tp` should result in `protocols = [\"l2tpv3\", \"l2tp\"]`\n  - `l2tp service on` (without protocols) should result in empty protocols list\n\n### REQ-4: Fix system config extraction\n- **User Story:** As a Terraform user, I want system configuration (timezone, console, packet_buffer, statistics) to be correctly parsed\n- **Acceptance Criteria:**\n  - All system commands from global context should be extracted\n  - Parser should correctly parse timezone, console, packet-buffer, and statistics settings\n\n### REQ-5: Fix DHCP binding scope ID extraction\n- **User Story:** As a Terraform user, I want DHCP bindings to maintain consistent resource IDs\n- **Acceptance Criteria:**\n  - Scope ID should be extracted from each `dhcp scope bind` line\n  - Resource IDs should match format used in terraform state\n\n### REQ-6: Update main.tf dns_servers order\n- **User Story:** As a Terraform user, I want the main.tf to reflect the actual router configuration\n- **Acceptance Criteria:**\n  - Update `dns_servers` order in main.tf to match actual config: `[\"1.1.1.1\", \"1.0.0.1\"]`\n\n### REQ-7: Create holistic integration tests using actual RTX config\n\n**User Story:** As a developer, I want comprehensive tests that validate the entire parsing pipeline using realistic RTX configuration data, following the same holistic test pattern established for SSH-based parsing.\n\n**Acceptance Criteria:**\n\n1. WHEN a holistic test file is created THEN it SHALL be named `config_file_sftp_test.go` in `internal/rtx/parsers/`\n2. WHEN the actual RTX config is used as test input THEN sensitive data SHALL be masked with test values\n3. WHEN testing L2TPv3 tunnel (tunnel 1) THEN the test SHALL verify:\n   - `AlwaysOn = true` (from `l2tp always-on on`)\n   - `KeepaliveEnabled = true` (from `l2tp keepalive use on 60 3`)\n   - `Name = \"test-RTX1210\"` (from `l2tp hostname test-RTX1210`)\n   - `Version = \"l2tpv3\"` (from `tunnel encapsulation l2tpv3`)\n   - `Mode = \"l2vpn\"` (default for L2TPv3)\n4. WHEN testing L2TPv2 LNS tunnel (tunnel 2) THEN the test SHALL verify:\n   - `Mode = \"lns\"` (implied by `tunnel encapsulation l2tp`)\n   - `Version = \"l2tp\"` (from `tunnel encapsulation l2tp`)\n5. WHEN testing L2TP service THEN the test SHALL verify:\n   - `Enabled = true` (from `l2tp service on`)\n   - `Protocols = [\"l2tpv3\", \"l2tp\"]` (from `l2tp service on l2tpv3 l2tp`)\n6. WHEN testing system config THEN the test SHALL verify:\n   - `Timezone = \"+09:00\"`\n   - `Console.Character = \"ja.utf8\"`\n   - `Console.Lines = \"infinity\"`\n   - `Console.Prompt = \"[RTX1210] \"`\n   - `PacketBuffer` has 3 entries (small, middle, large)\n   - `Statistics.Traffic = true`\n   - `Statistics.NAT = true`\n7. WHEN testing DHCP bindings THEN the test SHALL verify:\n   - All 5 bindings are extracted\n   - Each binding has correct `ScopeID = 1`\n   - IP addresses match: 192.168.1.20, .21, .22, .28, .29\n8. IF a test fails before fixes are applied THEN it is expected (TDD Red phase)\n9. WHEN fixes are applied THEN all tests SHALL pass (TDD Green phase)\n\n**Test Coverage Matrix:**\n\n| Resource | Extract Function | Expected Fields | Test Priority |\n|----------|-----------------|-----------------|---------------|\n| L2TP Tunnel 1 | `ExtractL2TPTunnels` | AlwaysOn, KeepaliveEnabled, Name | High |\n| L2TP Tunnel 2 | `ExtractL2TPTunnels` | Mode=\"lns\", Version=\"l2tp\" | High |\n| L2TP Service | `ExtractL2TPService` | Protocols=[\"l2tpv3\",\"l2tp\"] | High |\n| System | `ExtractSystem` | Timezone, Console, PacketBuffer, Statistics | High |\n| DHCP Bindings | `ExtractDHCPBindings` | 5 bindings with ScopeID=1 | High |\n\n**Reuse Existing Test Patterns:**\n\nThe holistic test approach was established in `config_file_test.go` during SSH-based parsing development. The same patterns SHALL be reused:\n\n```go\n// Pattern 1: Full config parsing with resource extraction verification\n// Reference: TestConfigFileParser_ExtractFromSampleConfig\nfunc TestConfigFileParser_SFTPConfig(t *testing.T) {\n    sampleConfig := `...actual RTX config from SFTP...`\n    parser := NewConfigFileParser()\n    result, err := parser.Parse(sampleConfig)\n    require.NoError(t, err)\n\n    // Verify each resource extraction matches expected values\n}\n\n// Pattern 2: Table-driven tests for specific extraction functions\n// Reference: TestConfigFileParser_ExtractL2TPTunnels\nfunc TestConfigFileParser_SFTPConfig_L2TPTunnels(t *testing.T) {\n    tests := []struct {\n        name     string\n        tunnelID int\n        expected *L2TPConfig\n    }{\n        {\n            name:     \"L2TPv3 tunnel with keepalive\",\n            tunnelID: 1,\n            expected: &L2TPConfig{\n                AlwaysOn:         true,\n                KeepaliveEnabled: true,\n                Name:             \"test-RTX1210\",\n                // ...\n            },\n        },\n        // ...\n    }\n}\n\n// Pattern 3: Verify raw config is correctly captured\n// Reference: TestConfigFileParser_Context handling\nfunc TestConfigFileParser_SFTPConfig_RawCommands(t *testing.T) {\n    // Verify tunnel context commands are properly collected\n}\n```\n\n**TDD Cycle:**\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│ Step 1: Write Tests (Red)                                   │\n│ - Create config_file_sftp_test.go with expected values      │\n│ - Tests WILL fail initially (this is expected)              │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Step 2: Fix Implementation (Green)                          │\n│ - Fix l2tp.go for Mode detection                            │\n│ - Fix l2tp_service.go for protocol parsing                  │\n│ - Fix config_file.go for context handling                   │\n│ - Fix system.go for system config parsing                   │\n└─────────────────────────────────────────────────────────────┘\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│ Step 3: Verify Green                                        │\n│ - Run: go test ./internal/rtx/parsers/... -v -run SFTP      │\n│ - All tests must pass                                       │\n└─────────────────────────────────────────────────────────────┘\n```\n\n## Out of Scope\n\n- Changes to SFTP connection handling\n- Changes to SSH-based config reading\n- Performance optimizations\n",
  "fileStats": {
    "size": 18232,
    "lines": 526,
    "lastModified": "2026-01-23T16:28:42.856Z"
  },
  "comments": []
}