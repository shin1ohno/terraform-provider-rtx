{
  "id": "snapshot_1768800191951_f0rwbw5rw",
  "approvalId": "approval_1768799795824_jrx9ao0y4",
  "approvalTitle": "Design: rtx_ospf resource",
  "version": 2,
  "timestamp": "2026-01-19T05:23:11.951Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: rtx_ospf\n\n## Overview\n\nThe `rtx_ospf` resource enables Terraform-based management of OSPF (Open Shortest Path First) routing configuration on Yamaha RTX series routers. Following Cisco IOS XE Terraform provider naming conventions, this resource manages OSPF process configuration including router ID, areas, networks, and redistribution settings.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/dhcp_scope_service.go`**: Pattern for service layer implementation with CRUD operations.\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with OSPF methods.\n- **`internal/rtx/parsers/dhcp_scope.go`**: Reference for parser implementation and command builders.\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add OSPF methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **Interface configuration**: Coordinate with interface IP settings\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_ospf.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        OSPFService[ospf_service.go]\n    end\n\n    subgraph Parser Layer\n        OSPFParser[ospf.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> OSPFService\n    OSPFService --> OSPFParser\n    OSPFParser --> Commands\n    OSPFParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `OSPFService` handles all OSPF CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all OSPF logic\n- **Utility Modularity**: Shared validation functions for IP/area operations\n\n## Components and Interfaces\n\n### Component 1: OSPFService (`internal/client/ospf_service.go`)\n\n- **Purpose:** Handles all OSPF CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type OSPFService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *OSPFService) Create(ctx context.Context, ospf OSPFConfig) error\n  func (s *OSPFService) Get(ctx context.Context) (*OSPFConfig, error)\n  func (s *OSPFService) Update(ctx context.Context, ospf OSPFConfig) error\n  func (s *OSPFService) Delete(ctx context.Context) error\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.OSPFParser`\n- **Reuses:** Pattern from `DHCPScopeService`, `Executor` interface\n\n### Component 2: OSPFParser (`internal/rtx/parsers/ospf.go`)\n\n- **Purpose:** Parses RTX router output for OSPF configuration and builds commands\n- **Interfaces:**\n  ```go\n  type OSPFConfig struct {\n      ProcessID            int           `json:\"process_id\"`\n      RouterID             string        `json:\"router_id\"`\n      Distance             int           `json:\"distance\"`\n      DefaultOriginate     bool          `json:\"default_information_originate\"`\n      Networks             []OSPFNetwork `json:\"networks\"`\n      Areas                []OSPFArea    `json:\"areas,omitempty\"`\n      Neighbors            []OSPFNeighbor `json:\"neighbors,omitempty\"`\n      RedistributeStatic   bool          `json:\"redistribute_static\"`\n      RedistributeConnected bool         `json:\"redistribute_connected\"`\n  }\n\n  type OSPFNetwork struct {\n      IP       string `json:\"ip\"`\n      Wildcard string `json:\"wildcard\"`\n      Area     string `json:\"area\"`\n  }\n\n  type OSPFArea struct {\n      ID        string `json:\"id\"`\n      Type      string `json:\"type\"`  // normal, stub, nssa\n      NoSummary bool   `json:\"no_summary,omitempty\"`\n  }\n\n  type OSPFNeighbor struct {\n      IP       string `json:\"ip\"`\n      Priority int    `json:\"priority,omitempty\"`\n      Cost     int    `json:\"cost,omitempty\"`\n  }\n\n  func ParseOSPFConfig(raw string) (*OSPFConfig, error)\n  func BuildOSPFEnableCommand() string\n  func BuildOSPFRouterIDCommand(routerID string) string\n  func BuildOSPFAreaCommand(area, iface string) string\n  func BuildOSPFImportCommand(protocol string) string\n  func BuildDeleteOSPFCommand() string\n  ```\n- **Dependencies:** `regexp`, `strings`, `net`\n- **Reuses:** IP validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_ospf.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXOSPF() *schema.Resource\n  func resourceRTXOSPFCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXOSPFRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXOSPFUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXOSPFDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXOSPFImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `OSPFConfig`, Terraform SDK\n- **Reuses:** `resourceRTXDHCPScope` patterns\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with OSPF methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetOSPF(ctx context.Context) (*OSPFConfig, error)\n  CreateOSPF(ctx context.Context, ospf OSPFConfig) error\n  UpdateOSPF(ctx context.Context, ospf OSPFConfig) error\n  DeleteOSPF(ctx context.Context) error\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### OSPFConfig\n\n```go\n// OSPFConfig represents OSPF configuration on an RTX router\ntype OSPFConfig struct {\n    ProcessID             int            `json:\"process_id\"`              // OSPF process ID\n    RouterID              string         `json:\"router_id\"`               // Router ID (dotted decimal)\n    Distance              int            `json:\"distance\"`                // Administrative distance\n    DefaultOriginate      bool           `json:\"default_information_originate\"`\n    Networks              []OSPFNetwork  `json:\"networks\"`\n    Areas                 []OSPFArea     `json:\"areas,omitempty\"`\n    Neighbors             []OSPFNeighbor `json:\"neighbors,omitempty\"`\n    RedistributeStatic    bool           `json:\"redistribute_static\"`\n    RedistributeConnected bool           `json:\"redistribute_connected\"`\n}\n\n// OSPFNetwork represents a network/area mapping\ntype OSPFNetwork struct {\n    IP       string `json:\"ip\"`       // Network IP\n    Wildcard string `json:\"wildcard\"` // Wildcard mask\n    Area     string `json:\"area\"`     // Area ID\n}\n\n// OSPFArea represents an OSPF area configuration\ntype OSPFArea struct {\n    ID        string `json:\"id\"`         // Area ID (0.0.0.0 for backbone)\n    Type      string `json:\"type\"`       // normal, stub, nssa\n    NoSummary bool   `json:\"no_summary\"` // Totally stubby\n}\n\n// OSPFNeighbor represents a static neighbor configuration\ntype OSPFNeighbor struct {\n    IP       string `json:\"ip\"`       // Neighbor IP\n    Priority int    `json:\"priority\"` // DR/BDR priority\n    Cost     int    `json:\"cost\"`     // Link cost\n}\n```\n\n### Terraform Schema\n\n```hcl\nresource \"rtx_ospf\" \"backbone\" {\n  process_id = 1               # Optional, default 1\n  router_id  = \"1.1.1.1\"       # Required\n  distance   = 110             # Optional, default 110\n\n  default_information_originate = true\n\n  networks = [\n    {\n      ip       = \"192.168.1.0\"\n      wildcard = \"0.0.0.255\"\n      area     = \"0\"\n    },\n    {\n      ip       = \"10.0.0.0\"\n      wildcard = \"0.0.0.255\"\n      area     = \"1\"\n    }\n  ]\n\n  areas = [\n    {\n      id   = \"0\"\n      type = \"normal\"\n    },\n    {\n      id         = \"1\"\n      type       = \"stub\"\n      no_summary = false\n    }\n  ]\n\n  neighbors = [\n    {\n      ip       = \"192.168.1.2\"\n      priority = 10\n      cost     = 100\n    }\n  ]\n\n  redistribute_static = true\n}\n```\n\n## RTX Command Mapping\n\n### Enable OSPF\n\n```\nospf use on\n```\n\n### Configure Router ID\n\n```\nospf router id <router_id>\n```\n\nExample: `ospf router id 1.1.1.1`\n\n### Configure Area\n\n```\nospf area <area>\nip <interface> ospf area <area>\n```\n\nExample: `ip lan1 ospf area 0`\n\n### Configure Network\n\n```\nospf area <area> <interface>\n```\n\n### Configure Stub Area\n\n```\nospf area <area> stub [no-summary]\n```\n\n### Redistribute Routes\n\n```\nospf import from static\nospf import from ospf\n```\n\n### Configure Interface OSPF Settings\n\n```\nip <interface> ospf cost <cost>\nip <interface> ospf priority <priority>\n```\n\n### Delete OSPF\n\n```\nospf use off\n```\n\n### Show OSPF Configuration\n\n```\nshow config | grep ospf\nshow status ospf neighbor\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Router ID**\n   - **Handling:** Validate router ID is valid IPv4 format\n   - **User Impact:** Clear validation error with expected format\n\n2. **OSPF Already Configured**\n   - **Handling:** Parse RTX output for existing configuration\n   - **User Impact:** Error suggesting import\n\n3. **Invalid Area ID**\n   - **Handling:** Validate area ID format (decimal or dotted decimal)\n   - **User Impact:** Clear error with valid formats\n\n4. **Invalid Network**\n   - **Handling:** Validate IP and wildcard mask\n   - **User Impact:** Error indicating invalid network\n\n5. **Interface Not Found**\n   - **Handling:** Validate interface exists before assigning to area\n   - **User Impact:** Error indicating missing interface\n\n6. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`ospf_test.go`):\n  - Parse various RTX `show config` output for OSPF\n  - Test command builder functions with different parameters\n  - Test router ID and area validation\n\n- **Service Tests** (`ospf_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test network/area configuration\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_ospf_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Multi-area configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create OSPF with single area\n  - Create OSPF with multiple areas\n  - Configure stub area\n  - Enable redistribution\n  - Update OSPF settings\n  - Delete OSPF\n  - Import existing OSPF\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_ospf.go      # NEW: Terraform resource\n│   └── resource_rtx_ospf_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go              # MODIFY: Add OSPF types and methods\n│   ├── client.go                  # MODIFY: Add OSPF service initialization\n│   ├── ospf_service.go           # NEW: OSPF service implementation\n│   └── ospf_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── ospf.go               # NEW: Parser and command builders\n        └── ospf_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Singleton Resource**: OSPF is a singleton resource on RTX. Only one OSPF configuration can exist.\n\n2. **Terraform ID**: Use \"ospf\" as the fixed Terraform resource ID.\n\n3. **Area Format**: RTX supports both decimal (0) and dotted decimal (0.0.0.0) area IDs. Normalize to one format.\n\n4. **Wildcard Mask**: Cisco-style wildcard masks (0.0.0.255 = /24). Convert between formats as needed.\n\n5. **Process ID**: RTX may not support multiple OSPF processes. The process_id is for Cisco compatibility.\n\n6. **In-place Updates**: Most OSPF settings support in-place updates without recreating the resource.\n\n7. **Dependency Ordering**: Networks depend on interfaces having IP addresses configured.\n\n8. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n9. **Provider Registration**: Add `resourceRTXOSPF` to provider's resource map.\n",
  "fileStats": {
    "size": 11847,
    "lines": 397,
    "lastModified": "2026-01-19T05:08:41.229Z"
  },
  "comments": []
}