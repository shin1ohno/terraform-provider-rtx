{
  "id": "snapshot_1768890005510_f06v3a1br",
  "approvalId": "approval_1768889982068_eq8oqx33s",
  "approvalTitle": "Requirements: Security and Filter Resources",
  "version": 2,
  "timestamp": "2026-01-20T06:20:05.510Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Security and Filter Resources\n\n## Introduction\n\nThis specification addresses the implementation of security, filter, and VPN-related resource types that are currently missing from the Terraform provider. These resources are essential for complete router configuration management and include:\n\n- **IP/IPv6 Filters**: Layer 3/4 packet filtering and firewall rules\n- **Ethernet Filters**: Layer 2 MAC address filtering\n- **L2TP Service**: L2TP/L2TPv3 protocol service configuration\n- **IPsec Transport**: IPsec transport mode mappings for L2TP over IPsec\n\nEach resource type will support full CRUD (Create, Read, Update, Delete) operations and Terraform import functionality.\n\n## Alignment with Product Vision\n\nFrom `product.md`:\n- \"Ethernet Filters: Layer 2 packet filtering\"\n- \"IP Filters: Layer 3/4 packet filtering and firewall rules\"\n- \"Enable complete IaC management of Yamaha RTX router configurations\"\n\nWithout filter resources, users cannot manage a significant portion of their router's security configuration via Terraform.\n\n## Current State Analysis\n\nBased on actual router configuration (`config.txt`), the following filter types are in use:\n\n### IP Filters (Layer 3/4)\n```\nip filter 200000 reject 10.0.0.0/8 * * * *\nip filter 200020 reject * * udp,tcp 135 *\nip filter 200099 pass * * * * *\nip filter 200100 pass * * udp * 500\nip filter dynamic 200080 * * ftp syslog=off\n```\n\n### IPv6 Filters\n```\nipv6 filter 101000 pass * * icmp6 * *\nipv6 filter 101099 pass * * * * *\nipv6 filter dynamic 101080 * * ftp syslog=off\n```\n\n### Ethernet Filters (Layer 2)\n```\nethernet filter 1 reject-nolog bc:5c:17:05:59:3a *:*:*:*:*:*\nethernet filter 100 pass *:*:*:*:*:* *:*:*:*:*:*\nethernet lan1 filter in 1 100\nethernet lan1 filter out 2 100\n```\n\n### L2TP Service\n```\nl2tp service on l2tpv3 l2tp\n```\n\n### IPsec Transport\n```\nipsec transport 1 101 udp 1701\nipsec transport 3 3 udp 1701\n```\n\n## Requirements\n\n### REQ-1: IP Filter Resource\n\n**User Story:** As a network administrator, I want to define IP packet filters in Terraform, so that firewall rules can be version-controlled and consistently deployed.\n\n#### Acceptance Criteria\n\n1. WHEN `ip filter N action src dst proto sport dport` is defined THEN a `rtx_ip_filter` resource SHALL represent it\n2. WHEN filter action is `reject`, `pass`, or `restrict` THEN it SHALL be captured as an attribute\n3. WHEN source/destination are network ranges THEN they SHALL be parsed correctly\n4. WHEN protocol is `udp,tcp` (combined) THEN it SHALL be represented as a list\n5. WHEN port is a named service (e.g., `netbios_ns-netbios_ssn`) THEN it SHALL be preserved\n\n#### Resource Schema (Draft)\n```hcl\nresource \"rtx_ip_filter\" \"block_netbios\" {\n  filter_id   = 200020\n  action      = \"reject\"\n  source      = \"*\"\n  destination = \"*\"\n  protocol    = [\"udp\", \"tcp\"]\n  source_port = 135\n  dest_port   = \"*\"\n}\n```\n\n### REQ-2: IP Filter Dynamic Resource\n\n**User Story:** As a network administrator, I want to define dynamic (stateful) IP filters, so that connection tracking rules are managed via Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `ip filter dynamic N src dst service options` is defined THEN a `rtx_ip_filter_dynamic` resource SHALL represent it\n2. WHEN service is a named service (ftp, domain, www, etc.) THEN it SHALL be captured\n3. WHEN options like `syslog=off` are present THEN they SHALL be captured as attributes\n\n#### Resource Schema (Draft)\n```hcl\nresource \"rtx_ip_filter_dynamic\" \"ftp\" {\n  filter_id = 200080\n  source    = \"*\"\n  destination = \"*\"\n  service   = \"ftp\"\n  syslog    = false\n}\n```\n\n### REQ-3: IPv6 Filter Resource\n\n**User Story:** As a network administrator, I want to define IPv6 packet filters, so that IPv6 security policies can be managed via Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `ipv6 filter N action src dst proto sport dport` is defined THEN a `rtx_ipv6_filter` resource SHALL represent it\n2. WHEN protocol is `icmp6` THEN it SHALL be correctly identified\n3. WHEN filter is dynamic THEN `rtx_ipv6_filter_dynamic` resource SHALL be used\n\n#### Resource Schema (Draft)\n```hcl\nresource \"rtx_ipv6_filter\" \"allow_icmp6\" {\n  filter_id   = 101000\n  action      = \"pass\"\n  source      = \"*\"\n  destination = \"*\"\n  protocol    = \"icmp6\"\n  source_port = \"*\"\n  dest_port   = \"*\"\n}\n```\n\n### REQ-4: Ethernet Filter Resource\n\n**User Story:** As a network administrator, I want to define Layer 2 MAC address filters, so that Ethernet-level access control can be managed via Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `ethernet filter N action src-mac dst-mac` is defined THEN a `rtx_ethernet_filter` resource SHALL represent it\n2. WHEN action is `reject-nolog` THEN both action and logging flag SHALL be captured\n3. WHEN MAC uses wildcard format `*:*:*:*:*:*` THEN it SHALL be preserved\n\n#### Resource Schema (Draft)\n```hcl\nresource \"rtx_ethernet_filter\" \"block_tv\" {\n  filter_id       = 1\n  action          = \"reject\"\n  log             = false\n  source_mac      = \"bc:5c:17:05:59:3a\"\n  destination_mac = \"*\"\n}\n```\n\n### REQ-5: Interface Filter Binding\n\n**User Story:** As a network administrator, I want to associate filters with interfaces, so that filter application points are managed via Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `ethernet lanN filter in/out filter_ids...` is defined THEN interface SHALL reference filter resources\n2. WHEN `ip lanN secure filter in/out filter_ids...` is defined THEN interface SHALL reference filter resources\n3. WHEN multiple filters are applied THEN order SHALL be preserved\n\n**Note:** This may be handled as attributes on existing `rtx_interface` resource rather than separate resource.\n\n### REQ-6: L2TP Service Resource\n\n**User Story:** As a network administrator, I want to configure the global L2TP service settings, so that L2TP/L2TPv3 enablement is managed via Terraform.\n\n#### Acceptance Criteria\n\n1. WHEN `l2tp service on` is configured THEN service SHALL be enabled\n2. WHEN service supports multiple protocols (l2tpv3, l2tp) THEN they SHALL be listed as attributes\n3. IF service is `off` THEN resource SHALL reflect disabled state\n\n#### Resource Schema (Draft)\n```hcl\nresource \"rtx_l2tp_service\" \"main\" {\n  enabled   = true\n  protocols = [\"l2tpv3\", \"l2tp\"]\n}\n```\n\n### REQ-7: IPsec Transport Resource\n\n**User Story:** As a network administrator, I want to define IPsec transport mode mappings, so that L2TP over IPsec configurations are complete.\n\n#### Acceptance Criteria\n\n1. WHEN `ipsec transport N tunnel_id proto port` is defined THEN a `rtx_ipsec_transport` resource SHALL represent it\n2. WHEN protocol is `udp` and port is `1701` (L2TP) THEN they SHALL be captured\n3. WHEN transport maps to a tunnel THEN tunnel_id SHALL reference the IPsec tunnel\n\n#### Resource Schema (Draft)\n```hcl\nresource \"rtx_ipsec_transport\" \"l2tp_tunnel1\" {\n  transport_id = 1\n  tunnel_id    = 101\n  protocol     = \"udp\"\n  port         = 1701\n}\n```\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Consistent Naming**: Follow Cisco IOS XE naming conventions where applicable\n- **Parser Registry**: Register parsers in the existing parser registry pattern\n- **Resource Consistency**: Follow existing resource implementation patterns\n\n### Performance\n\n- Filter parsing should handle configurations with 100+ filter rules within 5 seconds\n\n### Reliability\n\n- Invalid filter syntax should produce clear error messages\n- Circular references between filters and interfaces should be detected\n\n### Usability\n\n- All resources SHALL support full CRUD operations (Create, Read, Update, Delete)\n- All resources SHALL support `terraform import` for existing configurations\n- Documentation should include common filter pattern examples\n\n## Implementation Priority\n\n1. **P0 - Core Filters**: `rtx_ip_filter`, `rtx_ipv6_filter` (most commonly used)\n2. **P1 - Dynamic Filters**: `rtx_ip_filter_dynamic`, `rtx_ipv6_filter_dynamic`\n3. **P1 - Layer 2**: `rtx_ethernet_filter`\n4. **P2 - Supporting**: `rtx_l2tp_service`, `rtx_ipsec_transport`\n\n## Dependencies\n\n- Parser infrastructure established in `import-fidelity-fix` spec provides patterns for command parsing\n- Interface filter binding may require updates to existing `rtx_interface` resource\n- L2TP and IPsec transport resources complement existing `rtx_ipsec_tunnel` and VPN resources\n\n## Estimated Scope\n\n- **New Resources**: 7 resource types\n- **New Parsers**: 7 parser implementations\n- **Files Changed**: ~15-20 new files\n- **Complexity**: Medium-High (new resource types with complex syntax)\n",
  "fileStats": {
    "size": 8485,
    "lines": 246,
    "lastModified": "2026-01-20T06:18:59.714Z"
  },
  "comments": []
}