{
  "id": "snapshot_1768891908078_7ip0b0l33",
  "approvalId": "approval_1768890158786_djj8rijef",
  "approvalTitle": "Design: Security and Filter Resources",
  "version": 2,
  "timestamp": "2026-01-20T06:51:48.078Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Security and Filter Resources\n\n## Overview\n\nThis design document covers the implementation of missing security, filter, and VPN-related resources for the Terraform RTX provider. Based on codebase analysis, some resources already exist while others need to be implemented.\n\n### Existing vs. New Resources\n\n| Resource Type | Status | Notes |\n|--------------|--------|-------|\n| `rtx_access_list_ip` | **NEW** | Static IP filter (ip filter N action...) |\n| `rtx_access_list_ip_dynamic` | EXISTS | Already implemented |\n| `rtx_access_list_ipv6` | **NEW** | Static IPv6 filter |\n| `rtx_access_list_ipv6_dynamic` | EXISTS | Already implemented |\n| `rtx_access_list_mac` | EXISTS | Layer 2 MAC filter (generates `ethernet filter` command) |\n| `rtx_l2tp_service` | **NEW** | Global L2TP service on/off |\n| `rtx_ipsec_transport` | **NEW** | IPsec transport mode mapping |\n\n**Analysis Notes**:\n- `rtx_access_list_extended` uses Cisco IOS-style `ip access-list extended` syntax\n- `rtx_access_list_mac` internally generates RTX `ethernet filter` commands (no separate resource needed)\n- New `rtx_access_list_ip` uses RTX native `ip filter` syntax (different command from access-list)\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Go 1.23**: All implementations use Go 1.23 idioms\n- **terraform-plugin-sdk/v2**: Follow existing resource patterns\n- **Parser Registry Pattern**: Register parsers in `internal/rtx/parsers/registry.go`\n- **Stateless SSH Sessions**: Each CRUD operation opens fresh connection\n\n### Project Structure (structure.md)\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_access_list_ip.go          # NEW\n│   ├── resource_rtx_access_list_ipv6.go        # NEW\n│   ├── resource_rtx_l2tp_service.go       # NEW\n│   └── resource_rtx_ipsec_transport.go    # NEW\n├── rtx/parsers/\n│   ├── ip_filter.go                       # EXTEND (add static filter resource support)\n│   ├── l2tp.go                            # EXTEND (add service on/off parsing)\n│   └── ipsec_transport.go                 # NEW\n└── client/\n    ├── ip_filter_service.go               # EXTEND\n    ├── l2tp_service.go                    # EXTEND\n    └── ipsec_transport_service.go         # NEW\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`parsers/ip_filter.go`**: Already contains `IPFilter` struct and parsing logic. Extend for static filters.\n- **`parsers/l2tp.go`**: Contains `L2TPConfig` and `BuildL2TPServiceCommand`. Extend for service on/off.\n- **`client/ip_filter_service.go`**: Extend with static filter CRUD operations.\n\n### Integration Points\n\n- **Provider Registration**: Add new resources to `internal/provider/provider.go` ResourcesMap\n- **Parser Registry**: Register new parsers via `parsers.RegisterParser()`\n- **SSH Client**: Use existing `client.Client` for router communication\n\n## Architecture\n\n### Resource Implementation Pattern\n\nAll resources follow the established pattern:\n\n```go\nfunc resourceRTXAccessListIP() *schema.Resource {\n    return &schema.Resource{\n        Create: resourceRTXAccessListIPCreate,\n        Read:   resourceRTXAccessListIPRead,\n        Update: resourceRTXAccessListIPUpdate,\n        Delete: resourceRTXAccessListIPDelete,\n        Importer: &schema.ResourceImporter{\n            State: resourceRTXAccessListIPImport,\n        },\n        Schema: map[string]*schema.Schema{...},\n    }\n}\n```\n\n### Component Interaction\n\n```mermaid\ngraph TD\n    TF[Terraform] --> Provider[Provider]\n    Provider --> Resource[Resource Handler]\n    Resource --> Client[RTX Client]\n    Client --> Parser[Parser]\n    Client --> SSH[SSH Session]\n    SSH --> RTX[RTX Router]\n    Parser --> Registry[Parser Registry]\n```\n\n## Components and Interfaces\n\n### Component 1: rtx_access_list_ip Resource\n\n- **Purpose**: Manage static IP packet filters\n- **File**: `internal/provider/resource_rtx_access_list_ip.go`\n- **Interfaces**:\n  - `resourceRTXAccessListIPCreate(d, meta)` - Create filter via SSH\n  - `resourceRTXAccessListIPRead(d, meta)` - Read filter state\n  - `resourceRTXAccessListIPUpdate(d, meta)` - Update filter\n  - `resourceRTXAccessListIPDelete(d, meta)` - Delete filter\n  - `resourceRTXAccessListIPImport(d, meta)` - Import existing filter\n- **Dependencies**: `client.IPFilterService`, `parsers.ParseIPFilterConfig`\n- **Reuses**: Existing `IPFilter` struct from `parsers/ip_filter.go`\n\n### Component 2: rtx_access_list_ipv6 Resource\n\n- **Purpose**: Manage static IPv6 packet filters\n- **File**: `internal/provider/resource_rtx_access_list_ipv6.go`\n- **Interfaces**: Same pattern as rtx_access_list_ip\n- **Dependencies**: `client.IPFilterService`, `parsers.ParseIPv6FilterConfig`\n- **Reuses**: IPv6 parsing functions already in `parsers/ip_filter.go`\n\n### Component 3: rtx_l2tp_service Resource\n\n- **Purpose**: Manage global L2TP service state (on/off with protocols)\n- **File**: `internal/provider/resource_rtx_l2tp_service.go`\n- **Interfaces**: Same CRUD pattern\n- **Dependencies**: `client.L2TPService`, `parsers.L2TPParser`\n- **Reuses**: Existing `BuildL2TPServiceCommand` function\n\n### Component 4: rtx_ipsec_transport Resource\n\n- **Purpose**: Manage IPsec transport mode mappings for L2TP over IPsec\n- **File**: `internal/provider/resource_rtx_ipsec_transport.go`\n- **Interfaces**: Same CRUD pattern\n- **Dependencies**: New `client.IPsecTransportService`, new parser\n- **Reuses**: Pattern from `parsers/ipsec_tunnel.go`\n\n## Data Models\n\n### IPFilter (Static)\n\n```go\ntype IPFilter struct {\n    Number      int      // Filter number (1-65534)\n    Action      string   // \"pass\", \"reject\", \"restrict\"\n    Source      string   // Source address/network or \"*\"\n    Destination string   // Destination address/network or \"*\"\n    Protocol    []string // [\"tcp\"], [\"udp\"], [\"tcp\", \"udp\"], [\"icmp\"], etc.\n    SourcePort  string   // Port number, range, or \"*\"\n    DestPort    string   // Port number, range, or \"*\"\n    Log         bool     // Whether to log matches\n}\n```\n\n### IPv6Filter (Static)\n\n```go\ntype IPv6Filter struct {\n    Number      int      // Filter number\n    Action      string   // \"pass\", \"reject\", \"restrict\"\n    Source      string   // IPv6 address/prefix or \"*\"\n    Destination string   // IPv6 address/prefix or \"*\"\n    Protocol    string   // \"tcp\", \"udp\", \"icmp6\", etc.\n    SourcePort  string   // Port or \"*\"\n    DestPort    string   // Port or \"*\"\n    Log         bool     // Whether to log matches\n}\n```\n\n### L2TPService\n\n```go\ntype L2TPService struct {\n    Enabled   bool     // Service on/off\n    Protocols []string // [\"l2tpv3\", \"l2tp\"]\n}\n```\n\n### IPsecTransport\n\n```go\ntype IPsecTransport struct {\n    TransportID int    // Transport number\n    TunnelID    int    // Associated tunnel number\n    Protocol    string // \"udp\" typically\n    Port        int    // Port number (1701 for L2TP)\n}\n```\n\n## Terraform Schema Definitions\n\n### rtx_access_list_ip Schema\n\n```hcl\nresource \"rtx_access_list_ip\" \"example\" {\n  filter_id   = 200000                    # Required: 1-65534\n  action      = \"reject\"                  # Required: pass|reject|restrict\n  source      = \"10.0.0.0/8\"             # Required: CIDR or \"*\"\n  destination = \"*\"                       # Required: CIDR or \"*\"\n  protocol    = [\"tcp\", \"udp\"]           # Optional: list of protocols\n  source_port = \"*\"                       # Optional: port or \"*\"\n  dest_port   = \"135\"                     # Optional: port or \"*\"\n  log         = false                     # Optional: default true\n}\n```\n\n### rtx_access_list_ipv6 Schema\n\n```hcl\nresource \"rtx_access_list_ipv6\" \"example\" {\n  filter_id   = 101000\n  action      = \"pass\"\n  source      = \"*\"\n  destination = \"*\"\n  protocol    = \"icmp6\"\n  source_port = \"*\"\n  dest_port   = \"*\"\n}\n```\n\n### rtx_l2tp_service Schema\n\n```hcl\nresource \"rtx_l2tp_service\" \"main\" {\n  enabled   = true\n  protocols = [\"l2tpv3\", \"l2tp\"]         # Optional\n}\n```\n\n### rtx_ipsec_transport Schema\n\n```hcl\nresource \"rtx_ipsec_transport\" \"l2tp\" {\n  transport_id = 1\n  tunnel_id    = 101\n  protocol     = \"udp\"\n  port         = 1701\n}\n```\n\n## RTX CLI Command Mapping\n\n### IP Filter Commands\n\n| Operation | RTX Command |\n|-----------|-------------|\n| Create | `ip filter 200000 reject 10.0.0.0/8 * * * *` |\n| Read | `show config \\| include \"ip filter 200000\"` |\n| Delete | `no ip filter 200000` |\n\n### IPv6 Filter Commands\n\n| Operation | RTX Command |\n|-----------|-------------|\n| Create | `ipv6 filter 101000 pass * * icmp6 * *` |\n| Read | `show config \\| include \"ipv6 filter 101000\"` |\n| Delete | `no ipv6 filter 101000` |\n\n### L2TP Service Commands\n\n| Operation | RTX Command |\n|-----------|-------------|\n| Enable | `l2tp service on l2tpv3 l2tp` |\n| Disable | `l2tp service off` |\n| Read | `show config \\| include \"l2tp service\"` |\n\n### IPsec Transport Commands\n\n| Operation | RTX Command |\n|-----------|-------------|\n| Create | `ipsec transport 1 101 udp 1701` |\n| Read | `show config \\| include \"ipsec transport 1\"` |\n| Delete | `no ipsec transport 1` |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Filter Number**\n   - **Handling**: Validate in schema (1-65534 for IP, check RTX limits)\n   - **User Impact**: Clear validation error before SSH connection\n\n2. **Filter Already Exists**\n   - **Handling**: Read existing state, compare, update if different\n   - **User Impact**: Terraform shows diff and applies changes\n\n3. **SSH Connection Failure**\n   - **Handling**: Use existing retry mechanism in `client/retry.go`\n   - **User Impact**: Error with connection details and retry info\n\n4. **Conflicting Filter Numbers**\n   - **Handling**: Check for existing filter before create\n   - **User Impact**: Error suggesting import or different ID\n\n## Testing Strategy\n\n### Unit Testing\n\n- Test all parser functions with various RTX output formats\n- Test command builders produce correct RTX CLI syntax\n- Test schema validation functions\n- Mock SSH client for resource CRUD tests\n\n### Integration Testing\n\n- Test with real RTX router in isolated environment\n- Verify filter creation, read, update, delete cycle\n- Test import functionality with pre-existing filters\n- Test error handling with invalid configurations\n\n### End-to-End Testing\n\n- Terraform acceptance tests (`TF_ACC=1`)\n- Full lifecycle: `terraform plan` → `terraform apply` → `terraform destroy`\n- Import scenarios: `terraform import rtx_access_list_ip.example 200000`\n\n### Test File Locations\n\n```\ninternal/provider/resource_rtx_access_list_ip_test.go\ninternal/provider/resource_rtx_access_list_ipv6_test.go\ninternal/provider/resource_rtx_l2tp_service_test.go\ninternal/provider/resource_rtx_ipsec_transport_test.go\ninternal/rtx/parsers/ipsec_transport_test.go\n```\n\n## Implementation Notes\n\n### Import ID Format\n\n- `rtx_access_list_ip`: Filter number (e.g., `200000`)\n- `rtx_access_list_ipv6`: Filter number (e.g., `101000`)\n- `rtx_l2tp_service`: Singleton, use `default` as ID\n- `rtx_ipsec_transport`: Transport number (e.g., `1`)\n\n### State Management\n\n- Store only configuration attributes, not operational status\n- Avoid perpetual diffs by not storing volatile data\n\n### Backward Compatibility\n\n- New resources, no backward compatibility concerns\n- Existing `rtx_access_list_*` resources remain unchanged\n",
  "fileStats": {
    "size": 11251,
    "lines": 346,
    "lastModified": "2026-01-20T06:49:18.794Z"
  },
  "comments": []
}