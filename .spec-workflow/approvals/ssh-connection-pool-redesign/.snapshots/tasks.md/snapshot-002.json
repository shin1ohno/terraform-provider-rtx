{
  "id": "snapshot_1769343888127_7diz7otsg",
  "approvalId": "approval_1769343472163_upf4wbozo",
  "approvalTitle": "SSH Connection Pool Redesign - Tasks",
  "version": 2,
  "timestamp": "2026-01-25T12:24:48.126Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: SSH Connection Pool Redesign\n\n- [ ] 1. Rename PooledSSHSession to PooledConnection with new fields\n  - File: internal/client/ssh_session_pool.go\n  - Rename `PooledSSHSession` struct to `PooledConnection`\n  - Add `client *ssh.Client` field to hold the SSH connection\n  - Change embedding of `*workingSession` to explicit `session *workingSession` field\n  - Keep existing fields: `poolID`, `lastUsed`, `useCount`, `adminMode`\n  - Update all references in the same file\n  - Purpose: Establish new data structure for connection-based pooling\n  - _Leverage: Current PooledSSHSession structure at line 31_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Rename PooledSSHSession to PooledConnection, add client *ssh.Client field, change workingSession from embedded to explicit session field. Update all references within ssh_session_pool.go | Restrictions: Do not modify other files yet, maintain method signatures | Success: Code compiles, all PooledSSHSession references renamed to PooledConnection_\n\n- [ ] 2. Rename SSHSessionPool to SSHConnectionPool with connection factory\n  - File: internal/client/ssh_session_pool.go\n  - Rename `SSHSessionPool` struct to `SSHConnectionPool`\n  - Remove `sshClient *ssh.Client` field (single connection)\n  - Add `sshConfig *ssh.ClientConfig` field for creating new connections\n  - Add `address string` field for dial target\n  - Rename `SessionFactory` to `ConnectionFactory`\n  - Update constructor to accept sshConfig and address instead of sshClient\n  - Update all method receivers and references\n  - Purpose: Transform pool from session-based to connection-based\n  - _Leverage: Current SSHSessionPool structure at line 44_\n  - _Requirements: 1.1, 1.2_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Rename SSHSessionPool to SSHConnectionPool, replace sshClient with sshConfig and address fields, rename SessionFactory to ConnectionFactory. Update constructors NewSSHSessionPool and NewSSHSessionPoolWithOptions | Restrictions: Keep SSHPoolConfig unchanged, maintain functional options pattern | Success: Pool struct holds connection config instead of single client_\n\n- [ ] 3. Update createConnection to dial new SSH connections\n  - File: internal/client/ssh_session_pool.go\n  - Rename `createSSHSession` to `createConnection`\n  - Implement `ssh.Dial(\"tcp\", p.address, p.sshConfig)` for new connections\n  - Create `workingSession` on the new client\n  - Return `*PooledConnection` with both client and session\n  - Handle errors: close client if session creation fails\n  - Purpose: Each pooled connection has its own SSH connection\n  - _Leverage: Current createSSHSession at line 323_\n  - _Requirements: 1.1, 2.1_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Rename createSSHSession to createConnection, implement ssh.Dial to create new TCP+SSH connection, then create workingSession on that connection. Wrap in PooledConnection with both client and session | Restrictions: Must close client if session creation fails, use Zerolog for logging | Success: Each call creates independent SSH connection with its own session_\n\n- [ ] 4. Update Acquire/Release/Discard/Close for connection model\n  - File: internal/client/ssh_session_pool.go\n  - Update `Acquire`: return `*PooledConnection` instead of `*PooledSSHSession`\n  - Update `Release`: close nothing (session stays open), return connection to pool\n  - Update `Discard`: close both session AND client, don't return to pool\n  - Update `Close`: close both session and client for all connections\n  - Update `idleCleanup`: close both session and client for idle connections\n  - Purpose: Proper lifecycle management for connection+session pairs\n  - _Leverage: Current Acquire at line 114, Release at line 211, Discard at line 251, Close at line 280_\n  - _Requirements: 1.3, 1.4, 2.2, 2.3, 2.4_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Update Acquire to return *PooledConnection, Release to keep session open, Discard to close both session and client, Close to clean up all connections | Restrictions: Maintain mutex locking patterns, signal cond on release | Success: Connection lifecycle properly manages both ssh.Client and workingSession_\n\n- [ ] 5. Update PooledExecutor to use PooledConnection\n  - File: internal/client/pooled_executor.go\n  - Update pool field type: `*SSHSessionPool` → `*SSHConnectionPool`\n  - Update all method parameters: `*PooledSSHSession` → `*PooledConnection`\n  - Update session access: `session.workingSession` → `conn.session`\n  - Update adminMode access: `session.adminMode` → `conn.adminMode`\n  - Update constructor: `NewPooledExecutor(pool *SSHConnectionPool, ...)`\n  - Purpose: Adapt executor to new connection-based pool\n  - _Leverage: Current PooledExecutor at line 19_\n  - _Requirements: 3.1, 3.2, 3.3, 4.1_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Update PooledExecutor to use SSHConnectionPool and PooledConnection types. Change all session access to conn.session, adminMode to conn.adminMode | Restrictions: Do not change Executor interface, maintain retry logic | Success: PooledExecutor works with new connection pool types_\n\n- [ ] 6. Update client.go to pass sshConfig and address to pool\n  - File: internal/client/client.go\n  - Update pool creation: pass `sshConfig` and `address` instead of `sshClient`\n  - Remove early SSH client creation for pool case\n  - Keep SSH client creation for simpleExecutor fallback\n  - Update NewPooledExecutor call with new pool type\n  - Purpose: Wire new connection pool into client initialization\n  - _Leverage: Current pool creation around line 200-230_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Update rtxClient.Connect to pass sshConfig and address to NewSSHConnectionPool instead of sshClient. Pool will create its own connections | Restrictions: Keep simpleExecutor path unchanged, maintain error handling | Success: Client initializes pool with config, pool creates connections on demand_\n\n- [ ] 7. Update unit tests for new connection model\n  - File: internal/client/ssh_session_pool_test.go, internal/client/pooled_executor_test.go\n  - Update mock factory to return `*PooledConnection` with nil client (for tests)\n  - Update type assertions and references\n  - Test connection creation includes client field\n  - Test Discard closes both session and client\n  - Purpose: Ensure tests pass with new structure\n  - _Leverage: Current test files_\n  - _Requirements: Testing requirements_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Update unit tests for SSHConnectionPool and PooledConnection types. Mock ConnectionFactory returns PooledConnection with nil client for test isolation | Restrictions: Maintain test coverage, use existing test patterns | Success: All unit tests pass with new types_\n\n- [ ] 8. Integration test with real RTX router\n  - File: internal/client/pooled_executor_integration_test.go\n  - Update integration tests for new pool constructor\n  - Test multiple concurrent commands use different connections\n  - Verify connection reuse via pool stats\n  - Verify no \"ssh: rejected\" errors\n  - Purpose: Confirm RTX router compatibility\n  - _Leverage: Current integration test file_\n  - _Requirements: Performance requirements_\n  - _Prompt: Implement the task for spec ssh-connection-pool-redesign: Role: Go Developer | Task: Update integration tests to use new SSHConnectionPool constructor. Test concurrent command execution uses multiple connections without rejection | Restrictions: Use build tags for integration tests | Success: Multiple commands execute in parallel without SSH rejection errors_\n",
  "fileStats": {
    "size": 7930,
    "lines": 97,
    "lastModified": "2026-01-25T12:17:47.971Z"
  },
  "comments": []
}