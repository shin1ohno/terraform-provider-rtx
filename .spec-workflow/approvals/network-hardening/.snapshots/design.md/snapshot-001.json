{
  "id": "snapshot_1768927133126_uz36mw5wk",
  "approvalId": "approval_1768926984822_j7k0r8ifm",
  "approvalTitle": "Network Hardening Design",
  "version": 1,
  "timestamp": "2026-01-20T16:38:53.126Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design: Network Hardening (MAC ACL expansion, PPP/L2TP session controls, IPsec/IKE depth)\n\n## Goals\n- Keep Cisco-aligned naming while covering RTX semantics for Ethernet filters, PPP/L2TP robustness, and IPsec/IKE interoperability.\n- Avoid breaking existing configs: new fields optional, legacy behavior unchanged by default.\n\n## Scope\n1) MAC ACL拡張でRTX `ethernet filter`機能を吸収  \n2) PPP/PPPoE/L2TPのキープアライブ・再接続・MTU/MRU/MSS制御追加  \n3) IPsec/IKE機能拡張（NAT-T、アルゴリズム拡充、IKEv1対応）\n\n## MAC ACL Expansion\n- **Schema (rtx_access_list_mac)**  \n  - Optional `filter_id` (int) at ACL level; when set, emit RTX `ethernet filter` commands.  \n  - Entry action: existing `permit/deny` plus `pass-log`, `pass-nolog`, `reject-log`, `reject-nolog` (mutually exclusive set).  \n  - Entry `dhcp_match` block: `type` (`dhcp-bind`/`dhcp-not-bind`), optional `scope` or `ip`. Disallow pairing with explicit MACs.  \n  - Entry offset matching: `offset` (int>=0) + `byte_list` (hex bytes or `*`, max 16).  \n  - Optional `apply` block: `interface`, `direction` (in/out), ordered `filter_ids`. Only used when `filter_id` is set.\n- **Command generation/parsing**  \n  - `filter_id` present: use RTX `ethernet filter <id> ...` with action/mac/DHCP/offset/ethertype/vlan.  \n  - `filter_id` absent: keep current ACL-style output; ignore RTX-only fields to preserve compatibility.  \n  - Apply commands: `ethernet <if> filter in|out <ids...>`; preserve order; delete with `no ethernet ...`.\n- **Validation**  \n  - MAC format `xx:xx:xx:xx:xx:xx` or `*`; byte_list length ≤16; action set exclusivity; DHCP and MAC mutually exclusive.  \n  - filter_id bounds per platform (1..512/100) with conservative validation.  \n  - apply requires filter_ids when present.\n- **Migration**  \n  - Default: no new fields -> legacy behavior.  \n  - Users enabling RTX semantics set `filter_id` and new fields; state schema tolerant to missing fields on import.\n\n## PPP/PPPoE/L2TP Session Controls\n- **Schema additions**  \n  - PPP/PPPoE: `lcp_echo_interval`, `lcp_echo_failure`, `reconnect_interval`, `reconnect_attempts`, `auto_connect`, `mtu`, `mru`, `mss_adjust`, `pppoe_service/ac`, `ipcp_dns` toggles.  \n  - L2TP: `always_on`, `keepalive_interval`, `keepalive_log`, `disconnect_timer`, `max_sessions`.  \n- **Command mapping**  \n  - LCP: map to `pp lcp echo on interval <n> failure <m>` (or RTX equivalent).  \n  - Reconnect: reconnect interval/attempts; auto_connect on boot.  \n  - MTU/MRU/MSS: apply to PPP interface (`pp <id>`).  \n  - L2TP: keepalive/log, always_on, disconnect timer, max-sessions.  \n- **Validation**  \n  - Interval/failure paired; ranges per RTX defaults; MSS/MTU bounds; attempts >=0.  \n  - Avoid overwriting router defaults on import when field absent.\n\n## IPsec/IKE Depth\n- **Schema additions**  \n  - NAT-T: `nat_traversal` (on/off) + `nat_keepalive_interval`.  \n  - Algorithms: AES-GCM (128/256), SHA-512, DH groups (14/16/19/20 where supported), PFS groups.  \n  - IKEv1: `ike_version` (v1/v2), `mode` (main/aggressive for v1), `identity` (address/fqdn/user-fqdn).  \n  - Cert placeholders: `local_cert`, `remote_id` (Sensitive).  \n- **Command mapping**  \n  - Map NAT-T to RTX ipsec ike commands; include keepalive when set.  \n  - Algorithm flags in proposal/transform; validate legal combos (e.g., GCM implies integrity off).  \n  - IKEv1 mode/identity to appropriate commands; keep v2 defaults unchanged.\n- **Validation**  \n  - Algorithm compatibility, group ranges, required identity for aggressive mode.  \n  - Sensitive fields flagged; no default overwrite on import.\n\n## Testing Strategy (TDD徹底)\n- RTXコマンドバリエーションを網羅するテーブル駆動テストを先に生成し、RED→GREENで実装。  \n- 生成元: 既存のパターンカタログに加え、新規フィールドの組合せを列挙（MAC: action/DHCP/offset/apply、PPP: keepalive/reconnect/MTU、IPsec: NAT-T/IKEv1/algorithms）。  \n- ラウンドトリップ必須: build→parse→buildが同一コマンド列/構造になることを全ケースで検証。  \n- リグレッション: 新フィールド未指定の従来コマンド群を固定フィクスチャとして保持し、diffが出ないことを確認。  \n- Importテスト: Router出力に欠落フィールドがある場合でもstateがデフォルト上書きされないことをケース化。\n\n## Rollout / Compatibility\n- All new fields optional; no behavior change without opt-in.  \n- Documentation to guide: how to enable RTX semantics for MAC filters, how to set PPP/L2TP keepalives, and how to configure NAT-T/IKEv1.\n",
  "fileStats": {
    "size": 4651,
    "lines": 68,
    "lastModified": "2026-01-20T16:38:26.791Z"
  },
  "comments": []
}