{
  "id": "snapshot_1769057973942_0yyyylfxh",
  "approvalId": "approval_1769057164085_wpzqi8iyk",
  "approvalTitle": "Import Fidelity Fix v2 - Requirements, Design, Tasks",
  "version": 2,
  "timestamp": "2026-01-22T04:59:33.942Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Import Fidelity Fix v2\n\n## Phase 1: DHCP Scope IP Range\n\n- [ ] 1.1. Update DHCPScope struct with range fields\n  - File: internal/rtx/parsers/dhcp_scope.go\n  - Add RangeStart, RangeEnd string fields to DHCPScope struct\n  - Purpose: Support IP range format in DHCP scope\n  - _Leverage: existing DHCPScope struct_\n  - _Requirements: REQ-1_\n\n- [ ] 1.2. Update scope regex for IP range format\n  - File: internal/rtx/parsers/dhcp_scope.go\n  - Add pattern for `<start_ip>-<end_ip>/<mask>` format\n  - Parse: `192.168.1.20-192.168.1.99/16 gateway 192.168.1.253`\n  - Purpose: Extract range_start, range_end, netmask, gateway\n  - _Leverage: existing scopePattern regex_\n  - _Requirements: REQ-1_\n\n- [ ] 1.3. Add DHCP scope IP range test cases\n  - File: internal/rtx/parsers/dhcp_scope_test.go\n  - Test: `dhcp scope 1 192.168.1.20-192.168.1.99/16 gateway 192.168.1.253 expire 12:00`\n  - Verify all fields extracted correctly\n  - Purpose: Ensure IP range format works\n  - _Leverage: existing DHCP test patterns_\n  - _Requirements: REQ-1_\n\n- [ ] 1.4. Update DHCP scope resource schema\n  - File: internal/provider/resource_rtx_dhcp_scope.go\n  - Add range_start, range_end fields to schema\n  - Update Read function to populate range fields\n  - Purpose: Expose range fields in Terraform\n  - _Leverage: existing resource schema_\n  - _Requirements: REQ-1_\n\n## Phase 2: User Attribute Parsing\n\n- [ ] 2.1. Fix login-timer parsing in ParseUserAttributeString\n  - File: internal/rtx/parsers/admin.go\n  - Ensure `login-timer=3600` extracts as integer 3600\n  - Handle variations: `login-timer=0`, `login-timer=300`\n  - Purpose: Correct login_timer import\n  - _Leverage: existing ParseUserAttributeString function_\n  - _Requirements: REQ-2_\n\n- [ ] 2.2. Fix gui-page parsing in ParseUserAttributeString\n  - File: internal/rtx/parsers/admin.go\n  - Parse `gui-page=dashboard,lan-map,config` as string array\n  - Handle empty gui-page and gui-page=none\n  - Purpose: Correct gui_pages import\n  - _Leverage: existing ParseUserAttributeString function_\n  - _Requirements: REQ-3_\n\n- [ ] 2.3. Add user attribute test cases from real config\n  - File: internal/rtx/parsers/admin_test.go\n  - Test: `user attribute shin1ohno connection=serial,telnet,remote,ssh,sftp,http gui-page=dashboard,lan-map,config login-timer=3600`\n  - Verify login_timer=3600, gui_pages=[\"dashboard\",\"lan-map\",\"config\"]\n  - Purpose: Verify parsing matches real RTX config\n  - _Leverage: existing admin parser tests_\n  - _Requirements: REQ-2, REQ-3_\n\n## Phase 3: NAT Masquerade Protocol-Only Entry\n\n- [ ] 3.1. Update MasqueradeStaticEntry for protocol-only\n  - File: internal/rtx/parsers/nat_masquerade.go\n  - Make port fields optional (use pointers or omitempty)\n  - Add IsProtocolOnly helper function\n  - Purpose: Support ESP/AH/GRE/ICMP entries\n  - _Leverage: existing MasqueradeStaticEntry struct_\n  - _Requirements: REQ-4_\n\n- [ ] 3.2. Add protocol-only entry parsing\n  - File: internal/rtx/parsers/nat_masquerade.go\n  - Parse: `nat descriptor masquerade static 1000 1 192.168.1.253 esp`\n  - Detect protocol-only format (no port specification)\n  - Purpose: Parse VPN passthrough entries\n  - _Leverage: existing static entry parsing_\n  - _Requirements: REQ-4_\n\n- [ ] 3.3. Add protocol-only entry command builder\n  - File: internal/rtx/parsers/nat_masquerade.go\n  - Build: `nat descriptor masquerade static <id> <entry> <ip> <protocol>`\n  - Skip port fields for protocol-only entries\n  - Purpose: Create VPN passthrough entries\n  - _Leverage: existing BuildStaticEntryCommand_\n  - _Requirements: REQ-4_\n\n- [ ] 3.4. Add NAT protocol-only test cases\n  - File: internal/rtx/parsers/nat_masquerade_test.go\n  - Test parsing: ESP, AH, GRE, ICMP protocol entries\n  - Test building: protocol-only command format\n  - Test round-trip: parse → build → parse\n  - Purpose: Verify protocol-only entry support\n  - _Leverage: existing NAT test patterns_\n  - _Requirements: REQ-4_\n\n- [ ] 3.5. Update NAT masquerade resource schema\n  - File: internal/provider/resource_rtx_nat_masquerade.go\n  - Make inside_local_port, outside_global_port Optional\n  - Add validation: ports required unless protocol is esp/ah/gre/icmp\n  - Purpose: Allow protocol-only entries in Terraform\n  - _Leverage: existing resource schema_\n  - _Requirements: REQ-4_\n\n## Phase 4: Verification\n\n- [ ] 4.1. Update main.tf with correct values\n  - File: examples/import/main.tf\n  - Update DHCP scope with range fields\n  - Update admin_user with login_timer=3600, gui_pages\n  - Add NAT ESP entry (entry_number=1)\n  - Purpose: Align main.tf with config.txt\n  - _Requirements: All_\n\n- [ ] 4.2. Run build and tests\n  - Execute: `go build ./... && go test ./internal/rtx/parsers/... -v`\n  - Verify all new tests pass\n  - Verify no regressions\n  - Purpose: Confirm fixes work\n  - _Requirements: All_\n",
  "fileStats": {
    "size": 4802,
    "lines": 121,
    "lastModified": "2026-01-22T04:45:58.369Z"
  },
  "comments": []
}