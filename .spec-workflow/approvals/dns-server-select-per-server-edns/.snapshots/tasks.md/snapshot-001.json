{
  "id": "snapshot_1769103365029_z18ny8q0t",
  "approvalId": "approval_1769103365015_e6ofaqjvu",
  "approvalTitle": "Tasks: DNS Server Select Per-Server EDNS",
  "version": 1,
  "timestamp": "2026-01-22T17:36:05.029Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: DNS Server Select Per-Server EDNS\n\n- [ ] 1. Add DNSServer struct and update DNSServerSelect in client interfaces\n  - File: internal/client/interfaces.go\n  - Add new `DNSServer` struct with `Address` and `EDNS` fields\n  - Update `DNSServerSelect.Servers` from `[]string` to `[]DNSServer`\n  - Remove `EDNS bool` field from `DNSServerSelect`\n  - Purpose: Align client types with parser types for per-server EDNS\n  - _Leverage: internal/rtx/parsers/dns.go (DNSServer struct as reference)_\n  - _Requirements: 1, 3, 4_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer specializing in Terraform provider development | Task: Add DNSServer struct and update DNSServerSelect in internal/client/interfaces.go to support per-server EDNS configuration. The DNSServer struct should have Address (string) and EDNS (bool) fields. Update DNSServerSelect.Servers to use []DNSServer instead of []string, and remove the standalone EDNS bool field. Reference the parser's DNSServer struct in internal/rtx/parsers/dns.go for consistency. | Restrictions: Do not modify parser layer, maintain JSON tags for serialization, keep other fields in DNSServerSelect unchanged | Success: DNSServer struct added, DNSServerSelect updated, code compiles without errors | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n\n- [ ] 2. Update DNS service conversion functions\n  - File: internal/client/dns_service.go\n  - Simplify `convertDNSServerSelectToParser` to directly map DNSServer fields\n  - Simplify `convertDNSServerSelectFromParser` to directly map DNSServer fields\n  - Remove the EDNS flattening/aggregation logic\n  - Purpose: Clean conversion between aligned client and parser types\n  - _Leverage: internal/rtx/parsers/dns.go (DNSServer, DNSServerSelect structs)_\n  - _Requirements: 3_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Developer with expertise in type conversion and service layers | Task: Update convertDNSServerSelectToParser and convertDNSServerSelectFromParser in internal/client/dns_service.go to directly map the new DNSServer struct fields. The old code applied a single EDNS to all servers or aggregated EDNS from multiple servers - this should now be a direct per-server copy. | Restrictions: Do not change other service methods, maintain error handling patterns, ensure bidirectional conversion preserves all data | Success: Conversion functions directly map Address and EDNS for each server, roundtrip conversion preserves per-server EDNS settings | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n\n- [ ] 3. Update Terraform schema for server_select\n  - File: internal/provider/resource_rtx_dns_server.go\n  - Replace `servers` (TypeList of strings) and `edns` (TypeBool) with `server` nested block\n  - Add `server` block with `address` (required string) and `edns` (optional bool, default false)\n  - Add MinItems: 1 and MaxItems: 2 validation for `server` block\n  - Purpose: Enable per-server EDNS in Terraform HCL configuration\n  - _Leverage: existing nested block patterns in other resources (e.g., rtx_nat_masquerade static_entry)_\n  - _Requirements: 1, 2_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer with expertise in schema design | Task: Update the server_select schema in internal/provider/resource_rtx_dns_server.go to replace the flat servers list and edns boolean with a nested server block. Each server block should have address (required, validated with validateIPAddressAny) and edns (optional, default false). Add MinItems:1 and MaxItems:2 constraints. | Restrictions: Do not change other schema fields (id, record_type, query_pattern, etc.), follow existing nested block patterns, maintain backward compatibility error messages | Success: New schema accepts server blocks with per-server EDNS, validation enforces 1-2 servers per entry | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n\n- [ ] 4. Update buildDNSConfigFromResourceData function\n  - File: internal/provider/resource_rtx_dns_server.go\n  - Update server_select parsing to extract `server` blocks\n  - Create `[]client.DNSServer` from nested block data\n  - Handle edns default (false when not specified)\n  - Purpose: Convert Terraform state to client types correctly\n  - _Leverage: existing nested block parsing patterns in the same file_\n  - _Requirements: 1, 3_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer | Task: Update buildDNSConfigFromResourceData in internal/provider/resource_rtx_dns_server.go to parse the new server nested blocks. Extract address and edns from each server block and create []client.DNSServer. Handle the case where edns is not specified (default to false). | Restrictions: Do not change parsing of other fields, maintain existing error handling patterns | Success: Function correctly extracts per-server EDNS from Terraform state, handles defaults properly | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n\n- [ ] 5. Update Read and Import flatten logic\n  - File: internal/provider/resource_rtx_dns_server.go\n  - Update `resourceRTXDNSServerRead` to flatten `[]client.DNSServer` to `server` blocks\n  - Update `resourceRTXDNSServerImport` with the same flatten logic\n  - Ensure each server's address and edns are preserved\n  - Purpose: Correctly populate Terraform state from router configuration\n  - _Leverage: existing flatten patterns for nested blocks_\n  - _Requirements: 3, 4_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Terraform Provider Developer | Task: Update resourceRTXDNSServerRead and resourceRTXDNSServerImport in internal/provider/resource_rtx_dns_server.go to flatten []client.DNSServer to the new server block structure. Each server in the list should become a map with address and edns keys. | Restrictions: Do not change flatten logic for other fields, ensure both Read and Import use consistent logic | Success: Read and Import correctly populate server blocks with per-server EDNS values, terraform plan shows no changes when config matches state | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n\n- [ ] 6. Update provider tests for new schema\n  - File: internal/provider/resource_rtx_dns_server_test.go\n  - Update test configurations to use new `server` block syntax\n  - Add test case for mixed EDNS settings (first=true, second=false)\n  - Verify roundtrip (create -> read -> plan with no changes)\n  - Purpose: Ensure provider works correctly with new schema\n  - _Leverage: existing test patterns in the same file_\n  - _Requirements: 1, 3, 4_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Go Test Developer with expertise in Terraform provider testing | Task: Update tests in internal/provider/resource_rtx_dns_server_test.go to use the new server block syntax. Add a test case with mixed EDNS settings (one server with edns=true, another with edns=false). Verify that the configuration round-trips correctly. | Restrictions: Do not remove existing test coverage, follow existing test patterns | Success: All tests pass, new schema is properly tested, mixed EDNS scenario is covered | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n\n- [ ] 7. Run tests and verify no regressions\n  - Run `go test ./internal/client/... ./internal/provider/...`\n  - Verify parser tests still pass (no parser changes)\n  - Run `go build` to ensure compilation succeeds\n  - Purpose: Ensure all changes work together without regressions\n  - _Leverage: existing test infrastructure_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec dns-server-select-per-server-edns, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with Go testing expertise | Task: Run the test suite to verify all changes work correctly. Execute go test ./internal/client/... ./internal/provider/... and go test ./internal/rtx/parsers/... to ensure parser tests still pass. Run go build to verify compilation. Fix any failing tests or compilation errors. | Restrictions: Do not skip failing tests, ensure all packages compile | Success: All tests pass, no compilation errors, parser tests confirm no parser-layer regressions | After completing, mark task as in-progress in tasks.md before starting, use log-implementation tool to record details, then mark as complete._\n",
  "fileStats": {
    "size": 9467,
    "lines": 71,
    "lastModified": "2026-01-22T17:35:58.117Z"
  },
  "comments": []
}