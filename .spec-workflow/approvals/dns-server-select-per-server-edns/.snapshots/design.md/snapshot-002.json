{
  "id": "snapshot_1769103266959_mponmub3i",
  "approvalId": "approval_1769103241977_323v4w6tx",
  "approvalTitle": "Design: DNS Server Select Per-Server EDNS",
  "version": 2,
  "timestamp": "2026-01-22T17:34:26.959Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: DNS Server Select Per-Server EDNS\n\n## Overview\n\nThis feature aligns the provider and client layers with the parser layer's per-server EDNS support. The parser layer already correctly implements `DNSServer{Address, EDNS}` structure, but the client layer flattens this to `[]string` + single `bool`, and the provider layer uses a similar flat schema. This design updates both layers to support per-server EDNS configuration.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Go 1.23**: All changes follow existing Go code style\n- **terraform-plugin-sdk/v2**: Schema changes follow SDK v2 nested block patterns\n- **Layer Separation**: Parser, Client, Provider layers maintain clear boundaries\n- **Type Alignment**: Client types will mirror parser types for consistency\n\n### Project Structure (structure.md)\n- Client interface changes in `internal/client/interfaces.go`\n- Service layer changes in `internal/client/dns_service.go`\n- Provider schema changes in `internal/provider/resource_rtx_dns_server.go`\n- Provider tests in `internal/provider/resource_rtx_dns_server_test.go`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **parsers.DNSServer**: Already correctly implemented with `Address` and `EDNS` fields\n- **parsers.DNSServerSelect**: Already uses `[]DNSServer` for per-server EDNS\n- **parsers.BuildDNSServerSelectCommand**: Already generates correct RTX commands with per-server EDNS\n- **parsers.ParseDNSConfig**: Already parses per-server EDNS from RTX output\n\n### Integration Points\n- **Parser Layer**: No changes needed - already correct\n- **Client Layer**: Update `DNSServerSelect` struct and conversion functions\n- **Provider Layer**: Update Terraform schema to use nested `server` blocks\n\n## Architecture\n\nThe data flow remains the same, but type alignment is improved:\n\n```mermaid\ngraph TD\n    subgraph \"Provider Layer\"\n        A[Terraform Config] --> B[server blocks with address + edns]\n        B --> C[buildDNSConfigFromResourceData]\n    end\n\n    subgraph \"Client Layer\"\n        C --> D[client.DNSServerSelect]\n        D --> E[\"Servers: []DNSServer\"]\n        E --> F[convertDNSServerSelectToParser]\n    end\n\n    subgraph \"Parser Layer\"\n        F --> G[parsers.DNSServerSelect]\n        G --> H[\"Servers: []DNSServer\"]\n        H --> I[BuildDNSServerSelectCommand]\n    end\n\n    subgraph \"RTX Router\"\n        I --> J[\"dns server select 1 1.1.1.1 edns=on 1.0.0.1 .\"]\n    end\n```\n\n### Modular Design Principles\n- **Type Alignment**: Client layer mirrors parser layer structures exactly\n- **Single Responsibility**: Each layer handles its specific concern\n- **Minimal Changes**: Only modify what's necessary for per-server EDNS\n\n## Components and Interfaces\n\n### Component 1: Client DNSServer Struct (NEW)\n- **Purpose:** Mirror parser's DNSServer struct for type consistency\n- **Location:** `internal/client/interfaces.go`\n- **Interface:**\n  ```go\n  type DNSServer struct {\n      Address string `json:\"address\"` // DNS server IP address\n      EDNS    bool   `json:\"edns\"`    // Enable EDNS for this server\n  }\n  ```\n- **Dependencies:** None\n- **Reuses:** Mirrors `parsers.DNSServer`\n\n### Component 2: Client DNSServerSelect Struct (MODIFIED)\n- **Purpose:** Store DNS server select entry with per-server EDNS\n- **Location:** `internal/client/interfaces.go`\n- **Interface:**\n  ```go\n  type DNSServerSelect struct {\n      ID             int         `json:\"id\"`\n      Servers        []DNSServer `json:\"servers\"`         // Changed from []string\n      RecordType     string      `json:\"record_type\"`\n      QueryPattern   string      `json:\"query_pattern\"`\n      OriginalSender string      `json:\"original_sender\"`\n      RestrictPP     int         `json:\"restrict_pp\"`\n  }\n  // Note: Removed EDNS field - now per-server in Servers\n  ```\n- **Dependencies:** `DNSServer`\n- **Changes:** Replace `Servers []string` + `EDNS bool` with `Servers []DNSServer`\n\n### Component 3: Conversion Functions (SIMPLIFIED)\n- **Purpose:** Convert between client and parser types\n- **Location:** `internal/client/dns_service.go`\n- **Interface:**\n  ```go\n  func convertDNSServerSelectToParser(sel DNSServerSelect) parsers.DNSServerSelect\n  func convertDNSServerSelectFromParser(sel parsers.DNSServerSelect) DNSServerSelect\n  ```\n- **Changes:** Direct mapping since types now align\n  ```go\n  // To parser - direct copy\n  func convertDNSServerSelectToParser(sel DNSServerSelect) parsers.DNSServerSelect {\n      servers := make([]parsers.DNSServer, len(sel.Servers))\n      for i, srv := range sel.Servers {\n          servers[i] = parsers.DNSServer{\n              Address: srv.Address,\n              EDNS:    srv.EDNS,\n          }\n      }\n      return parsers.DNSServerSelect{\n          ID:             sel.ID,\n          Servers:        servers,\n          RecordType:     sel.RecordType,\n          QueryPattern:   sel.QueryPattern,\n          OriginalSender: sel.OriginalSender,\n          RestrictPP:     sel.RestrictPP,\n      }\n  }\n\n  // From parser - direct copy\n  func convertDNSServerSelectFromParser(sel parsers.DNSServerSelect) DNSServerSelect {\n      servers := make([]DNSServer, len(sel.Servers))\n      for i, srv := range sel.Servers {\n          servers[i] = DNSServer{\n              Address: srv.Address,\n              EDNS:    srv.EDNS,\n          }\n      }\n      return DNSServerSelect{\n          ID:             sel.ID,\n          Servers:        servers,\n          RecordType:     sel.RecordType,\n          QueryPattern:   sel.QueryPattern,\n          OriginalSender: sel.OriginalSender,\n          RestrictPP:     sel.RestrictPP,\n      }\n  }\n  ```\n\n### Component 4: Terraform Schema (MODIFIED)\n- **Purpose:** Define HCL structure for server_select with per-server EDNS\n- **Location:** `internal/provider/resource_rtx_dns_server.go`\n- **Changes:** Replace `servers` list + `edns` bool with nested `server` block\n\n**Before:**\n```go\n\"servers\": {\n    Type:     schema.TypeList,\n    Required: true,\n    Elem:     &schema.Schema{Type: schema.TypeString},\n},\n\"edns\": {\n    Type:     schema.TypeBool,\n    Optional: true,\n},\n```\n\n**After:**\n```go\n\"server\": {\n    Type:        schema.TypeList,\n    Required:    true,\n    MinItems:    1,\n    MaxItems:    2,\n    Description: \"DNS servers with per-server EDNS configuration\",\n    Elem: &schema.Resource{\n        Schema: map[string]*schema.Schema{\n            \"address\": {\n                Type:         schema.TypeString,\n                Required:     true,\n                Description:  \"DNS server IP address (IPv4 or IPv6)\",\n                ValidateFunc: validateIPAddressAny,\n            },\n            \"edns\": {\n                Type:        schema.TypeBool,\n                Optional:    true,\n                Default:     false,\n                Description: \"Enable EDNS for this server\",\n            },\n        },\n    },\n},\n```\n\n### Component 5: Resource Data Conversion (MODIFIED)\n- **Purpose:** Convert between Terraform state and client types\n- **Location:** `internal/provider/resource_rtx_dns_server.go`\n- **Functions:**\n  - `buildDNSConfigFromResourceData`: Extract `server` blocks to `[]client.DNSServer`\n  - `resourceRTXDNSServerRead`: Flatten `[]client.DNSServer` to `server` blocks\n  - `resourceRTXDNSServerImport`: Same as Read\n\n## Data Models\n\n### Terraform HCL (New Format)\n```hcl\nresource \"rtx_dns_server\" \"main\" {\n  server_select {\n    id            = 500000\n    query_pattern = \".\"\n    record_type   = \"a\"\n\n    server {\n      address = \"1.1.1.1\"\n      edns    = true\n    }\n    server {\n      address = \"1.0.0.1\"\n      edns    = true\n    }\n  }\n}\n```\n\n### RTX Command (Unchanged)\n```\ndns server select 500000 1.1.1.1 edns=on 1.0.0.1 edns=on a .\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **No server blocks in server_select**\n   - **Handling:** Schema validation with `MinItems: 1`\n   - **User Impact:** Terraform plan fails: \"server_select: attribute 'server' is required\"\n\n2. **More than 2 server blocks**\n   - **Handling:** Schema validation with `MaxItems: 2`\n   - **User Impact:** Terraform plan fails: \"server_select: attribute 'server' cannot have more than 2 entries\"\n\n3. **Invalid IP address in server block**\n   - **Handling:** `validateIPAddressAny` function validates format\n   - **User Impact:** Terraform plan fails with validation error\n\n4. **Old schema with `servers` attribute**\n   - **Handling:** Terraform reports \"Unsupported argument\"\n   - **User Impact:** Clear error pointing to use `server` block instead\n\n## Testing Strategy\n\n### Unit Testing\n- **Client Layer** (`internal/client/dns_service_test.go`):\n  - Test `convertDNSServerSelectToParser` with various EDNS combinations\n  - Test `convertDNSServerSelectFromParser` preserves per-server EDNS\n  - Test roundtrip conversion maintains data integrity\n\n### Integration Testing\n- **Provider Layer** (`internal/provider/resource_rtx_dns_server_test.go`):\n  - Test CRUD with new `server` block schema\n  - Test mixed EDNS settings (first=true, second=false)\n  - Test import with per-server EDNS configuration\n  - Test schema validation (min/max items, required fields)\n\n### Acceptance Testing\n- Configure RTX with `dns server select 1 1.1.1.1 edns=on 1.0.0.1 .`\n- Verify Terraform read shows correct per-server EDNS\n- Verify Terraform plan shows no changes when config matches\n- Verify Terraform apply generates correct RTX commands\n\n## Implementation Sequence\n\n1. **Client Layer** (`internal/client/interfaces.go`)\n   - Add `DNSServer` struct\n   - Update `DNSServerSelect` to use `[]DNSServer`\n   - Remove `EDNS bool` field\n\n2. **Client Layer** (`internal/client/dns_service.go`)\n   - Simplify `convertDNSServerSelectToParser` (direct mapping)\n   - Simplify `convertDNSServerSelectFromParser` (direct mapping)\n\n3. **Provider Layer** (`internal/provider/resource_rtx_dns_server.go`)\n   - Update schema: replace `servers`+`edns` with `server` block\n   - Update `buildDNSConfigFromResourceData` for new schema\n   - Update `resourceRTXDNSServerRead` flatten logic\n   - Update `resourceRTXDNSServerImport` flatten logic\n\n4. **Tests**\n   - Update provider tests for new schema\n   - Verify existing parser tests still pass (no parser changes)\n",
  "fileStats": {
    "size": 10110,
    "lines": 290,
    "lastModified": "2026-01-22T17:33:54.824Z"
  },
  "comments": []
}