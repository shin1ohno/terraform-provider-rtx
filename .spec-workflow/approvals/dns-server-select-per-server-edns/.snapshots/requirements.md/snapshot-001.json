{
  "id": "snapshot_1769102775313_q4bp3z58s",
  "approvalId": "approval_1769102775298_d6rn0b75i",
  "approvalTitle": "Requirements: DNS Server Select Per-Server EDNS",
  "version": 1,
  "timestamp": "2026-01-22T17:26:15.313Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: DNS Server Select Per-Server EDNS\n\n## Introduction\n\nThis feature fixes a schema mismatch between the provider layer and parser layer in `rtx_dns_server` resource. The parser layer correctly supports per-server EDNS settings using `DNSServer` struct with `Address` and `EDNS` fields, but the provider layer's Terraform schema uses a flat `servers` string list with a single `edns` boolean, which cannot express per-server EDNS configuration.\n\nRTX router command syntax supports per-server EDNS:\n```\ndns server select 500000 . a 1.1.1.1 edns=on 1.0.0.1 edns=on\n```\n\nThe current schema cannot represent this configuration correctly.\n\n## Alignment with Product Vision\n\nPer product.md principles:\n- **Follow RTX CLI Semantics**: The RTX router CLI allows per-server EDNS, so the provider should too\n- **State Clarity**: The schema should accurately reflect the router's actual configuration to avoid diffs\n- **Fail Safely**: Clear validation and error messages for the new schema structure\n\n## Requirements\n\n### Requirement 1: Support Per-Server EDNS in Terraform Schema\n\n**User Story:** As a network administrator, I want to configure EDNS independently for each DNS server in a server_select entry, so that I can match the exact RTX router configuration.\n\n#### Acceptance Criteria\n\n1. WHEN a user defines `server_select` with nested `server` blocks THEN the provider SHALL accept a structure like:\n   ```hcl\n   server_select {\n     id            = 500000\n     query_pattern = \".\"\n     record_type   = \"a\"\n\n     server {\n       address = \"1.1.1.1\"\n       edns    = true\n     }\n     server {\n       address = \"1.0.0.1\"\n       edns    = true\n     }\n   }\n   ```\n\n2. IF a `server_select` entry contains more than 2 `server` blocks THEN the provider SHALL return a validation error with message \"maximum 2 servers allowed per server_select entry\"\n\n3. WHEN a `server_select` entry contains 0 `server` blocks THEN the provider SHALL return a validation error with message \"at least one server block is required\"\n\n4. IF `edns` is omitted from a `server` block THEN the provider SHALL default to `false`\n\n### Requirement 2: Backward Compatible Migration Path\n\n**User Story:** As a user with existing configurations, I want clear guidance on migrating from the old schema to the new schema, so that I can update my configurations without confusion.\n\n#### Acceptance Criteria\n\n1. WHEN a user attempts to use the old `servers` list attribute THEN Terraform SHALL report \"Unsupported argument\" error pointing to the new `server` block syntax\n\n2. IF documentation is generated THEN it SHALL include a migration example showing old vs new syntax\n\n### Requirement 3: Correct RTX Command Generation\n\n**User Story:** As a network administrator, I want the provider to generate correct RTX commands with per-server EDNS flags, so that the router configuration matches my Terraform definition.\n\n#### Acceptance Criteria\n\n1. WHEN a server_select has servers with different EDNS settings THEN the provider SHALL generate RTX command with per-server edns flags:\n   - Input: `[{address: \"1.1.1.1\", edns: true}, {address: \"1.0.0.1\", edns: false}]`\n   - Output: `dns server select 1 1.1.1.1 edns=on 1.0.0.1 .`\n\n2. WHEN all servers have EDNS disabled THEN the provider SHALL NOT include any edns flags in the command\n\n3. WHEN reading back router configuration THEN the provider SHALL correctly parse per-server EDNS settings into the `server` blocks\n\n### Requirement 4: Schema Consistency\n\n**User Story:** As a user, I want terraform plan to show no changes when my configuration matches the router's actual state, so that I have confidence in the provider's accuracy.\n\n#### Acceptance Criteria\n\n1. WHEN a router has `dns server select 1 1.1.1.1 edns=on . ` configured AND the Terraform config has matching `server { address = \"1.1.1.1\", edns = true }` THEN `terraform plan` SHALL show no changes\n\n2. WHEN a router has `dns server select 1 1.1.1.1 . ` (no edns) configured AND the Terraform config has `server { address = \"1.1.1.1\", edns = false }` THEN `terraform plan` SHALL show no changes\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Provider schema changes isolated to `resource_rtx_dns_server.go`\n- **Layer Alignment**: Provider schema matches parser layer `DNSServer` struct\n- **Clear Interfaces**: Schema-to-parser conversion in service layer (`dns_service.go`)\n\n### Performance\n- No performance impact expected; schema change only\n\n### Security\n- No security implications; schema change only\n\n### Reliability\n- Existing parser tests already cover per-server EDNS parsing\n- Provider tests must be updated for new schema structure\n\n### Usability\n- Clear error messages for validation failures\n- Migration guide in documentation\n",
  "fileStats": {
    "size": 4793,
    "lines": 107,
    "lastModified": "2026-01-22T17:26:08.026Z"
  },
  "comments": []
}