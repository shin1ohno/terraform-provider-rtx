{
  "id": "snapshot_1768799799834_du1syizgj",
  "approvalId": "approval_1768799799829_qqoeykn4j",
  "approvalTitle": "Design: rtx_pptp resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:39.834Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_pptp\n\n## Overview\n\nThe `rtx_pptp` resource enables Terraform-based management of PPTP (Point-to-Point Tunneling Protocol) configuration on Yamaha RTX series routers. Note that PPTP is considered a legacy/deprecated protocol for security-sensitive applications. This resource manages PPTP server configuration including authentication, encryption (MPPE), and IP address assignment.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/l2tp_service.go`**: Pattern for VPN service layer (if created first).\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with PPTP methods.\n- **`internal/rtx/parsers/l2tp.go`**: Reference for VPN parser implementation (if created first).\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add PPTP methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **PP Anonymous**: Coordinate with PP anonymous configuration\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_pptp.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        PPTPService[pptp_service.go]\n    end\n\n    subgraph Parser Layer\n        PPTPParser[pptp.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> PPTPService\n    PPTPService --> PPTPParser\n    PPTPParser --> Commands\n    PPTPParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `PPTPService` handles all PPTP CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all PPTP logic\n- **Utility Modularity**: Shared validation functions for authentication parameters\n\n## Components and Interfaces\n\n### Component 1: PPTPService (`internal/client/pptp_service.go`)\n\n- **Purpose:** Handles all PPTP CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type PPTPService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *PPTPService) Create(ctx context.Context, pptp PPTPConfig) error\n  func (s *PPTPService) Get(ctx context.Context) (*PPTPConfig, error)\n  func (s *PPTPService) Update(ctx context.Context, pptp PPTPConfig) error\n  func (s *PPTPService) Delete(ctx context.Context) error\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.PPTPParser`\n- **Reuses:** Pattern from service layer implementations\n\n### Component 2: PPTPParser (`internal/rtx/parsers/pptp.go`)\n\n- **Purpose:** Parses RTX router output for PPTP configuration and builds commands\n- **Interfaces:**\n  ```go\n  type PPTPConfig struct {\n      Shutdown       bool           `json:\"shutdown\"`\n      ListenAddress  string         `json:\"listen_address,omitempty\"`\n      MaxConnections int            `json:\"max_connections,omitempty\"`\n      Authentication PPTPAuth       `json:\"authentication\"`\n      Encryption     PPTPEncryption `json:\"encryption,omitempty\"`\n      IPPool         *PPTPIPPool    `json:\"ip_pool,omitempty\"`\n      DisconnectTime int            `json:\"disconnect_time,omitempty\"`\n      KeepaliveEnabled bool         `json:\"keepalive_enabled\"`\n  }\n\n  type PPTPAuth struct {\n      Method   string `json:\"method\"`   // pap, chap, mschap, mschap-v2\n      Username string `json:\"username,omitempty\"`\n      Password string `json:\"password,omitempty\"`\n  }\n\n  type PPTPEncryption struct {\n      MPPEBits int  `json:\"mppe_bits\"`  // 40, 56, 128\n      Required bool `json:\"required\"`\n  }\n\n  type PPTPIPPool struct {\n      Start string `json:\"start\"`\n      End   string `json:\"end\"`\n  }\n\n  func ParsePPTPConfig(raw string) (*PPTPConfig, error)\n  func BuildPPTPServiceCommand(enabled bool) string\n  func BuildPPTPTunnelDisconnectTimeCommand(seconds int) string\n  func BuildPPTPKeepaliveCommand(enabled bool) string\n  func BuildPPAuthAcceptCommand(method string) string\n  func BuildPPPCCPTypeCommand(mppeType string) string\n  func BuildDeletePPTPCommand() string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** IP validation patterns, authentication patterns from L2TP\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_pptp.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXPPTP() *schema.Resource\n  func resourceRTXPPTPCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXPPTPRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXPPTPUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXPPTPDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXPPTPImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `PPTPConfig`, Terraform SDK\n- **Reuses:** Resource patterns from other implementations\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with PPTP methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetPPTP(ctx context.Context) (*PPTPConfig, error)\n  CreatePPTP(ctx context.Context, pptp PPTPConfig) error\n  UpdatePPTP(ctx context.Context, pptp PPTPConfig) error\n  DeletePPTP(ctx context.Context) error\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### PPTPConfig\n\n```go\n// PPTPConfig represents PPTP configuration on an RTX router\ntype PPTPConfig struct {\n    Shutdown         bool           `json:\"shutdown\"`          // Admin state\n    ListenAddress    string         `json:\"listen_address\"`    // 0.0.0.0 = all\n    MaxConnections   int            `json:\"max_connections\"`   // Max simultaneous\n    Authentication   PPTPAuth       `json:\"authentication\"`    // Auth settings\n    Encryption       PPTPEncryption `json:\"encryption\"`        // MPPE settings\n    IPPool           *PPTPIPPool    `json:\"ip_pool,omitempty\"` // IP pool\n    DisconnectTime   int            `json:\"disconnect_time\"`   // Idle timeout\n    KeepaliveEnabled bool           `json:\"keepalive_enabled\"`\n}\n\n// PPTPAuth represents authentication settings\ntype PPTPAuth struct {\n    Method   string `json:\"method\"`   // pap, chap, mschap, mschap-v2\n    Username string `json:\"username\"` // For server users\n    Password string `json:\"password\"` // Sensitive\n}\n\n// PPTPEncryption represents MPPE encryption settings\ntype PPTPEncryption struct {\n    MPPEBits int  `json:\"mppe_bits\"` // 40, 56, 128\n    Required bool `json:\"required\"`  // Require encryption\n}\n\n// PPTPIPPool represents IP address pool for clients\ntype PPTPIPPool struct {\n    Start string `json:\"start\"` // Start IP\n    End   string `json:\"end\"`   // End IP\n}\n```\n\n### Terraform Schema\n\n```hcl\n# PPTP VPN Server (Legacy - consider using L2TP/IPsec or IKEv2)\nresource \"rtx_pptp\" \"vpn_server\" {\n  shutdown = false\n\n  listen_address  = \"0.0.0.0\"\n  max_connections = 10\n\n  authentication {\n    method   = \"mschap-v2\"\n    username = \"vpnuser\"\n    password = var.pptp_password\n  }\n\n  encryption {\n    mppe_bits = 128\n    required  = true\n  }\n\n  ip_pool {\n    start = \"192.168.200.100\"\n    end   = \"192.168.200.200\"\n  }\n\n  disconnect_time   = 3600\n  keepalive_enabled = true\n}\n```\n\n## RTX Command Mapping\n\n### Enable PPTP Service\n\n```\npptp service on\n```\n\n### Configure PP Anonymous\n\n```\npp select anonymous\npp bind tunnel<n>\n```\n\n### Configure Authentication\n\n```\npp auth accept <pap/chap/mschap/mschap-v2>\npp auth myname <name> <password>\n```\n\n### Configure MPPE Encryption\n\n```\nppp ccp type mppe-any\nppp ccp type mppe-128\n```\n\n### Configure IPCP\n\n```\nppp ipcp ipaddress on\nip pp remote address pool <start>-<end>\n```\n\n### Configure Disconnect Time\n\n```\npptp tunnel disconnect time <n>\n```\n\n### Configure Keepalive\n\n```\npptp keepalive use on\n```\n\n### Delete PPTP\n\n```\npptp service off\nno pp select anonymous\n```\n\n### Show Configuration\n\n```\nshow config | grep pptp\nshow status pptp\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Authentication Method**\n   - **Handling:** Validate method is supported (pap/chap/mschap/mschap-v2)\n   - **User Impact:** Error with valid methods\n\n2. **Invalid MPPE Bits**\n   - **Handling:** Validate bits is 40, 56, or 128\n   - **User Impact:** Clear error with valid values\n\n3. **Invalid IP Pool**\n   - **Handling:** Validate IP range is valid\n   - **User Impact:** Clear error with expected format\n\n4. **Max Connections Out of Range**\n   - **Handling:** Validate within router limits\n   - **User Impact:** Clear error with valid range\n\n5. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`pptp_test.go`):\n  - Parse various RTX `show config` output for PPTP\n  - Test command builder functions with different parameters\n  - Test MPPE configuration parsing\n\n- **Service Tests** (`pptp_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test encryption configuration\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_pptp_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - Sensitive attribute handling\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create PPTP server\n  - Configure MPPE encryption\n  - Update settings\n  - Delete configuration\n  - Import existing PPTP\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_pptp.go      # NEW: Terraform resource\n│   └── resource_rtx_pptp_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go              # MODIFY: Add PPTP types and methods\n│   ├── client.go                  # MODIFY: Add PPTP service initialization\n│   ├── pptp_service.go           # NEW: PPTP service implementation\n│   └── pptp_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── pptp.go               # NEW: Parser and command builders\n        └── pptp_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **Singleton Resource**: PPTP is a singleton resource. Only one PPTP configuration can exist.\n\n2. **Terraform ID**: Use \"pptp\" as the fixed Terraform resource ID.\n\n3. **Sensitive Data**: Password must be marked as sensitive in Terraform state.\n\n4. **Security Warning**: Consider adding a deprecation warning in documentation since PPTP has known security vulnerabilities.\n\n5. **MPPE**: MPPE encryption is optional but recommended. 128-bit is the most secure option.\n\n6. **PP Anonymous**: PPTP uses PP anonymous configuration. Consider relationship.\n\n7. **Shared Code**: Consider sharing common VPN parsing code with `rtx_l2tp` resource.\n\n8. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n9. **Provider Registration**: Add `resourceRTXPPTP` to provider's resource map.\n\n10. **MS-CHAP v2**: Recommend MS-CHAP v2 over older authentication methods.\n",
  "fileStats": {
    "size": 11121,
    "lines": 370,
    "lastModified": "2026-01-19T05:12:08.906Z"
  },
  "comments": []
}