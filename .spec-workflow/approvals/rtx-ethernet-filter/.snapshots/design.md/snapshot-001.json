{
  "id": "snapshot_1768799800290_v29gtcobr",
  "approvalId": "approval_1768799800285_nt0jm4qjo",
  "approvalTitle": "Design: rtx_ethernet_filter resource",
  "version": 1,
  "timestamp": "2026-01-19T05:16:40.290Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: rtx_ethernet_filter\n\n## Overview\n\nThe `rtx_ethernet_filter` resource enables Terraform-based management of Ethernet (Layer 2) packet filters on Yamaha RTX series routers. Following Cisco MAC ACL naming patterns, this resource manages MAC address-based filtering, EtherType filtering, and Layer 2 access control.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`internal/client/ip_filter_service.go`**: Pattern for filter service implementation (if created first).\n- **`internal/client/interfaces.go`**: Extend the `Client` interface with Ethernet filter methods.\n- **`internal/rtx/parsers/ip_filter.go`**: Reference for filter parser implementation (if created first).\n- **`internal/provider/resource_rtx_dhcp_scope.go`**: Template for Terraform resource structure.\n\n### Integration Points\n\n- **`rtxClient`**: Add Ethernet filter methods for CRUD operations\n- **`Executor`**: Use existing SSH command execution infrastructure\n- **LAN interface**: Coordinate with interface configuration\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Provider Layer\n        TFResource[resource_rtx_ethernet_filter.go]\n    end\n\n    subgraph Client Layer\n        Client[client.go - Interface Extension]\n        EthFilterService[ethernet_filter_service.go]\n    end\n\n    subgraph Parser Layer\n        EthFilterParser[ethernet_filter.go]\n        Commands[Command Builders]\n        OutputParser[Output Parsers]\n    end\n\n    TFResource --> Client\n    Client --> EthFilterService\n    EthFilterService --> EthFilterParser\n    EthFilterParser --> Commands\n    EthFilterParser --> OutputParser\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `EthernetFilterService` handles all Ethernet filter CRUD operations\n- **Component Isolation**: Parser, service, and resource layers clearly separated\n- **Service Layer Separation**: Service encapsulates all filter logic\n- **Utility Modularity**: Shared validation functions for MAC address operations\n\n## Components and Interfaces\n\n### Component 1: EthernetFilterService (`internal/client/ethernet_filter_service.go`)\n\n- **Purpose:** Handles all Ethernet filter CRUD operations against the RTX router\n- **Interfaces:**\n  ```go\n  type EthernetFilterService struct {\n      executor Executor\n      client   *rtxClient\n  }\n\n  func (s *EthernetFilterService) Create(ctx context.Context, filter EthernetFilter) error\n  func (s *EthernetFilterService) Get(ctx context.Context, filterNum int) (*EthernetFilter, error)\n  func (s *EthernetFilterService) Update(ctx context.Context, filter EthernetFilter) error\n  func (s *EthernetFilterService) Delete(ctx context.Context, filterNum int) error\n  func (s *EthernetFilterService) List(ctx context.Context) ([]EthernetFilter, error)\n  ```\n- **Dependencies:** `Executor`, `rtxClient`, `parsers.EthernetFilterParser`\n- **Reuses:** Pattern from service layer implementations\n\n### Component 2: EthernetFilterParser (`internal/rtx/parsers/ethernet_filter.go`)\n\n- **Purpose:** Parses RTX router output for Ethernet filter configuration and builds commands\n- **Interfaces:**\n  ```go\n  type EthernetFilter struct {\n      Number  int                    `json:\"number\"`\n      Name    string                 `json:\"name,omitempty\"`\n      Entries []EthernetFilterEntry  `json:\"entries\"`\n  }\n\n  type EthernetFilterEntry struct {\n      Sequence       int    `json:\"sequence\"`\n      Action         string `json:\"ace_action\"`           // permit/deny\n      SourceMAC      string `json:\"source_address,omitempty\"`\n      SourceMACMask  string `json:\"source_address_mask,omitempty\"`\n      SourceAny      bool   `json:\"source_any,omitempty\"`\n      DestMAC        string `json:\"destination_address,omitempty\"`\n      DestMACMask    string `json:\"destination_address_mask,omitempty\"`\n      DestAny        bool   `json:\"destination_any,omitempty\"`\n      EtherType      string `json:\"ethertype,omitempty\"`\n      VlanID         int    `json:\"vlan_id,omitempty\"`\n  }\n\n  func ParseEthernetFilterConfig(raw string) ([]EthernetFilter, error)\n  func BuildEthernetFilterCommand(num int, entry EthernetFilterEntry) string\n  func BuildInterfaceEthernetFilterCommand(iface, dir string, filters []int) string\n  func BuildDeleteEthernetFilterCommand(num int) string\n  func NormalizeMAC(mac string) string\n  ```\n- **Dependencies:** `regexp`, `strings`, `strconv`\n- **Reuses:** MAC address validation patterns\n\n### Component 3: Terraform Resource (`internal/provider/resource_rtx_ethernet_filter.go`)\n\n- **Purpose:** Terraform resource definition implementing CRUD lifecycle\n- **Interfaces:**\n  ```go\n  func resourceRTXEthernetFilter() *schema.Resource\n  func resourceRTXEthernetFilterCreate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXEthernetFilterRead(ctx, d, meta) diag.Diagnostics\n  func resourceRTXEthernetFilterUpdate(ctx, d, meta) diag.Diagnostics\n  func resourceRTXEthernetFilterDelete(ctx, d, meta) diag.Diagnostics\n  func resourceRTXEthernetFilterImport(ctx, d, meta) ([]*schema.ResourceData, error)\n  ```\n- **Dependencies:** `Client`, `EthernetFilter`, Terraform SDK\n- **Reuses:** Resource patterns from other implementations\n\n### Component 4: Client Interface Extension (`internal/client/interfaces.go`)\n\n- **Purpose:** Extend Client interface with Ethernet filter methods\n- **Interfaces:**\n  ```go\n  // Add to existing Client interface:\n  GetEthernetFilter(ctx context.Context, filterNum int) (*EthernetFilter, error)\n  CreateEthernetFilter(ctx context.Context, filter EthernetFilter) error\n  UpdateEthernetFilter(ctx context.Context, filter EthernetFilter) error\n  DeleteEthernetFilter(ctx context.Context, filterNum int) error\n  ListEthernetFilters(ctx context.Context) ([]EthernetFilter, error)\n  ```\n- **Dependencies:** Existing Client interface\n- **Reuses:** Pattern from existing methods\n\n## Data Models\n\n### EthernetFilter\n\n```go\n// EthernetFilter represents an Ethernet (MAC) filter on an RTX router\ntype EthernetFilter struct {\n    Number  int                   `json:\"number\"`  // Filter number (1-65535)\n    Name    string                `json:\"name\"`    // Access list name\n    Entries []EthernetFilterEntry `json:\"entries\"` // Filter entries\n}\n\n// EthernetFilterEntry represents a single Ethernet filter rule\ntype EthernetFilterEntry struct {\n    Sequence      int    `json:\"sequence\"`                       // Entry sequence\n    Action        string `json:\"ace_action\"`                     // permit/deny\n    SourceMAC     string `json:\"source_address,omitempty\"`       // Source MAC\n    SourceMACMask string `json:\"source_address_mask,omitempty\"`  // Source MAC mask\n    SourceAny     bool   `json:\"source_any,omitempty\"`           // Any source\n    DestMAC       string `json:\"destination_address,omitempty\"`\n    DestMACMask   string `json:\"destination_address_mask,omitempty\"`\n    DestAny       bool   `json:\"destination_any,omitempty\"`\n    EtherType     string `json:\"ethertype,omitempty\"`            // 0x0800, 0x0806, etc.\n    VlanID        int    `json:\"vlan_id,omitempty\"`              // VLAN filter\n}\n```\n\n### Terraform Schema\n\n```hcl\n# MAC access list\nresource \"rtx_access_list_mac\" \"trusted_macs\" {\n  name = \"TRUSTED_MACS\"\n\n  entries = [\n    {\n      sequence            = 10\n      ace_action          = \"permit\"\n      source_address      = \"0011.2200.0000\"\n      source_address_mask = \"0000.00ff.ffff\"\n      destination_any     = true\n    },\n    {\n      sequence              = 20\n      ace_action            = \"deny\"\n      source_any            = true\n      destination_address   = \"ffff.ffff.ffff\"  # Broadcast\n      ethertype             = \"0x0806\"          # ARP\n    },\n    {\n      sequence        = 999\n      ace_action      = \"deny\"\n      source_any      = true\n      destination_any = true\n    }\n  ]\n}\n\n# Apply MAC ACL to interface\nresource \"rtx_interface_mac_acl\" \"lan1\" {\n  interface           = \"lan1\"\n  mac_access_group_in = \"TRUSTED_MACS\"\n}\n```\n\n## RTX Command Mapping\n\n### Create Ethernet Filter\n\n```\nethernet filter <n> <action> <src_mac> <dst_mac> [<eth_type>]\n```\n\nExample: `ethernet filter 1 pass 00:11:22:* * 0x0800`\n\n### Apply to Interface\n\n```\nethernet <interface> filter <direction> <filter_list>\n```\n\nExample: `ethernet lan1 filter in 1 2 3`\n\n### Delete Ethernet Filter\n\n```\nno ethernet filter <n>\n```\n\n### Show Configuration\n\n```\nshow config | grep \"ethernet filter\"\nshow ethernet filter\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Filter Number**\n   - **Handling:** Validate number is in range 1-65535\n   - **User Impact:** Clear validation error with valid range\n\n2. **Invalid MAC Address**\n   - **Handling:** Validate MAC address format\n   - **User Impact:** Clear error with expected format\n\n3. **Invalid EtherType**\n   - **Handling:** Validate EtherType is valid hex value\n   - **User Impact:** Clear error with valid format\n\n4. **Invalid VLAN ID**\n   - **Handling:** Validate VLAN ID is in range 1-4094\n   - **User Impact:** Clear error with valid range\n\n5. **Connection/Command Timeout**\n   - **Handling:** Use existing retry logic from `rtxClient`\n   - **User Impact:** Standard Terraform timeout error\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Parser Tests** (`ethernet_filter_test.go`):\n  - Parse various RTX `show config` output for Ethernet filters\n  - Test command builder functions with different parameters\n  - Test MAC address normalization\n\n- **Service Tests** (`ethernet_filter_service_test.go`):\n  - Mock executor for service method testing\n  - Test error handling for various failure scenarios\n  - Test EtherType filtering\n\n### Integration Testing\n\n- **Resource Tests** (`resource_rtx_ethernet_filter_test.go`):\n  - Full CRUD lifecycle with mock client\n  - Import functionality testing\n  - MAC matching configuration testing\n\n### End-to-End Testing\n\n- **Acceptance Tests** (with real RTX router):\n  - Create Ethernet filter with MAC matching\n  - Create filter with EtherType\n  - Update filter entries\n  - Delete filter\n  - Import existing filter\n\n## File Structure\n\n```\ninternal/\n├── provider/\n│   ├── resource_rtx_ethernet_filter.go      # NEW: Terraform resource\n│   └── resource_rtx_ethernet_filter_test.go # NEW: Resource tests\n├── client/\n│   ├── interfaces.go                         # MODIFY: Add EthernetFilter types and methods\n│   ├── client.go                             # MODIFY: Add filter service initialization\n│   ├── ethernet_filter_service.go           # NEW: Filter service implementation\n│   └── ethernet_filter_service_test.go      # NEW: Service tests\n└── rtx/\n    └── parsers/\n        ├── ethernet_filter.go               # NEW: Parser and command builders\n        └── ethernet_filter_test.go          # NEW: Parser tests\n```\n\n## Implementation Notes\n\n1. **MAC Address Format**: RTX may use different MAC formats (00:11:22:33:44:55 vs 0011.2233.4455). Normalize to one format.\n\n2. **Terraform ID**: Use filter number as Terraform resource ID.\n\n3. **Sequence Numbers**: Auto-generate or require explicit sequence numbers.\n\n4. **Action Mapping**: Map Cisco `permit/deny` to RTX `pass/reject`.\n\n5. **Wildcard Matching**: RTX uses `*` for wildcard MAC positions.\n\n6. **EtherType Values**: Common values: 0x0800 (IPv4), 0x0806 (ARP), 0x86DD (IPv6).\n\n7. **Interface ACL**: Consider separate resource `rtx_interface_mac_acl` for binding.\n\n8. **Order Sensitivity**: Filters evaluated in order. First match wins.\n\n9. **Configuration Save**: Use existing `SaveConfig()` pattern after modifications.\n\n10. **Provider Registration**: Add `resourceRTXEthernetFilter` to provider's resource map.\n",
  "fileStats": {
    "size": 11568,
    "lines": 328,
    "lastModified": "2026-01-19T05:14:42.498Z"
  },
  "comments": []
}