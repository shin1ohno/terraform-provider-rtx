# Master Requirements: Management Services

## Overview

This specification covers the management service resources for Yamaha RTX routers. These resources enable Terraform-based configuration of essential router management services including SSH daemon (SSHD), HTTP daemon (HTTPD), SFTP daemon (SFTPD), SNMP server, and Syslog forwarding. All resources are singleton resources - only one instance of each can exist per router.

## Alignment with Product Vision

Management services are foundational for router administration and monitoring. These resources support:
- Infrastructure as Code (IaC) practices for network device configuration
- Secure remote management through SSH and SFTP
- Web-based GUI access through HTTPD
- Network monitoring through SNMP
- Centralized logging through Syslog

## Resources Summary

| Resource Name | Type | Import Support | Purpose |
|--------------|------|----------------|---------|
| `rtx_sshd` | singleton | Yes | SSH daemon configuration |
| `rtx_httpd` | singleton | Yes | HTTP daemon configuration |
| `rtx_sftpd` | singleton | Yes | SFTP daemon configuration |
| `rtx_snmp_server` | singleton | Yes | SNMP server configuration |
| `rtx_syslog` | singleton | Yes | Syslog forwarding configuration |

---

## Resource: rtx_sshd

### Resource Summary

| Attribute | Value |
|-----------|-------|
| Resource Name | `rtx_sshd` |
| Type | singleton |
| Import Support | Yes |
| Import ID | `sshd` |
| Last Updated | 2026-01-23 |

### Description

Manages SSH daemon (sshd) configuration on RTX routers. The SSH service enables secure remote command-line access to the router. WARNING: Disabling SSH while connected via SSH may lock you out of remote management.

### Functional Requirements

#### Create

- Configure SSH service state (enabled/disabled)
- Optionally restrict SSH access to specific interfaces
- Router generates host key automatically
- Read back configuration to ensure consistency

#### Read

- Retrieve current SSH service state
- Retrieve interface restrictions (if configured)
- Retrieve host key (computed, sensitive)
- Remove from state if service is not configured

#### Update

- Update SSH service state
- Update interface restrictions
- Warn user when disabling SSH service

#### Delete

- Disable SSH service
- Remove interface restrictions
- Reset to factory defaults
- Warn user about potential lockout

### Schema Attributes

| Attribute | Type | Required | Computed | Sensitive | Description |
|-----------|------|----------|----------|-----------|-------------|
| `enabled` | bool | Yes | No | No | Enable or disable the SSH service |
| `hosts` | list(string) | No | No | No | List of interfaces to listen on (e.g., lan1, pp1, bridge1, tunnel1). Empty = all interfaces |
| `host_key` | string | No | Yes | Yes | SSH host key (read-only, generated by router) |

### Validation Rules

- `hosts` elements must match pattern: `^(lan\d+|pp\d+|bridge\d+|tunnel\d+)$`

### RTX Commands Reference

```
# Enable/disable SSH service
sshd service on
sshd service off

# Set interfaces (optional)
sshd host lan1 lan2

# Remove interface restriction
no sshd host

# Show configuration
show config | grep sshd
```

### Import Specification

- **Import ID Format**: `sshd`
- **Import Command**: `terraform import rtx_sshd.main sshd`

### Example Usage

```hcl
# Basic SSH configuration - listen on all interfaces
resource "rtx_sshd" "main" {
  enabled = true
}

# SSH restricted to specific interfaces
resource "rtx_sshd" "main" {
  enabled = true
  hosts   = ["lan1", "lan2"]
}
```

---

## Resource: rtx_httpd

### Resource Summary

| Attribute | Value |
|-----------|-------|
| Resource Name | `rtx_httpd` |
| Type | singleton |
| Import Support | Yes |
| Import ID | `httpd` |
| Last Updated | 2026-01-23 |

### Description

Manages HTTP daemon (httpd) configuration on RTX routers. The HTTPD service provides the web management interface (GUI) for the router.

### Functional Requirements

#### Create

- Configure HTTPD host interface
- Optionally enable L2MS proxy access
- Read back configuration to ensure consistency

#### Read

- Retrieve current HTTPD configuration
- Retrieve proxy access state
- Remove from state if not configured

#### Update

- Update host interface
- Update proxy access setting

#### Delete

- Remove HTTPD configuration
- Disable web interface access

### Schema Attributes

| Attribute | Type | Required | Computed | Sensitive | Description |
|-----------|------|----------|----------|-----------|-------------|
| `host` | string | Yes | No | No | Interface to listen on: 'any' or interface name (lan1, pp1, bridge1, tunnel1) |
| `proxy_access` | bool | No | Yes | No | Enable L2MS proxy access for HTTP |

### Validation Rules

- `host` must match pattern: `^(any|lan\d+|pp\d+|bridge\d+|tunnel\d+)$`

### RTX Commands Reference

```
# Set HTTPD host
httpd host any
httpd host lan1

# Set proxy access
httpd proxy-access l2ms permit on
httpd proxy-access l2ms permit off

# Remove HTTPD configuration
no httpd host

# Show configuration
show config | grep httpd
```

### Import Specification

- **Import ID Format**: `httpd`
- **Import Command**: `terraform import rtx_httpd.main httpd`

### Example Usage

```hcl
# HTTPD on all interfaces
resource "rtx_httpd" "main" {
  host = "any"
}

# HTTPD on specific interface with proxy access
resource "rtx_httpd" "main" {
  host         = "lan1"
  proxy_access = true
}
```

---

## Resource: rtx_sftpd

### Resource Summary

| Attribute | Value |
|-----------|-------|
| Resource Name | `rtx_sftpd` |
| Type | singleton |
| Import Support | Yes |
| Import ID | `sftpd` |
| Last Updated | 2026-01-23 |

### Description

Manages SFTP daemon (sftpd) configuration on RTX routers. SFTPD provides secure file transfer capabilities. NOTE: SFTPD requires SSHD to be enabled for the service to work.

### Functional Requirements

#### Create

- Configure SFTPD host interfaces (required, at least one)
- Read back configuration to ensure consistency

#### Read

- Retrieve current SFTPD configuration
- Remove from state if not configured (no hosts)

#### Update

- Update host interface list

#### Delete

- Remove SFTPD configuration
- Disable SFTP access

### Schema Attributes

| Attribute | Type | Required | Computed | Sensitive | Description |
|-----------|------|----------|----------|-----------|-------------|
| `hosts` | list(string) | Yes | No | No | List of interfaces to listen on (minimum 1) |

### Validation Rules

- `hosts` must have at least one element (MinItems: 1)
- `hosts` elements must match pattern: `^(lan\d+|pp\d+|bridge\d+|tunnel\d+)$`

### RTX Commands Reference

```
# Set SFTPD hosts
sftpd host lan1 lan2

# Remove SFTPD configuration
no sftpd host

# Show configuration
show config | grep sftpd
```

### Import Specification

- **Import ID Format**: `sftpd`
- **Import Command**: `terraform import rtx_sftpd.main sftpd`

### Example Usage

```hcl
# SFTPD on single interface
resource "rtx_sftpd" "main" {
  hosts = ["lan1"]
}

# SFTPD on multiple interfaces
resource "rtx_sftpd" "main" {
  hosts = ["lan1", "lan2"]
}
```

---

## Resource: rtx_snmp_server

### Resource Summary

| Attribute | Value |
|-----------|-------|
| Resource Name | `rtx_snmp_server` |
| Type | singleton |
| Import Support | Yes |
| Import ID | `snmp` |
| Last Updated | 2026-01-23 |

### Description

Manages SNMP configuration on RTX routers. SNMP enables network monitoring and management through standard SNMP protocols (v1, v2c).

### Functional Requirements

#### Create

- Configure system information (location, contact, chassis_id/sysName)
- Configure SNMP communities with permissions and optional ACLs
- Configure trap hosts
- Configure trap enable settings
- Read back configuration to ensure consistency

#### Read

- Retrieve all SNMP configuration
- Map to Terraform schema attributes

#### Update

- Compare current vs desired configuration
- Add/remove communities as needed
- Add/remove trap hosts as needed
- Update system information
- Update trap settings

#### Delete

- Remove all SNMP configuration in reverse dependency order
- Remove trap settings first
- Remove hosts
- Remove communities
- Remove system information

### Schema Attributes

| Attribute | Type | Required | Computed | Sensitive | Description |
|-----------|------|----------|----------|-----------|-------------|
| `location` | string | No | No | No | System location (SNMP sysLocation) |
| `contact` | string | No | No | No | System contact (SNMP sysContact) |
| `chassis_id` | string | No | No | No | System name (SNMP sysName) |
| `community` | list(object) | No | No | No | SNMP community configurations |
| `host` | list(object) | No | No | No | SNMP trap host configurations |
| `enable_traps` | list(string) | No | No | No | List of trap types to enable |

#### Community Object Schema

| Attribute | Type | Required | Sensitive | Description |
|-----------|------|----------|-----------|-------------|
| `name` | string | Yes | Yes | Community string name (acts as password) |
| `permission` | string | Yes | No | Access permission: 'ro' or 'rw' |
| `acl` | string | No | No | Access control list number |

#### Host Object Schema

| Attribute | Type | Required | Sensitive | Description |
|-----------|------|----------|-----------|-------------|
| `ip_address` | string | Yes | No | IP address of SNMP trap receiver |
| `community` | string | No | Yes | Community string for traps |
| `version` | string | No | No | SNMP version: '1' or '2c' |

### Validation Rules

- `community.permission` must be 'ro' or 'rw'
- `community.name` maximum length: 64 characters
- `host.ip_address` must be valid IPv4 address
- `host.version` must be '1' or '2c' (if specified)
- `enable_traps` valid values: all, authentication, coldstart, warmstart, linkdown, linkup, enterprise

### RTX Commands Reference

```
# System information
snmp sysname <name>
snmp syslocation <location>
snmp syscontact <contact>

# Communities
snmp community read-only <name> [<acl>]
snmp community read-write <name> [<acl>]

# Trap configuration
snmp trap community <name>
snmp host <ip>
snmp trap enable snmp <types>

# Delete commands
no snmp sysname
no snmp syslocation
no snmp syscontact
no snmp community read-only <name>
no snmp community read-write <name>
no snmp trap community
no snmp host <ip>
no snmp trap enable snmp

# Show configuration
show config | grep snmp
```

### Import Specification

- **Import ID Format**: `snmp`
- **Import Command**: `terraform import rtx_snmp_server.main snmp`

### Example Usage

```hcl
# Basic SNMP configuration
resource "rtx_snmp_server" "main" {
  location   = "Tokyo Data Center"
  contact    = "admin@example.com"
  chassis_id = "RTX830-Main"

  community {
    name       = "public"
    permission = "ro"
  }

  community {
    name       = "private"
    permission = "rw"
    acl        = "10"
  }

  host {
    ip_address = "192.168.1.100"
  }

  host {
    ip_address = "192.168.1.101"
    version    = "2c"
  }

  enable_traps = ["coldstart", "warmstart", "linkdown", "linkup"]
}
```

---

## Resource: rtx_syslog

### Resource Summary

| Attribute | Value |
|-----------|-------|
| Resource Name | `rtx_syslog` |
| Type | singleton |
| Import Support | Yes |
| Import ID | `syslog` |
| Last Updated | 2026-01-23 |

### Description

Manages syslog configuration on RTX routers for centralized logging. Supports multiple syslog destination hosts, configurable facility, and log level filtering.

### Functional Requirements

#### Create

- Configure one or more syslog destination hosts
- Optionally configure local address, facility, and log levels
- Read back configuration to ensure consistency

#### Read

- Retrieve all syslog configuration
- Map to Terraform schema attributes
- Remove from state if not configured

#### Update

- Compare current vs desired configuration
- Add/remove hosts as needed
- Update local address, facility, and log levels

#### Delete

- Remove all syslog configuration
- Remove hosts, local address, facility, and disable log levels

### Schema Attributes

| Attribute | Type | Required | Computed | Sensitive | Description |
|-----------|------|----------|----------|-----------|-------------|
| `host` | set(object) | Yes | No | No | Syslog destination hosts (one or more) |
| `local_address` | string | No | No | No | Source IP address for syslog messages |
| `facility` | string | No | Yes | No | Syslog facility (user, local0-local7) |
| `notice` | bool | No | Yes | No | Enable notice level logging |
| `info` | bool | No | Yes | No | Enable info level logging |
| `debug` | bool | No | Yes | No | Enable debug level logging |

#### Host Object Schema

| Attribute | Type | Required | Computed | Description |
|-----------|------|----------|----------|-------------|
| `address` | string | Yes | No | IP address or hostname of syslog server |
| `port` | int | No | Yes | UDP port (default 514, use 0 for default) |

### Validation Rules

- `host.address` must be valid IP address or hostname
- `host.port` must be 0-65535
- `local_address` must be valid IP address (if specified)
- `facility` must be one of: user, local0, local1, local2, local3, local4, local5, local6, local7

### RTX Commands Reference

```
# Syslog hosts
syslog host <address> [<port>]
no syslog host <address>

# Local address
syslog local address <ip>
no syslog local address

# Facility
syslog facility <facility>
no syslog facility

# Log levels
syslog notice on|off
syslog info on|off
syslog debug on|off

# Show configuration
show config | grep syslog
```

### Import Specification

- **Import ID Format**: `syslog`
- **Import Command**: `terraform import rtx_syslog.main syslog`

### Example Usage

```hcl
# Basic syslog configuration
resource "rtx_syslog" "main" {
  host {
    address = "192.168.1.200"
  }
}

# Full syslog configuration
resource "rtx_syslog" "main" {
  host {
    address = "192.168.1.200"
    port    = 514
  }

  host {
    address = "192.168.1.201"
    port    = 1514
  }

  local_address = "192.168.1.1"
  facility      = "local0"
  notice        = true
  info          = true
  debug         = false
}
```

---

## Non-Functional Requirements

### Code Architecture and Modularity

- **Single Responsibility Principle**: Each resource file handles one service type
- **Modular Design**: Parsers, services, and resources are isolated
- **Dependency Management**: Clear separation between client layer and provider layer
- **Clear Interfaces**: Client interface defines CRUD operations for each service

### Performance

- Configuration changes are saved immediately to router flash
- All resources use single-shot commands (no interactive sessions)
- Read operations use `show config | grep` for efficient filtering

### Security

- SNMP community strings are marked as sensitive
- SSH host key is marked as sensitive
- Passwords and keys are not logged
- Warning messages for potentially dangerous operations (disabling SSH)

### Reliability

- All resources implement full CRUD lifecycle
- Read-after-write ensures configuration consistency
- Delete operations are idempotent (ignore "not found" errors)
- Context cancellation is respected throughout operations

### Validation

- Schema-level validation using Terraform SDK validators
- Service-level validation before command execution
- RTX command output validation for error detection

## Terraform Command Support

| Command | Support | Description |
|---------|---------|-------------|
| `terraform plan` | Required | Preview configuration changes |
| `terraform apply` | Required | Apply configuration to router |
| `terraform destroy` | Required | Remove/reset configuration |
| `terraform import` | Required | Import existing configuration |
| `terraform refresh` | Required | Sync state with router |
| `terraform state` | Required | State management operations |

## State Handling

- Only configuration attributes are persisted in Terraform state
- Operational/runtime status is not stored in state
- Singleton resources use fixed IDs (sshd, httpd, sftpd, snmp, syslog)
- Computed attributes (host_key, defaults) are stored after read

## Change History

| Date | Source Spec | Changes |
|------|-------------|---------|
| 2026-01-23 | Initial | Created from implementation code analysis |
